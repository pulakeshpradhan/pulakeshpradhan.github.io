<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- Viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Primary Meta Tags -->
    <title>GEE Code Generator with Gemini AI</title>
    <meta name="title" content="GEE Code Generator with Gemini AI">
    <meta name="description" content="Generate Google Earth Engine JavaScript code for remote sensing tasks using Gemini AI. Fast, easy, and ready to use in the GEE Code Editor.">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://pulakeshpradhan.github.io/geeai.html">
    <meta property="og:title" content="GEE Code Generator with Gemini AI">
    <meta property="og:description" content="Generate Google Earth Engine JavaScript code for remote sensing tasks using Gemini AI. Fast, easy, and ready to use in the GEE Code Editor.">
    <meta property="og:image" content="https://pulakeshpradhan.github.io/vis/geeaiimg.JPG">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://pulakeshpradhan.github.io/geeai.html">
    <meta property="twitter:title" content="GEE Code Generator with Gemini AI">
    <meta property="twitter:description" content="Generate Google Earth Engine JavaScript code for remote sensing tasks using Gemini AI. Fast, easy, and ready to use in the GEE Code Editor.">
    <meta property="twitter:image" content="https://pulakeshpradhan.github.io/vis/geeaiimg.JPG">


    <title>GEE Code Generator with Gemini AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        :root {
            --primary-color-anim: #2c3e50;
            --secondary-color-anim: #3498db;
            --accent-color-anim: #e74c3c;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Tailwind gray-100 */
            cursor: none; 
            overflow-x: hidden; 
            position: relative; 
        }

        .cursor {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: var(--secondary-color-anim);
            position: fixed;
            pointer-events: none;
            mix-blend-mode: difference;
            z-index: 9999;
            transform: translate(-50%, -50%);
            transition: transform 0.1s ease, background-color 0.2s ease;
        }

        .cursor-trail {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: var(--accent-color-anim);
            position: fixed;
            pointer-events: none;
            z-index: 9998;
            opacity: 0.7;
            transform: translate(-50%, -50%);
            transition: opacity 0.5s ease;
        }
        
        .float-element {
            position: fixed;
            background-color: rgba(52, 152, 219, 0.15);
            border-radius: 50%;
            pointer-events: none;
            z-index: -1; 
            animation: float 20s linear infinite;
        }
        
        @keyframes float {
            0% { transform: translateY(100vh) translateX(0vw) scale(0.5); opacity: 0; }
            10% { opacity: 0.7; }
            50% { transform: translateY(50vh) translateX(50vw) scale(1); }
            90% { opacity: 0.5; }
            100% { transform: translateY(-100px) translateX(100vw) scale(0.7); opacity: 0; }
        }

        .ripple {
            position: fixed;
            border-radius: 50%;
            background-color: rgba(52, 152, 219, 0.3);
            transform: scale(0);
            animation: ripple-animation 0.6s linear;
            pointer-events: none;
            z-index: 9997;
        }

        @keyframes ripple-animation {
            to { transform: scale(4); opacity: 0; }
        }

        .section-title {
            border-bottom: 2px solid #60A5FA; /* Tailwind blue-400 */
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
            font-weight: 600;
            color: #1E3A8A; /* Tailwind blue-800 */
        }
        .btn { 
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem; /* 8px */
            font-weight: 500;
            transition: background-color 0.3s ease, transform 0.2s ease, color 0.3s ease, border-color 0.3s ease; /* Added transitions */
            cursor: pointer; 
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .btn-primary {
            background-color: #3B82F6; /* Tailwind blue-500 */
            color: white;
        }
        .btn-primary:hover:not(:disabled) {
            background-color: #2563EB; /* Tailwind blue-600 */
            transform: translateY(-1px);
        }
        .btn-primary:disabled {
            background-color: #9CA3AF; /* Tailwind gray-400 */
        }
        .btn-secondary {
            background-color: #10B981; /* Tailwind emerald-500 */
            color: white;
        }
        .btn-secondary:hover {
            background-color: #059669; /* Tailwind emerald-600 */
            transform: translateY(-1px);
        }
        .btn-outline {
            background-color: transparent;
            border: 1px solid #60A5FA; /* Tailwind blue-400 */
            color: #3B82F6; /* Tailwind blue-500 */
        }
        .btn-outline:hover {
            background-color: #EFF6FF; /* Tailwind blue-50 */
            border-color: #2563EB; /* Darker blue for border */
            color: #2563EB; /* Darker blue for text */
            transform: translateY(-1px);
        }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
        .modal-content { background-color: #fefefe; margin: auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 500px; border-radius: 0.5rem; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .modal-close { color: #aaa; float: right; font-size: 28px; font-weight: bold; }
        .modal-close:hover, .modal-close:focus { color: black; text-decoration: none; }
        
        #generatedCodeContent pre {
            background-color: #2d2d2d; 
            color: #f8f8f2; 
            padding: 1rem;
            border-radius: 0.375rem; 
            overflow-x: auto; 
            font-family: 'Courier New', Courier, monospace; 
            font-size: 0.875rem; 
            line-height: 1.5;
            white-space: pre; 
        }
         #generatedCodeContent code {
            font-family: inherit; 
            color: inherit;
        }


        @media (max-width: 768px) {
            body { cursor: auto; }
            .cursor, .cursor-trail { display: none; }
        }
    </style>
</head>
<body class="min-h-screen py-8 px-4 md:px-8">
    <div class="cursor"></div>

    <div class="container mx-auto max-w-6xl relative z-10">
        <header class="mb-10 text-center">
            <div class="flex items-center justify-center mb-2">
                <i class="fas fa-code fa-3x text-green-600 mr-3"></i>
                <h1 class="text-4xl font-bold text-gray-800">GEE Code Generator</h1>
            </div>
            <p class="text-lg text-gray-600">AI-Powered Google Earth Engine JavaScript Code Snippets (India-Focused)</p>
        </header>

        <div class="flex flex-col md:flex-row gap-8">
            <div class="md:w-1/3 w-full">
                <div class="bg-white p-6 rounded-lg shadow-lg space-y-6 h-full">
                    <h2 class="text-2xl font-semibold text-gray-700 mb-4">Configuration</h2>
                    <div>
                        <label for="apiKey" class="block text-sm font-medium text-gray-700 mb-1">Gemini API Key</label>
                        <div class="relative rounded-md shadow-sm">
                            <input type="password" id="apiKey" class="focus:ring-blue-500 focus:border-blue-500 block w-full pl-3 pr-10 py-2 sm:text-sm border border-gray-300 rounded-md" placeholder="Enter your Gemini API key">
                            <div class="absolute inset-y-0 right-0 pr-3 flex items-center">
                                <button id="toggleApiKeyVisibility" class="text-gray-400 hover:text-gray-500">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                        <div id="apiKeyStatus" class="text-sm mt-1"></div>
                    </div>
                    <div>
                        <label for="userInput" class="block text-sm font-medium text-gray-700 mb-1">Describe GEE Task/Analysis</label>
                        <input type="text" id="userInput" class="focus:ring-blue-500 focus:border-blue-500 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm sm:text-sm" placeholder="e.g., Calculate NDVI for an area, detect water bodies in Odisha">
                    </div>
                     <div>
                        <label for="temperature" class="block text-sm font-medium text-gray-700 mb-1">AI Creativity (0.0 - 1.0)</label>
                        <input type="number" id="temperature" min="0" max="1" step="0.1" value="0.5" class="focus:ring-blue-500 focus:border-blue-500 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm sm:text-sm">
                    </div>
                    <button id="generateCodeBtn" class="btn btn-primary w-full text-lg">
                        <i class="fas fa-cogs mr-2"></i> Generate GEE Code
                    </button>
                    <div class="mt-8">
                        <a href="https://wa.me/918617812861" 
                            class="download-button w-full inline-block bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition-transform transform hover:scale-105 text-center" 
                            target="_blank">
                            <i class="fab fa-whatsapp mr-2"></i> Say Hi...
                        </a>
                    </div>
                    <div>
                        <button id="openNewsPopupBtn" class="btn btn-outline w-full mb-2">
                            <i class="fas fa-bolt mr-2"></i>Show Latest News (India)
                        </button>
                    </div>

                    <div id="newsPopupModal" class="modal" style="display:none;">
                        <div class="modal-content" style="max-width:600px;">
                            <span class="modal-close" id="closeNewsPopupBtn" style="cursor:pointer;">&times;</span>
                            <h3 class="text-xl font-semibold mb-4 text-gray-700 flex items-center">
                                <i class="fas fa-newspaper text-blue-500 mr-2"></i>
                                Latest India News (Google News)
                            </h3>
                            <form id="newsSearchForm" class="mb-4 flex gap-2">
                                <input type="text" id="newsSearchInput" class="flex-1 border border-gray-300 rounded px-3 py-2 text-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Search India news topic...">
                                <button type="submit" class="btn btn-primary px-4 py-2 text-sm">
                                    <i class="fas fa-search mr-1"></i>Search
                                </button>
                            </form>
                            <div class="rounded-lg overflow-hidden shadow border border-gray-200 bg-gray-50 p-4">
                                <ul id="newsList" class="list-disc list-inside text-gray-700 space-y-1">
                                    <li><a href="https://news.google.com/search?q=" id="newsTopicLink" target="_blank" class="text-blue-500 hover:underline">Search News for Current Topic</a></li>
                                    <li><a href="https://news.google.com/topics/CAAqJggKIiBDQkFTRWdvSkwyMHZNREp3ZVRBNUVnVmxiaTFIUWlnQVAB?hl=en-IN&gl=IN&ceid=IN%3Aen" target="_blank" class="text-blue-500 hover:underline">Environment</a></li>
                                    <li><a href="https://news.google.com/topics/CAAqJggKIiBDQkFTRWdvSkwyMHZNR1F3TmpOMkVnVmxiaTFIUWlnQVAB?hl=en-IN&gl=IN&ceid=IN%3Aen" target="_blank" class="text-blue-500 hover:underline">Climate Change</a></li>
                                    <li><a href="https://news.google.com/topics/CAAqJAgKIh5DQkFTRUFvSEwyMHZNR2hyWmhJRlpXNHRSMElvQUFQAQ?hl=en-IN&gl=IN&ceid=IN%3Aen" target="_blank" class="text-blue-500 hover:underline">Agriculture</a></li>
                                </ul>
                            </div>
                            <div class="mt-4">
                                <div id="newsResultsContainer" class="space-y-3"></div>
                            </div>
                        </div>
                    </div>
                </div> 
            </div>

            <div class="md:w-2/3 w-full">
                <main id="codeOutputContainer" class="bg-white p-6 md:p-8 rounded-lg shadow-lg min-h-[400px] flex flex-col justify-center">
                    <div id="initialMessage" class="text-center text-gray-500 py-10">
                        <i class="fab fa-google fa-3x mb-4 text-green-500"></i>
                        <p class="text-lg">Enter your API Key and describe the GEE task, then click "Generate GEE Code".</p>
                        <p>Your AI-generated GEE JavaScript code will appear here.</p>
                    </div>
                    <div id="loadingIndicator" class="hidden text-center text-gray-500 py-10">
                        <i class="fas fa-spinner fa-spin fa-3x mb-4 text-blue-500"></i>
                        <p class="text-lg">Generating GEE code with AI... This may take a moment.</p>
                    </div>
                    <div id="errorMessage" class="hidden text-center text-red-600 py-10">
                        <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                        <p class="text-lg">Could not generate GEE code.</p>
                        <p class="text-sm">Please check your API key, task description, and network connection. See console for details.</p>
                        <pre id="errorDetails" class="mt-2 text-xs text-left bg-red-50 p-3 rounded max-h-32 overflow-y-auto"></pre>
                    </div>
                    <div id="generatedCodeContent" class="prose max-w-none hidden">
                        </div>
                    <div id="codeActions" class="mt-6 text-center hidden">
                        <button id="copyCodeBtn" class="btn btn-secondary mr-2">
                            <i class="fas fa-copy mr-2"></i>Copy Code
                        </button>
                        <button id="openInGeeEditorBtn" class="btn btn-outline"> <i class="fas fa-external-link-alt mr-2"></i>Open in GEE Editor 
                        </button>
                    </div>
                </main>
            </div>
        </div>

        <footer class="mt-12 text-center text-xs text-gray-500">
            <p class="mb-1">&copy; <span id="currentYear"></span> Pulakesh Pradhan</p>
            <p class="mb-1">Powered by Gemini AI &amp; Google Earth Engine</p>
            <div class="flex flex-col sm:flex-row gap-2 justify-center items-center text-gray-400">
                <span>
                    <i class="fas fa-key mr-1"></i>
                    <a href="https://aistudio.google.com/apikey" target="_blank" class="text-blue-500 hover:underline">Get Gemini API Key</a>
                </span>
                <span class="hidden sm:inline">|</span>
                <span>
                    <i class="fas fa-lock mr-1"></i>
                    API key stays in your browser
                </span>
            </div>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const generateCodeBtn = document.getElementById('generateCodeBtn');
            const generatedCodeContent = document.getElementById('generatedCodeContent');
            const initialMessage = document.getElementById('initialMessage');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const errorMessage = document.getElementById('errorMessage');
            const errorDetails = document.getElementById('errorDetails');
            const codeActions = document.getElementById('codeActions');
            const copyCodeBtn = document.getElementById('copyCodeBtn');
            const openInGeeEditorBtn = document.getElementById('openInGeeEditorBtn'); 
            
            const apiKeyInput = document.getElementById('apiKey');
            const apiKeyStatus = document.getElementById('apiKeyStatus');
            const toggleApiKeyVisibilityBtn = document.getElementById('toggleApiKeyVisibility');
            const userInput = document.getElementById('userInput'); 
            const temperatureInput = document.getElementById('temperature');

            const openNewsPopupBtn = document.getElementById('openNewsPopupBtn');
            const newsPopupModal = document.getElementById('newsPopupModal');
            const closeNewsPopupBtn = document.getElementById('closeNewsPopupBtn');
            const newsSearchForm = document.getElementById('newsSearchForm');
            const newsSearchInput = document.getElementById('newsSearchInput');
            const newsTopicLink = document.getElementById('newsTopicLink');
            const newsResultsContainer = document.getElementById('newsResultsContainer');
            
            document.getElementById('currentYear').textContent = new Date().getFullYear();

            const GEMINI_API_BASE_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent'; 

            let currentGeneratedGeeCode = null;
            let storedApiKey = localStorage.getItem('geminiApiKeyGeeCoder') || '';

            if (storedApiKey) {
                apiKeyInput.value = storedApiKey;
                validateApiKeySilent();
            }

            toggleApiKeyVisibilityBtn.addEventListener('click', () => {
                if (apiKeyInput.type === 'password') {
                    apiKeyInput.type = 'text';
                    toggleApiKeyVisibilityBtn.innerHTML = '<i class="fas fa-eye-slash"></i>';
                } else {
                    apiKeyInput.type = 'password';
                    toggleApiKeyVisibilityBtn.innerHTML = '<i class="fas fa-eye"></i>';
                }
            });

            apiKeyInput.addEventListener('input', () => {
                storedApiKey = apiKeyInput.value.trim();
                localStorage.setItem('geminiApiKeyGeeCoder', storedApiKey);
                if (!storedApiKey) {
                    apiKeyStatus.innerHTML = '<span class="text-yellow-600">Please enter your API key.</span>';
                } else {
                     apiKeyStatus.innerHTML = ''; 
                }
            });
            
            async function validateApiKeySilent() {
                if (!storedApiKey) return false;
                try {
                    const testUrl = `${GEMINI_API_BASE_URL}?key=${storedApiKey}`;
                    const response = await fetch(testUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: "Hello" }] }] })
                    });
                    if (response.ok) {
                        const testData = await response.json();
                        if (testData.candidates && testData.candidates.length > 0) {
                             apiKeyStatus.innerHTML = '<span class="text-green-600 text-xs">API key appears valid.</span>';
                             return true;
                        } else if (testData.error) {
                            apiKeyStatus.innerHTML = `<span class="text-red-600 text-xs">API key validation failed: ${testData.error.message}</span>`;
                            return false;
                        } else {
                             apiKeyStatus.innerHTML = '<span class="text-yellow-600 text-xs">API key status uncertain. Proceed with generation.</span>';
                             return true; 
                        }
                    } else {
                        const error = await response.json();
                        apiKeyStatus.innerHTML = `<span class="text-red-600 text-xs">API key validation failed: ${error.error?.message || response.statusText}</span>`;
                        console.error("API Key validation error:", error);
                        return false;
                    }
                } catch (error) {
                    apiKeyStatus.innerHTML = `<span class="text-red-600 text-xs">Error during API key check. Check console.</span>`;
                    console.error("API Key check exception:", error);
                    return false;
                }
            }

            function displayGeneratedCode(geeCodeString) {
                currentGeneratedGeeCode = geeCodeString;
                initialMessage.classList.add('hidden');
                loadingIndicator.classList.add('hidden');
                errorMessage.classList.add('hidden');
                generatedCodeContent.classList.remove('hidden');
                codeActions.classList.remove('hidden');

                const codeElement = document.createElement('code');
                codeElement.textContent = geeCodeString;
                const preElement = document.createElement('pre');
                preElement.appendChild(codeElement);
                
                generatedCodeContent.innerHTML = ''; 
                generatedCodeContent.appendChild(preElement);
            }

            async function generateGeeCodeWithAI() {
                const userTask = userInput.value.trim();
                const currentApiKey = apiKeyInput.value.trim();
                const currentTemperature = parseFloat(temperatureInput.value);

                if (!currentApiKey) {
                    apiKeyStatus.innerHTML = '<span class="text-red-600">API Key is required.</span>';
                    apiKeyInput.focus();
                    return;
                }
                 if (!userTask) {
                    userInput.focus();
                    const userTaskLabel = document.querySelector('label[for="userInput"]');
                    if (userTaskLabel) {
                        let tempMsg = userTaskLabel.querySelector('.temp-error-msg');
                        if (!tempMsg) {
                            tempMsg = document.createElement('span');
                            tempMsg.className = 'text-red-500 text-xs ml-2 temp-error-msg';
                            userTaskLabel.appendChild(tempMsg);
                        }
                        tempMsg.textContent = 'Please describe the GEE task.';
                        setTimeout(() => { tempMsg.remove(); }, 3000);
                    }
                    return;
                }

                initialMessage.classList.add('hidden');
                generatedCodeContent.classList.add('hidden');
                generatedCodeContent.innerHTML = '';
                errorMessage.classList.add('hidden');
                codeActions.classList.add('hidden');
                loadingIndicator.classList.remove('hidden');
                generateCodeBtn.disabled = true;
                generateCodeBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Generating...';

                const prompt = `
You are an expert assistant for Google Earth Engine (GEE) that ONLY generates JavaScript code.
The user wants to perform the following task in GEE, often related to India: "${userTask}".

IMPORTANT: Before generating code, assess if the user's request might involve a GEE Image Collection that is deprecated or has a newer, preferred version (e.g., older Landsat collections vs. Collection 2, or non-harmonized Sentinel-2 vs. harmonized Sentinel-2 Surface Reflectance).
If a potentially deprecated collection is implied or mentioned:
1. Prioritize using the most current, recommended, and analysis-ready version of that collection (e.g., 'COPERNICUS/S2_SR_HARMONIZED' for Sentinel-2, Landsat Collection 2 Level-2 products like 'LANDSAT/LC09/C02/T1_L2').
2. If you use a newer collection, briefly mention this choice in a comment within the generated code, for example: "// Using Sentinel-2 Harmonized Surface Reflectance collection for better consistency."
3. If the user explicitly names a very old or clearly superseded collection ID, and a direct modern equivalent exists, use the modern one and note the change in a comment.

Generate a concise and functional Google Earth Engine JavaScript code snippet to accomplish the user's task.
The code MUST be ready to run in the GEE Code Editor.
Include brief comments in the code to explain key steps (e.g., // This line does X).
Focus on the core GEE logic.
If an Area of Interest (AOI) is needed and not specified, you can use a placeholder like a point, a small rectangle, or suggest the user defines one. For India-related queries, you might use a generic India boundary or a state if appropriate and simple.
Output ONLY the JavaScript code. 
Do NOT include any other text, greetings, explanations, or markdown formatting like \`\`\`javascript or \`\`\` around the code.
Your entire response should be JUST the JavaScript code block.

Example user request: "Calculate NDVI for a sample area in India using Sentinel 2 and display it"
Example GEE Code (This is just an example of format, your output should be tailored to the user's request):
// Define a sample rectangular AOI in India
var aoi = ee.Geometry.Rectangle([77.0, 28.5, 77.5, 29.0]); // Example near Delhi
Map.centerObject(aoi, 10);
Map.addLayer(aoi, {color: 'FF0000'}, 'Area of Interest');

// Load Sentinel-2 Harmonized Surface Reflectance collection
// Using Sentinel-2 Harmonized Surface Reflectance collection for better consistency.
var s2 = ee.ImageCollection('COPERNICUS/S2_SR_HARMONIZED')
  .filterBounds(aoi) 
  .filterDate('2023-01-01', '2023-03-31') // Use a recent short period for example
  .filter(ee.Filter.lt('CLOUDY_PIXEL_PERCENTAGE', 20));

// Create a cloud-free median composite
var image = ee.Image(s2.median()).clip(aoi); 

// Compute NDVI
// Sentinel-2 bands: B8 (NIR), B4 (Red)
var nir = image.select('B8'); 
var red = image.select('B4'); 
var ndvi = nir.subtract(red).divide(nir.add(red)).rename('NDVI');

// Display NDVI
var ndviParams = {min: -0.5, max: 0.9, palette: ['blue', 'white', 'green']};
Map.addLayer(ndvi, ndviParams, 'NDVI from Sentinel-2');

print('NDVI calculation complete for the AOI.');
print('Image used for composite:', image);
print('NDVI layer:', ndvi);
                `;

                try {
                    const fullApiUrl = `${GEMINI_API_BASE_URL}?key=${currentApiKey}`;
                    const response = await fetch(fullApiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }],
                            generationConfig: {
                                temperature: currentTemperature,
                            }
                        }),
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        console.error('API Error Response:', errorData);
                        throw new Error(`API Error: ${errorData.error?.message || response.statusText}`);
                    }

                    const responseData = await response.json();
                    let geeCodeString;

                    if (responseData.candidates && responseData.candidates[0] && 
                        responseData.candidates[0].content && responseData.candidates[0].content.parts &&
                        responseData.candidates[0].content.parts[0] && responseData.candidates[0].content.parts[0].text) {
                        
                        geeCodeString = responseData.candidates[0].content.parts[0].text;
                        geeCodeString = geeCodeString.replace(/^```javascript\s*|```$/g, '').trim();

                    } else {
                        console.error("Unexpected API response structure:", responseData);
                        throw new Error("Unexpected API response format: Could not extract GEE code.");
                    }
                    
                    displayGeneratedCode(geeCodeString);
                    loadingIndicator.classList.add('hidden');
                    errorMessage.classList.add('hidden');

                } catch (error) {
                    console.error('Error generating GEE code:', error);
                    loadingIndicator.classList.add('hidden');
                    errorMessage.classList.remove('hidden');
                    errorDetails.textContent = error.message + (error.response ? `\nDetails: ${JSON.stringify(error.response, null, 2)}` : '');
                    generatedCodeContent.innerHTML = ''; 
                    generatedCodeContent.classList.add('hidden');
                    codeActions.classList.add('hidden');
                } finally {
                    generateCodeBtn.disabled = false;
                    generateCodeBtn.innerHTML = '<i class="fas fa-cogs mr-2"></i> Generate GEE Code';
                }
            }

            function copyGeeCodeToClipboard(feedbackElement) { 
                if (!currentGeneratedGeeCode) return false;
                const textarea = document.createElement('textarea');
                textarea.value = currentGeneratedGeeCode;
                document.body.appendChild(textarea);
                textarea.select();
                let success = false;
                const originalFeedbackHTML = feedbackElement ? feedbackElement.innerHTML : ''; 

                try {
                    document.execCommand('copy');
                    success = true;
                    if (feedbackElement) {
                        feedbackElement.innerHTML = '<i class="fas fa-check mr-2"></i> Copied!';
                    }
                } catch (err) {
                    console.error('Failed to copy text: ', err);
                    if (feedbackElement) {
                        feedbackElement.innerHTML = '<i class="fas fa-times mr-2"></i> Failed';
                    }
                }
                document.body.removeChild(textarea);

                if (feedbackElement) {
                    setTimeout(() => {
                         feedbackElement.innerHTML = originalFeedbackHTML;
                    }, 2000);
                }
                return success;
            }

            function openInGeeEditor() {
                const openBtn = document.getElementById('openInGeeEditorBtn'); 
                const originalHTML = openBtn.innerHTML; 

                if (!currentGeneratedGeeCode) {
                    openBtn.innerHTML = '<i class="fas fa-exclamation-circle mr-2"></i> No Code!';
                    setTimeout(() => { openBtn.innerHTML = originalHTML; }, 2500);
                    return;
                }

                const textarea = document.createElement('textarea');
                textarea.value = currentGeneratedGeeCode;
                document.body.appendChild(textarea);
                textarea.select();
                let copiedSuccessfully = false;
                try {
                    document.execCommand('copy');
                    copiedSuccessfully = true;
                } catch (err) {
                    console.error('Failed to copy text for GEE Editor: ', err);
                }
                document.body.removeChild(textarea);

                if (copiedSuccessfully) {
                    openBtn.innerHTML = '<i class="fas fa-check mr-2"></i> Code Copied! Paste in Editor Tab';
                } else {
                    openBtn.innerHTML = '<i class="fas fa-times mr-2"></i> Copy Failed. Opening Editor...';
                }

                window.open('https://code.earthengine.google.co.in/', '_blank');
                
                setTimeout(() => {
                    openBtn.innerHTML = originalHTML;
                }, 3500); 
            }
            
            generateCodeBtn.addEventListener('click', generateGeeCodeWithAI);
            openInGeeEditorBtn.addEventListener('click', openInGeeEditor); 
            copyCodeBtn.addEventListener('click', () => copyGeeCodeToClipboard(copyCodeBtn)); 
            
            // --- News Popup Logic ---
            openNewsPopupBtn.addEventListener('click', function() {
                const topic = userInput.value.trim(); 
                if (topic) {
                    newsSearchInput.value = topic; 
                    newsTopicLink.href = "https://news.google.com/search?q=" + encodeURIComponent(topic + " India environment OR technology OR gis OR remote sensing");
                    newsTopicLink.textContent = `Search News for "${topic}"`;
                    fetchNews(topic + " India environment OR technology OR gis OR remote sensing"); 
                } else {
                    newsSearchInput.value = "India environment technology";
                    newsTopicLink.href = "https://news.google.com/search?q=India%20environment%20technology%20gis%20remote%20sensing";
                    newsTopicLink.textContent = "Search General India Tech/Env News";
                    fetchNews("India environment technology gis remote sensing");
                }
                newsPopupModal.style.display = 'flex';
            });

            closeNewsPopupBtn.addEventListener('click', function() {
                newsPopupModal.style.display = 'none';
            });

            newsPopupModal.addEventListener('click', function(event) {
                if (event.target === newsPopupModal) {
                    newsPopupModal.style.display = 'none';
                }
            });
            
            newsSearchForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const searchTerm = newsSearchInput.value.trim();
                if (searchTerm) {
                    fetchNews(searchTerm + " India");
                     newsTopicLink.href = "https://news.google.com/search?q=" + encodeURIComponent(searchTerm + " India");
                     newsTopicLink.textContent = `Search News for "${searchTerm}"`;
                }
            });

            function fetchNews(searchTerm) {
                newsResultsContainer.innerHTML = `
                    <div class="flex items-center justify-center text-blue-500">
                        <i class="fas fa-spinner fa-spin mr-2"></i>Loading news for "<span class="font-semibold">${searchTerm.replace(" India", "")}</span>"...
                    </div>
                `;
                const rssUrl = "https://news.google.com/rss/search?q=" + encodeURIComponent(searchTerm) + "&hl=en-IN&gl=IN&ceid=IN:en";
                const apiUrl = "https://api.rss2json.com/v1/api.json?rss_url=" + encodeURIComponent(rssUrl);

                fetch(apiUrl)
                    .then(res => res.json())
                    .then(data => {
                        if (data.status === "ok" && data.items && data.items.length > 0) {
                            let resultHtml = "";
                            data.items.slice(0, 5).forEach(item => { 
                                resultHtml += `
                                    <div class="bg-white border border-gray-200 rounded-lg p-3 shadow-sm hover:shadow transition">
                                        <a href="${item.link}" target="_blank" class="text-blue-700 font-semibold hover:underline text-base block mb-1">${item.title}</a>
                                        <div class="text-xs text-gray-500 mb-1">${item.pubDate ? new Date(item.pubDate).toLocaleDateString() : ''} - ${item.author || 'Google News'}</div>
                                        <div class="text-gray-600 text-sm">${item.description ? item.description.replace(/<[^>]+>/g, '').slice(0, 120) + '...' : 'No description available.'}</div>
                                    </div>
                                `;
                            });
                            newsResultsContainer.innerHTML = resultHtml;
                        } else {
                            newsResultsContainer.innerHTML = `<div class="text-center text-gray-500">No news found for "<span class="font-semibold">${searchTerm.replace(" India", "")}</span>". Try a broader search.</div>`;
                        }
                    })
                    .catch((error) => {
                        console.error("News fetch error:", error);
                        newsResultsContainer.innerHTML = `<div class="text-center text-red-500">Failed to load news. The public RSS-to-JSON API might be temporarily unavailable or rate-limited.</div>`;
                    });
            }

            const customCursor = document.querySelector('.cursor');
            const linksAndButtons = document.querySelectorAll('a, button, input[type="button"], input[type="submit"], input[type="text"], input[type="password"], input[type="number"]');

            if (customCursor) {
                document.addEventListener('mousemove', (e) => {
                    customCursor.style.left = e.clientX + 'px';
                    customCursor.style.top = e.clientY + 'px';
                });

                let lastTrailTime = 0;
                document.addEventListener('mousemove', (e) => {
                    if (window.innerWidth <= 768) return;
                    const now = Date.now();
                    if (now - lastTrailTime > 50) {
                        createCursorTrail(e);
                        lastTrailTime = now;
                    }
                });

                linksAndButtons.forEach(el => {
                    el.addEventListener('mouseenter', () => {
                        customCursor.style.transform = 'translate(-50%, -50%) scale(2)';
                        customCursor.style.backgroundColor = 'var(--accent-color-anim)';
                    });
                    el.addEventListener('mouseleave', () => {
                        customCursor.style.transform = 'translate(-50%, -50%) scale(1)';
                        customCursor.style.backgroundColor = 'var(--secondary-color-anim)';
                    });
                });
            }

            function createCursorTrail(e) {
                const trail = document.createElement('div');
                trail.className = 'cursor-trail';
                trail.style.left = e.clientX + 'px';
                trail.style.top = e.clientY + 'px';
                document.body.appendChild(trail);
                
                const trailColors = ['#3498db', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6'];
                trail.style.backgroundColor = trailColors[Math.floor(Math.random() * trailColors.length)];
                
                setTimeout(() => {
                    trail.style.opacity = '0';
                    setTimeout(() => {
                        if (document.body.contains(trail)) {
                           document.body.removeChild(trail);
                        }
                    }, 500);
                }, 300);
            }

            function createFloatingElements() {
                if (window.innerWidth <= 768) return; 
                const count = 10; 
                const body = document.body; 
                
                for (let i = 0; i < count; i++) {
                    const floatEl = document.createElement('div');
                    floatEl.className = 'float-element';
                    const size = Math.random() * 80 + 20; 
                    const initialX = Math.random() * 100; 
                    const delay = Math.random() * 15; 
                    const duration = Math.random() * 10 + 15; 
                    const floatColors = ['rgba(52, 152, 219, 0.1)', 'rgba(231, 76, 60, 0.08)', 'rgba(46, 204, 113, 0.1)'];
                    
                    floatEl.style.width = `${size}px`;
                    floatEl.style.height = `${size}px`;
                    floatEl.style.left = `${initialX}vw`; 
                    floatEl.style.animationDuration = `${duration}s`;
                    floatEl.style.animationDelay = `${delay}s`;
                    floatEl.style.backgroundColor = floatColors[Math.floor(Math.random() * floatColors.length)];
                    body.insertBefore(floatEl, body.firstChild); 
                }
            }
            createFloatingElements(); 

            document.addEventListener('click', (e) => {
                if (window.innerWidth <= 768) return; 
                const ripple = document.createElement('div');
                ripple.className = 'ripple';
                document.body.appendChild(ripple);
                ripple.style.left = `${e.clientX}px`;
                ripple.style.top = `${e.clientY}px`;
                const rippleColors = ['rgba(52, 152, 219, 0.3)', 'rgba(231, 76, 60, 0.25)', 'rgba(46, 204, 113, 0.3)'];
                ripple.style.backgroundColor = rippleColors[Math.floor(Math.random() * rippleColors.length)];
                ripple.onanimationend = () => {
                    if (document.body.contains(ripple)) {
                        document.body.removeChild(ripple);
                    }
                };
            });
        });
    </script>
</body>
</html>
