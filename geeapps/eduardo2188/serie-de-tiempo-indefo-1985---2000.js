var geometry = ui.import && ui.import("geometry", "geometry", {
      "geometries": [
        {
          "type": "Point",
          "coordinates": [
            -71.20109737799095,
            -3.371657713814247
          ]
        },
        {
          "type": "Point",
          "coordinates": [
            -75.17867157016768,
            -9.306976694472622
          ]
        },
        {
          "type": "Point",
          "coordinates": [
            -72.38622618927194,
            -9.826487936402511
          ]
        }
      ],
      "displayProperties": [],
      "properties": {},
      "color": "#0b4a8b",
      "mode": "Geometry",
      "shown": true,
      "locked": false
    }) || /* color: #0b4a8b */ee.Geometry.MultiPoint(
        [[-71.20109737799095, -3.371657713814247],
         [-75.17867157016768, -9.306976694472622],
         [-72.38622618927194, -9.826487936402511]]),
    image4 = ui.import && ui.import("image4", "image", {
      "id": "users/eduardo2188/LANDSAT_MOSAICO_1985_2000_INDEFO_065_FINAL3"
    }) || ee.Image("users/eduardo2188/LANDSAT_MOSAICO_1985_2000_INDEFO_065_FINAL3");
var vectores = ee.FeatureCollection("users/GEE-RRBM/Limite_departamental"),
    logo = ee.Image("users/GEE-RRBM/Logo_MINAM6");
var rect = vectores.geometry();
var logominagri =  ui.Thumbnail({image:logo,params:{bands:['b1','b2','b3'],min:0,max:255},style:{backgroundColor:'#cefff4', border: '1px solid black', margin: '0px 0px 0px 100px'}});
var app={};
app.createConstants = function() {
app.Departamento=ee.FeatureCollection('users/GEE-RRBM/Limite_departamental');
app.SelectedDepartamento='JUNIN';
app.HELPER_TEXT_STYLE = {margin: '8px 0 -3px 50px',fontSize: '14px',fontWeight: 'bold',width:'180px',color: 'green'};
app.URL_TEXT_STYLE = {margin: '4px 0 -1px 4px',fontSize: '10px',color: '3792cb'};
//app.eez =ee.FeatureCollection('users/GEE-RRBM/Limite_departamental');};
app.eez =ee.FeatureCollection('users/GEE-RRBM/LANDSATV3');};
app.createPanels = function() {
  app.logo =  {panel: ui.Thumbnail({image:logo,params:{bands:['b1','b2','b3'],min:0,max:255},style:{border: '1px solid black', margin: '10px 0 0 75px'}})};
  app.intro = {panel: ui.Panel([ui.Label({value: 'MONITOREO DE LOS BOSQUES MEDIANTE LANDSAT',style: {fontWeight: 'bold', fontSize: '16px', margin: '15px 10px 10px 15px',color: 'black'}}),
  ui.Label('http://www.bosques.gob.pe',{color: 'blue',fontWeight: 'bold',fontSize: '14px', margin: '8px 0 0px 110px'}).setUrl('http://www.bosques.gob.pe')])};
  var features = ee.FeatureCollection(app.eez).sort('CUADRANTE').getInfo()['features'];
  var items=[];
  for (var i = 0; i < features.length; i++) {items.push({label: features[i]['properties']['CUADRANTE'],value: features[i]['properties']['CUADRANTE']});}
  app.filters = {
    c1: ui.Select({items:items, onChange: function(value) 
    {var selected_country = app.eez.filter(ee.Filter.eq('CUADRANTE', value));
    Map.clear();
    panel.clear()
    app.inspector_intro.clear()
    app.inspector_intro2.clear()
    Map.setOptions("HYBRID")
    //Map.setOptions('Dark', MAP_STYLES)
    Map.addLayer(selected_country.style({color:'black', width:2, fillColor:'00000000'}), {}, 'Cuadrante'+' '+value);
    Map.centerObject(selected_country);
    app.SelectedDepartamento=value;
    },
    style:{width:'100px', border: '1px solid black'},placeholder:'Path/Row'}),
    d1: ui.Textbox('YYYY-MM-DD', '1985-01-01',0,0,{fontWeight: 'bold',border: '1px solid blue', fontSize: '12px', color: 'black',width:'90px'}),
    d2: ui.Textbox('YYYY-MM-DD', '2000-12-31',0,0,{fontWeight: 'bold',border: '1px solid blue', fontSize: '12px', color: 'black',width:'90px'}),
 apply: ui.Button('Run',app.refreshPlace,0,{fontWeight: 'bold', border: '1px solid blue', fontSize: '12px', width:'90px',color: 'red'}),};
  app.filters.panel = ui.Panel({
    widgets: [ 
      ui.Panel([ui.Label('')], ui.Panel.Layout.flow('horizontal')),
      ui.Panel([ui.Label('Seleccionar Cuadrante:', app.HELPER_TEXT_STYLE), app.filters.c1], ui.Panel.Layout.flow('horizontal')),
      ui.Panel([ui.Label('Fecha de Inicio:', app.HELPER_TEXT_STYLE), app.filters.d1], ui.Panel.Layout.flow('horizontal')),
      ui.Panel([ui.Label('Fecha Final:', app.HELPER_TEXT_STYLE), app.filters.d2], ui.Panel.Layout.flow('horizontal')),
      ui.Panel([ui.Label('Ejecutar:', app.HELPER_TEXT_STYLE), app.filters.apply], ui.Panel.Layout.flow('horizontal')),
      ui.Panel([ui.Label('')], ui.Panel.Layout.flow('horizontal')),
    ],
    style: app.SECTION_STYLE});
  //app.inspector_intro = ui.Panel([ui.Label('Cuantificación',{color: 'black',fontWeight: 'bold',fontSize: '18px', margin: '8px 0 0px 20px'})]);
  app.inspector_intro = ui.Panel([ui.Label('')]);
  app.inspector_intro2 = ui.Panel([ui.Label('')]);
  app.inspector = ui.Panel([ui.Label('')]);
  app.export = ui.Panel([ui.Label('')]);};
var panel = ui.Panel({style: {width: '500px'}}).add(ui.Label('Serie de Tiempo', {fontWeight: 'bold', fontSize: '22px',margin: '0 0 5px 30px'}))
app.refreshPlace = function() {
  Map.clear();
  panel.clear()
  app.inspector_intro.clear()
  app.inspector_intro2.clear()
  app.inspector.clear();
  app.export.clear();
  Map.setOptions("HYBRID")
  //Map.setOptions('Dark', MAP_STYLES)
  var AOI = ee.FeatureCollection(app.eez.filter(ee.Filter.eq('CUADRANTE', app.SelectedDepartamento)).geometry());//.buffer(app.bufferd)
      var pathh = app.SelectedDepartamento[0]+app.SelectedDepartamento[1]
      var roww  = app.SelectedDepartamento[3]+app.SelectedDepartamento[4]
  print(ee.Number.parse(pathh),ee.Number.parse(roww))
  //var AOI = ee.FeatureCollection(app.eez.filter(ee.Filter.eq('nombdep', app.SelectedDepartamento)).geometry());//.buffer(app.bufferd)
  // var Date_Start = ee.Date(app.filters.d1.getValue());
  // var Date_End = ee.Date(app.filters.d2.getValue());
  // var Date_Start = app.filters.d1.getValue();
  // var Date_End = app.filters.d2.getValue();
  var Date_Start = ee.Date(app.filters.d1.getValue()+'T00:00:00');
  var Date_End = ee.Date(app.filters.d2.getValue()+'T23:59:59');
var INDEFO = function(image) {
var banda2 = image.expression('(((nir-red)/(nir+red))-((nir-swir1)/(swir1+nir)))/(((nir-red)/(nir+red))+((nir-swir1)/(swir1+nir)))', {'blue':image.select('blue'),'red':image.select('red'),'green':image.select('green'),'nir':image.select('nir'),'swir1':image.select('swir1'),'swir2':image.select('swir2')}).rename('INDEFO');
return image.addBands(banda2).copyProperties(image,['system:time_start','system:time_end']);};
function umbral(image) {
var maska = (image.select('blue').lte(0.10)).and(image.select('INDEFO').gt(0.50))
return image.updateMask(maska).copyProperties(image,['system:time_start','system:time_end'])}
var NBR_LANDSAT = ee.ImageCollection(image4).map(INDEFO).map(umbral).median().gte(0)
Map.addLayer(ee.ImageCollection(image4).map(INDEFO), {bands: ['swir2','nir','red'], min: [0.01,0.05,0.03], max: [0.20,0.6,0.25]},'Landsat 1985-2000');
Map.addLayer(NBR_LANDSAT, {bands: ['INDEFO'], min: [0], max: [1],palette: 'black'},'NO BOSQUE');
Map.addLayer(AOI.style({color:'black', width:2, fillColor:'00000000'}),{},'Cuadrante'+' '+app.SelectedDepartamento,true);
app.inspector_intro.widgets().set(1, ui.Label('Seleccione un Pixel en el Mapa --------->', {fontWeight: 'bold',color: 'black', fontSize: '18px',margin: '20px 0 5px 25px'}))
var IMAGEADDED = false
var cur_point;
/////////////////////////////////////////////////////////
var refresh_layers = function(point) {
Map.layers().reset();
Map.layers().set(3);
var pointOutline = ee.Image().byte().paint({featureCollection: ee.FeatureCollection(point),color: 1,width: 2});
var INDEFO = function(image) {
var banda2 = image.expression('(((nir-red)/(nir+red))-((nir-swir1)/(swir1+nir)))/(((nir-red)/(nir+red))+((nir-swir1)/(swir1+nir)))', {'blue':image.select('blue'),'red':image.select('red'),'green':image.select('green'),'nir':image.select('nir'),'swir1':image.select('swir1'),'swir2':image.select('swir2')}).rename('INDEFO');
return image.addBands(banda2).copyProperties(image,['system:time_start','system:time_end']);};
function umbral(image) {
var maska = (image.select('blue').lte(0.10)).and(image.select('INDEFO').gt(0.50))
return image.updateMask(maska).copyProperties(image,['system:time_start','system:time_end'])}
var NBR_LANDSAT = ee.ImageCollection(image4).map(INDEFO).map(umbral).median().gte(0)
Map.addLayer(ee.ImageCollection(image4).map(INDEFO), {bands: ['swir2','nir','red'], min: [0.01,0.05,0.03], max: [0.20,0.6,0.25]},'Landsat 1985-2000');
Map.addLayer(NBR_LANDSAT, {bands: ['INDEFO'], min: [0], max: [1],palette: 'black'},'NO BOSQUE');
Map.addLayer(ee.Image(0).updateMask(0).paint(AOI,'#000000', 2.5), {palette: '#010000'},'Cuadrante'+' '+app.SelectedDepartamento,true )
Map.addLayer(pointOutline, {palette: 'yellow'}, 'Punto de Análisis')
;};
/////////////////////////////////////////////////////////
//************************************************************
var getImageRegion = function(region, date) {
///////////////////////////
var Numero_de_banda =ee.Dictionary({L8: ee.List([1,2,3,4,5,6,7,10]), L7: ee.List([0,1,2,3,4,6,5,9]),L5: ee.List([0,1,2,3,4,6,5,9]),L4: ee.List([0,1,2,3,4,6,5,9])});
var Nombre_de_banda = ee.List(['blue','green','red','nir','swir1','swir2','temp','pixel_qa']);
var landsat5 = (ee.ImageCollection('LANDSAT/LT05/C01/T1_SR').select(Numero_de_banda.get('L5'), Nombre_de_banda)).filter(ee.Filter.eq('IMAGE_QUALITY' , 9))
.filter(ee.Filter.inList('system:index', ['LT05_003069_19910421','LT05_003069_19990918','LT05_002070_19861009','LT05_002069_19990404','LT05_002069_19991114','LT05_002069_19890830','LT05_002069_19960427','LT05_002069_19880912','LT05_002069_19950511','LT05_002069_19850702','LT05_003068_19930613','LT05_003068_19850709','LT05_003068_19880717','LT05_004068_19880825','LT05_003068_19970624','LT05_003068_19850709','LT05_003068_19910726','LT05_002068_19980823','LT05_002068_19981229','LT05_002068_19860907','LT05_002068_19870214','LT05_002068_19950511','LT05_002068_19970921','LT05_002069_19870214','LT05_002069_19870724','LT05_002069_19871215','LT05_002069_19880304','LT05_002069_19880811','LT05_002069_19881030','LT05_002069_19931012','LT05_002069_19950425','LT05_002069_19950916','LT05_002069_19960529','LT05_002069_19960614','LT05_002069_19960902','LT05_002069_19961004','LT05_002069_19980212','LT05_002069_20001031','LT05_002070_19880726','LT05_002070_19880928','LT05_002070_19881030','LT05_002070_19951103','LT05_002070_19961004','LT05_002070_19980604','LT05_002070_19991114','LT05_002070_19991130','LT05_003067_19880818','LT05_003068_19861016','LT05_003068_19870426','LT05_003068_19870512','LT05_003068_19870613','LT05_003068_19910421','LT05_003068_19920626','LT05_003068_19960520','LT05_003068_19970710','LT05_003068_19970827','LT05_003068_20000209','LT05_003069_19850506','LT05_003069_19860829','LT05_003069_19900824','LT05_003069_19920626','LT05_003069_19961128','LT05_003069_19970624','LT05_003069_19970827','LT05_003069_19980118','LT05_003069_20001022','LT05_003069_20001022','LT05_003069_20001209','LT05_004062_19860719','LT05_004062_19860804','LT05_004062_19981109','LT05_004063_19860804','LT05_004063_19890828','LT05_004063_19990824','LT05_004063_20001013','LT05_004066_20000522','LT05_004067_19851020','LT05_004067_19860804','LT05_004067_19870519','LT05_004067_19870823','LT05_004067_19880622','LT05_004067_19960612','LT05_004067_19960815','LT05_004067_19961103','LT05_004067_19971106','LT05_004067_20001013','LT05_004068_19931010','LT05_004068_19941013','LT05_004068_20001013','LT05_004069_19871026','LT05_004069_19871111','LT05_004069_19881012','LT05_004069_19881113','LT05_004069_19881129','LT05_004069_19890609','LT05_004069_19910701','LT05_004069_19931010','LT05_004069_19941013','LT05_004069_19950525','LT05_004069_19951016','LT05_004069_19960612','LT05_004069_19961018','LT05_004069_19961103','LT05_004069_19970903','LT05_004069_19990213','LT05_004069_19991027','LT05_005062_19860811','LT05_005062_19870729','LT05_005062_19940716','LT05_005062_19960705','LT05_005062_19970606','LT05_005062_20001105','LT05_005063_19970622','LT05_005066_19870814','LT05_005066_19930830','LT05_005066_19970809','LT05_005067_19861030','LT05_005067_19881003','LT05_005067_19900923',
'LT05_005067_19930830','LT05_005067_19980406','LT05_005067_19980812','LT05_005067_19991018','LT05_005067_19991103','LT05_005068_19860912','LT05_005068_19861030','LT05_005068_19870830','LT05_005068_19870915','LT05_005068_19881003','LT05_005068_19920320','LT05_005068_19960619','LT05_005068_19961110','LT05_005068_19971012','LT05_005068_19971113','LT05_005068_19980812','LT05_005068_19991018','LT05_005068_19991103','LT05_005068_20000918','LT05_005069_19900331','LT05_005069_19900923','LT05_005069_19971113','LT05_005069_19980116','LT05_006062_19890607','LT05_006062_19890826','LT05_006062_20000909','LT05_006063_19950405','LT05_006063_19961117','LT05_006063_19970629','LT05_006063_20000824','LT05_006064_19900423','LT05_006064_19910205','LT05_006064_19950320','LT05_006065_19880924','LT05_006065_19910613','LT05_006065_19920107','LT05_006065_19950827','LT05_006065_19960813','LT05_006065_19970629','LT05_006065_19981006','LT05_006065_19990721','LT05_006066_19981006','LT05_006066_20001112','LT05_006067_19860903','LT05_006067_19871227','LT05_006067_19981006','LT05_006067_19990907','LT05_006067_19990923','LT05_006068_19861005','LT05_006068_20000504','LT05_007060_19990914','LT05_007061_19910401','LT05_007061_19971213','LT05_007061_20000831','LT05_007062_19860419','LT05_007062_19880103','LT05_007062_19901007','LT05_007062_19980810','LT05_007063_19850110','LT05_007063_19901007','LT05_007063_19940119','LT05_007063_19961124','LT05_007063_19990117','LT05_007064_19900804','LT05_007064_20001103','LT05_007065_19850907','LT05_007065_19860809','LT05_007065_19880307','LT05_007065_19881001','LT05_007065_19930929','LT05_007065_19970823','LT05_007065_19971010','LT05_007065_19990712','LT05_007065_19990914','LT05_007065_19990930','LT05_007065_19991016','LT05_007065_20001018','LT05_007066_19850907','LT05_007066_19860809','LT05_007066_19860910','LT05_007066_19880814','LT05_007066_19881001','LT05_007066_19881204','LT05_007066_19891121','LT05_007066_19921028','LT05_007066_19971010','LT05_007066_19981130','LT05_007066_20000527','LT05_007067_19870305','LT05_007067_19891121','LT05_007067_19900209','LT05_007067_19931015','LT05_008061_19950825','LT05_008061_20000806','LT05_008062_19880821','LT05_008062_19910526','LT05_008062_19950825','LT05_008062_19951231','LT05_008063_19931123','LT05_008063_19990209','LT05_008063_19990719','LT05_008064_19860426','LT05_008064_19871209','LT05_008064_19880517','LT05_008064_19880821','LT05_008064_19881211','LT05_008064_19891112','LT05_008064_19931123','LT05_008064_19941126','LT05_008064_19950926','LT05_008064_19960726','LT05_008064_19961201',
'LT05_008064_19971001','LT05_008064_19981121','LT05_008064_19991007','LT05_008064_20000502','LT05_008064_20000907','LT05_008065_19850306','LT05_008065_19860309','LT05_008065_19860426','LT05_008065_19871006','LT05_008065_19871209','LT05_008065_19880821','LT05_008065_19881024','LT05_008065_19881125','LT05_008065_19891112','LT05_008065_19900928','LT05_008065_19910526','LT05_008065_19911118','LT05_008065_19941126','LT05_008065_19950926','LT05_008065_19961115','LT05_008065_19970102','LT05_008065_19970118','LT05_008065_19970915','LT05_008065_19980427','LT05_008065_19980817','LT05_008065_19991007','LT05_008065_19991108','LT05_008065_19991210','LT05_008065_20000822','LT05_008065_20000907','LT05_008065_20001126','LT05_008066_19860426','LT05_008066_20001009','LT05_009062_19850124','LT05_009062_19860823','LT05_009062_19860924','LT05_009062_19870303','LT05_009062_19870522','LT05_009062_19871013','LT05_009062_19900207','LT05_009062_19910602','LT05_009062_19970906','LT05_009062_19970922','LT05_009062_19980808','LT05_009062_19980909','LT05_009062_19981230','LT05_009062_19990710','LT05_009062_19990726','LT05_009062_20001101','LT05_009063_19860823','LT05_009063_19861026','LT05_009063_19870623','LT05_009063_19870927','LT05_009063_19871013','LT05_009063_19940930','LT05_009063_19961021','LT05_009063_19970922','LT05_009063_19980808','LT05_009063_19980909','LT05_009063_19981230','LT05_009063_19991115','LT05_009063_20001016','LT05_009063_20001101','LT05_009064_19861026','LT05_009064_19880913','LT05_009064_19940930','LT05_009064_19970922','LT05_009064_19971024','LT05_009064_19980909','LT05_009064_19980925','LT05_009064_19981230','LT05_009064_19991115','LT05_009064_19991201','LT05_009064_20001101','LT05_009065_19980925','LT05_010063_19860203','LT05_010063_19961028','LT05_002070_19871012','LT05_003067_19870528','LT05_003067_19871003','LT05_003068_19980627','LT05_003069_19870816','LT05_003069_19901027','LT05_003069_19990902','LT05_003069_20000920','LT05_004069_20001013','LT05_005067_19870729','LT05_005067_19880715','LT05_005068_19850808','LT05_005068_19880410','LT05_005068_19900923','LT05_005068_19910505','LT05_005068_19910521','LT05_005068_19921014','LT05_005068_19970214','LT05_005068_19970708','LT05_005068_19980406','LT05_005069_19861014','LT05_005069_19861030','LT05_005069_19871118','LT05_005069_19891022','LT05_005069_19951007','LT05_005069_19980508','LT05_005069_19980913','LT05_005069_19981202','LT05_005069_20000918','LT05_006065_19970901','LT05_006066_19860514','LT05_006066_19861005','LT05_006066_19880823','LT05_006066_19881026','LT05_006066_19900930',
'LT05_006066_19960423','LT05_006066_19980208','LT05_006066_19991009','LT05_006066_20000504','LT05_006066_20000925','LT05_006067_19851002','LT05_006067_19861005','LT05_006067_19870704','LT05_006067_19871008','LT05_006067_19880503','LT05_006067_19880823','LT05_006067_19881026','LT05_006067_19890826','LT05_006067_19890911','LT05_006067_19900930','LT05_006067_19901219','LT05_006067_19910426','LT05_006067_19920802','LT05_006067_19960914','LT05_006067_19961117','LT05_006067_19980429','LT05_006067_19980718','LT05_006067_19980803','LT05_006067_19980904','LT05_006067_19990822','LT05_006067_19991009','LT05_006067_19991126','LT05_006067_19991228','LT05_006067_20000808','LT05_006067_20000824','LT05_006068_19860903','LT05_006068_19871008','LT05_006068_19871024','LT05_006068_19881026','LT05_006068_19910205','LT05_006068_19930922','LT05_006068_19940925','LT05_006068_19941112','LT05_006068_19961203','LT05_006068_19981006','LT05_006068_19990923','LT05_006068_19991009','LT05_006068_19991126','LT05_006068_19991126','LT05_006068_19991228','LT05_006068_20001112','LT05_007064_19990930','LT05_007065_19850806','LT05_007065_19860825','LT05_007065_19870812','LT05_007065_19930524','LT05_007065_19950514','LT05_007065_19970604','LT05_007065_19980607','LT05_007065_19980927','LT05_007065_19990610','LT05_007066_19860521','LT05_007066_19890513','LT05_007066_19890716','LT05_007066_19920910','LT05_007066_19930828','LT05_007066_19931015','LT05_007066_19941018','LT05_007066_19960820','LT05_007066_19961108','LT05_007066_19961226','LT05_007066_19970823','LT05_007066_19971111','LT05_007066_19980607','LT05_007066_19980709','LT05_007066_19980810','LT05_007066_19981013','LT05_007066_19990712','LT05_007066_19990914','LT05_007066_19990930','LT05_007066_19991016','LT05_007066_19991101','LT05_007066_20000104','LT05_007066_20000511','LT05_007066_20001002','LT05_007066_20001018','LT05_007067_19850907','LT05_007067_19860505','LT05_007067_19860910','LT05_007067_19880408','LT05_007067_19881001','LT05_007067_19890716','LT05_007067_19941018','LT05_007067_19971010','LT05_007067_19971026','LT05_007067_19981013','LT05_007067_19981216','LT05_007067_19990423','LT05_007067_19991016','LT05_007067_19991101','LT05_007067_20000831','LT05_007067_20001002','LT05_007067_20001018','LT05_008064_19871006','LT05_008064_19881125','LT05_008064_19940518','LT05_008064_19960827','LT05_008064_19960912','LT05_008064_19980902','LT05_008064_19991210','LT05_008064_20000212','LT05_008065_19860901','LT05_008065_19870208','LT05_008065_19880720','LT05_008065_19890504','LT05_008065_19900811','LT05_008065_19900912',
'LT05_008065_19910408','LT05_008065_19910424','LT05_008065_19930920','LT05_008065_19960912','LT05_008065_19981004','LT05_008065_19981121','LT05_008065_19990820','LT05_008065_20000502','LT05_008066_19860901','LT05_008066_19880517','LT05_008066_19900912','LT05_008066_19991007','LT05_008066_20000822','LT05_009062_19980707','LT05_009062_19991115','LT05_009063_19870522','LT05_009063_19900122','LT05_009063_19910602','LT05_009063_19950816','LT05_009063_19961005','LT05_009063_19970720','LT05_009063_19970906','LT05_009063_19971024','LT05_009063_19981128','LT05_009063_19990710','LT05_009063_19990726','LT05_009063_20000525','LT05_009064_19870826','LT05_009064_19871013','LT05_009064_19880609','LT05_009064_19900122','LT05_009064_19980808','LT05_009064_20000423','LT05_009064_20000728','LT05_009064_20000813','LT05_009064_20000930','LT05_010063_19981221','LT05_010064_19981221']).not())
var landsat7 = (ee.ImageCollection('LANDSAT/LE07/C01/T1_SR').select(Numero_de_banda.get('L7'), Nombre_de_banda)).filter(ee.Filter.eq('IMAGE_QUALITY' , 9)).filter(ee.Filter.inList('system:index', ['LE07_007065_19991227','LE07_007067_20000706','LE07_003068_20000726','LE07_003069_19991012','LE07_003069_20000827','LE07_004067_20000615','LE07_004067_20000701','LE07_004069_20000802','LE07_005067_20000708','LE07_006062_19991102','LE07_006067_20000613','LE07_007063_19991227','LE07_008066_20000729','LE07_009064_20001211','LE07_010063_20000727','LE07_010063_20001031']).not())
var landsat8 = (ee.ImageCollection('LANDSAT/LC08/C01/T1_SR').select(Numero_de_banda.get('L8'), Nombre_de_banda)).filter(ee.Filter.eq('IMAGE_QUALITY_OLI' , 9)).filter(ee.Filter.eq('IMAGE_QUALITY_TIRS' , 9))
var landsat = landsat5.merge(landsat7).merge(landsat8);
/////////////////////////////////////////////////////////
function reproyectar(image) {
image = image.reproject('EPSG:4326', null, 30)
return image.copyProperties(image,['system:time_start','system:time_end']);}
//////////////////////////
var Landsat_path_row =  landsat.filterBounds(region)
.filter(ee.Filter.or(ee.Filter.and(ee.Filter.eq('WRS_PATH', ee.Number.parse(pathh)),ee.Filter.eq('WRS_ROW', ee.Number.parse(roww)))))
.filterDate(Date_Start,Date_End).map(brdfCorrect)
var colNoClouds = (Landsat_path_row).map(reproyectar)
var imDate = ee.Date(date)
var befDate = imDate.advance(-1, 'day')
var aftDate = imDate.advance(1, 'day')
var selectedImage = colNoClouds.filterDate(befDate, aftDate).first()
//Map.add(loadPanel)  
////////////////////////////////////////////////////////
selectedImage.get('system:index').evaluate(function(obj) {
Map.layers().set(0, ui.Map.Layer(ee.Image(selectedImage), visParams, obj), obj);
app.inspector_intro2.widgets().set(0, ui.Label('ID DE LA IMAGEN: '+obj[4]+obj[5]+obj[6]+obj[7]+obj[8]+obj[9]+obj[10]+obj[11]+obj[12]+obj[13]+obj[14]+obj[15]+obj[16]+obj[17]+obj[18]+obj[19]+obj[20]+obj[21]+obj[22]+obj[23], {fontWeight: 'bold',color: 'blue', fontSize: '18px',margin: '20px 0 5px 25px'}))
Map.remove(loadPanel)})
return selectedImage}
//************************************************************
//************************************************************
var getInputsRegion = function(region) {
///////////////////////////
var Numero_de_banda =ee.Dictionary({L8: ee.List([1,2,3,4,5,6,7,10]), L7: ee.List([0,1,2,3,4,6,5,9]),L5: ee.List([0,1,2,3,4,6,5,9]),L4: ee.List([0,1,2,3,4,6,5,9])});
var Nombre_de_banda = ee.List(['blue','green','red','nir','swir1','swir2','temp','pixel_qa']);
var landsat5 = (ee.ImageCollection('LANDSAT/LT05/C01/T1_SR').select(Numero_de_banda.get('L5'), Nombre_de_banda)).filter(ee.Filter.eq('IMAGE_QUALITY' , 9))
.filter(ee.Filter.inList('system:index', ['LT05_003069_19910421','LT05_003069_19990918','LT05_002070_19861009','LT05_002069_19990404','LT05_002069_19991114','LT05_002069_19890830','LT05_002069_19960427','LT05_002069_19880912','LT05_002069_19950511','LT05_002069_19850702','LT05_003068_19930613','LT05_003068_19850709','LT05_003068_19880717','LT05_004068_19880825','LT05_003068_19970624','LT05_003068_19850709','LT05_003068_19910726','LT05_002068_19980823','LT05_002068_19981229','LT05_002068_19860907','LT05_002068_19870214','LT05_002068_19950511','LT05_002068_19970921','LT05_002069_19870214','LT05_002069_19870724','LT05_002069_19871215','LT05_002069_19880304','LT05_002069_19880811','LT05_002069_19881030','LT05_002069_19931012','LT05_002069_19950425','LT05_002069_19950916','LT05_002069_19960529','LT05_002069_19960614','LT05_002069_19960902','LT05_002069_19961004','LT05_002069_19980212','LT05_002069_20001031','LT05_002070_19880726','LT05_002070_19880928','LT05_002070_19881030','LT05_002070_19951103','LT05_002070_19961004','LT05_002070_19980604','LT05_002070_19991114','LT05_002070_19991130','LT05_003067_19880818','LT05_003068_19861016','LT05_003068_19870426','LT05_003068_19870512','LT05_003068_19870613','LT05_003068_19910421','LT05_003068_19920626','LT05_003068_19960520','LT05_003068_19970710','LT05_003068_19970827','LT05_003068_20000209','LT05_003069_19850506','LT05_003069_19860829','LT05_003069_19900824','LT05_003069_19920626','LT05_003069_19961128','LT05_003069_19970624','LT05_003069_19970827','LT05_003069_19980118','LT05_003069_20001022','LT05_003069_20001022','LT05_003069_20001209','LT05_004062_19860719','LT05_004062_19860804','LT05_004062_19981109','LT05_004063_19860804','LT05_004063_19890828','LT05_004063_19990824','LT05_004063_20001013','LT05_004066_20000522','LT05_004067_19851020','LT05_004067_19860804','LT05_004067_19870519','LT05_004067_19870823','LT05_004067_19880622','LT05_004067_19960612','LT05_004067_19960815','LT05_004067_19961103','LT05_004067_19971106','LT05_004067_20001013','LT05_004068_19931010','LT05_004068_19941013','LT05_004068_20001013','LT05_004069_19871026','LT05_004069_19871111','LT05_004069_19881012','LT05_004069_19881113','LT05_004069_19881129','LT05_004069_19890609','LT05_004069_19910701','LT05_004069_19931010','LT05_004069_19941013','LT05_004069_19950525','LT05_004069_19951016','LT05_004069_19960612','LT05_004069_19961018','LT05_004069_19961103','LT05_004069_19970903','LT05_004069_19990213','LT05_004069_19991027','LT05_005062_19860811','LT05_005062_19870729','LT05_005062_19940716','LT05_005062_19960705','LT05_005062_19970606','LT05_005062_20001105','LT05_005063_19970622','LT05_005066_19870814','LT05_005066_19930830','LT05_005066_19970809','LT05_005067_19861030','LT05_005067_19881003','LT05_005067_19900923',
'LT05_005067_19930830','LT05_005067_19980406','LT05_005067_19980812','LT05_005067_19991018','LT05_005067_19991103','LT05_005068_19860912','LT05_005068_19861030','LT05_005068_19870830','LT05_005068_19870915','LT05_005068_19881003','LT05_005068_19920320','LT05_005068_19960619','LT05_005068_19961110','LT05_005068_19971012','LT05_005068_19971113','LT05_005068_19980812','LT05_005068_19991018','LT05_005068_19991103','LT05_005068_20000918','LT05_005069_19900331','LT05_005069_19900923','LT05_005069_19971113','LT05_005069_19980116','LT05_006062_19890607','LT05_006062_19890826','LT05_006062_20000909','LT05_006063_19950405','LT05_006063_19961117','LT05_006063_19970629','LT05_006063_20000824','LT05_006064_19900423','LT05_006064_19910205','LT05_006064_19950320','LT05_006065_19880924','LT05_006065_19910613','LT05_006065_19920107','LT05_006065_19950827','LT05_006065_19960813','LT05_006065_19970629','LT05_006065_19981006','LT05_006065_19990721','LT05_006066_19981006','LT05_006066_20001112','LT05_006067_19860903','LT05_006067_19871227','LT05_006067_19981006','LT05_006067_19990907','LT05_006067_19990923','LT05_006068_19861005','LT05_006068_20000504','LT05_007060_19990914','LT05_007061_19910401','LT05_007061_19971213','LT05_007061_20000831','LT05_007062_19860419','LT05_007062_19880103','LT05_007062_19901007','LT05_007062_19980810','LT05_007063_19850110','LT05_007063_19901007','LT05_007063_19940119','LT05_007063_19961124','LT05_007063_19990117','LT05_007064_19900804','LT05_007064_20001103','LT05_007065_19850907','LT05_007065_19860809','LT05_007065_19880307','LT05_007065_19881001','LT05_007065_19930929','LT05_007065_19970823','LT05_007065_19971010','LT05_007065_19990712','LT05_007065_19990914','LT05_007065_19990930','LT05_007065_19991016','LT05_007065_20001018','LT05_007066_19850907','LT05_007066_19860809','LT05_007066_19860910','LT05_007066_19880814','LT05_007066_19881001','LT05_007066_19881204','LT05_007066_19891121','LT05_007066_19921028','LT05_007066_19971010','LT05_007066_19981130','LT05_007066_20000527','LT05_007067_19870305','LT05_007067_19891121','LT05_007067_19900209','LT05_007067_19931015','LT05_008061_19950825','LT05_008061_20000806','LT05_008062_19880821','LT05_008062_19910526','LT05_008062_19950825','LT05_008062_19951231','LT05_008063_19931123','LT05_008063_19990209','LT05_008063_19990719','LT05_008064_19860426','LT05_008064_19871209','LT05_008064_19880517','LT05_008064_19880821','LT05_008064_19881211','LT05_008064_19891112','LT05_008064_19931123','LT05_008064_19941126','LT05_008064_19950926','LT05_008064_19960726','LT05_008064_19961201',
'LT05_008064_19971001','LT05_008064_19981121','LT05_008064_19991007','LT05_008064_20000502','LT05_008064_20000907','LT05_008065_19850306','LT05_008065_19860309','LT05_008065_19860426','LT05_008065_19871006','LT05_008065_19871209','LT05_008065_19880821','LT05_008065_19881024','LT05_008065_19881125','LT05_008065_19891112','LT05_008065_19900928','LT05_008065_19910526','LT05_008065_19911118','LT05_008065_19941126','LT05_008065_19950926','LT05_008065_19961115','LT05_008065_19970102','LT05_008065_19970118','LT05_008065_19970915','LT05_008065_19980427','LT05_008065_19980817','LT05_008065_19991007','LT05_008065_19991108','LT05_008065_19991210','LT05_008065_20000822','LT05_008065_20000907','LT05_008065_20001126','LT05_008066_19860426','LT05_008066_20001009','LT05_009062_19850124','LT05_009062_19860823','LT05_009062_19860924','LT05_009062_19870303','LT05_009062_19870522','LT05_009062_19871013','LT05_009062_19900207','LT05_009062_19910602','LT05_009062_19970906','LT05_009062_19970922','LT05_009062_19980808','LT05_009062_19980909','LT05_009062_19981230','LT05_009062_19990710','LT05_009062_19990726','LT05_009062_20001101','LT05_009063_19860823','LT05_009063_19861026','LT05_009063_19870623','LT05_009063_19870927','LT05_009063_19871013','LT05_009063_19940930','LT05_009063_19961021','LT05_009063_19970922','LT05_009063_19980808','LT05_009063_19980909','LT05_009063_19981230','LT05_009063_19991115','LT05_009063_20001016','LT05_009063_20001101','LT05_009064_19861026','LT05_009064_19880913','LT05_009064_19940930','LT05_009064_19970922','LT05_009064_19971024','LT05_009064_19980909','LT05_009064_19980925','LT05_009064_19981230','LT05_009064_19991115','LT05_009064_19991201','LT05_009064_20001101','LT05_009065_19980925','LT05_010063_19860203','LT05_010063_19961028','LT05_002070_19871012','LT05_003067_19870528','LT05_003067_19871003','LT05_003068_19980627','LT05_003069_19870816','LT05_003069_19901027','LT05_003069_19990902','LT05_003069_20000920','LT05_004069_20001013','LT05_005067_19870729','LT05_005067_19880715','LT05_005068_19850808','LT05_005068_19880410','LT05_005068_19900923','LT05_005068_19910505','LT05_005068_19910521','LT05_005068_19921014','LT05_005068_19970214','LT05_005068_19970708','LT05_005068_19980406','LT05_005069_19861014','LT05_005069_19861030','LT05_005069_19871118','LT05_005069_19891022','LT05_005069_19951007','LT05_005069_19980508','LT05_005069_19980913','LT05_005069_19981202','LT05_005069_20000918','LT05_006065_19970901','LT05_006066_19860514','LT05_006066_19861005','LT05_006066_19880823','LT05_006066_19881026','LT05_006066_19900930',
'LT05_006066_19960423','LT05_006066_19980208','LT05_006066_19991009','LT05_006066_20000504','LT05_006066_20000925','LT05_006067_19851002','LT05_006067_19861005','LT05_006067_19870704','LT05_006067_19871008','LT05_006067_19880503','LT05_006067_19880823','LT05_006067_19881026','LT05_006067_19890826','LT05_006067_19890911','LT05_006067_19900930','LT05_006067_19901219','LT05_006067_19910426','LT05_006067_19920802','LT05_006067_19960914','LT05_006067_19961117','LT05_006067_19980429','LT05_006067_19980718','LT05_006067_19980803','LT05_006067_19980904','LT05_006067_19990822','LT05_006067_19991009','LT05_006067_19991126','LT05_006067_19991228','LT05_006067_20000808','LT05_006067_20000824','LT05_006068_19860903','LT05_006068_19871008','LT05_006068_19871024','LT05_006068_19881026','LT05_006068_19910205','LT05_006068_19930922','LT05_006068_19940925','LT05_006068_19941112','LT05_006068_19961203','LT05_006068_19981006','LT05_006068_19990923','LT05_006068_19991009','LT05_006068_19991126','LT05_006068_19991126','LT05_006068_19991228','LT05_006068_20001112','LT05_007064_19990930','LT05_007065_19850806','LT05_007065_19860825','LT05_007065_19870812','LT05_007065_19930524','LT05_007065_19950514','LT05_007065_19970604','LT05_007065_19980607','LT05_007065_19980927','LT05_007065_19990610','LT05_007066_19860521','LT05_007066_19890513','LT05_007066_19890716','LT05_007066_19920910','LT05_007066_19930828','LT05_007066_19931015','LT05_007066_19941018','LT05_007066_19960820','LT05_007066_19961108','LT05_007066_19961226','LT05_007066_19970823','LT05_007066_19971111','LT05_007066_19980607','LT05_007066_19980709','LT05_007066_19980810','LT05_007066_19981013','LT05_007066_19990712','LT05_007066_19990914','LT05_007066_19990930','LT05_007066_19991016','LT05_007066_19991101','LT05_007066_20000104','LT05_007066_20000511','LT05_007066_20001002','LT05_007066_20001018','LT05_007067_19850907','LT05_007067_19860505','LT05_007067_19860910','LT05_007067_19880408','LT05_007067_19881001','LT05_007067_19890716','LT05_007067_19941018','LT05_007067_19971010','LT05_007067_19971026','LT05_007067_19981013','LT05_007067_19981216','LT05_007067_19990423','LT05_007067_19991016','LT05_007067_19991101','LT05_007067_20000831','LT05_007067_20001002','LT05_007067_20001018','LT05_008064_19871006','LT05_008064_19881125','LT05_008064_19940518','LT05_008064_19960827','LT05_008064_19960912','LT05_008064_19980902','LT05_008064_19991210','LT05_008064_20000212','LT05_008065_19860901','LT05_008065_19870208','LT05_008065_19880720','LT05_008065_19890504','LT05_008065_19900811','LT05_008065_19900912',
'LT05_008065_19910408','LT05_008065_19910424','LT05_008065_19930920','LT05_008065_19960912','LT05_008065_19981004','LT05_008065_19981121','LT05_008065_19990820','LT05_008065_20000502','LT05_008066_19860901','LT05_008066_19880517','LT05_008066_19900912','LT05_008066_19991007','LT05_008066_20000822','LT05_009062_19980707','LT05_009062_19991115','LT05_009063_19870522','LT05_009063_19900122','LT05_009063_19910602','LT05_009063_19950816','LT05_009063_19961005','LT05_009063_19970720','LT05_009063_19970906','LT05_009063_19971024','LT05_009063_19981128','LT05_009063_19990710','LT05_009063_19990726','LT05_009063_20000525','LT05_009064_19870826','LT05_009064_19871013','LT05_009064_19880609','LT05_009064_19900122','LT05_009064_19980808','LT05_009064_20000423','LT05_009064_20000728','LT05_009064_20000813','LT05_009064_20000930','LT05_010063_19981221','LT05_010064_19981221']).not())
var landsat7 = (ee.ImageCollection('LANDSAT/LE07/C01/T1_SR').select(Numero_de_banda.get('L7'), Nombre_de_banda)).filter(ee.Filter.eq('IMAGE_QUALITY' , 9)).filter(ee.Filter.inList('system:index', ['LE07_007065_19991227','LE07_007067_20000706','LE07_003068_20000726','LE07_003069_19991012','LE07_003069_20000827','LE07_004067_20000615','LE07_004067_20000701','LE07_004069_20000802','LE07_005067_20000708','LE07_006062_19991102','LE07_006067_20000613','LE07_007063_19991227','LE07_008066_20000729','LE07_009064_20001211','LE07_010063_20000727','LE07_010063_20001031']).not())
var landsat8 = (ee.ImageCollection('LANDSAT/LC08/C01/T1_SR').select(Numero_de_banda.get('L8'), Nombre_de_banda)).filter(ee.Filter.eq('IMAGE_QUALITY_OLI' , 9)).filter(ee.Filter.eq('IMAGE_QUALITY_TIRS' , 9))
var landsat = landsat5.merge(landsat7).merge(landsat8);
//////////////////////////
function sombraynube(image) {
var cloudShadowBitMask = ee.Number(2).pow(3).int();
var cloudsBitMask = ee.Number(2).pow(5).int();
var qa = image.select('pixel_qa');
//var cloud_buffer=300;
var mask = 
    (qa.bitwiseAnd(cloudShadowBitMask).eq(0).and(qa.bitwiseAnd(cloudsBitMask).eq(0)))
.and(image.select('blue').gt(0)).and(image.select('green').gt(0)).and(image.select('red').gt(0))
.and(image.select('nir').gt(0)).and(image.select('swir1').gt(0)).and(image.select('swir2').gt(0))
.and(image.select('blue').lt(10000)).and(image.select('green').lt(10000)).and(image.select('red').lt(10000))
.and(image.select('nir').lt(10000)).and(image.select('swir1').lt(10000)).and(image.select('swir2').lt(10000))
//.focal_min(cloud_buffer,'circle','meters',1);
return image.updateMask(mask).divide(10000).copyProperties(image,['system:time_start','system:time_end']);}
//////////////////////////
/////////////////////////////////////////////////////////
var INDEFO = function(image) {
var banda2 = image.expression('(((nir-red)/(nir+red))-((nir-swir1)/(swir1+nir)))/(((nir-red)/(nir+red))+((nir-swir1)/(swir1+nir)))', {'blue':image.select('blue'),'red':image.select('red'),'green':image.select('green'),'nir':image.select('nir'),'swir1':image.select('swir1'),'swir2':image.select('swir2')}).rename('INDEFO');
return image.addBands(banda2).copyProperties(image,['system:time_start','system:time_end']);};
/////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////
function reproyectar(image) {
image = image.reproject('EPSG:4326', null, 30)
return image.copyProperties(image,['system:time_start','system:time_end']);}
//////////////////////////
var Landsat_path_row =  landsat.filterBounds(region)
.filter(ee.Filter.or(ee.Filter.and(ee.Filter.eq('WRS_PATH', ee.Number.parse(pathh)),ee.Filter.eq('WRS_ROW', ee.Number.parse(roww)))))
.filterDate(Date_Start,Date_End).map(brdfCorrect).map(sombraynube).map(INDEFO)
var colNoClouds = Landsat_path_row.map(reproyectar)
return colNoClouds}  
//************************************************************
/////////////////////////////////////////////////////////
var makeImagePlot = function(iCol, region, bandName, position, ptcolor, longName){
var yminNew = ee.Image(iCol.min()).reduceRegion({reducer: ee.Reducer.mean(),geometry: region,scale: 5})
var ymaxNew = ee.Image(iCol.max()).reduceRegion({reducer: ee.Reducer.mean(),geometry: region,scale: 5})
/////////////////////////////////////////////////////////
var timeSeriesDisplay = {title: 'SERIE DE TIEMPO',fontSize: 14,curveType: 'function',format: 'short',hAxis: {'title': 'Tiempo',format: 'MM-yyyy',textStyle: {fontSize: 12,color: 'black'}, gridlines: {color: 'black'}},vAxis: {'title': bandName, viewWindow: {min: 0.65, max: 20},textStyle: {fontSize: 12,color: 'black'}, gridlines: {color: 'black'}},colors: [ptcolor],pointSize: 2,lineWidth: 0}//,backgroundColor:'#ffdc5e'
/////////////////////////////////////////////////////////
var chart = ui.Chart.image.series(ee.ImageCollection(iCol).select(bandName), region, ee.Reducer.mean(),10).setOptions(timeSeriesDisplay)
chart.onClick(function(coords) {getImageRegion(ee.Feature(region).geometry(), coords)});
panel.widgets().set(position, chart)
}
/////////////////////////////////////////////////////////
var updateImage = function(viz) {var im = Map.layers().get(0)
im.setVisParams(viz)}
/////////////////////////////////////////////////////////
var notSaved = function(pgeo){
//panel.clear();
//panel.widgets().set(3, resetButton);
panel.widgets().set(5, select_stretch);}
/////////////////////////////////////////////////////////
Map.onClick(function(coords) {
panel.clear()
var pgeo = ee.Geometry.Point([coords.lon, coords.lat]);
cur_point = pgeo
var location = 'Coordenada del Pixel'+'  ---->  '+ '[  '+   'Longitud: ' + coords.lon.toFixed(2) + '  '+'   y   ' + 'Latitud: ' + coords.lat.toFixed(2)+'  ]'
panel.widgets().set(1, ui.Label('Serie de Tiempo del Indice INDEFO', {fontWeight: 'bold',color: 'blue', fontSize: '18px',margin: '20px 0 5px 110px'}))
panel.widgets().set(2, ui.Label(location, {fontWeight: 'bold', fontSize: '14px',margin: '20px 0 10px 55px'}))
panel.widgets().set(3,ui.Label({value: '__________________________________________________',style: {fontSize: '20px',margin: '0px 0px 0px 0px',color: 'black',textAlign: 'center'}}));
panel.widgets().set(4,ui.Label({value: '* Seleccione un Punto de la Imagen Landsat.',style: {fontSize: '12px',margin: '20px 0px 0px 8px',color: 'black',textAlign: 'center'}}));
//panel.widgets().set(3, resetButton)
panel.widgets().set(5, select_stretch)
//panel.widgets().set(6,ui.Label({value: '* Seleccione un Punto de la Serie Fenologia y eliga la combinación de bandas .',style: {fontSize: '14px',margin: '0px 0px 0px 10px',color: 'black',textAlign: 'center'}}));
var s2Data = getInputsRegion(pgeo)
//print(s2Data)
var point = ee.Geometry.Point(coords.lon, coords.lat);
var pointOutline = point.buffer(10).bounds()
refresh_layers(ee.Feature(pointOutline))
makeImagePlot(s2Data, pgeo, 'INDEFO', 6, '#FF2D00', 'INDEFO');});
/////////////////////////////////////////////////////////
var selectedIndex = 0;
var visParams   = {bands: ['swir2', 'nir', 'red'] , min: [100, 500, 300], max: [2000, 6000, 2500]};
var stretch_432 = {bands: ['red', 'green', 'blue'], min: [300, 100, 0], max: [2500, 2500, 2300], gamma: 1.3};
var stretch_843 = {bands: ['swir2', 'nir', 'red'] , min: [100, 500, 300], max: [2000, 6000, 2500]};
//var paleta_NBR2 = {min: 0,max: 1,palette: ['FFFFFF','CE7E45','DF923D','F1B555','FCD163','99B718','74A901','66A000','529400','3E8601','207401','056201','004C00','023B01','012E01','011D01','011301']};
var stretch_NBR2 = {bands: ['INDEFO'] , min: 0,max: 1,palette: ['FFFFFF','CE7E45','DF923D','F1B555','FCD163','99B718','74A901','66A000','529400','3E8601','207401','056201','004C00','023B01','012E01','011D01','011301']};
var stretches = {'Color': stretch_432,'Falso Color': stretch_843,'INDEFO': stretch_NBR2};
var select_stretch = ui.Select({items: Object.keys(stretches),onChange: function(key) {visParams = stretches[key];
if (IMAGEADDED = true) {updateImage(visParams)}}});
select_stretch.setPlaceholder('Combinacion de Bandas');
/////////////////////////////////////////////////////////
var resetButton = ui.Button({label: 'Resetear Visor',onClick: function() {
Map.layers().reset();
Map.setOptions('SATELLITE');}});
/////////////////////////////////////////////////////////
//var panel = ui.Panel({style: {width: '450px'}}).add(ui.Label('Serie de Tiempo', {fontWeight: 'bold', fontSize: '18px'}))
var inspector = ui.Panel({style: {shown: false, width: '200px'}});
inspector.style().set({position: 'bottom-left'});
Map.add(inspector);
Map.style().set('cursor', 'crosshair');
Map.setOptions('SATELLITE');
var loadPanel = ui.Panel({style: {position: 'bottom-left', width: '250px', shown: true}});
loadPanel.add(ui.Label('Cargando la imágen Landsat...'))
ui.root.add(panel)
var lon = ui.Label();
var lat = ui.Label();
Map.onClick(function(coords) {
  app.inspector.clear();
  app.export.clear();
  app.inspector.widgets().set(0, ui.Label({value: 'Espere...',style: {color: 'gray'}}));
var click_point = ee.Geometry.Point(coords.lon, coords.lat); 
var dot = ui.Map.Layer(click_point, {color: 'FF0000'},'Punto de Análisis'); 
//Map.layers().set(7, dot);
app.inspector.widgets().set(0, ui.Label({value: ['Latitud : ' + coords.lat.toFixed(3) +' y'+' Longitud : ' + coords.lon.toFixed(3)],
style:{margin: '8px 0 -3px 45px',fontSize: '13px',fontWeight: 'bold',width:'250px',color: 'blue'}}));
    var urlpoint=ee.FeatureCollection(click_point).getDownloadURL('kml', 0, 'test.kml');
    app.export.widgets().set(0, ui.Label({value: 'Point download URL:',style:app.HELP_TEXT_STYLE}));
    app.export.widgets().set(1, ui.Label({value: urlpoint,style:app.URL_TEXT_STYLE}));});
///////////////////FUNCTIONS///////////////////////////////////////////////////////////
///////////////////IG//////////////////////////////////////////////////////////////////
  function removeLayer(name) {var layers = Map.layers();var names = [];layers.forEach(function(lay) {var lay_name = lay.getName();names.push(lay_name);});var index = names.indexOf(name);if (index > -1) {var layer = layers.get(index);Map.remove(layer);} else {print('Layer '+name+' not found');}}
  function formatDate(date){return ee.Date(date).format('YYYY-MM-dd');}
  function setDate(imagen){return imagen.set('system:time_start',ee.Date(imagen.get('system:time_start')).format('YYYY-MM-dd'));}
}
var palettes = require('users/gena/packages:palettes');
var palette2 = palettes.crameri.roma[10];
var palette = palettes.misc.jet[7].reverse();
var Paleta = {min: 0, max: 0.8, palette:palette };
var Paleta2 = {min: -0.5, max: 0.5, palette:palette2 };
function displayerS2(imagen,d1,d2) {Map.addLayer(imagen,{'bands':["B4","B3","B2"],min: '0, 0, 0', max: '3000, 3000, 3000'},'Imagen a Color',false);}//'Sentinel 2 from '+d1+' to '+d2,true
function displayerS2infra(imagen,d1,d2) {Map.addLayer(imagen,{'bands':["B8","B4","B3"],min: '0, 0, 0', max: '5000, 5000, 5000'},'Imagen Infrarrojo Color',false);}//'Sentinel 2 from '+d1+' to '+d2,true
function displayerS2NBR2(imagen,d1,d2) {Map.addLayer(imagen.select(["INDEFO"]).sldStyle(Paleta),{},'Clasificación',true);}//'Sentinel 2 from '+d1+' to '+d2,true
 app.boot = function() {
  app.createConstants();
  app.createPanels();
  var main = ui.Panel({widgets: [app.logo.panel,app.intro.panel,app.filters.panel,app.inspector_intro,app.inspector_intro2,], style: {width: '420px', padding: '4px',border: '2px solid black'}});
Map.style().set('cursor', 'crosshair');
  ui.root.insert(0, main);
  var scountry=ee.FeatureCollection(app.Departamento).filter(ee.Filter.eq('CUADRANTE', app.SelectedDepartamento));
  Map.centerObject(scountry,5);
  //app.refreshPlace();
};
Map.setOptions("HYBRID")
//Map.setOptions('Dark', MAP_STYLES)
app.boot();
// ************** MODELO BRDF  **************
// D.P. Roy, H.K. Zhang, J. Ju, J.L. Gomez-Dans, P.E. Lewis, C.B. Schaaf, Q. Sun, J. Li, H. Huang, V. Kovalskyy, A general method to normalize Landsat reflectance data to nadir BRDF adjusted reflectance, Remote Sensing of Environment, Volume 176, April 2016, Pages 255-271
    function brdfCorrect(image) {
      var inputBandNames = image.bandNames() 
      var constants = {
        pi: Math.PI
      }
      var coefficientsByBand = {
        'blue': {fiso: 0.0774, fgeo: 0.0079, fvol: 0.0372},
        'green': {fiso: 0.1306, fgeo: 0.0178, fvol: 0.0580},
        'red': {fiso: 0.1690, fgeo: 0.0227, fvol: 0.0574},
        'nir': {fiso: 0.3093, fgeo: 0.0330, fvol: 0.1535},
        'swir1': {fiso: 0.3430, fgeo: 0.0453, fvol: 0.1154},
        'swir2': {fiso: 0.2658, fgeo: 0.0387, fvol: 0.0639}
      }
      var corners = findCorners()
      viewAngles()
      solarPosition()
      sunZenOut()
      set('relativeSunViewAz', 'i.sunAz - i.viewAz')
      rossThick('kvol', 'i.sunZen', 'i.viewZen', 'i.relativeSunViewAz')
      rossThick('kvol0', 'i.sunZenOut', 0, 0)
      liThin('kgeo', 'i.sunZen', 'i.viewZen', 'i.relativeSunViewAz')
      liThin('kgeo0', 'i.sunZenOut', 0, 0)
      adjustBands()
      return image.select(inputBandNames)
      function viewAngles() {
        var maxDistanceToSceneEdge = 1000000
        var maxSatelliteZenith = 9.5
        var upperCenter = pointBetween(corners.upperLeft, corners.upperRight)
        var lowerCenter = pointBetween(corners.lowerLeft, corners.lowerRight)
        var slope = slopeBetween(lowerCenter, upperCenter)
        var slopePerp = ee.Number(-1).divide(slope)
        set('viewAz',
          ee.Image(ee.Number(Math.PI / 2).subtract((slopePerp).atan())))
        var leftLine = toLine(corners.upperLeft, corners.lowerLeft)
        var rightLine = toLine(corners.upperRight, corners.lowerRight)
        var leftDistance = ee.FeatureCollection(leftLine).distance(maxDistanceToSceneEdge)
        var rightDistance = ee.FeatureCollection(rightLine).distance(maxDistanceToSceneEdge)
        var viewZenith = rightDistance.multiply(maxSatelliteZenith * 2)
          .divide(rightDistance.add(leftDistance))
          .subtract(maxSatelliteZenith)
        set('viewZen',
          viewZenith.multiply(Math.PI).divide(180))
      }
      function solarPosition() {
        // Ported from http://pythonfmask.org/en/latest/_modules/fmask/landsatangles.html
        var date = ee.Date(ee.Number(image.get('system:time_start')))
        var secondsInHour = 3600
        set('longDeg',
          ee.Image.pixelLonLat().select('longitude'))
        set('latRad',
          ee.Image.pixelLonLat().select('latitude')
            .multiply(Math.PI).divide(180))
        set('hourGMT',
          ee.Number(date.getRelative('second', 'day')).divide(secondsInHour))
        set('jdp', // Julian Date Proportion
          date.getFraction('year'))
        set('jdpr', // Julian Date Proportion in Radians
          'i.jdp * 2 * {pi}')
        set('meanSolarTime',
          'i.hourGMT + i.longDeg / 15')
        set('localSolarDiff',
          '(0.000075 + 0.001868 * cos(i.jdpr) - 0.032077 * sin(i.jdpr)' +
          '- 0.014615 * cos(2 * i.jdpr) - 0.040849 * sin(2 * i.jdpr))' +
          '* 12 * 60 / {pi}')
        set('trueSolarTime',
          'i.meanSolarTime + i.localSolarDiff / 60 - 12')
        set('angleHour',
          'i.trueSolarTime * 15 * {pi} / 180')
        set('delta',
          '0.006918 - 0.399912 * cos(i.jdpr) + 0.070257 * sin(i.jdpr) - 0.006758 * cos(2 * i.jdpr)' +
          '+ 0.000907 * sin(2 * i.jdpr) - 0.002697 * cos(3 * i.jdpr) + 0.001480 * sin(3 * i.jdpr)')
        set('cosSunZen',
          'sin(i.latRad) * sin(i.delta) ' +
          '+ cos(i.latRad) * cos(i.delta) * cos(i.angleHour)')
        set('sunZen',
          'acos(i.cosSunZen)')
        set('sinSunAzSW',
          toImage('cos(i.delta) * sin(i.angleHour) / sin(i.sunZen)')
            .clamp(-1, 1))
        set('cosSunAzSW',
          '(-cos(i.latRad) * sin(i.delta)' +
          '+ sin(i.latRad) * cos(i.delta) * cos(i.angleHour)) / sin(i.sunZen)')
        set('sunAzSW',
          'asin(i.sinSunAzSW)')
        setIf('sunAzSW',
          'i.cosSunAzSW <= 0',
          '{pi} - i.sunAzSW',
          'sunAzSW')
        setIf('sunAzSW',
          'i.cosSunAzSW > 0 and i.sinSunAzSW <= 0',
          '2 * {pi} + i.sunAzSW',
          'sunAzSW')
        set('sunAz',
          'i.sunAzSW + {pi}')
        setIf('sunAz',
          'i.sunAz > 2 * {pi}',
          'i.sunAz - 2 * {pi}',
          'sunAz')
      }
      function sunZenOut() {
        // https://nex.nasa.gov/nex/static/media/publication/HLS.v1.0.UserGuide.pdf
        set('centerLat',
          ee.Number(
            ee.Geometry(image.get('system:footprint'))
              .bounds().centroid(30).coordinates().get(0))
            .multiply(Math.PI).divide(180))
        set('sunZenOut',
          '(31.0076' +
          '- 0.1272 * i.centerLat' +
          '+ 0.01187 * pow(i.centerLat, 2)' +
          '+ 2.40E-05 * pow(i.centerLat, 3)' +
          '- 9.48E-07 * pow(i.centerLat, 4)' +
          '- 1.95E-09 * pow(i.centerLat, 5)' +
          '+ 6.15E-11 * pow(i.centerLat, 6)) * {pi}/180')
      }
      function rossThick(bandName, sunZen, viewZen, relativeSunViewAz) {
        var args = {sunZen: sunZen, viewZen: viewZen, relativeSunViewAz: relativeSunViewAz}
        cosPhaseAngle('cosPhaseAngle', sunZen, viewZen, relativeSunViewAz)
        set('phaseAngle',
          'acos(i.cosPhaseAngle)')
        set(bandName,
          '(({pi}/2 - i.phaseAngle) * i.cosPhaseAngle + sin(i.phaseAngle)) ' +
          '/ (cos({sunZen}) + cos({viewZen})) - {pi}/4', args)
      }
      function liThin(bandName, sunZen, viewZen, relativeSunViewAz) {
        // From https://modis.gsfc.nasa.gov/data/atbd/atbd_mod09.pdf
        var args = {
          sunZen: sunZen,
          viewZen: viewZen,
          relativeSunViewAz: relativeSunViewAz,
          'h/b': 2,
        }
        anglePrime('sunZenPrime', sunZen)
        anglePrime('viewZenPrime', viewZen)
        cosPhaseAngle('cosPhaseAnglePrime', 'i.sunZenPrime', 'i.viewZenPrime', relativeSunViewAz)
        set('distance',
          'sqrt(pow(tan(i.sunZenPrime), 2) + pow(tan(i.viewZenPrime), 2)' +
          '- 2 * tan(i.sunZenPrime) * tan(i.viewZenPrime) * cos({relativeSunViewAz}))', args)
        set('temp',
          '1/cos(i.sunZenPrime) + 1/cos(i.viewZenPrime)')
        set('cosT',
          toImage('{h/b} * sqrt(pow(i.distance, 2) + pow(tan(i.sunZenPrime) * tan(i.viewZenPrime) * sin({relativeSunViewAz}), 2))' +
            '/ i.temp', args)
            .clamp(-1, 1))
        set('t', 'acos(i.cosT)')
        set('overlap',
          '(1/{pi}) * (i.t - sin(i.t) * i.cosT) * (i.temp)')
        setIf('overlap', 'i.overlap > 0', 0)
        set(bandName,
          'i.overlap - i.temp' +
          '+ (1/2) * (1 + i.cosPhaseAnglePrime) * (1/cos(i.sunZenPrime)) * (1/cos(i.viewZenPrime))')
      }
      function anglePrime(name, angle) {
        var args = {'b/r': 1, angle: angle}
        set('tanAnglePrime',
          '{b/r} * tan({angle})', args)
        setIf('tanAnglePrime', 'i.tanAnglePrime < 0', 0)
        set(name,
          'atan(i.tanAnglePrime)')
      }
      function cosPhaseAngle(name, sunZen, viewZen, relativeSunViewAz) {
        var args = {
          sunZen: sunZen,
          viewZen: viewZen,
          relativeSunViewAz: relativeSunViewAz
        }
        set(name,
          toImage('cos({sunZen}) * cos({viewZen})' +
            '+ sin({sunZen}) * sin({viewZen}) * cos({relativeSunViewAz})', args)
            .clamp(-1, 1))
      }
      function adjustBands() {
        for (var bandName in coefficientsByBand)
          applyCFactor(bandName, coefficientsByBand[bandName])
      }
      function applyCFactor(bandName, coefficients) {
        brdf('brdf', 'kvol', 'kgeo', coefficients)
        brdf('brdf0', 'kvol0', 'kgeo0', coefficients)
        set('cFactor',
          'i.brdf0 / i.brdf', coefficients)
        set(bandName,
          '{bandName} * i.cFactor', {bandName: 'i.' + bandName})
      }
      function brdf(bandName, kvolBand, kgeoBand, coefficients) {
        var args = merge(coefficients, {
          // kvol: 'i.' + kvolBand,
          kvol: '3 * i.' + kvolBand,     // check this multiplication factor.  Is there an 'optimal' value?  Without a factor here, there is not enough correction.
          kgeo: 'i.' + kgeoBand
        })
        return set(bandName,
          '{fiso} + {fvol} * {kvol} + {fgeo} * {kvol}', args)
      }
      function findCorners() {
        var footprint = ee.Geometry(image.get('system:footprint'))
        var bounds = ee.List(footprint.bounds().coordinates().get(0))
        var coords = footprint.coordinates()
        var xs = coords.map(function (item) {
          return x(item)
        })
        var ys = coords.map(function (item) {
          return y(item)
        })
        function findCorner(targetValue, values) {
          var diff = values.map(function (value) {
            return ee.Number(value).subtract(targetValue).abs()
          })
          var minValue = diff.reduce(ee.Reducer.min())
          var idx = diff.indexOf(minValue)
          return coords.get(idx)
        }
        var lowerLeft = findCorner(x(bounds.get(0)), xs)
        var lowerRight = findCorner(y(bounds.get(1)), ys)
        var upperRight = findCorner(x(bounds.get(2)), xs)
        var upperLeft = findCorner(y(bounds.get(3)), ys)
        return {
          upperLeft: upperLeft,
          upperRight: upperRight,
          lowerRight: lowerRight,
          lowerLeft: lowerLeft
        }
      }
      function x(point) {
        return ee.Number(ee.List(point).get(0))
      }
      function y(point) {
        return ee.Number(ee.List(point).get(1))
      }
      function pointBetween(pointA, pointB) {
        return ee.Geometry.LineString([pointA, pointB]).centroid().coordinates()
      }
      function slopeBetween(pointA, pointB) {
        return ((y(pointA)).subtract(y(pointB))).divide((x(pointA)).subtract(x(pointB)))
      }
      function toLine(pointA, pointB) {
        return ee.Geometry.LineString([pointA, pointB])
      }
// ************** COMMON HELPERS **************
      function set(name, toAdd, args) {
        toAdd = toImage(toAdd, args)
        image = image.addBands(toAdd.rename(name), null, true)
      }
      function setIf(name, condition, trueValue, falseValue) {
        condition = toImage(condition)
        var trueMasked = toImage(trueValue).mask(toImage(condition))
        var falseMasked = toImage(falseValue).mask(invertMask(condition))
        var value = trueMasked.unmask(falseMasked)
        set(name, value)
        function invertMask(mask) {
          return mask.multiply(-1).add(1)
        }
      }
      function toImage(band, args) {
        if ((typeof band) === 'string') {
          if (band.indexOf('.') > -1 || band.indexOf(' ') > -1 || band.indexOf('{') > -1) {
            band = image.expression(format(band, args), {i: image})
          } else
            band = image.select(band)
        }
        return ee.Image(band)
      }
      function format(s, args) {
        if (!args) args = {}
        var allArgs = merge(constants, args)
        var result = s.replace(/{([^{}]*)}/g,
          function (a, b) {
            var replacement = allArgs[b]
            if (replacement == null) {
              print('Undeclared argument: ' + b, 's: ' + s, args)
              return null
            }
            return allArgs[b]
          }
        )
        if (result.indexOf('{') > -1)
          return format(result, args)
        return result
      }
      function merge(o1, o2) {
        function addAll(target, toAdd) {
          for (var key in toAdd) target[key] = toAdd[key]
        }
        var result = {}
        addAll(result, o1)
        addAll(result, o2)
        return result
      }
      function show(band, min, max) {
        Map.addLayer(toImage(band), {min: min ? min : -1, max: max ? max : 1}, band)
      }
    }