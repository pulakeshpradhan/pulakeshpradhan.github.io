var Amazon = ui.import && ui.import("Amazon", "geometry", {
      "geometries": [
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                -66.725694397348,
                -2.3441159796655406
              ],
              [
                -66.725694397348,
                -4.23056924112859
              ],
              [
                -65.5995957645355,
                -4.23056924112859
              ],
              [
                -65.5995957645355,
                -2.3441159796655406
              ]
            ]
          ],
          "geodesic": false,
          "evenOdd": true
        }
      ],
      "displayProperties": [],
      "properties": {},
      "color": "#00ffff",
      "mode": "Geometry",
      "shown": false,
      "locked": false
    }) || 
    /* color: #00ffff */
    /* shown: false */
    ee.Geometry.Polygon(
        [[[-66.725694397348, -2.3441159796655406],
          [-66.725694397348, -4.23056924112859],
          [-65.5995957645355, -4.23056924112859],
          [-65.5995957645355, -2.3441159796655406]]], null, false),
    Bangladesh = ui.import && ui.import("Bangladesh", "geometry", {
      "geometries": [
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                90.01471189609596,
                23.755435891349205
              ],
              [
                90.01471189609596,
                21.75975759675572
              ],
              [
                91.58575681797096,
                21.75975759675572
              ],
              [
                91.58575681797096,
                23.755435891349205
              ]
            ]
          ],
          "geodesic": false,
          "evenOdd": true
        }
      ],
      "displayProperties": [],
      "properties": {},
      "color": "#00ff00",
      "mode": "Geometry",
      "shown": false,
      "locked": false
    }) || 
    /* color: #00ff00 */
    /* shown: false */
    ee.Geometry.Polygon(
        [[[90.01471189609596, 23.755435891349205],
          [90.01471189609596, 21.75975759675572],
          [91.58575681797096, 21.75975759675572],
          [91.58575681797096, 23.755435891349205]]], null, false),
    EAU = ui.import && ui.import("EAU", "geometry", {
      "geometries": [
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                54.91812862668561,
                25.01469237512225
              ],
              [
                54.96482052121686,
                24.943736797718728
              ],
              [
                55.03897823606061,
                24.94622715986388
              ],
              [
                55.08704342160748,
                24.969883088506155
              ],
              [
                55.22162594113873,
                25.141563180305884
              ],
              [
                55.28617061887311,
                25.24967245259215
              ],
              [
                55.17356075559186,
                25.2931375927202
              ],
              [
                55.08429683957623,
                25.176367440304286
              ]
            ]
          ],
          "evenOdd": true
        }
      ],
      "displayProperties": [],
      "properties": {},
      "color": "#0000ff",
      "mode": "Geometry",
      "shown": false,
      "locked": false
    }) || 
    /* color: #0000ff */
    /* shown: false */
    ee.Geometry.Polygon(
        [[[54.91812862668561, 25.01469237512225],
          [54.96482052121686, 24.943736797718728],
          [55.03897823606061, 24.94622715986388],
          [55.08704342160748, 24.969883088506155],
          [55.22162594113873, 25.141563180305884],
          [55.28617061887311, 25.24967245259215],
          [55.17356075559186, 25.2931375927202],
          [55.08429683957623, 25.176367440304286]]]),
    Suez_channel = ui.import && ui.import("Suez_channel", "geometry", {
      "geometries": [
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                -79.63680382659574,
                8.880476545573057
              ],
              [
                -79.51458092620511,
                8.953737957499138
              ],
              [
                -79.74529381683011,
                9.20596914364637
              ],
              [
                -79.85378380706449,
                9.111064276670856
              ]
            ]
          ],
          "evenOdd": true
        }
      ],
      "displayProperties": [],
      "properties": {},
      "color": "#009999",
      "mode": "Geometry",
      "shown": false,
      "locked": false
    }) || 
    /* color: #009999 */
    /* shown: false */
    ee.Geometry.Polygon(
        [[[-79.63680382659574, 8.880476545573057],
          [-79.51458092620511, 8.953737957499138],
          [-79.74529381683011, 9.20596914364637],
          [-79.85378380706449, 9.111064276670856]]]),
    Aral_Sea = ui.import && ui.import("Aral_Sea", "geometry", {
      "geometries": [
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                57.93918483131517,
                46.81633593463086
              ],
              [
                57.93918483131517,
                43.69301518263304
              ],
              [
                61.80637233131517,
                43.69301518263304
              ],
              [
                61.80637233131517,
                46.81633593463086
              ]
            ]
          ],
          "geodesic": false,
          "evenOdd": true
        }
      ],
      "displayProperties": [],
      "properties": {},
      "color": "#ff00ff",
      "mode": "Geometry",
      "shown": false,
      "locked": false
    }) || 
    /* color: #ff00ff */
    /* shown: false */
    ee.Geometry.Polygon(
        [[[57.93918483131517, 46.81633593463086],
          [57.93918483131517, 43.69301518263304],
          [61.80637233131517, 43.69301518263304],
          [61.80637233131517, 46.81633593463086]]], null, false),
    Bangladesh1 = ui.import && ui.import("Bangladesh1", "geometry", {
      "geometries": [
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                89.46036224106189,
                25.892345295309976
              ],
              [
                89.46036224106189,
                24.750330859533292
              ],
              [
                90.11954192856189,
                24.750330859533292
              ],
              [
                90.11954192856189,
                25.892345295309976
              ]
            ]
          ],
          "geodesic": false,
          "evenOdd": true
        }
      ],
      "displayProperties": [],
      "properties": {},
      "color": "#99ff99",
      "mode": "Geometry",
      "shown": false,
      "locked": false
    }) || 
    /* color: #99ff99 */
    /* shown: false */
    ee.Geometry.Polygon(
        [[[89.46036224106189, 25.892345295309976],
          [89.46036224106189, 24.750330859533292],
          [90.11954192856189, 24.750330859533292],
          [90.11954192856189, 25.892345295309976]]], null, false),
    Xangai = ui.import && ui.import("Xangai", "geometry", {
      "geometries": [
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                121.20638703567326,
                31.64678970874803
              ],
              [
                121.20638703567326,
                30.787103671232188
              ],
              [
                122.02486848098576,
                30.787103671232188
              ],
              [
                122.02486848098576,
                31.64678970874803
              ]
            ]
          ],
          "geodesic": false,
          "evenOdd": true
        }
      ],
      "displayProperties": [],
      "properties": {},
      "color": "#98ff00",
      "mode": "Geometry",
      "shown": false,
      "locked": false
    }) || 
    /* color: #98ff00 */
    /* shown: false */
    ee.Geometry.Polygon(
        [[[121.20638703567326, 31.64678970874803],
          [121.20638703567326, 30.787103671232188],
          [122.02486848098576, 30.787103671232188],
          [122.02486848098576, 31.64678970874803]]], null, false),
    Lageado = ui.import && ui.import("Lageado", "geometry", {
      "geometries": [
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                -48.75976788971894,
                -9.682596991186223
              ],
              [
                -48.75976788971894,
                -10.990338512354247
              ],
              [
                -48.03467023346894,
                -10.990338512354247
              ],
              [
                -48.03467023346894,
                -9.682596991186223
              ]
            ]
          ],
          "geodesic": false,
          "evenOdd": true
        }
      ],
      "displayProperties": [],
      "properties": {},
      "color": "#bf04c2",
      "mode": "Geometry",
      "shown": false,
      "locked": false
    }) || 
    /* color: #bf04c2 */
    /* shown: false */
    ee.Geometry.Polygon(
        [[[-48.75976788971894, -9.682596991186223],
          [-48.75976788971894, -10.990338512354247],
          [-48.03467023346894, -10.990338512354247],
          [-48.03467023346894, -9.682596991186223]]], null, false),
    Guadiana = ui.import && ui.import("Guadiana", "geometry", {
      "geometries": [
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                -7.750229936831308,
                38.69195960771985
              ],
              [
                -7.750229936831308,
                38.11945092805576
              ],
              [
                -7.156968218081308,
                38.11945092805576
              ],
              [
                -7.156968218081308,
                38.69195960771985
              ]
            ]
          ],
          "geodesic": false,
          "evenOdd": true
        }
      ],
      "displayProperties": [],
      "properties": {},
      "color": "#0b4a8b",
      "mode": "Geometry",
      "shown": false,
      "locked": false
    }) || 
    /* color: #0b4a8b */
    /* shown: false */
    ee.Geometry.Polygon(
        [[[-7.750229936831308, 38.69195960771985],
          [-7.750229936831308, 38.11945092805576],
          [-7.156968218081308, 38.11945092805576],
          [-7.156968218081308, 38.69195960771985]]], null, false);
////////////////////////////////////////////////////// Define a região de interesse //////////////
var List = {
  'Amazon and Juruá River (river meander migration) - Brazil': Amazon,
  'Lageado Dam (reservoir filling) - Brazil': Lageado,
  'Guadiana Dam (reservoir filling) - Portugal': Guadiana,
  'Ganges Delta (river migration) - Bangladesh': Bangladesh,
  'Brahmaputra River (river migration) - Bangladesh': Bangladesh1,
  'Xangai (urban expansion) - China': Xangai,
  'Dubai (artificial Islands) - UAE': EAU,
  'Suez Channel expansion (artificial channel) - Panama': Suez_channel,
  'Aral Sea (lake drought) - Kazakhstan': Aral_Sea,
};
///////////////// CRIAR O PAINEL DO USUÁRIO ////////////////////////////////
Map.setControlVisibility(false);
Map.setControlVisibility({scaleControl: true, zoomControl: true});
Map.style().set({cursor: 'crosshair'});
var panel = ui.Panel({
  style:{width:"300px",backgroundColor:"lightgrey", border:"2px solid black"} 
})
// Create an intro panel with labels.
var intro = ui.Panel([
  ui.Label({
    value: 'Water Surface Change Detection Algorithm (WSCDA)',
    style: {fontSize: '20px', fontWeight: 'bold'}
  }),
  ui.Label('The algorithm detects areas where the presence of water increased or decreased over the past 36 years. The algorithm is based on Landsat 5 and 8 Time Series (1984-2020). Due to the high amount of data the algorithm might take time to process'),
  ui.Label('Please, adjust the scale in order to have a broader view (zoom out) and detail view (zoom in)')
]);
var select = ui.Select({
  items:Object.keys(List),
  placeholder: "PLEASE, SELECT A REGION OF INTEREST !!!",
  style: {fontSize: '20px'},
  onChange: updateMap
})
ui.root.add(panel.add(intro).add(select))
  // This function changes the given map to show the selected image.
  function updateMap(selection) {
    Map.clear()
    legend.clear()
  var StartLandsat5 = '1984-01-01'
  var EndLandsat5 = '2012-12-31'
  var StartLandsat8 = '2013-01-01'
  var EndLandsat8 = '2020-12-31'
  var mes1 = 3
  var mes2 = 6
  //  LANDSAT 5 ______________________________________________________________________
  // This function adds a time band to the image.
  var createTimeBand = function(image) {
    // Scale milliseconds by a large constant to avoid very small slopes
    // in the linear regression output.
    return image.addBands(image.metadata('system:time_start').multiply(3.1715e-11)).copyProperties(image);
  };
  // create to clip the image
  var recorte = function(image) {
    // Crop by table extension
    return image.clip(List[selection]).copyProperties(image);
  };
  //  Nuvem
  var cloud5 = function(image) {
    var qa = image.select('pixel_qa');
    // If the cloud bit (5) is set and the cloud confidence (7) is high
    // or the cloud shadow bit is set (3), then it's a bad pixel.
    var cloud = qa.bitwiseAnd(1 << 5)
                    .and(qa.bitwiseAnd(1 << 7))
                    .or(qa.bitwiseAnd(1 << 3));
    // Remove edge pixels that don't occur in all bands
    var mask2 = image.mask().reduce(ee.Reducer.min());
    return image.updateMask(cloud.not()).updateMask(mask2).copyProperties(image);
  };
  var clouds_free = ee.ImageCollection('LANDSAT/LT05/C01/T1_SR')
                    .filterDate(StartLandsat5, EndLandsat5)
                    .filterBounds(List[selection])
                    .map(cloud5)
                    .map(recorte)
                    .map(createTimeBand)
                    .filter(ee.Filter.lessThan('CLOUD_COVER', 50));
  var filter1 = ee.Filter.calendarRange(mes1,mes2, 'month');
  var clouds_free = clouds_free.filter(filter1);
  // Árvore de Decisão
  var decision_tree = function(image){
    var system = image.select('system:time_start')
    var evi = image.expression(
      '((GREEN - SWIR) / (GREEN + SWIR))', {
        'BLUE': image.select('B1'),
        'GREEN': image.select('B2'),
        'NIR': image.select('B4'),
        'SWIR': image.select('B5'),
        'SWIR1': image.select('B7'),
      });
    var water = evi.rename('water');
    return water.addBands(system).copyProperties(image);  
  };
  var result = clouds_free.map(decision_tree);
  // Get a palette: a list of hex strings
  var palettes = require('users/gena/packages:palettes');
  var palette = palettes.misc.jet[7];
  //  LANDSAT 8 ______________________________________________________________________
  //  Nuvem
  function maskL8sr(image) {
    // Bits 3 and 5 are cloud shadow and cloud, respectively.
    var cloudShadowBitMask = (1 << 3);
    var cloudsBitMask = (1 << 5);
    // Get the pixel QA band.
    var qa = image.select('pixel_qa');
    // Both flags should be set to zero, indicating clear conditions.
    var mask = qa.bitwiseAnd(cloudShadowBitMask).eq(0)
                   .and(qa.bitwiseAnd(cloudsBitMask).eq(0));
    return image.updateMask(mask).copyProperties(image);
  }
  var clouds_free8 = ee.ImageCollection("LANDSAT/LC08/C01/T1_SR")
                    .filterDate(StartLandsat8, EndLandsat8)
                    .filterBounds(List[selection])
                    .map(maskL8sr)
                    .map(recorte)
                    .map(createTimeBand)
                    .filter(ee.Filter.lessThan('CLOUD_COVER', 50));
  var filter8 = ee.Filter.calendarRange(mes1,mes2, 'month');
  var clouds_free8 = clouds_free8.filter(filter8);
  // Árvore de Decisão
  var decision_tree = function(image){
    var system = image.select('system:time_start')
    var evi = image.expression(
      '((GREEN - SWIR) / (GREEN + SWIR))', {
        'BLUE': image.select('B2'),
        'GREEN': image.select('B3'),
        'NIR': image.select('B5'),
        'SWIR': image.select('B6'),
        'SWIR1': image.select('B7'),
      });
    var water = evi.rename('water');
    return water.addBands(system).copyProperties(image);  
  };
  var result8 = clouds_free8.map(decision_tree);
// Pós processamento __________________________________________________________
var landsat5 = result.select(['water','system:time_start'])
var landsat8 = result8.select(['water','system:time_start'])
var LANDSAT = landsat5.merge(landsat8)
  // Aplica uma regressão linear para cada pixel
  var linearFit = LANDSAT.select(['system:time_start', 'water'])
    .reduce(ee.Reducer.linearFit());
  var linearFit = linearFit.select(['scale'])
  var linearFit_positive = linearFit.updateMask(linearFit.gte(0.015));
  var linearFit_positive = linearFit_positive.neq(1)
  var linearFit_negative = linearFit.updateMask(linearFit.lte(-0.014));
  var linearFit_negative = linearFit_negative.neq(1)
  var ancientLand = ee.ImageCollection('LANDSAT/LT05/C01/T1_SR')
                  .map(recorte)
                  .filterDate('1984-01-01', '1985-12-30')
                  .sort('CLOUD_COVER',false)
  var recentLand = ee.ImageCollection('LANDSAT/LC08/C01/T1_SR')
                    .map(recorte)
                    .filterDate('2019-03-01', '2020-06-30')
                    .sort('CLOUD_COVER',false)
    var visParams = {
    palette: ['0000FF']
  };
  var visParams5 = {
    palette: ['red']
  };
  var visParams1 = {
    bands: ['B3', 'B2', 'B1'], min: 0, max: 3000, gamma: 1.4,
  };
  var visParams2 = {
    bands: ['B4', 'B3', 'B2'],min: 0, max: 3000, gamma: 1.4,
  };
  Map.addLayer(ancientLand, visParams1, '1984 Landsat Image');
  Map.addLayer(recentLand, visParams2, '2020 Landsat Image');
  Map.addLayer(linearFit_positive, visParams, 'Land -> Water')
  Map.addLayer(linearFit_negative, visParams5, 'Water -> Land')
  var centre = List[selection].centroid(10).coordinates();
  Map.setCenter(ee.Number(centre.get(0)).getInfo(), ee.Number(centre.get(1)).getInfo(), 10);
    //  Palette with the colors
  var palette =['0000FF', 'cc0013'];
  // name of the legend
  var names = ['Land -> Water','Water -> Land'];
  // Add color and and names
  for (var i = 0; i < 2; i++) {
    legend.add(makeRow(palette[i], names[i]));
    }  
  // add legend to map (alternatively you can also print the legend to the console)
  Map.add(legend);
  ////////////////// Função para criar um gráfico de série temporal ///////////
  }
///////////////////// Adicionar legenda no Mapa ////////////////////////////////////////////////////
// set position of panel
var legend = ui.Panel({
  style: {
    position: 'bottom-right',
    padding: '8px 15px'
  }
});
// Create legend title
var legendTitle = ui.Label({
  value: 'My Legend',
  style: {
    fontWeight: 'bold',
    fontSize: '18px',
    margin: '0 0 4px 0',
    padding: '0'
    }
});
// Add the title to the panel
legend.add(legendTitle);
// Creates and styles 1 row of the legend.
var makeRow = function(color, name) {
      // Create the label that is actually the colored box.
      var colorBox = ui.Label({
        style: {
          backgroundColor: '#' + color,
          // Use padding to give the box height and width.
          padding: '10px',
          margin: '0 0 4px 0'
        }
      });
      // Create the label filled with the description text.
      var description = ui.Label({
        value: name,
        style: {margin: '0 0 4px 6px'}
      });
      // return the panel
      return ui.Panel({
        widgets: [colorBox, description],
        layout: ui.Panel.Layout.Flow('horizontal')
      });
};