var extent_1 = ui.import && ui.import("extent_1", "table", {
      "id": "users/ogordienko112/gispzf2021/Biatov_GEE_SCGGISUA_2021"
    }) || ee.FeatureCollection("users/ogordienko112/gispzf2021/Biatov_GEE_SCGGISUA_2021"),
    geometry = ui.import && ui.import("geometry", "geometry", {
      "geometries": [
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                35.148819107606464,
                50.141356023225
              ],
              [
                35.148819107606464,
                50.06516363803672
              ],
              [
                35.283401627137714,
                50.06516363803672
              ],
              [
                35.283401627137714,
                50.141356023225
              ]
            ]
          ],
          "geodesic": false,
          "evenOdd": true
        }
      ],
      "displayProperties": [
        {
          "type": "rectangle"
        }
      ],
      "properties": {},
      "color": "#d63000",
      "mode": "Geometry",
      "shown": false,
      "locked": false
    }) || 
    /* color: #d63000 */
    /* shown: false */
    /* displayProperties: [
      {
        "type": "rectangle"
      }
    ] */
    ee.Geometry.Polygon(
        [[[35.148819107606464, 50.141356023225],
          [35.148819107606464, 50.06516363803672],
          [35.283401627137714, 50.06516363803672],
          [35.283401627137714, 50.141356023225]]], null, false),
    Class_1 = ui.import && ui.import("Class_1", "geometry", {
      "geometries": [
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                35.330083901948626,
                50.2596142976659
              ],
              [
                35.333602960176165,
                50.25840708922259
              ],
              [
                35.33248716122597,
                50.26071173333975
              ],
              [
                35.32965474850624,
                50.26115070053007
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                35.452242342002066,
                50.213879316432624
              ],
              [
                35.454473939902456,
                50.21420886577902
              ],
              [
                35.45584723091808,
                50.2142637904488
              ],
              [
                35.456276384360464,
                50.214758109631575
              ],
              [
                35.454044786460074,
                50.21514257656641
              ],
              [
                35.45357271767345,
                50.214758109631575
              ],
              [
                35.45297190285412,
                50.21412647865581
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                35.42695470091747,
                50.2208746550546
              ],
              [
                35.423349812001454,
                50.22114923940284
              ],
              [
                35.424122288197744,
                50.22038039924471
              ],
              [
                35.429315044850576,
                50.22038039924471
              ],
              [
                35.42974419829296,
                50.22114923940284
              ],
              [
                35.427855923146474,
                50.22139636396487
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                35.34831339412685,
                50.25234525597943
              ],
              [
                35.346854272422746,
                50.25078112783295
              ],
              [
                35.349128785667375,
                50.24949136951097
              ],
              [
                35.349600854453996,
                50.25053415553742
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                35.350158753929094,
                50.249409043326466
              ],
              [
                35.35028749996181,
                50.250067648820085
              ],
              [
                35.35003000789638,
                50.251165304415046
              ],
              [
                35.349600854453996,
                50.25053415553742
              ]
            ]
          ],
          "evenOdd": true
        }
      ],
      "displayProperties": [],
      "properties": {
        "Class": 1
      },
      "color": "#2353ff",
      "mode": "FeatureCollection",
      "shown": false,
      "locked": false
    }) || 
    /* color: #2353ff */
    /* shown: false */
    ee.FeatureCollection(
        [ee.Feature(
            ee.Geometry.Polygon(
                [[[35.330083901948626, 50.2596142976659],
                  [35.333602960176165, 50.25840708922259],
                  [35.33248716122597, 50.26071173333975],
                  [35.32965474850624, 50.26115070053007]]]),
            {
              "Class": 1,
              "system:index": "0"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[35.452242342002066, 50.213879316432624],
                  [35.454473939902456, 50.21420886577902],
                  [35.45584723091808, 50.2142637904488],
                  [35.456276384360464, 50.214758109631575],
                  [35.454044786460074, 50.21514257656641],
                  [35.45357271767345, 50.214758109631575],
                  [35.45297190285412, 50.21412647865581]]]),
            {
              "Class": 1,
              "system:index": "1"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[35.42695470091747, 50.2208746550546],
                  [35.423349812001454, 50.22114923940284],
                  [35.424122288197744, 50.22038039924471],
                  [35.429315044850576, 50.22038039924471],
                  [35.42974419829296, 50.22114923940284],
                  [35.427855923146474, 50.22139636396487]]]),
            {
              "Class": 1,
              "system:index": "2"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[35.34831339412685, 50.25234525597943],
                  [35.346854272422746, 50.25078112783295],
                  [35.349128785667375, 50.24949136951097],
                  [35.349600854453996, 50.25053415553742]]]),
            {
              "Class": 1,
              "system:index": "3"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[35.350158753929094, 50.249409043326466],
                  [35.35028749996181, 50.250067648820085],
                  [35.35003000789638, 50.251165304415046],
                  [35.349600854453996, 50.25053415553742]]]),
            {
              "Class": 1,
              "system:index": "4"
            })]),
    Class_2 = ui.import && ui.import("Class_2", "geometry", {
      "geometries": [
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                35.586605451093256,
                50.23937055895707
              ],
              [
                35.59141196964794,
                50.207300671024356
              ],
              [
                35.6007560816939,
                50.208388323041376
              ],
              [
                35.598696145170464,
                50.21849463058655
              ],
              [
                35.606929354024025,
                50.235212407366085
              ],
              [
                35.61379580910215,
                50.24509347676966
              ],
              [
                35.59216647560606,
                50.247947626618796
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                35.31240634813549,
                50.077579273983304
              ],
              [
                35.32857514197609,
                50.079124659693164
              ],
              [
                35.35093629479059,
                50.10582987825105
              ],
              [
                35.3406157750796,
                50.11178687940362
              ],
              [
                35.30139776420127,
                50.105829882776874
              ],
              [
                35.30449394380712,
                50.08972023993996
              ]
            ]
          ],
          "evenOdd": true
        }
      ],
      "displayProperties": [],
      "properties": {
        "Class": 2
      },
      "color": "#ede043",
      "mode": "FeatureCollection",
      "shown": true,
      "locked": false
    }) || /* color: #ede043 */ee.FeatureCollection(
        [ee.Feature(
            ee.Geometry.Polygon(
                [[[35.586605451093256, 50.23937055895707],
                  [35.59141196964794, 50.207300671024356],
                  [35.6007560816939, 50.208388323041376],
                  [35.598696145170464, 50.21849463058655],
                  [35.606929354024025, 50.235212407366085],
                  [35.61379580910215, 50.24509347676966],
                  [35.59216647560606, 50.247947626618796]]]),
            {
              "Class": 2,
              "system:index": "0"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[35.31240634813549, 50.077579273983304],
                  [35.32857514197609, 50.079124659693164],
                  [35.35093629479059, 50.10582987825105],
                  [35.3406157750796, 50.11178687940362],
                  [35.30139776420127, 50.105829882776874],
                  [35.30449394380712, 50.08972023993996]]]),
            {
              "Class": 2,
              "system:index": "1"
            })]),
    Class_1_2 = ui.import && ui.import("Class_1_2", "geometry", {
      "geometries": [
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                35.40058547258219,
                50.42082025332729
              ],
              [
                35.40086442231974,
                50.42088177560489
              ],
              [
                35.401293575762125,
                50.42118255003389
              ],
              [
                35.40149742364726,
                50.42132610079261
              ],
              [
                35.401776373384806,
                50.42110052083361
              ],
              [
                35.40166908502421,
                50.42133293653215
              ],
              [
                35.4014330506309,
                50.421599529605565
              ],
              [
                35.401025354860636,
                50.421250907592324
              ],
              [
                35.400553286074015,
                50.42099114834554
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                35.41683352861469,
                50.41363571320052
              ],
              [
                35.4171232071883,
                50.4139638808598
              ],
              [
                35.4172485428171,
                50.41540556594354
              ],
              [
                35.417838628800375,
                50.41553546106102
              ],
              [
                35.41774206927584,
                50.41588412514162
              ],
              [
                35.4171412544565,
                50.41582943290651
              ],
              [
                35.41713052562044,
                50.41569270204249
              ],
              [
                35.417119796784384,
                50.41543291231363
              ],
              [
                35.41697746554055,
                50.41519274318374
              ],
              [
                35.41668778696694,
                50.41459111634447
              ],
              [
                35.41674143114724,
                50.41396213466147
              ]
            ]
          ],
          "evenOdd": true
        }
      ],
      "displayProperties": [],
      "properties": {
        "Class": 1
      },
      "color": "#53f3ff",
      "mode": "FeatureCollection",
      "shown": true,
      "locked": false
    }) || /* color: #53f3ff */ee.FeatureCollection(
        [ee.Feature(
            ee.Geometry.Polygon(
                [[[35.40058547258219, 50.42082025332729],
                  [35.40086442231974, 50.42088177560489],
                  [35.401293575762125, 50.42118255003389],
                  [35.40149742364726, 50.42132610079261],
                  [35.401776373384806, 50.42110052083361],
                  [35.40166908502421, 50.42133293653215],
                  [35.4014330506309, 50.421599529605565],
                  [35.401025354860636, 50.421250907592324],
                  [35.400553286074015, 50.42099114834554]]]),
            {
              "Class": 1,
              "system:index": "0"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[35.41683352861469, 50.41363571320052],
                  [35.4171232071883, 50.4139638808598],
                  [35.4172485428171, 50.41540556594354],
                  [35.417838628800375, 50.41553546106102],
                  [35.41774206927584, 50.41588412514162],
                  [35.4171412544565, 50.41582943290651],
                  [35.41713052562044, 50.41569270204249],
                  [35.417119796784384, 50.41543291231363],
                  [35.41697746554055, 50.41519274318374],
                  [35.41668778696694, 50.41459111634447],
                  [35.41674143114724, 50.41396213466147]]]),
            {
              "Class": 1,
              "system:index": "1"
            })]),
    Class_2_2 = ui.import && ui.import("Class_2_2", "geometry", {
      "geometries": [
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                35.420202383137394,
                50.41415531094463
              ],
              [
                35.420202383137394,
                50.41237771611469
              ],
              [
                35.42410767946308,
                50.41237771611469
              ],
              [
                35.42410767946308,
                50.41415531094463
              ]
            ]
          ],
          "geodesic": false,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                35.393680700398136,
                50.408644549874296
              ],
              [
                35.393680700398136,
                50.4029553500018
              ],
              [
                35.40483868990009,
                50.4029553500018
              ],
              [
                35.40483868990009,
                50.408644549874296
              ]
            ]
          ],
          "geodesic": false,
          "evenOdd": true
        }
      ],
      "displayProperties": [
        {
          "type": "rectangle"
        },
        {
          "type": "rectangle"
        }
      ],
      "properties": {
        "Class": 2
      },
      "color": "#54ff22",
      "mode": "FeatureCollection",
      "shown": true,
      "locked": false
    }) || 
    /* color: #54ff22 */
    /* displayProperties: [
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      }
    ] */
    ee.FeatureCollection(
        [ee.Feature(
            ee.Geometry.Polygon(
                [[[35.420202383137394, 50.41415531094463],
                  [35.420202383137394, 50.41237771611469],
                  [35.42410767946308, 50.41237771611469],
                  [35.42410767946308, 50.41415531094463]]], null, false),
            {
              "Class": 2,
              "system:index": "0"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[35.393680700398136, 50.408644549874296],
                  [35.393680700398136, 50.4029553500018],
                  [35.40483868990009, 50.4029553500018],
                  [35.40483868990009, 50.408644549874296]]], null, false),
            {
              "Class": 2,
              "system:index": "1"
            })]);
/*
Примеры кода для участников семинара 
ГИС и заповедные территории 2021
https://scgis.org.ua
*/
// new Assets folder GISPZF2021
// upload scgis_2021_extent
// New repository gis-pzf-2021
// Create file scgis_2021_NDVI_and_Classification
// import scgis_2021_extent
// rename to extent_1
// Установим базовую карту Google Hybrid
Map.setOptions("HYBRID");
// Центрируем карту по координатам X Y и  зуму карты
Map.setCenter(35.52, 50.1646, 9);
// Центрируем карту по объекту и  зуму карты
// Map.centerObject(extent_1, 10);
// Создадим переменные для первой и последней даты
var startDate = '2021-05-15';
var endDate = '2021-08-27';
// Поцент покрытия снимка облаками
var cloud_treshold = 30;
var scale = 10;
// Добавим данные Sentinel-2, Level-2A
// https://developers.google.com/earth-engine/datasets/catalog/COPERNICUS_S2_SR
// https://explorer.earthengine.google.com/#detail/COPERNICUS%2FS2_SR
var collectionS2 = ee.ImageCollection('COPERNICUS/S2_SR');
// Создадим функцию маскировки облаков для данных Sentinel-2 Level-2A
/**
 * Function to mask clouds using the Sentinel-2 QA band
 * @param {ee.Image} image Sentinel-2 image
 * @return {ee.Image} cloud masked Sentinel-2 image
 */
function maskS2clouds(image) {
  var qa = image.select('QA60');
  // Bits 10 and 11 are clouds and cirrus, respectively.
  var cloudBitMask = 1 << 10;
  var cirrusBitMask = 1 << 11;
  // Both flags should be set to zero, indicating clear conditions.
  var mask = qa.bitwiseAnd(cloudBitMask).eq(0)
      .and(qa.bitwiseAnd(cirrusBitMask).eq(0));
  return image.updateMask(mask);
//  return image.updateMask(mask).divide(10000); // если делить на 10000 то результирующий растр будет в долях еденицы.
}
var dataset_S2 = collectionS2
                  .filterBounds(extent_1)
                  .filterDate(startDate, endDate)
                  .filter(ee.Filter.lt('CLOUDY_PIXEL_PERCENTAGE', cloud_treshold)) // отфильтруем снимки по проценту облачности
                  .map(maskS2clouds) // применим маску облачных пикселей
                  .select(['B2', 'B3', 'B4', 'B5', 'B6', 'B7', 'B8', 'B8A', 'B11', 'B12']); // отфильтруем каналы нужные нам
// напечатаем количество снимков в коллекции снимков
print('Number of S2 Scenes', dataset_S2.size());
// напечатаем описание коллекции снимков
print('dataset_S2',dataset_S2);
// Посчитаем медиану для коллекции Sentinel 2 
var S2_median = dataset_S2.median().uint16();
// Создадим варианты настроек отображения Sentinel 2
var rgbVis_natural_color = {
  min: 0,
  max: 1500,
  bands: ['B4', 'B3', 'B2'],
};
var rgbVis_Color_Infrared = {
  min: 0,
  max: 5000,
  bands: ['B8', 'B4', 'B3'],
};
var rgbVis_False_color = {
  min: 0,
  max: 5000,
  bands: ['B11', 'B8', 'B4'],
};
var rgbVis_Pseudo_color = {
  min: 0,
  max: 3000,
  bands: ['B12', 'B11', 'B5'],
};
// >>>   НА КАРТЕ ПОДКЛЮЧЕНО НЕСКОЛЬКО СЛОЕВ
Map.addLayer(S2_median, rgbVis_False_color, 'S2 False color no cliped',false);
// Обрежем по геометрии зоны интереса и добавим на карту
Map.addLayer(S2_median.clip(extent_1), rgbVis_natural_color, 'S2 natural color',false);
Map.addLayer(S2_median.clip(extent_1), rgbVis_False_color, 'S2 False color',false);
Map.addLayer(S2_median.clip(extent_1), rgbVis_Pseudo_color, 'S2 Pseudo color',false);
Map.addLayer(S2_median.clip(extent_1), rgbVis_Color_Infrared, 'S2 Color Infrared',false);
// Посчитаем  NDVI, NDWI и GNDVI
// Расчитаем NDVI Sentinel 2     (NIR - RED) / (NIR + RED)
var S2_NDVI = S2_median.normalizedDifference(['B8', 'B4']).rename('NDVI');
// Расчитаем NDWI Sentinel 2   (NIR - SWIR1)/(NIR + SWIR1)
var S2_NDWI = S2_median.expression('(b("B8") - b("B11")) / (b("B8") + b("B11"))').rename('NDWI');
// GNDVI - Green Normalized Difference Vegetation Index 
//  (NIR - Green)/(NIR + Green)
// Создадим функцию расчета
var calc_GNDVI = function(image) {
	return image.expression('(B8-B3)/(B8+B3)', {
		'B3': image.select('B3'), 
		'B8': image.select('B8')
     }).rename('MSAVI');
};
var S2_GNDVI = calc_GNDVI(S2_median);
print('S2_NDVI: ',S2_NDVI);
print('S2_NDWI: ',S2_NDWI);
print('S2_GNDVI: ',S2_GNDVI);
// Display VI.
Map.addLayer(S2_NDVI, {min: 0, max: 1, palette: ['white', 'green']}, 'S2_NDVI',false);
Map.addLayer(S2_GNDVI, {min: 0, max: 1, palette: ['white', 'green']}, 'S2_GNDVI',false);
Map.addLayer(S2_NDWI, {min: 0, max: 1, palette: ['white', 'green']}, 'S2_NDWI',false);
// Нарисуем квадратик поменьше
// Экспорт данных
Export.image.toDrive({
  image: S2_median.clip(geometry), // обрезаем изображение по маске
  description: 'Se2_'+startDate+'_'+endDate,
  folder: 'GEE_data_SCGIS2021',
  scale: scale,
  region: geometry,
  crs: 'EPSG:4326',
  maxPixels: 1e10,
  fileFormat: 'GeoTIFF',
  formatOptions: {
    cloudOptimized: true
  }
  });
// Экспорт медианного NDVI Sentinel 2
Export.image.toDrive({
  image: S2_NDVI.clip(geometry), // обрезаем изображение по маске
  description: 'S2_NDVI_'+startDate+'_'+endDate,
  folder: 'GEE_data_SCGIS2021',
  scale: scale,
  region: geometry,
  crs: 'EPSG:4326',
  maxPixels: 1e10,
  fileFormat: 'GeoTIFF',
  formatOptions: {
    cloudOptimized: true
  }
});
Export.image.toDrive({
  image: S2_NDWI.clip(geometry), // обрезаем изображение по маске
  description: 'S2_NDWI_'+startDate+'_'+endDate,
  folder: 'GEE_data_SCGIS2021',
  scale: scale,
  region: geometry,
  crs: 'EPSG:4326',
  maxPixels: 1e10,
  fileFormat: 'GeoTIFF',
  formatOptions: {
    cloudOptimized: true
  }
});
Export.image.toDrive({
  image: S2_GNDVI.clip(geometry), // обрезаем изображение по маске
  description: 'S2_GNDVI_'+startDate+'_'+endDate,
  folder: 'GEE_data_SCGIS2021',
  scale: scale,
  region: geometry,
  crs: 'EPSG:4326',
  maxPixels: 1e10,
  fileFormat: 'GeoTIFF',
  formatOptions: {
    cloudOptimized: true
  }
});
// >>>>>>>>>>>>>>>>>>>>> CLASSIFICATION
var my_bands_var = ['B2', 'B3', 'B4', 'B5', 'B6', 'B7', 'B8', 'B11', 'B12'];
var input = S2_median.select(my_bands_var);
// create laer FeatureCollection Class_1 with field "Class" = 1
// create laer FeatureCollection Class_2 with field "Class" = 2
// нарисуем учебные полигоны в каждом слое
// Class
// 1. вода
// 2. не вода
// объеденим учебные классы
var classes = Class_1.merge(Class_2);
// экспортируем SHP
Export.table.toDrive({
  collection: classes,
  description:'my_train_classes',
  folder: 'GEE_data_SCGIS2021',
  fileFormat: 'SHP'
});
var training = input.sampleRegions({
  collection: classes,
  properties: ['Class'],
  scale: scale,
 });
var classifier = ee.Classifier.smileRandomForest(30)
.train({
  features:training,
  classProperty: 'Class',
  inputProperties: my_bands_var
  });
var classified = input.classify(classifier).clip(extent_1);
var palette_cl = [
  '#3182bd',
  '#fc9272',
  ];
Map.addLayer(classified, {min: 1, max: 2, palette: palette_cl}, 'classification',false);
// Get a confusion matrix representing resubstitution accuracy.
var trainAccuracy = classifier.confusionMatrix();
print('Resubstitution error matrix: ', trainAccuracy);
print('Training overall accuracy: ', trainAccuracy.accuracy());
// создадим проверочные полигоны
// create laer FeatureCollection Class_1_2 with field "Class" = 1
// create laer FeatureCollection Class_2_2 with field "Class" = 2
// нарисуем проверочные полигоны в каждом слое
// Class
// 1. вода
// 2. не вода
// Sample the input with a different random seed to get validation data.
// проверочные классы
var classes_2 = Class_1_2.merge(Class_2_2);
var validation = input.sampleRegions({
collection: classes_2,
  properties: ['Class'],
  scale: scale,
});
// Classify the validation data.
var validated = validation.classify(classifier);
// Get a confusion matrix representing expected accuracy.
var testAccuracy = validated.errorMatrix('Class', 'classification');
print('Validation error matrix: ', testAccuracy);
print('Validation overall accuracy: ', testAccuracy.accuracy());
var waterVis = {min: 1, max: 1, palette: ['blue']};
var water = classified.eq(1).selfMask();
Map.addLayer(water, waterVis, 'water',false);
//  Векторизируем полученную маску
var vectors = water.reduceToVectors({
  geometry: extent_1,
  crs: 'EPSG:4326',
  scale: scale,
  geometryType: 'polygon',
  eightConnected: false,
  labelProperty: 'water'
});
print("vectors size: ", vectors.size());
// отфильтруем вектор, только water. Теу которых атрибут 'water' = 1
var water_vectors = vectors.filter(ee.Filter.eq('water', 1));
print("water_vectors size: ", water_vectors.size());
Map.addLayer(water_vectors, {color: 'red'}, 'water_vectors', false);
Export.image.toDrive({
  image: water,
  description: 'water_10_m',
  folder: 'GEE_data_SCGIS2021',
  scale: scale,
  region: geometry,
  crs: 'EPSG:4326',
  maxPixels: 1e10,
  fileFormat: 'GeoTIFF',
  formatOptions: {
    cloudOptimized: true
  }
  });
Export.table.toDrive({
  collection: water_vectors,
  description:'water_vectors',
  folder: 'GEE_data_SCGIS2021',
  fileFormat: 'SHP'
});