var other12 = ui.import && ui.import("other12", "geometry", {
      "geometries": [
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                -58.86500257504532,
                -71.31316249890543
              ],
              [
                -58.86500257504532,
                -71.36237945107085
              ],
              [
                -58.61781019223282,
                -71.36237945107085
              ],
              [
                -58.61781019223282,
                -71.31316249890543
              ]
            ]
          ],
          "geodesic": false,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                -58.56013196957657,
                -71.30700157442078
              ],
              [
                -58.56013196957657,
                -71.33602879409538
              ],
              [
                -58.46125501645157,
                -71.33602879409538
              ],
              [
                -58.46125501645157,
                -71.30700157442078
              ]
            ]
          ],
          "geodesic": false,
          "evenOdd": true
        }
      ],
      "displayProperties": [
        {
          "type": "rectangle"
        },
        {
          "type": "rectangle"
        }
      ],
      "properties": {
        "class": 0
      },
      "color": "#d63000",
      "mode": "FeatureCollection",
      "shown": false,
      "locked": false
    }) || 
    /* color: #d63000 */
    /* shown: false */
    /* displayProperties: [
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      }
    ] */
    ee.FeatureCollection(
        [ee.Feature(
            ee.Geometry.Polygon(
                [[[-58.86500257504532, -71.31316249890543],
                  [-58.86500257504532, -71.36237945107085],
                  [-58.61781019223282, -71.36237945107085],
                  [-58.61781019223282, -71.31316249890543]]], null, false),
            {
              "class": 0,
              "system:index": "0"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-58.56013196957657, -71.30700157442078],
                  [-58.56013196957657, -71.33602879409538],
                  [-58.46125501645157, -71.33602879409538],
                  [-58.46125501645157, -71.30700157442078]]], null, false),
            {
              "class": 0,
              "system:index": "1"
            })]),
    iceberg = ui.import && ui.import("iceberg", "geometry", {
      "geometries": [
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                -58.14288758522019,
                -71.29295269809666
              ],
              [
                -58.14288758522019,
                -71.30836249758535
              ],
              [
                -58.09344910865769,
                -71.30836249758535
              ],
              [
                -58.09344910865769,
                -71.29295269809666
              ]
            ]
          ],
          "geodesic": false,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                -58.67847108131394,
                -71.40669572544567
              ],
              [
                -58.66885804420456,
                -71.41851464017523
              ],
              [
                -58.61941956764206,
                -71.40844713325765
              ],
              [
                -58.62628602272019,
                -71.39793629877147
              ],
              [
                -58.64688538795456,
                -71.40056454465676
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                -58.571170697258886,
                -71.15549934810929
              ],
              [
                -58.584903607415136,
                -71.17057505500071
              ],
              [
                -58.60824955468076,
                -71.18032372975681
              ],
              [
                -58.612369427727636,
                -71.1927240988414
              ],
              [
                -58.55881107811826,
                -71.17367743384742
              ],
              [
                -58.55606449608701,
                -71.16170840033874
              ],
              [
                -58.55606449608701,
                -71.15195043285155
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                -57.069468071288156,
                -71.20158293463456
              ],
              [
                -57.0718713305655,
                -71.20268922492562
              ],
              [
                -57.058481743163156,
                -71.20600771929492
              ],
              [
                -57.05092864257722,
                -71.20279985050328
              ],
              [
                -57.06363158447175,
                -71.19914887508901
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                -58.197989976129975,
                -71.31325256218294
              ],
              [
                -58.18631700249716,
                -71.32205044549559
              ],
              [
                -58.1554179546456,
                -71.31589234668523
              ],
              [
                -58.176017319879975,
                -71.3053310506543
              ]
            ]
          ],
          "evenOdd": true
        }
      ],
      "displayProperties": [
        {
          "type": "rectangle"
        },
        {
          "type": "polygon"
        },
        {
          "type": "polygon"
        },
        {
          "type": "polygon"
        },
        {
          "type": "polygon"
        }
      ],
      "properties": {
        "class": 1
      },
      "color": "#98ff00",
      "mode": "FeatureCollection",
      "shown": false,
      "locked": false
    }) || 
    /* color: #98ff00 */
    /* shown: false */
    /* displayProperties: [
      {
        "type": "rectangle"
      },
      {
        "type": "polygon"
      },
      {
        "type": "polygon"
      },
      {
        "type": "polygon"
      },
      {
        "type": "polygon"
      }
    ] */
    ee.FeatureCollection(
        [ee.Feature(
            ee.Geometry.Polygon(
                [[[-58.14288758522019, -71.29295269809666],
                  [-58.14288758522019, -71.30836249758535],
                  [-58.09344910865769, -71.30836249758535],
                  [-58.09344910865769, -71.29295269809666]]], null, false),
            {
              "class": 1,
              "system:index": "0"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-58.67847108131394, -71.40669572544567],
                  [-58.66885804420456, -71.41851464017523],
                  [-58.61941956764206, -71.40844713325765],
                  [-58.62628602272019, -71.39793629877147],
                  [-58.64688538795456, -71.40056454465676]]]),
            {
              "class": 1,
              "system:index": "1"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-58.571170697258886, -71.15549934810929],
                  [-58.584903607415136, -71.17057505500071],
                  [-58.60824955468076, -71.18032372975681],
                  [-58.612369427727636, -71.1927240988414],
                  [-58.55881107811826, -71.17367743384742],
                  [-58.55606449608701, -71.16170840033874],
                  [-58.55606449608701, -71.15195043285155]]]),
            {
              "class": 1,
              "system:index": "2"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-57.069468071288156, -71.20158293463456],
                  [-57.0718713305655, -71.20268922492562],
                  [-57.058481743163156, -71.20600771929492],
                  [-57.05092864257722, -71.20279985050328],
                  [-57.06363158447175, -71.19914887508901]]]),
            {
              "class": 1,
              "system:index": "3"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-58.197989976129975, -71.31325256218294],
                  [-58.18631700249716, -71.32205044549559],
                  [-58.1554179546456, -71.31589234668523],
                  [-58.176017319879975, -71.3053310506543]]]),
            {
              "class": 1,
              "system:index": "4"
            })]),
    geometry = ui.import && ui.import("geometry", "geometry", {
      "geometries": [
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                27.179026700227507,
                72.01825486955954
              ],
              [
                27.179026700227507,
                67.84061567690401
              ],
              [
                73.93683920022751,
                67.84061567690401
              ],
              [
                73.93683920022751,
                72.01825486955954
              ]
            ]
          ],
          "geodesic": false,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                -59.60760530945193,
                -71.06087231075301
              ],
              [
                -59.60760530945193,
                -71.57637031541853
              ],
              [
                -57.10272249695193,
                -71.57637031541853
              ],
              [
                -57.10272249695193,
                -71.06087231075301
              ]
            ]
          ],
          "geodesic": false,
          "evenOdd": true
        }
      ],
      "displayProperties": [
        {
          "type": "rectangle"
        },
        {
          "type": "rectangle"
        }
      ],
      "properties": {},
      "color": "#0b4a8b",
      "mode": "Geometry",
      "shown": false,
      "locked": false
    }) || 
    /* color: #0b4a8b */
    /* shown: false */
    /* displayProperties: [
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      }
    ] */
    ee.Geometry.MultiPolygon(
        [[[[27.179026700227507, 72.01825486955954],
           [27.179026700227507, 67.84061567690401],
           [73.93683920022751, 67.84061567690401],
           [73.93683920022751, 72.01825486955954]]],
         [[[-59.60760530945193, -71.06087231075301],
           [-59.60760530945193, -71.57637031541853],
           [-57.10272249695193, -71.57637031541853],
           [-57.10272249695193, -71.06087231075301]]]], null, false),
    road = ui.import && ui.import("road", "geometry", {
      "geometries": [
        {
          "type": "LineString",
          "coordinates": [
            [
              33.51128041647847,
              69.28471007106772
            ],
            [
              55.30815541647847,
              69.90519354214689
            ],
            [
              63.02055776022847,
              71.14286755148385
            ],
            [
              66.84435051409253,
              71.1765567217364
            ]
          ]
        }
      ],
      "displayProperties": [],
      "properties": {},
      "color": "#d63000",
      "mode": "Geometry",
      "shown": false,
      "locked": false
    }) || 
    /* color: #d63000 */
    /* shown: false */
    ee.Geometry.LineString(
        [[33.51128041647847, 69.28471007106772],
         [55.30815541647847, 69.90519354214689],
         [63.02055776022847, 71.14286755148385],
         [66.84435051409253, 71.1765567217364]]);
// Make a label to display mean elevation at drawn points.
var label = new ui.Label('Draw line to calculate number of iceberg');
var inspector = new ui.Panel([label]);
Map.add(inspector);
// Don't make imports that correspond to the drawn points.
Map.drawingTools().setLinked(false);
// Limit the draw modes to points.
Map.drawingTools().setDrawModes(['line']);
// Add an empty layer to hold the drawn lines.
Map.drawingTools().addLayer([]);
// Set the geometry type to be point.
Map.drawingTools().setShape('line');
// Enter drawing mode.
Map.drawingTools().draw();
// This function gets called when the geometry layer changes.
// Use debounce to call the function at most every 100 milliseconds.
var getAverageElevation = ui.util.debounce(function() {
  var line = Map.drawingTools().layers().get(0).toGeometry();
  var elevation = icebergR.reduceRegion({
    reducer: ee.Reducer.count(),
    geometry: line,
    scale: 30
  }).get('classification');
  // Asynchronously evaluate the mean elevation.
  elevation.evaluate(showElevation);
}, 10);
// Set the callback function on changes of the geometry layer.
Map.drawingTools().onEdit(getAverageElevation);
Map.drawingTools().onDraw(getAverageElevation);
Map.drawingTools().onErase(getAverageElevation);
// Set the label to the result of the mean reduction.
function showElevation(elevation) {
  inspector.clear();
  var elevationLabel = ui.Label('Number of iceberg: ' + elevation);
  inspector.add(elevationLabel);
}
/////////////////////////////////////////////////////
var rgbVis_natural_color = {
  min: 0,
  max: 1500,
  bands: ['B4', 'B3', 'B2'],
};
// задаю дату для поиска
var startDate = '2021-02-01';
var endDate = '2021-03-10';
var cloud_treshold = 30;
var collectionS2 = ee.ImageCollection('COPERNICUS/S2_SR');
function maskS2clouds(image) {
  var qa = image.select('QA60');
  // Bits 10 and 11 are clouds and cirrus, respectively.
  var cloudBitMask = 1 << 10;
  var cirrusBitMask = 1 << 11;
  // Both flags should be set to zero, indicating clear conditions.
  var mask = qa.bitwiseAnd(cloudBitMask).eq(0)
      .and(qa.bitwiseAnd(cirrusBitMask).eq(0));
  return image.updateMask(mask);}
  var dataset_S2 = collectionS2
                  .filterBounds(geometry)
                  .filterDate(startDate, endDate)
                  .filter(ee.Filter.lt('CLOUDY_PIXEL_PERCENTAGE', cloud_treshold)) // отфильтруем снимки по проценту облачности
                  .map(maskS2clouds) // применим маску облачных пикселей
                  .select(['B2', 'B3', 'B4', 'B5', 'B6', 'B7', 'B8', 'B8A', 'B11', 'B12']);
//print('Number of S2 Scenes', dataset_S2.size());
var rgbVis_natural_color = {
  min: 0,
  max: 1500,
  bands: ['B4', 'B3', 'B2'],
};
Map.addLayer(dataset_S2, rgbVis_natural_color, 'S2 natural color',false);
////////////////////////////////////////////////////////////////////////////////////////////////////
var imgVV = ee.ImageCollection('COPERNICUS/S1_GRD')
        .filter(ee.Filter.listContains('transmitterReceiverPolarisation', 'HH'))
        .filter(ee.Filter.eq('instrumentMode', 'EW'))
        .filterDate('2020-03-01', '2020-04-20')
        .select('HH')
        .map(function(image) {
          var edge = image.lt(-30.0);
          var maskedImage = image.mask().and(edge.not());
          return image.updateMask(maskedImage);
        });
var desc = imgVV.filter(ee.Filter.eq('orbitProperties_pass', 'DESCENDING'));
var asc = imgVV.filter(ee.Filter.eq('orbitProperties_pass', 'ASCENDING'));
var spring = ee.Filter.date('2015-03-01', '2015-04-20');
var lateSpring = ee.Filter.date('2015-04-21', '2015-06-10');
var summer = ee.Filter.date('2015-06-11', '2015-08-31');
var descChange = ee.Image.cat(
      //  desc.filter(spring).mean(),
       // desc.filter(lateSpring).mean(),
        desc.filter(summer).mean());
var ascChange = ee.Image.cat(
        asc.filter(spring).mean(),
        asc.filter(lateSpring).mean(),
        asc.filter(summer).mean());
//Map.centerObject(geometry,8);
//Map.addLayer(ascChange, {min: -25, max: 5}, 'Multi-T Mean ASC', false);
//Map.addLayer(descChange, {min: -25, max: 5}, 'Multi-T Mean DESC', false);
//Map.addLayer (imgVV, {min: -25, max: 5},'duPolarization',false)
var polygons=other12.merge(iceberg);
//var start = ee.Date.fromYMD(2021,5,1);
//var finish = ee.Date.fromYMD(2021,8,1);
var image = ee.Image(dataset_S2.filterBounds(geometry).sort('CLOUDY_PIXEL_PERCENTAGE').min());
var bands = ['B5'];
var image = image.select(bands);
var training = image.sampleRegions({
  collection: polygons,
  properties: ['class'],
  scale: 30
});
var classifier = ee.Classifier.smileRandomForest({
    numberOfTrees: 30,
});
var trained = classifier.train(training, 'class', bands);
var classified = image.classify(trained);
var palette = [
  '#858b45', 
  '#27c8ff' 
 ]; 
Map.addLayer(classified.clip(geometry),{min: 0, max: 1, palette: palette},'Binary class',false);
//Map.centerObject(road, 12);
var bufferLine = road.buffer({'distance': 100})
//Map.addLayer (bufferLine,{},'Bufer',false)
var icebergR = classified.updateMask(classified.select('classification')).gte(0.9) // костыль, значения 1 и 0
Map.addLayer (icebergR,{},'iceberg',false)
/*var reprojected = icebergR
    .unitScale(-2000, 10000)
    .reproject('EPSG:6069', null, 500);
*/
//var icebergV = icebergR.reduceToVectors()
var vectors = icebergR.reduceToVectors({
  geometry: geometry,
  crs: icebergR.projection(),
  scale: 1000,
  geometryType: 'polygon',
  eightConnected: false,
  labelProperty: 'zone',
  //reducer: ee.Reducer.mean()
});
//Map.addLayer(vectors)
//print (vectors)
print(icebergR)
var intersect_iceberg_road = bufferLine.intersection(vectors,100)
//print (intersect_iceberg_road)
//////////////////////////////////////////////////////////////