var geometry = ui.import && ui.import("geometry", "geometry", {
      "geometries": [
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                -3.4559831881671244,
                38.790676765218386
              ],
              [
                -3.455558661742657,
                38.79057185245293
              ],
              [
                -3.4555525630419197,
                38.78975194370313
              ],
              [
                -3.4546992573202715,
                38.7896785821911
              ],
              [
                -3.453867411022202,
                38.789642846894424
              ],
              [
                -3.453183085653677,
                38.78960710624359
              ],
              [
                -3.452855093458993,
                38.789299206709366
              ],
              [
                -3.452615996670829,
                38.78911180564677
              ],
              [
                -3.4523017987381763,
                38.78911674513541
              ],
              [
                -3.4521994938845637,
                38.78920740141091
              ],
              [
                -3.4522044771764513,
                38.78943186009058
              ],
              [
                -3.4523539191142163,
                38.78985568917705
              ],
              [
                -3.4508518820658765,
                38.7896215365693
              ],
              [
                -3.4510450011149487,
                38.78915322904651
              ],
              [
                -3.4520749693766675,
                38.78851766391635
              ],
              [
                -3.452783072556599,
                38.7884005855112
              ],
              [
                -3.4537486678019604,
                38.78831695796123
              ],
              [
                -3.454306567277058,
                38.78836713450297
              ],
              [
                -3.4564737921610913,
                38.78873509473009
              ],
              [
                -3.45675274189864,
                38.78799917237668
              ],
              [
                -3.4569458609477124,
                38.78783191623687
              ],
              [
                -3.4576110487834057,
                38.78727996819157
              ],
              [
                -3.4561948424235425,
                38.786326593321185
              ],
              [
                -3.4546498900309643,
                38.78538993191055
              ],
              [
                -3.4519247656718335,
                38.784921596590785
              ],
              [
                -3.4474830275431714,
                38.784386352458455
              ],
              [
                -3.446646178330525,
                38.783984916722375
              ],
              [
                -3.4453372603312573,
                38.78341621222742
              ],
              [
                -3.444800818528279,
                38.783048224548935
              ],
              [
                -3.443792307938679,
                38.7827471423085
              ],
              [
                -3.442247355546101,
                38.78247951258309
              ],
              [
                -3.4415821677104077,
                38.781994431145485
              ],
              [
                -3.44102426823531,
                38.784135455388274
              ],
              [
                -3.441324675644978,
                38.78457034308214
              ],
              [
                -3.441346133317097,
                38.78538993191055
              ],
              [
                -3.441002810563191,
                38.78751412849026
              ],
              [
                -3.441045725907429,
                38.789034724037165
              ],
              [
                -3.44102426823531,
                38.79035601455372
              ],
              [
                -3.4423062296965554,
                38.790782501834016
              ],
              [
                -3.4427353831389382,
                38.790857764030385
              ],
              [
                -3.4428802224257424,
                38.790953932276764
              ],
              [
                -3.443035790548606,
                38.79103755673336
              ],
              [
                -3.443320104704185,
                38.79127170468995
              ],
              [
                -3.443743893728538,
                38.79180271595589
              ],
              [
                -3.444099770769526,
                38.79208916952447
              ],
              [
                -3.444700585588862,
                38.79242366143519
              ],
              [
                -3.4451565611213937,
                38.79260345018865
              ],
              [
                -3.445049272760798,
                38.79290867191772
              ],
              [
                -3.4442177879661813,
                38.79275815177632
              ],
              [
                -3.4438422787040963,
                38.79227314026962
              ],
              [
                -3.4435311424583688,
                38.79220206071983
              ],
              [
                -3.4436657925443797,
                38.79294043839509
              ],
              [
                -3.443805267413154,
                38.79364704227336
              ],
              [
                -3.4435745974378733,
                38.793797560537676
              ],
              [
                -3.443456580241218,
                38.793437988601134
              ],
              [
                -3.44290940960218,
                38.79346307507418
              ],
              [
                -3.442737748225227,
                38.792764831610825
              ],
              [
                -3.4422978659467844,
                38.793107682549326
              ],
              [
                -3.441804339488044,
                38.79348816153839
              ],
              [
                -3.441310813029304,
                38.793667947606856
              ],
              [
                -3.441434658643402,
                38.79409669774845
              ],
              [
                -3.4402008424965516,
                38.794539886709856
              ],
              [
                -3.4393747221199646,
                38.79470712711122
              ],
              [
                -3.438387669202484,
                38.79519212205607
              ],
              [
                -3.4372504125801697,
                38.79560185659285
              ],
              [
                -3.4363277326790467,
                38.79577745638756
              ],
              [
                -3.4363062750069275,
                38.79630425317584
              ],
              [
                -3.433794870769816,
                38.797091184175876
              ],
              [
                -3.434274917619632,
                38.7974749224512
              ],
              [
                -3.4352405128649934,
                38.79744147570123
              ],
              [
                -3.4352190551928743,
                38.79782611237814
              ],
              [
                -3.4352190551928743,
                38.79812713093812
              ],
              [
                -3.43632412530701,
                38.79810204610668
              ],
              [
                -3.4363133964709505,
                38.798963286933514
              ],
              [
                -3.4351332245043977,
                38.79890475633318
              ],
              [
                -3.435176139848636,
                38.799289385112544
              ],
              [
                -3.4352834282092317,
                38.79957367461521
              ],
              [
                -3.4358091411761507,
                38.7999833839623
              ],
              [
                -3.4359915313891634,
                38.80025930933806
              ],
              [
                -3.43632724591248,
                38.80038781342081
              ],
              [
                -3.437453773698735,
                38.80061356934464
              ],
              [
                -3.4387090475177047,
                38.80091457613054
              ],
              [
                -3.43882706471436,
                38.800697182468284
              ],
              [
                -3.440103796205449,
                38.80087276970855
              ],
              [
                -3.4400930673693892,
                38.801583475547
              ],
              [
                -3.4413376123522994,
                38.80159183674998
              ],
              [
                -3.441401985368657,
                38.801984812182994
              ],
              [
                -3.442646530351567,
                38.801917922900635
              ],
              [
                -3.4424319536303756,
                38.80064701460586
              ],
              [
                -3.4421100885485885,
                38.79984496718943
              ],
              [
                -3.4402166084115606,
                38.799504216402575
              ],
              [
                -3.4401200488870245,
                38.798684789843094
              ],
              [
                -3.440881796247254,
                38.79848411251471
              ],
              [
                -3.441107101804505,
                38.79805767131558
              ],
              [
                -3.44148261106659,
                38.79823326505953
              ],
              [
                -3.4412894920175177,
                38.798969081757654
              ],
              [
                -3.441707916623841,
                38.799052696810826
              ],
              [
                -3.4421370700662237,
                38.7991530347451
              ],
              [
                -3.442383833295594,
                38.79925337253812
              ],
              [
                -3.4426413253610235,
                38.799228288103095
              ],
              [
                -3.4429631904428106,
                38.798969081757654
              ],
              [
                -3.4434459880654913,
                38.79779009906427
              ],
              [
                -3.443252869016419,
                38.79738873880365
              ],
              [
                -3.444776363736878,
                38.797246589835986
              ],
              [
                -3.4456561282937628,
                38.79643549912569
              ],
              [
                -3.4460852817361456,
                38.79609266419442
              ],
              [
                -3.446675367719422,
                38.79601740752534
              ],
              [
                -3.44697577512909,
                38.795950512641674
              ],
              [
                -3.4477589801614386,
                38.79508087344053
              ],
              [
                -3.4479413703744513,
                38.79508087344053
              ],
              [
                -3.4500549510781866,
                38.7961846444598
              ],
              [
                -3.451042003995667,
                38.79651075535329
              ],
              [
                -3.452865906125794,
                38.79706263192756
              ],
              [
                -3.453413076764832,
                38.79718805782572
              ],
              [
                -3.4537242130105597,
                38.79609266419442
              ],
              [
                -3.4540568069284063,
                38.79620136813167
              ],
              [
                -3.4544001296823126,
                38.79648566995293
              ],
              [
                -3.4543250278298956,
                38.79728003667743
              ],
              [
                -3.4550975040261847,
                38.79733856861215
              ],
              [
                -3.455440826780091,
                38.797422185578384
              ],
              [
                -3.4557791922168235,
                38.79408656591032
              ],
              [
                -3.4557791922168235,
                38.79336742313917
              ],
              [
                -3.454438087709377,
                38.79325035269902
              ],
              [
                -3.4543844435290794,
                38.79302457344999
              ],
              [
                -3.4531613562182883,
                38.792982762399475
              ],
              [
                -3.4522417731866426,
                38.79210825943797
              ],
              [
                -3.4522417731866426,
                38.791840664850916
              ],
              [
                -3.4536365218743867,
                38.79191592593007
              ],
              [
                -3.4537116237268037,
                38.79132219747987
              ],
              [
                -3.4539476581201143,
                38.790837176202686
              ],
              [
                -3.4559646792993135,
                38.7908957134285
              ]
            ]
          ],
          "evenOdd": true
        }
      ],
      "displayProperties": [],
      "properties": {},
      "color": "#d63000",
      "mode": "Geometry",
      "shown": true,
      "locked": false
    }) || /* color: #d63000 */ee.Geometry.Polygon(
        [[[-3.4559831881671244, 38.790676765218386],
          [-3.455558661742657, 38.79057185245293],
          [-3.4555525630419197, 38.78975194370313],
          [-3.4546992573202715, 38.7896785821911],
          [-3.453867411022202, 38.789642846894424],
          [-3.453183085653677, 38.78960710624359],
          [-3.452855093458993, 38.789299206709366],
          [-3.452615996670829, 38.78911180564677],
          [-3.4523017987381763, 38.78911674513541],
          [-3.4521994938845637, 38.78920740141091],
          [-3.4522044771764513, 38.78943186009058],
          [-3.4523539191142163, 38.78985568917705],
          [-3.4508518820658765, 38.7896215365693],
          [-3.4510450011149487, 38.78915322904651],
          [-3.4520749693766675, 38.78851766391635],
          [-3.452783072556599, 38.7884005855112],
          [-3.4537486678019604, 38.78831695796123],
          [-3.454306567277058, 38.78836713450297],
          [-3.4564737921610913, 38.78873509473009],
          [-3.45675274189864, 38.78799917237668],
          [-3.4569458609477124, 38.78783191623687],
          [-3.4576110487834057, 38.78727996819157],
          [-3.4561948424235425, 38.786326593321185],
          [-3.4546498900309643, 38.78538993191055],
          [-3.4519247656718335, 38.784921596590785],
          [-3.4474830275431714, 38.784386352458455],
          [-3.446646178330525, 38.783984916722375],
          [-3.4453372603312573, 38.78341621222742],
          [-3.444800818528279, 38.783048224548935],
          [-3.443792307938679, 38.7827471423085],
          [-3.442247355546101, 38.78247951258309],
          [-3.4415821677104077, 38.781994431145485],
          [-3.44102426823531, 38.784135455388274],
          [-3.441324675644978, 38.78457034308214],
          [-3.441346133317097, 38.78538993191055],
          [-3.441002810563191, 38.78751412849026],
          [-3.441045725907429, 38.789034724037165],
          [-3.44102426823531, 38.79035601455372],
          [-3.4423062296965554, 38.790782501834016],
          [-3.4427353831389382, 38.790857764030385],
          [-3.4428802224257424, 38.790953932276764],
          [-3.443035790548606, 38.79103755673336],
          [-3.443320104704185, 38.79127170468995],
          [-3.443743893728538, 38.79180271595589],
          [-3.444099770769526, 38.79208916952447],
          [-3.444700585588862, 38.79242366143519],
          [-3.4451565611213937, 38.79260345018865],
          [-3.445049272760798, 38.79290867191772],
          [-3.4442177879661813, 38.79275815177632],
          [-3.4438422787040963, 38.79227314026962],
          [-3.4435311424583688, 38.79220206071983],
          [-3.4436657925443797, 38.79294043839509],
          [-3.443805267413154, 38.79364704227336],
          [-3.4435745974378733, 38.793797560537676],
          [-3.443456580241218, 38.793437988601134],
          [-3.44290940960218, 38.79346307507418],
          [-3.442737748225227, 38.792764831610825],
          [-3.4422978659467844, 38.793107682549326],
          [-3.441804339488044, 38.79348816153839],
          [-3.441310813029304, 38.793667947606856],
          [-3.441434658643402, 38.79409669774845],
          [-3.4402008424965516, 38.794539886709856],
          [-3.4393747221199646, 38.79470712711122],
          [-3.438387669202484, 38.79519212205607],
          [-3.4372504125801697, 38.79560185659285],
          [-3.4363277326790467, 38.79577745638756],
          [-3.4363062750069275, 38.79630425317584],
          [-3.433794870769816, 38.797091184175876],
          [-3.434274917619632, 38.7974749224512],
          [-3.4352405128649934, 38.79744147570123],
          [-3.4352190551928743, 38.79782611237814],
          [-3.4352190551928743, 38.79812713093812],
          [-3.43632412530701, 38.79810204610668],
          [-3.4363133964709505, 38.798963286933514],
          [-3.4351332245043977, 38.79890475633318],
          [-3.435176139848636, 38.799289385112544],
          [-3.4352834282092317, 38.79957367461521],
          [-3.4358091411761507, 38.7999833839623],
          [-3.4359915313891634, 38.80025930933806],
          [-3.43632724591248, 38.80038781342081],
          [-3.437453773698735, 38.80061356934464],
          [-3.4387090475177047, 38.80091457613054],
          [-3.43882706471436, 38.800697182468284],
          [-3.440103796205449, 38.80087276970855],
          [-3.4400930673693892, 38.801583475547],
          [-3.4413376123522994, 38.80159183674998],
          [-3.441401985368657, 38.801984812182994],
          [-3.442646530351567, 38.801917922900635],
          [-3.4424319536303756, 38.80064701460586],
          [-3.4421100885485885, 38.79984496718943],
          [-3.4402166084115606, 38.799504216402575],
          [-3.4401200488870245, 38.798684789843094],
          [-3.440881796247254, 38.79848411251471],
          [-3.441107101804505, 38.79805767131558],
          [-3.44148261106659, 38.79823326505953],
          [-3.4412894920175177, 38.798969081757654],
          [-3.441707916623841, 38.799052696810826],
          [-3.4421370700662237, 38.7991530347451],
          [-3.442383833295594, 38.79925337253812],
          [-3.4426413253610235, 38.799228288103095],
          [-3.4429631904428106, 38.798969081757654],
          [-3.4434459880654913, 38.79779009906427],
          [-3.443252869016419, 38.79738873880365],
          [-3.444776363736878, 38.797246589835986],
          [-3.4456561282937628, 38.79643549912569],
          [-3.4460852817361456, 38.79609266419442],
          [-3.446675367719422, 38.79601740752534],
          [-3.44697577512909, 38.795950512641674],
          [-3.4477589801614386, 38.79508087344053],
          [-3.4479413703744513, 38.79508087344053],
          [-3.4500549510781866, 38.7961846444598],
          [-3.451042003995667, 38.79651075535329],
          [-3.452865906125794, 38.79706263192756],
          [-3.453413076764832, 38.79718805782572],
          [-3.4537242130105597, 38.79609266419442],
          [-3.4540568069284063, 38.79620136813167],
          [-3.4544001296823126, 38.79648566995293],
          [-3.4543250278298956, 38.79728003667743],
          [-3.4550975040261847, 38.79733856861215],
          [-3.455440826780091, 38.797422185578384],
          [-3.4557791922168235, 38.79408656591032],
          [-3.4557791922168235, 38.79336742313917],
          [-3.454438087709377, 38.79325035269902],
          [-3.4543844435290794, 38.79302457344999],
          [-3.4531613562182883, 38.792982762399475],
          [-3.4522417731866426, 38.79210825943797],
          [-3.4522417731866426, 38.791840664850916],
          [-3.4536365218743867, 38.79191592593007],
          [-3.4537116237268037, 38.79132219747987],
          [-3.4539476581201143, 38.790837176202686],
          [-3.4559646792993135, 38.7908957134285]]]);
//First variables to choose dates of calculated imags and NDVI chart
var fechaInicioNDVI = '2019-07-01';
var fechaFinNDVI = '2019-07-30';
var fechaInicioChart = '2016-01-01';
var fechaFinChart =  new Date()-3;
//GEOMETRY CALCULATIONS AND functions
//The first step is on imports
// Create a planar polygon.
var planarPolygon = ee.Geometry(geometry, null, false);
// Display the polygons by adding them to the map.
Map.centerObject(geometry);
//Map.addLayer(geometry, {color: 'FF0000'}, 'geodesic polygon');
Map.addLayer(planarPolygon, {color: '000000'}, 'Área de estudio');
print('Polygon printout: ', geometry);
// Print polygon area in square kilometers.
print('Polygon area: ', geometry.area().divide(10000));
// Print polygon perimeter length in kilometers.
print('Polygon perimeter: ', geometry.perimeter().divide(1000));
// Print the geometry as a GegeometrygeometryoJSON string.
print('Polygon GeoJSON: ', geometry.toGeoJSONString());
// Print the GeoJSON 'type'.
print('Geometry type: ', geometry.type());
// Print the coordinates as lists.
print('Polygon coordinates: ', geometry.coordinates());
// Print whether the geometry is geodesic.
print('Geodesic? ', geometry.geodesic());
/*
// Compute a buffer of the polygon.
var buffer = polygon.buffer(1000000);
// Compute the centroid of the polygon.
var centroid = polygon.centroid();
Map.addLayer(buffer, {}, 'buffer');
Map.addLayer(centroid, {}, 'centroid');
// Display polygon 1 in red and polygon 2 in blue.
Map.setCenter(-45, 30);
Map.addLayer(poly1, {color: 'FF0000'}, 'poly1');
Map.addLayer(poly2, {color: '0000FF'}, 'poly2');
// Compute the intersection, display it in blue.
var intersection = poly1.intersection(poly2, ee.ErrorMargin(1));
Map.addLayer(intersection, {color: '00FF00'}, 'intersection');
// Compute the union, display it in magenta.
var union = poly1.union(poly2, ee.ErrorMargin(1));
Map.addLayer(union, {color: 'FF00FF'}, 'union');
// Compute the difference, display in yellow.
var diff1 = poly1.difference(poly2, ee.ErrorMargin(1));
Map.addLayer(diff1, {color: 'FFFF00'}, 'diff1');
// Compute symmetric difference, display in black.
var symDiff = poly1.symmetricDifference(poly2, ee.ErrorMargin(1));
Map.addLayer(symDiff, {color: '000000'}, 'symmetric difference');
*/
// Load the FeatureCollection Sentinel 2.
var s2 = ee.ImageCollection('COPERNICUS/S2')
          .filterBounds(geometry)
          .filterDate(fechaInicioNDVI,fechaFinNDVI );
print(s2);
// Function to mask clouds using the Sentinel-2 QA band..
function maskS2clouds(image) {
  // get date of the image to pass it through
  var date = image.date().millis();
  var qa = image.select('QA60');
  // Bits 10 and 11 are clouds and cirrus, respectively.
  var cloudBitMask = ee.Number(2).pow(10).int();
  var cirrusBitMask = ee.Number(2).pow(11).int();
  // Both flags should be set to zero, indicating clear conditions.
  var mask = qa.bitwiseAnd(cloudBitMask).eq(0).and(
             qa.bitwiseAnd(cirrusBitMask).eq(0));
  // Return the masked and scaled data.
  return image.updateMask(mask).divide(10000).set('system:time_start', date);
}
var imagenes=s2.map(maskS2clouds);
// Display the results on the geometry we are working on.
Map.centerObject(geometry);
//Create the palettes to paint layers in the map.addlayer
var ndviPalette = ['b5b1ae', 'CE7E45', 'DF923D', 'F1B555', 'FCD163', '99B718',
  '74A901', '66A000', '529400', '3E8601', '207401', '056201',
  '004C00', '023B01', '012E01', '011D01', '011301'];
var ndwiPalette = ['#eff3ff', '#c6dbef', '#9ecae1', '#6baed6', '#4292c6', '#2171b5', '#084594', '#002556'];
//New variables to know how many images we have for the choosen dates and list them for the loop, try to change GETINFO
print (imagenes);
var list=imagenes.toList(imagenes.size());
var max=ee.Number(imagenes.size());
var maximo = max.getInfo();
//maximum of 149 images to not saturate the server and machine.
if(maximo>149) maximo=149;
var cuenta =0;
//Here starts the loop to calculate each image from the collection with mask clouds of S2 collection
for (var i=0;i<maximo;i++){
    var AuxImg = list.get(i);
    var image = ee.Image(AuxImg);
    var clip=image.clip(geometry);
    if(i===0){
      var dateAnt = 0;
    }else{
      var dateAnt = date;  
    }
    //Try to optimize the code taking GETINFO out or changing it.
    var date = clip.date().format('yyyy-MM-dd').getInfo();
    if(date==dateAnt){
    }else{
      //Now we already have the images in order to be calculated with all the indexes we want to use.
      //At the beginning using the clip image from the general image we collect with all the data about date and bands
      //NDVI: calculate, give name, visualize and export to task menu
        image=clip.addBands(clip.normalizedDifference(['B8','B4']).rename('Vigorosidad_Cultivo'));
        var nameVigorosidad_Cultivo= 'Vigorosidad_Cultivo_'+cuenta.toString()+'_'+(date);
        var NDVI=image.addBands('Vigorosidad_Cultivo');
        Map.addLayer(image.select(['Vigorosidad_Cultivo']), {min:0, max: 1,palette: ndviPalette},nameVigorosidad_Cultivo, false);
        /*Export.image.toDrive({ 
                   image: image.select(['Vigorosidad_Cultivo']),
                   description: nameVigorosidad_Cultivo,
                   fileNamePrefix: nameVigorosidad_Cultivo,
                   scale: 10,
                   region:geometry,
                   });*/
        //NDWI: calculate reusing the image already we use in NDVI calculation (as a clip, because it contains all bands) , give name, visualize and export to task menu.        
        image=image.addBands(image.normalizedDifference(['B8A','B11']).rename('Estrés_hídrico'));
        var nameEstrés_hídrico= 'Estrés_hídrico_'+cuenta.toString()+'_'+date;
        Map.addLayer(image.select(['Estrés_hídrico']), {min:0, max: 1,palette: ndwiPalette},nameEstrés_hídrico, false);
        /*Export.image.toDrive({ 
                     image: image.select(['Estrés_hídrico']),
                     description: nameEstrés_hídrico,
                     fileNamePrefix: nameEstrés_hídrico,
                     scale: 30,
                     region:geometry,
                     });*/
        /*//NDRE: calculate reusing the image already we use in NDWI calculation (as a clip, because it contains all bands) , give name, visualize and export to task menu.            
        image=image.addBands(image.normalizedDifference(['B8','B5']).rename('NDRE'));
        var nameNDRE= 'NDRE_'+cuenta.toString()+'_'+date;
        Map.addLayer(image.select(['NDRE']), {min:0, max: 1,palette: ndviPalette},nameNDRE);
        Export.image.toDrive({ 
                   image: image.select(['NDRE']),
                   description: nameNDRE,
                   fileNamePrefix: nameNDRE,
                   scale: 10,
                   region:geometry,
                   });
        //MSAVI2: calculate reusing the image already we use in NDRE calculation (as a clip, because it contains all bands) , give name, visualize and export to task menu.
        image=image.addBands((image.select('B8').multiply(2).add(1).subtract(image.select('B8').multiply(2).add(1).pow(2).subtract(image.select('B8').subtract(image.select('B4')).multiply(8)).sqrt()).divide(2)).rename('MSAVI2'));
        var nameMSAVI2= 'MSAVI2_'+cuenta.toString()+'_'+date;
        Map.addLayer(image.select(['MSAVI2']), {min:0, max: 1,palette: ndviPalette},nameMSAVI2);
        Export.image.toDrive({ 
             image: image.select(['MSAVI2']),
             description: nameMSAVI2,
             fileNamePrefix: nameMSAVI2,
             scale: 10,
             region:geometry,
             });
        */
        //Calculate statistics of indexes
        var maxIndex = image.reduceRegion({
          reducer: ee.Reducer.max(),
          geometry: geometry,
          scale: 10,
          maxPixels: 1e9
        });
        var minIndex = image.reduceRegion({
          reducer: ee.Reducer.min(),
          geometry: geometry,
          scale: 10,
          maxPixels: 1e9
        });
        var meanIndex = image.reduceRegion({
          reducer: ee.Reducer.mean(),
          geometry: geometry,
          scale: 10,
          maxPixels: 1e9
        });
        print('maxIndex',maxIndex);
        print('minIndex',minIndex);
        print('meanIndex',meanIndex);
        /*
        var has = geometry.reduceRegion({
          reducer: ee.Reducer.max(area),
          geometry: geometry,
          scale: 10,
          maxPixels: 1e9
        });
        print('area',has);
        */
        /*var pairwisediff= function(image){
          var index = NDVIlist.indexOf(image);
          if (index !== 0) {
          var previousimage=NDVIlist.get(index.add(-1));
          var diff = image.subtract(previousimage);
          return diff;}
          };
        var S2_collection_dNDVI = S2collection_NDVI.map(pairwisediff);
*/
        //Calculate Kc from NDVI proposed formulation Calera et al,2014.
        var Kc = (ee.Number(meanIndex.get('Vigorosidad_Cultivo'))).multiply(1.25).add(0.1);
        //var Kc = ((ee.Number(meanIndex.get('Vigorosidad_Cultivo')).subtract(ee.Number(minIndex.get('Vigorosidad_Cultivo')))).divide((ee.Number(maxIndex.get('Vigorosidad_Cultivo'))).subtract(ee.Number(minIndex.get('Vigorosidad_Cultivo'))))).multiply(1.20);
        print('Kc value',Kc);
        //Every time we calculate we visualize and export tehn we are using less cache and computer resources for the executed of the code.
        //with that "cuenta" we get the number of calculated images for each index.
        cuenta++;
    }
}
//Here it give us the info of cuenta
print("Al final tengo " + cuenta + " imágenes");
/////////////////////////////////////////////////////////////////////////////////////////
//APP DEVELOPMENT
//center Button for the geometry
var button = ui.Button({
  style: {
    position:('top-left'),
    fontFamily:('monospace'),
    color:('#009639'),
    backgroundColor:('#8f8f8f'),
    padding:('3px 3px 3px 3px' ),
    //height:('500'),
    //fontWeight: ('100'),
    //fontSize :('6px'),
    //whiteSpace:('pre'),
    //border:('1px solid black'),
    //shown: (false)
    },
  label: 'Centrar Mapa',
  onClick: function() {
    print(Map.centerObject(geometry));
  }
});
//print(button);
Map.add(button);
// Create a panel, initially hidden.
var panel = ui.Panel({
  style: {
    width: '400px',
    shown: false
  },
  widgets: [
    ui.Label('Haz click en el mapa para cerrar el panel.')
  ]
});
//Let´s create and obtain the data for NDVI over time chart
var getdata= ee.ImageCollection ('COPERNICUS/S2') 
                .filterDate (fechaInicioChart, fechaFinChart)
                .filterBounds (geometry) 
                .filterMetadata ('CLOUDY_PIXEL_PERCENTAGE', 'Less_Than', 20);
//Calculations for NDVI
var withNDVI = getdata.map(function(image) {
  var ndvi = image.normalizedDifference(['B8', 'B4']).rename('NDVI');
  return image.addBands(ndvi);
});
var chart1 = ui.Chart.image.doySeriesByYear({
      imageCollection: withNDVI.select ('NDVI'),
      bandName: ('NDVI'),
      region: geometry,
      regionReducer: ee.Reducer.mean(),
      scale: 30,
      //startDay:fechaInicioChart,
      //endDay:fechaFinChart,
    }).setOptions({
      title: 'Histórico NDVI',
      hAxis: {title: 'Línea Temporal (día)', gridlines: {count: 7}},
      vAxis: {title: 'Valor NDVI'},
      interpolateNulls: true,
    });
    chart1.style().set({
            width: '450px',
            height: '340px'
        });
  //we finally add the chart to the panel   
  panel.add(chart1);
//ADD CHART POINT ANALYSIS TO THE PANEL!!!
// Create an intro panel with labels.
var intro = ui.Panel([
  ui.Label({
    value: 'Image Inspector',
    style: {fontSize: '20px', fontWeight: 'bold'}
  }),
  ui.Label('Hacer Click en un punto del mapa para inspeccionar.')
]);
panel.add(intro);
// Create panels to hold lon/lat values.
var lon = ui.Label();
var lat = ui.Label();
panel.add(ui.Panel([lon, lat], ui.Panel.Layout.flow('horizontal')));
// Register a callback on the default map to be invoked when the map is clicked.
Map.onClick(function(coords) {
  // Update the lon/lat panel with values from the click event.
  //lon.setValue('lon: ' + coords.lon.toFixed(2));
  lat.setValue('lat: ' + coords.lat.toFixed(2));
  // Add a red dot for the point clicked on.
  var point = ee.Geometry.Point(coords.lon, coords.lat);
  var dot = ui.Map.Layer(point, {color: 'FF0000'});
  Map.layers().set(2, dot);
  // Create an NDVI chart.
  var ndviChart = ui.Chart.image.seriesByRegion({
      imageCollection: withNDVI.select ('NDVI'),
      band: ('NDVI'),
      regions: point,
      reducer: ee.Reducer.mean(),
      scale: 10,
  });
  ndviChart.setOptions({
    title: 'Histórico NDVI de un punto',
    vAxis: {title: 'NDVI'},
    hAxis: {title: 'Fecha', format: 'MM-yy', gridlines: {count: 7}},
    interpolateNulls: true,
  });
  panel.widgets().set(2, ndviChart);
});
  //CHIRPS Precipitation chart
  var prec = ee.ImageCollection('UCSB-CHG/CHIRPS/DAILY')
  .filterDate(fechaInicioChart, fechaFinChart)
  .select(['precipitation'])
  .filterBounds(geometry);
  // .map(function (img) {
  //   return img.clip(g).multiply(30)
  //   .set('system:time_start', img.get('system:time_start')). select(['precipitation']);
  //   })
  //   .sort('system:time_start', true);
  Map.style().set('cursor', 'crosshair');
  // Create prec chart.
  var precChart = ui.Chart.image.series(prec, geometry)
      .setOptions({
        title: 'Precipitación',
        vAxis: {title: 'Prec. (mm)'},
        hAxis: {title: 'Fecha', format: 'MM-yy', gridlines: {count: 7}},
        colors: ['#000099'],
      });
  //panel.widgets().set(3, GSMapChart);
  panel.add(precChart);
  //MODIS Temp chart
  var temp1 = ee.ImageCollection('MODIS/006/MOD11A2')
    .select(['LST_Day_1km'])
    .filterDate(fechaInicioChart, fechaFinChart)
    .map(function (img) {
    return img.clip(geometry).multiply(0.02).subtract(273.15)
    .set('system:time_start', img.get('system:time_start')). select(['LST_Day_1km']);
    })
    .sort('system:time_start', true);
  /*
    var temp2 = ee.ImageCollection('MODIS/006/MOD11A2')
    .select(['LST_Night_1km'])
    .filterDate(fechaInicioChart, fechaFinChart)
    .map(function (img) {
    return img.clip(geometry).multiply(0.02).subtract(273.15)
    .set('system:time_start', img.get('system:time_start')). select(['LST_Night_1km']);
    })
    .sort('system:time_start', true);
var temp=temp1+temp2(2);
print (temp);
*/
    // Create temp chart.
  var TempChart = ui.Chart.image.series(temp1, geometry)
      .setOptions({
        title: 'Temperatura',
        vAxis: {title: 'Temp. °C'},
        hAxis: {title: 'Fecha', format: 'MM-yy', gridlines: {count: 7}},
        colors: ['#000099'],
      });
  //panel.widgets().set(4, TempChart);
  panel.add(TempChart);
Map.style().set('cursor', 'crosshair');
// Create a button to unhide the panel.
var button = ui.Button({
  label: 'Gráficas',
  style: {
    position:('top-left'),
    fontFamily:('monospace'),
    color:('#009639'),
    backgroundColor:('#8f8f8f'),
    padding:('3px 3px 3px 3px' ),
    //height:('500'),
    //fontWeight: ('100'),
    //fontSize :('6px'),
    //whiteSpace:('pre'),
    //border:('1px solid black'),
    //shown: (false)
    },
  onClick: function() {
    // Hide the button.
    button.style().set('shown', false);
    // Display the panel.
    panel.style().set('shown', true);
    // Temporarily make a map click hide the panel
    // and show the button.
    var listenerId = Map.onClick(function() {
      panel.style().set('shown', false);
      button.style().set('shown', true);
      // Once the panel is hidden, the map should not
      // try to close it by listening for clicks.
      Map.unlisten(listenerId);
    });
  }
});
// Add the button to the map and the panel to root.
Map.add(button);
ui.root.insert(0, panel);
/////////////////////////////////////////////////////////////////////////////////////////////////////////
//MEJORAS PARA LA APP and visualization
Map.setOptions('SATELLITE');
// Set position of new panel2 for legend and title of map
var legend = ui.Panel({
style: {
position: 'bottom-left',
padding: '8px 15px'
}
});
// Create legend title for panel2
var legendTitle = ui.Label({
value: 'NDVI',
style: {
fontWeight: 'bold',
fontSize: '15px',
margin: '0 0 4px 0',
padding: '0'
}
});
//Add AGRON logo
/*
var logo = ee.Image("users/agronservice/tif_2");
//Add logo to panel2 we create
var branding = ui.Thumbnail({
  image:logo,
  params:{bands:['b1','b2','b3'],min:0,max:255},
  style:{width:'75px',height:'75px'}});
legend.add(branding);
*/
// Add the title to the panel2
legend.add(legendTitle);
// create vizualization parameters of the panel2
var viz = {min:0, max:1, palette:['b5b1ae', 'CE7E45', 'DF923D', 'F1B555', 'FCD163', '99B718',
  '74A901', '66A000', '529400', '3E8601', '207401', '056201',
  '004C00', '023B01', '012E01', '011D01', '011301']};
// create the legend image of panel2
var lon = ee.Image.pixelLonLat().select('latitude');
var gradient = lon.multiply((viz.max-viz.min)/100.0).add(viz.min);
var legendImage = gradient.visualize(viz);
// create text on top of legend
var panel1 = ui.Panel({
widgets: [
ui.Label(viz['max'])
],
});
legend.add(panel1);
// create thumbnail from the image
var thumbnail = ui.Thumbnail({
image: legendImage,
params: {bbox:'0,0,10,100', dimensions:'10x200'},
style: {padding: '1px', position: 'bottom-center'}
});
// add the thumbnail to the legend
legend.add(thumbnail);
// create text on top of legend
var panel1 = ui.Panel({
widgets: [
ui.Label(viz['min'])
],
});
legend.add(panel1);
Map.add(legend);
//Add text to the map
var label = ui.Label('Developed by AGRON agtech.');
  label.style().set({
    position:('bottom-right'),
    fontFamily:('monospace'),
    color:('#009639'),
    backgroundColor:('#DBDBDB'),
    padding:('3px 3px 3px 3px' ),
    //height:('500'),
    //fontWeight: ('100'),
    //fontSize :('6px'),
    //whiteSpace:('pre'),
    //border:('1px solid black'),
    //shown: (false)
    });
//print(label);
Map.add(label);
//Do a Check Box
/*var checkbox = ui.Checkbox('Mostrar Layers', false);
checkbox.onChange(function(checked) {
  // Shows or hides the first map layer based on the checkbox's value.
  Map.layers().get().setShown(checked);
});
Map.add(checkbox);*/
/*
// CREATE 2 MAPS
var leftMap = ui.Map();
//leftMap.setControlVisibility(false);
var leftSelector = addLayerSelector(leftMap, 0, 'top-left');
var rightMap = ui.Map();
//rightMap.setControlVisibility(false);
var rightSelector = addLayerSelector(rightMap, 1, 'top-right');
function addLayerSelector(mapToChange, defaultValue, position) {
  var label = ui.Label('Selecciona capa para visualizar');
  // This function changes the given map to show the selected image.
  function updateMap(selection) {
    mapToChange.layers().set(0, ui.Map.Layer(images[selection]));
  }
  // Configure a selection dropdown to allow the user to choose between images,
  // and set the map to update when a user makes a selection.
  var select = ui.Select({items: Object.keys(images), onChange: updateMap});
  select.setValue(Object.keys(images)['NDVI'], true);
  var controlPanel =
      ui.Panel({widgets: [label, select], style: {position: position}});
  mapToChange.add(controlPanel);
}
leftMap.setControlVisibility({zoomControl: true});
// Link them together.
var linker = new ui.Map.Linker([leftMap, rightMap]);
// Create a split panel with the two maps.
var splitPanel = ui.SplitPanel({
  firstPanel: leftMap,
  secondPanel: rightMap,
  orientation: 'horizontal',
  wipe: true
});
// Remove the default map from the root panel.
ui.root.clear();
// Add our split panel to the root panel.
ui.root.add(splitPanel);
/*
//===============================Create a slider==========================//
// A helper function to show the image for a given year on the default map.
var showLayer = function(imageNumber) {
  Map.layers().reset();
  var image2 = image.toList(1, imageNumber).get(0);
  Map.addLayer({
    eeObject: ee.Image(image),
    visParams: {
      bands: ['nd'],
      min: 0,
      max: 1,
      palette: ndviPalette
    },
    name: nameVigorosidad_Cultivo + imageNumber
  });
};
print ('hola')
// Create a label and slider.
var label = ui.Label('NDVI');
// Make a slider to step through all the images.
var slider;
s2.size().evaluate(function(size) {
  slider = ui.Slider({
    min: 0,
    max: size-1,
    step: 1,
    onChange: showLayer,
    style: {stretch: 'horizontal'}
  });
  // Create a panel that contains both the slider and the label.
  var panel2 = ui.Panel({
    widgets: [label, slider],
    layout: ui.Panel.Layout.flow('vertical'),
    style: {
      position: 'top-center',
      padding: '7px'
    }
  });
  // Add the panel to the map.
  Map.add(panel2);
  // Set default values on the slider and map.
  slider.setValue(0);
})
*/
/*
//OTRO SLIDER
var dateSliderOne = ui.Panel([ui.DateSlider({
  start: fechaInicioNDVI,
  end: fechaFinNDVI
})]);
Map.add(dateSliderOne)
*/
/*
// Define a function to generate a download URL of the image for the
// viewport region. 
function downloadImg() {
  var viewBounds = ee.Geometry.Rectangle(Map.getBounds());
  var downloadArgs = {
    name: 'ee_image',
    band: (nameVigorosidad_Cultivo),
    scale: 10,
    region: viewBounds.toGeoJSONString()
 };
 var url = image.getDownloadURL(downloadArgs);
 urlLabel.setUrl(url);
 urlLabel.style().set({shown: true});
}
// Add UI elements to the Map.
var downloadButton = ui.Button('Download viewport', downloadImg);
var urlLabel = ui.Label('Download', {shown: false});
var panel = ui.Panel([downloadButton, urlLabel]);
Map.add(panel);
*/
/////////////////////////////STATISTICS///////////////////////////////////////////////////////
// Create a panel, initially hidden.
/*
var panel3 = ui.Panel({
  style: {
    width: '400px',
    shown: false
  },
  widgets: [
    ui.Label('Haz click en el mapa para cerrar el panel.')
  ]
});
var intro3 = ui.Panel([
  ui.Label({
    value: 'Valores Estadísticos de los Índices',
    style: {fontSize: '20px', fontWeight: 'bold'}
  }),
]);
panel3.add(intro3);
var maxIndexl = ui.Label(maxIndex.get('Vigorosidad_Cultivo'));
var minIndexl = ui.Label(minIndex.get('Vigorosidad_Cultivo'));
var meanIndexl = ui.Label(meanIndex.get('Vigorosidad_Cultivo'));
var Kcl = ui.Label(Kc);
var area=ui.Label('Polygon area: ', geometry.area().divide(10000));
panel3.add(ui.Panel([area,maxIndexl,minIndexl,meanIndexl,Kcl], ui.Panel.Layout.flow('horizontal')));
// Create a button to unhide the panel.
var button3 = ui.Button({
  label: 'Valores Estadísticos',
  style: {
    position:('top-left'),
    fontFamily:('monospace'),
    color:('#009639'),
    backgroundColor:('#8f8f8f'),
    padding:('3px 3px 3px 3px' ),
    //height:('500'),
    //fontWeight: ('100'),
    //fontSize :('6px'),
    //whiteSpace:('pre'),
    //border:('1px solid black'),
    //shown: (false)
    },
  onClick: function() {
    // Hide the button.
    button3.style().set('shown', false);
    // Display the panel.
    panel3.style().set('shown', true);
    // Temporarily make a map click hide the panel
    // and show the button.
    var listenerId3 = Map.onClick(function() {
      panel3.style().set('shown', false);
      button3.style().set('shown', true);
      // Once the panel is hidden, the map should not
      // try to close it by listening for clicks.
      Map.unlisten(listenerId3);
    });
  }
});
// Add the button to the map and the panel to root.
Map.add(button3);
ui.root.insert(0, panel3);
*/
/*
// Extracting the series of VI
var ndvis = image.select(['Vigorosidad_Cultivo']);
// Individual differences of composites from the start and the end of time period
var ndvipre = ndvis.filterDate('2019-12-05', '2019-12-10').median();
var ndviactual = ndvis.filterDate('2019-12-10', '2019-12-16');
var difference = ndviactual.subtract(ndvipre);
var differenceLoss= difference.mask(difference.lt(0)).clip(geometry);
var num_differenceLoss=differenceLoss.reduceRegion(ee.Reducer.count(), geometry,250);
print(num_differenceLoss,'NDVI difference');
*/
//////////////////////////////DSM///////////////////////////////////////////////
//Selección de la colección DEM
var DEM = ee.Image("JAXA/ALOS/AW3D30_V1_1");
//Generación de los mapas de pendientes y orientación de laderas
var slope =  ee.Terrain.slope (DEM);
var slope = slope.clip(geometry.buffer(10));
var aspect =  ee.Terrain.aspect (DEM);
var aspect = aspect.clip(geometry.buffer(10));
var DSM = DEM.select('AVE');
var DSM = DSM.clip(geometry.buffer(10));
//Visualización de pendientes
Map.addLayer (slope,{
  min: 0.0,
  max: 90.0,
  palette: [
    '3ae237', 'b5e22e', 'd6e21f', 'fff705', 'ffd611', 'ffb613', 'ff8b13',
    'ff6e08', 'ff500d', 'ff0000', 'de0101', 'c21301', '0602ff', '235cb1',
    '307ef3', '269db1', '30c8e2', '32d3ef', '3be285', '3ff38f', '86e26f'
  ]},
'Pendientes',false);
// Convert to radians, compute the sin of the aspect.
var sinImage = aspect.divide(180).multiply(Math.PI).sin();
// Display the result.
Map.addLayer(sinImage, {min: -1, max: 1}, 'Orientaciones', false);
/*
//Visualización de orientación de laderas
Map.addLayer (aspect,{
  min: 0.0,
  max: 360.0,
  shown:false,
  palette: [
    '3ae237', 'b5e22e', 'd6e21f', 'fff705', 'ffd611', 'ffb613', 'ff8b13',
    'ff6e08', 'ff500d', 'ff0000', 'de0101', 'c21301', '0602ff', '235cb1',
    '307ef3', '269db1', '30c8e2', '32d3ef', '3be285', '3ff38f', '86e26f'
  ]},
'Laderas');
*/
//Visualización de DEM
Map.addLayer (DSM,{
  min: 678.0,
  max: 690.0,
  palette: [
    '709959', '8ead6a', 'acc27a', 'cbd68b', 'ebe89d', 'f2ea9d', 'f2e399',
    'f2dc91', 'f2d38a', 'ebc486', 'e0b484', 'd4a281', 'c9957f', 'c79183',
    'd9a5a5', 'e6bcc7', 'f2d8e6', 'fff2ff'
  ]},
'Modelo Digital del Terreno');
// Load the SRTM image as new DEM.
var srtm = ee.Image('CGIAR/SRTM90_V4');
// Compute the mean elevation in the polygon.
var meanDict = srtm.reduceRegion({
  reducer: ee.Reducer.mean(),
  geometry: planarPolygon,
  scale: 90
});
// Get the mean from the dictionary and print it.
var mean = meanDict.get('elevation');
print('Mean elevation', mean);
var minDict = srtm.reduceRegion({
  reducer: ee.Reducer.min(),
  geometry: planarPolygon,
  scale: 90
});
var min = minDict.get('elevation');
print('Min elevation', min);
var maxDict = srtm.reduceRegion({
  reducer: ee.Reducer.max(),
  geometry: planarPolygon,
  scale: 90
});
var max = maxDict.get('elevation');
print('Max elevation', max);