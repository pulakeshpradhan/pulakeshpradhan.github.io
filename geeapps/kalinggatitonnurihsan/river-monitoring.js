var geometry = ui.import && ui.import("geometry", "geometry", {
      "geometries": [
        {
          "type": "Point",
          "coordinates": [
            106.59753006673247,
            -6.107614473940045
          ]
        }
      ],
      "displayProperties": [],
      "properties": {},
      "color": "#d63000",
      "mode": "Geometry",
      "shown": false,
      "locked": false
    }) || 
    /* color: #d63000 */
    /* shown: false */
    ee.Geometry.Point([106.59753006673247, -6.107614473940045]),
    river = ui.import && ui.import("river", "geometry", {
      "geometries": [
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                106.64361046197226,
                -6.0051512990928675
              ],
              [
                106.64346025826741,
                -6.006196954316263
              ],
              [
                106.64279507043172,
                -6.006922509821961
              ],
              [
                106.64167927148154,
                -6.0073706465630945
              ],
              [
                106.6404132688265,
                -6.007584044881591
              ],
              [
                106.63934038593969,
                -6.007861463378751
              ],
              [
                106.638342603467,
                -6.008405627626932
              ],
              [
                106.63618610741904,
                -6.010977066906101
              ],
              [
                106.63453386666588,
                -6.013196390622062
              ],
              [
                106.63264559151936,
                -6.01479685883615
              ],
              [
                106.63195894601158,
                -6.015537118002655
              ],
              [
                106.63140104653645,
                -6.017329634369359
              ],
              [
                106.63127230050377,
                -6.01929285979784
              ],
              [
                106.63148687722496,
                -6.019911701125708
              ],
              [
                106.63316057565025,
                -6.0217895601505065
              ],
              [
                106.63395796549771,
                -6.022639693384529
              ],
              [
                106.63415108454679,
                -6.023663975785499
              ],
              [
                106.6334858967111,
                -6.024965665215321
              ],
              [
                106.63267050517057,
                -6.026971541176443
              ],
              [
                106.63297091258023,
                -6.028557628213173
              ],
              [
                106.6331640316293,
                -6.029240475916553
              ],
              [
                106.6330567432687,
                -6.030222067984249
              ],
              [
                106.63232718241666,
                -6.032078552472264
              ],
              [
                106.63106789090872,
                -6.034727199138582
              ],
              [
                106.63162579038382,
                -6.034940586710305
              ],
              [
                106.63233389356375,
                -6.033169467319934
              ],
              [
                106.63314928510428,
                -6.031675747673459
              ],
              [
                106.63352202997989,
                -6.030563702503215
              ],
              [
                106.63367223368473,
                -6.029816839605461
              ],
              [
                106.63367223368473,
                -6.028749890824801
              ],
              [
                106.6334147416193,
                -6.027853652227434
              ],
              [
                106.63328599558659,
                -6.027170802778643
              ],
              [
                106.63369369135685,
                -6.025741083962431
              ],
              [
                106.63416576014346,
                -6.024866179545809
              ],
              [
                106.63448762522525,
                -6.023991273719157
              ],
              [
                106.63468126249171,
                -6.0232403192550015
              ],
              [
                106.63450960111477,
                -6.0224294285475874
              ],
              [
                106.63382295560696,
                -6.021511840234267
              ],
              [
                106.63238529157496,
                -6.02014612452542
              ],
              [
                106.63184647128502,
                -6.019243711552704
              ],
              [
                106.63173918292443,
                -6.01768593529419
              ],
              [
                106.63221125171104,
                -6.016448246864777
              ],
              [
                106.6325974898092,
                -6.0155733274818655
              ],
              [
                106.63375620410362,
                -6.014485011162697
              ],
              [
                106.63517622439826,
                -6.013126863698785
              ],
              [
                106.63661388843023,
                -6.011569069915387
              ],
              [
                106.63768677203622,
                -6.009989931938782
              ],
              [
                106.63903860537972,
                -6.008773565778634
              ],
              [
                106.64077667682135,
                -6.008112032164413
              ],
              [
                106.64247183291879,
                -6.007813274784809
              ],
              [
                106.6432846347505,
                -6.007714808057996
              ],
              [
                106.64379961888135,
                -6.007245331759617
              ],
              [
                106.64611704747024,
                -6.006797194915346
              ],
              [
                106.64639599720776,
                -6.006413077326711
              ],
              [
                106.64598830143753,
                -6.00613565889973
              ],
              [
                106.64626725117508,
                -6.005410102345683
              ],
              [
                106.64682515065017,
                -6.0046418649407896
              ],
              [
                106.64192268632425,
                -6.000943644986511
              ],
              [
                106.64200851701275,
                -6.001519827052633
              ],
              [
                106.64187977098004,
                -6.001946628190354
              ],
              [
                106.64228746675028,
                -6.002245388787879
              ],
              [
                106.64228746675028,
                -6.002736209413928
              ],
              [
                106.64271662019269,
                -6.003312389584705
              ],
              [
                106.64325306199564,
                -6.003824549224978
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        }
      ],
      "displayProperties": [],
      "properties": {},
      "color": "#d63000",
      "mode": "Geometry",
      "shown": false,
      "locked": false
    }) || 
    /* color: #d63000 */
    /* shown: false */
    ee.Geometry.Polygon(
        [[[106.64361046197226, -6.0051512990928675],
          [106.64346025826741, -6.006196954316263],
          [106.64279507043172, -6.006922509821961],
          [106.64167927148154, -6.0073706465630945],
          [106.6404132688265, -6.007584044881591],
          [106.63934038593969, -6.007861463378751],
          [106.638342603467, -6.008405627626932],
          [106.63618610741904, -6.010977066906101],
          [106.63453386666588, -6.013196390622062],
          [106.63264559151936, -6.01479685883615],
          [106.63195894601158, -6.015537118002655],
          [106.63140104653645, -6.017329634369359],
          [106.63127230050377, -6.01929285979784],
          [106.63148687722496, -6.019911701125708],
          [106.63316057565025, -6.0217895601505065],
          [106.63395796549771, -6.022639693384529],
          [106.63415108454679, -6.023663975785499],
          [106.6334858967111, -6.024965665215321],
          [106.63267050517057, -6.026971541176443],
          [106.63297091258023, -6.028557628213173],
          [106.6331640316293, -6.029240475916553],
          [106.6330567432687, -6.030222067984249],
          [106.63232718241666, -6.032078552472264],
          [106.63106789090872, -6.034727199138582],
          [106.63162579038382, -6.034940586710305],
          [106.63233389356375, -6.033169467319934],
          [106.63314928510428, -6.031675747673459],
          [106.63352202997989, -6.030563702503215],
          [106.63367223368473, -6.029816839605461],
          [106.63367223368473, -6.028749890824801],
          [106.6334147416193, -6.027853652227434],
          [106.63328599558659, -6.027170802778643],
          [106.63369369135685, -6.025741083962431],
          [106.63416576014346, -6.024866179545809],
          [106.63448762522525, -6.023991273719157],
          [106.63468126249171, -6.0232403192550015],
          [106.63450960111477, -6.0224294285475874],
          [106.63382295560696, -6.021511840234267],
          [106.63238529157496, -6.02014612452542],
          [106.63184647128502, -6.019243711552704],
          [106.63173918292443, -6.01768593529419],
          [106.63221125171104, -6.016448246864777],
          [106.6325974898092, -6.0155733274818655],
          [106.63375620410362, -6.014485011162697],
          [106.63517622439826, -6.013126863698785],
          [106.63661388843023, -6.011569069915387],
          [106.63768677203622, -6.009989931938782],
          [106.63903860537972, -6.008773565778634],
          [106.64077667682135, -6.008112032164413],
          [106.64247183291879, -6.007813274784809],
          [106.6432846347505, -6.007714808057996],
          [106.64379961888135, -6.007245331759617],
          [106.64611704747024, -6.006797194915346],
          [106.64639599720776, -6.006413077326711],
          [106.64598830143753, -6.00613565889973],
          [106.64626725117508, -6.005410102345683],
          [106.64682515065017, -6.0046418649407896],
          [106.64192268632425, -6.000943644986511],
          [106.64200851701275, -6.001519827052633],
          [106.64187977098004, -6.001946628190354],
          [106.64228746675028, -6.002245388787879],
          [106.64228746675028, -6.002736209413928],
          [106.64271662019269, -6.003312389584705],
          [106.64325306199564, -6.003824549224978]]]),
    imageVisParam = ui.import && ui.import("imageVisParam", "imageVisParam", {
      "params": {
        "opacity": 1,
        "bands": [
          "scale"
        ],
        "min": -2.789596110951735e-12,
        "max": 2.3225193948619613e-12,
        "palette": [
          "0409f1",
          "02e3f1",
          "3cf104",
          "f1f1f1",
          "ebf100",
          "f13a00",
          "b60505"
        ]
      }
    }) || {"opacity":1,"bands":["scale"],"min":-2.789596110951735e-12,"max":2.3225193948619613e-12,"palette":["0409f1","02e3f1","3cf104","f1f1f1","ebf100","f13a00","b60505"]};
Map.centerObject(river,13);
Map.add(ui.Label('Plastic Index Cisadane River, Tangerang (2017-2021)', {fontWeight: 'bold', fontSize: '22px', position: 'top-center'})); 
//-----------------------------------------------------------------------------
var dataset = ee.ImageCollection('COPERNICUS/S2')
            .map(function(image){return image.clip(river)})
            .filter(ee.Filter.lt('CLOUDY_PIXEL_PERCENTAGE', 20));
//-----------------------------------------------------------------------------
var PI = dataset.map(function(image) {
  var plastic_index = image.expression(
    'nir /(nir + red)', {
      'red': image.select('B4'),
      'nir': image.select('B8')
})
.rename('PI');
return image.addBands(plastic_index);
});
var createTimeBand = function(image) {
  return image.addBands(image.metadata('system:time_start'));
};
var collection = PI
   .filterDate(ee.Date('2017-01-01'), ee.Date('2021-12-31'))
  .map(createTimeBand);
var linearFit = collection.select(['system:time_start', 'PI'])
  .reduce(ee.Reducer.linearFit());
var OParams = {min: -2.789596110951735e-12 , max: 2.3225193948619613e-12, palette: 
  ["0409f1","02e3f1","3cf104","f1f1f1","ebf100","f13a00","b60505"], bands: ['scale']}; 
Map.addLayer(linearFit,OParams,'offset_2016_2021');
//-----------------------------------------------------------------------------
var PI = dataset.map(function(image) {
  var plastic_index = image.expression(
    'nir /(nir + red)', {
      'red': image.select('B4'),
      'nir': image.select('B8')
})
.rename('PI');
return image.addBands(plastic_index);
});
var point = ee.FeatureCollection([
ee.Feature(ee.Geometry.Point(107.59202238141778,-6.980870905565), {label: 'Sungai Citarum'}),
]);
var chart_mean =
    ui.Chart.image
        .seriesByRegion({
          imageCollection: PI.select('PI'),
          regions: river,
          reducer: ee.Reducer.mean(),
          scale: 1000,
        })
        .setOptions({
                    titlePostion: 'none',
                    legend: {position: 'none'},
                    title: 'Time Series of Plastic Index',
                    hAxis: {title: 'Date'},
                    vAxis: {title: 'Plstic Index'},
                    series: {0: {color: '23cba7'}}
                  });
var PI_2018 = PI.select('PI').filterDate('2017-01-01', '2017-12-30');
var PI_2019 = PI.select('PI').filterDate('2019-01-01', '2019-12-30');
var PI_2020 = PI.select('PI').filterDate('2021-01-01', '2021-12-30');
var piParams = {min: 0.2, max: 0.9, palette: ['blue','green','red']};
Map.addLayer(PI_2018.mean(), piParams, 'PI 2017');
Map.addLayer(PI_2019.mean(), piParams, 'PI 2019');
Map.addLayer(PI_2020.mean(), piParams, 'PI 2021');
// ---------------------------Visualisasi Plastic Index-----------------------------------------------------------
function makeColorBarParams(palette) {
  return {
    bbox: [0, 0, 1, 0.1],
    dimensions: '100x10',
    format: 'png',
    min: 0,
    max: 1,
    palette: palette,
  };
}
var colorBar = ui.Thumbnail({
  image: ee.Image.pixelLonLat().select(0),
  params: makeColorBarParams(piParams.palette),
  style: {stretch: 'horizontal', margin: '0px 8px', maxHeight: '30px'},
});
var legendLabels = ui.Panel({
  widgets: [
    ui.Label(('Low'), {margin: '4px 8px'}),
    ui.Label(
        ('Moderate'),
        {margin: '4px 8px', textAlign: 'center', stretch: 'horizontal'}),
    ui.Label(('High'), {margin: '4px 8px'})
  ],
  layout: ui.Panel.Layout.flow('horizontal')
});
var legendTitle = ui.Label({
  value: ' Plastic Index ',
  style: {fontWeight: 'bold'},
});
var legend = ui.Panel({
  style: {
    position: 'bottom-right',
    padding: '8px 15px'
  }
});
legend.add(legendTitle);
legend.add(legendLabels);
legend.add(colorBar);
Map.add(legend);
// ---------------------------Visualisasi Plastic Index-----------------------------------------------------------
function makeColorBarParams(palette) {
  return {
    bbox: [0, 0, 1, 0.1],
    dimensions: '100x10',
    format: 'png',
    min: 0,
    max: 1,
    palette: palette,
  };
}
var colorBar = ui.Thumbnail({
  image: ee.Image.pixelLonLat().select(0),
  params: makeColorBarParams(OParams.palette),
  style: {stretch: 'horizontal', margin: '0px 8px', maxHeight: '30px'},
});
var legendLabels = ui.Panel({
  widgets: [
    ui.Label(('Negative'), {margin: '4px 8px'}),
    ui.Label(
        ('Constant'),
        {margin: '4px 8px', textAlign: 'center', stretch: 'horizontal'}),
    ui.Label(('Positive'), {margin: '4px 8px'})
  ],
  layout: ui.Panel.Layout.flow('horizontal')
});
var legendTitle = ui.Label({
  value: 'Rate Of Change 2017-2021',
  style: {fontWeight: 'bold'},
});
var legend = ui.Panel({
  style: {
    position: 'bottom-right',
    padding: '8px 15px'
  }
});
legend.add(legendTitle);
legend.add(legendLabels);
legend.add(colorBar);
Map.add(legend);
//Pembuatan Data Tampilan Grafik Time Series
var chartPanel = ui.Panel({
  style:
      {height: '250px', width: '450px', position: 'bottom-left', shown: true}
});
// function chartPITimeSeries() {
//   // Make the chart panel visible the first time a geometry is drawn.
//   // if (!chartPanel.style().get('shown')) {
//   //   chartPanel.style().set('shown', true);
//   // }
//   // Reduction scale is based on map scale to avoid memory/timeout errors.
//   var mapScale = Map.getScale();
//   var scale = mapScale > 5000 ? mapScale * 2 : 5000;
//   // Replace the existing chart in the chart panel with the new chart.
//   chartPanel.widgets().chart_mean;
// }
//Pembuatan Data Tampilan Grafik Time Series
chartPanel.add(chart_mean);
Map.add(chartPanel);