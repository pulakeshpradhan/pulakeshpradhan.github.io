var roi = ui.import && ui.import("roi", "geometry", {
      "geometries": [
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                8.14117025583667,
                55.115335366678636
              ],
              [
                8.088436275992201,
                55.48010121229299
              ],
              [
                7.943695389354217,
                55.960366644284576
              ],
              [
                7.837237811751274,
                56.64323532884262
              ],
              [
                8.068156683642917,
                56.93200255707417
              ],
              [
                8.346526658242697,
                57.18313642776699
              ],
              [
                9.195343437048326,
                57.28727454285614
              ],
              [
                9.698938963353653,
                57.647318700420385
              ],
              [
                11.121902884851078,
                57.999730119919946
              ],
              [
                10.934372799877536,
                58.793615289310864
              ],
              [
                10.593520185917992,
                59.09659498269551
              ],
              [
                10.206884360348306,
                58.968381197407595
              ],
              [
                7.8457198910206305,
                57.81454566252261
              ],
              [
                5.828880909656591,
                58.244766716337004
              ],
              [
                5.1633122347993465,
                59.040140070049176
              ],
              [
                4.837728474421139,
                59.55073413543116
              ],
              [
                4.837281300698608,
                59.98781418806184
              ],
              [
                4.217584854337608,
                59.983087264780494
              ],
              [
                0.843491553758744,
                59.57479925823545
              ],
              [
                -1.4520611734279831,
                58.66940226688952
              ],
              [
                -3.6489791900421076,
                58.02914451206633
              ],
              [
                -3.6668546141866143,
                57.75700581348845
              ],
              [
                -1.886931521828079,
                57.77031246682538
              ],
              [
                -1.6148792283417746,
                56.9882589523252
              ],
              [
                -2.5506494895295972,
                56.36307389139518
              ],
              [
                -1.5538647209157141,
                55.68918069350194
              ],
              [
                0.20929062129569706,
                53.904086940228225
              ],
              [
                0.6420588842934736,
                53.03508998208609
              ],
              [
                1.6611322515834548,
                52.83492877504425
              ],
              [
                1.8492791450376878,
                52.41392012128027
              ],
              [
                0.9827112285016115,
                51.54459428189541
              ],
              [
                1.3703859646473049,
                51.41065449114792
              ],
              [
                1.492663768560778,
                51.235036876024616
              ],
              [
                1.1074607184738694,
                51.0071972323902
              ],
              [
                0.8343036756632438,
                50.889576681744785
              ],
              [
                0.24108882901160644,
                50.68864387249409
              ],
              [
                -0.40443117132956896,
                50.73428114809002
              ],
              [
                -0.932153627149992,
                50.625047384663475
              ],
              [
                -1.5560293956922422,
                50.527580414675235
              ],
              [
                -3.170275036154895,
                50.54907583048989
              ],
              [
                -3.329040691801315,
                50.33643540969944
              ],
              [
                -3.6511856050839597,
                50.13766609341296
              ],
              [
                -4.180888662048594,
                50.23527617544612
              ],
              [
                -4.554803879315172,
                50.287415936589035
              ],
              [
                -4.807017422791566,
                50.144668527359315
              ],
              [
                -5.1416812701030175,
                49.882752477351865
              ],
              [
                -5.905773702159875,
                49.326623886082984
              ],
              [
                -5.225925417353765,
                48.779769395050614
              ],
              [
                -4.061024059758671,
                48.78515758861346
              ],
              [
                -2.978244027893757,
                48.95946690510483
              ],
              [
                -2.7798292026529015,
                48.813997299751605
              ],
              [
                -2.4947901225681046,
                48.69695638765949
              ],
              [
                -2.1074366364626806,
                48.78341304738846
              ],
              [
                -1.7851757795666257,
                48.9411215761431
              ],
              [
                -1.9887277062735342,
                49.34823905540739
              ],
              [
                -2.1732282050594764,
                49.69801943562904
              ],
              [
                -1.6532770279223197,
                49.7635629479175
              ],
              [
                -1.2159815780787842,
                49.70936145237342
              ],
              [
                -0.8349539272378292,
                49.48265595745222
              ],
              [
                -0.48852743529613774,
                49.425350797988514
              ],
              [
                -0.22736269769110917,
                49.39628352700442
              ],
              [
                -0.18548592600194924,
                49.567018867862316
              ],
              [
                0.3363688814925947,
                49.83350939562407
              ],
              [
                0.9076740521980042,
                49.96566014758204
              ],
              [
                1.2713193604273565,
                50.09977414096127
              ],
              [
                1.4830182717748563,
                50.296510673576286
              ],
              [
                1.541125444967597,
                50.55657394024542
              ],
              [
                1.5006524690433487,
                50.746187819445396
              ],
              [
                1.7952245887994067,
                50.99967135751883
              ],
              [
                2.140448036667677,
                51.12316183717482
              ],
              [
                2.5901470294498763,
                51.21682618561731
              ],
              [
                3.435684482532295,
                51.54451622538679
              ],
              [
                3.6999833449511588,
                51.84825957094164
              ],
              [
                4.300860303400071,
                52.20635349815819
              ],
              [
                4.667647922806686,
                53.19972800669888
              ],
              [
                5.173116588180866,
                53.49624666420991
              ],
              [
                5.904039026044905,
                53.58023378789404
              ],
              [
                8.262062712895217,
                53.859019438156324
              ],
              [
                8.34982993258013,
                54.6034597397802
              ]
            ]
          ],
          "evenOdd": true
        }
      ],
      "displayProperties": [],
      "properties": {},
      "color": "#98ff00",
      "mode": "Geometry",
      "shown": false,
      "locked": false
    }) || 
    /* color: #98ff00 */
    /* shown: false */
    ee.Geometry.Polygon(
        [[[8.14117025583667, 55.115335366678636],
          [8.088436275992201, 55.48010121229299],
          [7.943695389354217, 55.960366644284576],
          [7.837237811751274, 56.64323532884262],
          [8.068156683642917, 56.93200255707417],
          [8.346526658242697, 57.18313642776699],
          [9.195343437048326, 57.28727454285614],
          [9.698938963353653, 57.647318700420385],
          [11.121902884851078, 57.999730119919946],
          [10.934372799877536, 58.793615289310864],
          [10.593520185917992, 59.09659498269551],
          [10.206884360348306, 58.968381197407595],
          [7.8457198910206305, 57.81454566252261],
          [5.828880909656591, 58.244766716337004],
          [5.1633122347993465, 59.040140070049176],
          [4.837728474421139, 59.55073413543116],
          [4.837281300698608, 59.98781418806184],
          [4.217584854337608, 59.983087264780494],
          [0.843491553758744, 59.57479925823545],
          [-1.4520611734279831, 58.66940226688952],
          [-3.6489791900421076, 58.02914451206633],
          [-3.6668546141866143, 57.75700581348845],
          [-1.886931521828079, 57.77031246682538],
          [-1.6148792283417746, 56.9882589523252],
          [-2.5506494895295972, 56.36307389139518],
          [-1.5538647209157141, 55.68918069350194],
          [0.20929062129569706, 53.904086940228225],
          [0.6420588842934736, 53.03508998208609],
          [1.6611322515834548, 52.83492877504425],
          [1.8492791450376878, 52.41392012128027],
          [0.9827112285016115, 51.54459428189541],
          [1.3703859646473049, 51.41065449114792],
          [1.492663768560778, 51.235036876024616],
          [1.1074607184738694, 51.0071972323902],
          [0.8343036756632438, 50.889576681744785],
          [0.24108882901160644, 50.68864387249409],
          [-0.40443117132956896, 50.73428114809002],
          [-0.932153627149992, 50.625047384663475],
          [-1.5560293956922422, 50.527580414675235],
          [-3.170275036154895, 50.54907583048989],
          [-3.329040691801315, 50.33643540969944],
          [-3.6511856050839597, 50.13766609341296],
          [-4.180888662048594, 50.23527617544612],
          [-4.554803879315172, 50.287415936589035],
          [-4.807017422791566, 50.144668527359315],
          [-5.1416812701030175, 49.882752477351865],
          [-5.905773702159875, 49.326623886082984],
          [-5.225925417353765, 48.779769395050614],
          [-4.061024059758671, 48.78515758861346],
          [-2.978244027893757, 48.95946690510483],
          [-2.7798292026529015, 48.813997299751605],
          [-2.4947901225681046, 48.69695638765949],
          [-2.1074366364626806, 48.78341304738846],
          [-1.7851757795666257, 48.9411215761431],
          [-1.9887277062735342, 49.34823905540739],
          [-2.1732282050594764, 49.69801943562904],
          [-1.6532770279223197, 49.7635629479175],
          [-1.2159815780787842, 49.70936145237342],
          [-0.8349539272378292, 49.48265595745222],
          [-0.48852743529613774, 49.425350797988514],
          [-0.22736269769110917, 49.39628352700442],
          [-0.18548592600194924, 49.567018867862316],
          [0.3363688814925947, 49.83350939562407],
          [0.9076740521980042, 49.96566014758204],
          [1.2713193604273565, 50.09977414096127],
          [1.4830182717748563, 50.296510673576286],
          [1.541125444967597, 50.55657394024542],
          [1.5006524690433487, 50.746187819445396],
          [1.7952245887994067, 50.99967135751883],
          [2.140448036667677, 51.12316183717482],
          [2.5901470294498763, 51.21682618561731],
          [3.435684482532295, 51.54451622538679],
          [3.6999833449511588, 51.84825957094164],
          [4.300860303400071, 52.20635349815819],
          [4.667647922806686, 53.19972800669888],
          [5.173116588180866, 53.49624666420991],
          [5.904039026044905, 53.58023378789404],
          [8.262062712895217, 53.859019438156324],
          [8.34982993258013, 54.6034597397802]]]),
    train_label = ui.import && ui.import("train_label", "table", {
      "id": "users/MarsXu/Rudong_Feature"
    }) || ee.FeatureCollection("users/MarsXu/Rudong_Feature"),
    train_image = ui.import && ui.import("train_image", "image", {
      "id": "users/MarsXu/exampleExport"
    }) || ee.Image("users/MarsXu/exampleExport");
var year_start=2015, year_end=2022;
var i=0,data=[];
for(var year=year_start;year<year_end;year++)
{
   var y=year.toString();
   print('SAR Data '+y);
   data[i]=ee.ImageCollection('COPERNICUS/S1_GRD')
      .filter(ee.Filter.eq('instrumentMode', 'IW')) 
      .filter(ee.Filter.eq('orbitProperties_pass', 'ASCENDING')) 
      .filter(ee.Filter.eq('transmitterReceiverPolarisation',['VV', 'VH']))
      .filterMetadata('resolution_meters', 'equals' , 10)
      .filterDate(y+'-1-1', y+'-12-31')
      .filterBounds(roi).mean().clip(roi);
   i     =i+1;
}
// Import SAR data processing module
var method = require('users/MarsXu/CodeofRS:dataProcessing/methods');
// Display SAR data
Map.centerObject(roi, 11);
/*
i=0;
for(var year=year_start;year<year_end;year++){
   var y=year.toString();
   Map.addLayer(data[i].select('VV'), {min:-15,max:0}, y+'_VV', 0);
   Map.addLayer(data[i].select('VH'), {min:-27,max:0}, y+'_VH', 0);
   i=i+1;
}
*/
//Apply Refined Lee filter to reduce speckle
var data_filtered=[];
for(i=0;i<data.length;i++)
{
 data_filtered[i] = ee.Image.cat([
      method.toDB(
        method.refinedLee(
          method.toNatural(data[i].select('VV'))
        )
      ),
      method.toDB(
        method.refinedLee(
          method.toNatural(data[i].select('VH'))
          )
        )
    ]).rename(['VV', 'VH']);
  //print(data_filtered[i],'filtered');  
}
i=0;
for(var year=year_start;year<year_end;year++){
   var y=year.toString();
   Map.addLayer(data_filtered[i].select('VV'), {min:-15,max:0}, y+'filtered_VV', 0);
  // Map.addLayer(data_filtered[i].select('VH'), {min:-27,max:0}, y+'filtered_VH', 0);
   i=i+1;
}
var Pol_data=[];
i=0;
for(var year=year_start;year<year_end;year++){
  Pol_data[i]=ee.Image.cat(data_filtered[i].select('VV'),data_filtered[i].select('VH'));
  i=i+1;
}
//define the sar bands to train you data
var bands=['VH','VV'];
var training= train_image.select(bands).sampleRegions({
    collection:train_label,
    properties:['landcover'],
    scale:30,
  });
//train the classifier
var classifier=ee.Classifier.smileRandomForest(2).train({
    features:training,
    classProperty:'landcover',
    inputProperties:bands
  });
//Run the classifier
var classified=[];
var class_augmented =[];
i=0;
for(var year=year_start;year<year_end;year++){
  classified[i]= Pol_data[i].select(bands).classify(classifier);
  class_augmented[i]= classified[i].spectralDilation('sed', ee.Kernel.circle(300,'meters'), true); //dilation
var palette= ['FFFFFF', '0000ff', 'ff0000'];
var dif_Vispar = {
  min: 0,
  max:2,
  palette:palette,
};
  //Map.addLayer(classified[i].eq(2).selfMask(),{palette:'FF0000'},year+'classified',0); 
  Map.addLayer( class_augmented[i],dif_Vispar,year+'Augmented classification',0);
  i=i+1;
}
var palette= ['FFFFFF', '0000ff', 'ff0000'];
var dif_Vispar = {
  min: -1,
  max: 1,
  palette:palette,
};
i=0;
var dif_windturbine=[];
for(var year=year_start;year<year_end-1;year++){
  dif_windturbine[i]= class_augmented[i+1].subtract(class_augmented[i]);
  dif_windturbine[i]=(dif_windturbine[i].eq(1)).spectralErosion('sed', ee.Kernel.circle(120,'meters'), true); //Erosion
  //dif_windturbine[i]= dif_windturbine[i].spectralDilation('sed', ee.Kernel.circle(90,'meters'), true); //dilation
  Map.addLayer( dif_windturbine[i].eq(1).selfMask(),dif_Vispar,year+'~'+(year+1)+'diff classification',1);
  i=i+1;
}
//create a confusion matrix representing resubstitution accuracy
print('RF-SAR error matrix:',classifier.confusionMatrix());
print('RF-SAR accuracy:',classifier.confusionMatrix().accuracy());