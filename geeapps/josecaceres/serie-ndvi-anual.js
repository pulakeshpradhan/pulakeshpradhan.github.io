var geometry = ui.import && ui.import("geometry", "geometry", {
      "geometries": [],
      "displayProperties": [],
      "properties": {},
      "color": "#23cba7",
      "mode": "Geometry",
      "shown": true,
      "locked": false
    }) || /* color: #23cba7 */ee.Geometry.MultiPoint();
//PARTE 5. Series temporales de NDVI definidas por el usuario.
//Agregar limites
var hn =  ee.FeatureCollection("users/josecaceres/Limite_Depto_HN")
//Agregar coleccion Landsat8 TOA
var l8 = ee.ImageCollection("LANDSAT/LC08/C01/T1_TOA").map(function(image){return image.clip(hn)})
// Defina una funcion que calculara NDVI a partir de una imagen Landsat 8.
var addNDVI = function(image) {
  var cloud = ee.Algorithms.Landsat.simpleCloudScore(image).select('cloud');
  var mask = cloud.lt(20);
  var ndvi = image.normalizedDifference(['B5', 'B4']).rename('NDVI');
  return image.addBands(ndvi).updateMask(mask);
};
// Filtre y asigne la funcion a la coleccion.
var withNDVI = l8.filterDate('2020-01-01', '2020-12-31')
    .map(addNDVI); // <-- map() the function over the collection.
var ndvi = withNDVI.median().select('NDVI');
var vis = {min: -0.2, max: 0.7, palette: ['blue', 'white', 'green']};
//Creamos un widget de herramientas de dibujo; def√≠nalo como una variable por conveniencia
//para recordarlo m√°s tarde.
var drawingTools = Map.drawingTools();
//Ocultar las herramientas de dibujo predeterminadas.
drawingTools.setShown(false);
//Configure un ciclo while para borrar todas las geometr√≠as existentes que se han agregado
//como importaciones de las herramientas de dibujo (de ejecutar previamente el script).
while (drawingTools.layers().length() > 0) {
  var layer = drawingTools.layers().get(0);
  drawingTools.layers().remove(layer);
}
//Inicializar una GeometryLayer ficticia con geometr√≠a nula para que act√∫e como marcador
//de posici√≥n para las geometr√≠as dibujadas
var dummyGeometry =
    ui.Map.GeometryLayer({geometries: null, name: 'geometry', color: '23cba7'});
drawingTools.layers().add(dummyGeometry);
//Defina la funci√≥n de limpieza de geometr√≠a.
function clearGeometry() {
  var layers = drawingTools.layers();
  layers.get(0).geometries().remove(layers.get(0).geometries().get(0));
}
//Defina las funciones a las que se llamar√° cuando se haga clic en cada bot√≥n de dibujo respectivo.
//Cada funci√≥n borrar√° los dibujos anteriores utilizando la funci√≥n clearGeometry y luego
//inicializar√° el dibujo para el modo de dibujo en particular.
function drawRectangle() {
  clearGeometry();
  drawingTools.setShape('rectangle');
  drawingTools.draw();
}
function drawPolygon() {
  clearGeometry();
  drawingTools.setShape('polygon');
  drawingTools.draw();
}
function drawPoint() {
  clearGeometry();
  drawingTools.setShape('point');
  drawingTools.draw();
}
//Defina un panel para contener el gr√°fico de series de tiempo. Establezca el par√°metro de estilo
//mostrado en "false" para ocultar inicialmente el panel hasta que se renderice el primer gr√°fico.
var chartPanel = ui.Panel({
  style:
      {height: '235px', width: '600px', position: 'bottom-right', shown: false}
});
Map.add(chartPanel);
//Defina una funci√≥n a la que se llame en eventos de finalizaci√≥n y edici√≥n de dibujos geom√©tricos
//para generar un gr√°fico de series de tiempo para la regi√≥n dibujada
function chartTimeSeries() {
  // Haga que el panel de gr√°fico sea visible la primera vez que se dibuje una geometr√≠a.
  if (!chartPanel.style().get('shown')) {
    chartPanel.style().set('shown', true);
  }
  // Obtenga la geometr√≠a dibujada; definir√° la regi√≥n de reducci√≥n.
  var aoi = drawingTools.layers().get(0).getEeObject();
  // Vuelva a establecer el modo de dibujo en "null"; apaga el dibujo.
  drawingTools.setShape(null);
  // La escala de reducci√≥n se basa en la escala del mapa para evitar errores de memoria / tiempo de espera.
  var mapScale = Map.getScale();
  var scale = mapScale > 5000 ? mapScale * 2 : 5000;
  // Agregue un grafico de los valores del NDVI.
  var grafico = ui.Chart.image.series({
    imageCollection: withNDVI.select('NDVI'), 
    region: aoi, 
    reducer: ee.Reducer.mean(), 
    scale: 30
  });
  grafico.setOptions({
    title: 'Serie temporal NDVI',
    vAxis: {title: 'NDVI'},
    hAxis: {title: 'fecha', format: 'MM-yy', gridlines: {count: 7}},
    interpolateNulls: true
  });
  // Replace the existing chart in the chart panel with the new chart.
  chartPanel.widgets().reset([grafico]);
}
drawingTools.onDraw(ui.util.debounce(chartTimeSeries, 500));
drawingTools.onEdit(ui.util.debounce(chartTimeSeries, 500));
var symbol = {
  rectangle: '‚¨õ',
  polygon: 'üî∫',
  point: 'üìç',
};
var controlPanel = ui.Panel({
  widgets: [
    ui.Label('1. Select un tipo de selecci√≥n.'),
    ui.Button({
      label: symbol.rectangle + ' Rect√°ngulo',
      onClick: drawRectangle,
      style: {stretch: 'horizontal'}
    }),
    ui.Button({
      label: symbol.polygon + ' Poligono',
      onClick: drawPolygon,
      style: {stretch: 'horizontal'}
    }),
    ui.Button({
      label: symbol.point + ' Punto',
      onClick: drawPoint,
      style: {stretch: 'horizontal'}
    }),
    ui.Label('2. Dibuja la geometr√≠a.'),
    ui.Label('3. Espera a que se cree el gr√°fico.'),
    ui.Label(
        '4. Repetir 1-3 or edita/mueve\nla geometria para un nuevo gr√°fico.',
        {whiteSpace: 'pre'})
  ],
  style: {position: 'bottom-left'},
  layout: null,
});
Map.add(controlPanel);
//Agregar capas
Map.centerObject(hn, 8)
Map.addLayer(ndvi, vis, 'NDVI');