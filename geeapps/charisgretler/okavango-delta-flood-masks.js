var aoi = ui.import && ui.import("aoi", "geometry", {
      "geometries": [
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                21.76055556,
                -20.6825
              ],
              [
                23.87916667,
                -20.66
              ],
              [
                23.83638889,
                -18.20861111
              ],
              [
                21.74916667,
                -18.22833333
              ]
            ]
          ],
          "evenOdd": true
        }
      ],
      "displayProperties": [],
      "properties": {},
      "color": "#d63000",
      "mode": "Geometry",
      "shown": false,
      "locked": false
    }) || 
    /* color: #d63000 */
    /* shown: false */
    ee.Geometry.Polygon(
        [[[21.76055556, -20.6825],
          [23.87916667, -20.66],
          [23.83638889, -18.20861111],
          [21.74916667, -18.22833333]]]),
    aoi_2 = ui.import && ui.import("aoi_2", "geometry", {
      "geometries": [
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                21.98265511663694,
                -18.420151093933903
              ],
              [
                21.98265511663694,
                -19.432092914831063
              ],
              [
                22.851261684019754,
                -19.432092914831063
              ],
              [
                22.851261684019754,
                -18.420151093933903
              ]
            ]
          ],
          "geodesic": false,
          "evenOdd": true
        }
      ],
      "displayProperties": [
        {
          "type": "rectangle"
        }
      ],
      "properties": {},
      "color": "#d63000",
      "mode": "Geometry",
      "shown": false,
      "locked": false
    }) || 
    /* color: #d63000 */
    /* shown: false */
    /* displayProperties: [
      {
        "type": "rectangle"
      }
    ] */
    ee.Geometry.Polygon(
        [[[21.98265511663694, -18.420151093933903],
          [21.98265511663694, -19.432092914831063],
          [22.851261684019754, -19.432092914831063],
          [22.851261684019754, -18.420151093933903]]], null, false),
    left_clip = ui.import && ui.import("left_clip", "geometry", {
      "geometries": [
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                21.72870555865476,
                -18.20710574373064
              ],
              [
                21.73145214068601,
                -20.693108049229654
              ],
              [
                23.0955203318089,
                -20.68038697956354
              ],
              [
                22.42391615230987,
                -18.202303919776845
              ]
            ]
          ],
          "evenOdd": true
        }
      ],
      "displayProperties": [],
      "properties": {},
      "color": "#d63000",
      "mode": "Geometry",
      "shown": false,
      "locked": false
    }) || 
    /* color: #d63000 */
    /* shown: false */
    ee.Geometry.Polygon(
        [[[21.72870555865476, -18.20710574373064],
          [21.73145214068601, -20.693108049229654],
          [23.0955203318089, -20.68038697956354],
          [22.42391615230987, -18.202303919776845]]]),
    right_clip = ui.import && ui.import("right_clip", "geometry", {
      "geometries": [
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                22.83692659301432,
                -20.7837419794638
              ],
              [
                24.046440373604757,
                -20.738515741528374
              ],
              [
                23.928384086094983,
                -18.151445269246928
              ],
              [
                22.14919795928946,
                -18.11235023940344
              ]
            ]
          ],
          "evenOdd": true
        }
      ],
      "displayProperties": [],
      "properties": {},
      "color": "#98ff00",
      "mode": "Geometry",
      "shown": false,
      "locked": false
    }) || 
    /* color: #98ff00 */
    /* shown: false */
    ee.Geometry.Polygon(
        [[[22.83692659301432, -20.7837419794638],
          [24.046440373604757, -20.738515741528374],
          [23.928384086094983, -18.151445269246928],
          [22.14919795928946, -18.11235023940344]]]),
    orbit_Y = ui.import && ui.import("orbit_Y", "geometry", {
      "geometries": [
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                21.76039837038415,
                -20.682579464213973
              ],
              [
                23.110426357550104,
                -20.671016008587774
              ],
              [
                22.457041691708763,
                -18.224099693132082
              ],
              [
                21.749068600235688,
                -18.228298208691633
              ]
            ]
          ],
          "evenOdd": true
        }
      ],
      "displayProperties": [],
      "properties": {},
      "color": "#2072d6",
      "mode": "Geometry",
      "shown": false,
      "locked": false
    }) || 
    /* color: #2072d6 */
    /* shown: false */
    ee.Geometry.Polygon(
        [[[21.76039837038415, -20.682579464213973],
          [23.110426357550104, -20.671016008587774],
          [22.457041691708763, -18.224099693132082],
          [21.749068600235688, -18.228298208691633]]]),
    orbit_X = ui.import && ui.import("orbit_X", "geometry", {
      "geometries": [
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                22.683590462799852,
                -20.675613899702274
              ],
              [
                23.87880255900273,
                -20.65986256170844
              ],
              [
                23.83592423157906,
                -18.20877802036868
              ],
              [
                22.071931922008748,
                -18.226388181572272
              ]
            ]
          ],
          "evenOdd": true
        }
      ],
      "displayProperties": [],
      "properties": {},
      "color": "#ff0000",
      "mode": "Geometry",
      "shown": false,
      "locked": false
    }) || 
    /* color: #ff0000 */
    /* shown: false */
    ee.Geometry.Polygon(
        [[[22.683590462799852, -20.675613899702274],
          [23.87880255900273, -20.65986256170844],
          [23.83592423157906, -18.20877802036868],
          [22.071931922008748, -18.226388181572272]]]),
    left = ui.import && ui.import("left", "geometry", {
      "geometries": [
        {
          "type": "Point",
          "coordinates": [
            22.170184988625653,
            -19.12216753282325
          ]
        }
      ],
      "displayProperties": [],
      "properties": {},
      "color": "#98ff00",
      "mode": "Geometry",
      "shown": false,
      "locked": false
    }) || 
    /* color: #98ff00 */
    /* shown: false */
    ee.Geometry.Point([22.170184988625653, -19.12216753282325]),
    right = ui.import && ui.import("right", "geometry", {
      "geometries": [
        {
          "type": "Point",
          "coordinates": [
            23.312763113625653,
            -19.14162912482627
          ]
        }
      ],
      "displayProperties": [],
      "properties": {},
      "color": "#d63000",
      "mode": "Geometry",
      "shown": false,
      "locked": false
    }) || 
    /* color: #d63000 */
    /* shown: false */
    ee.Geometry.Point([23.312763113625653, -19.14162912482627]);
var flooding = require('users/charisgretler/GEO441:SAR Flood Mapping/functions/main.js')
//  ============================= Input display dates: ====================================================
// The indices of the dates with aquisition (see console after running) can be used as input below:
var displaydate = 30; // --> this number has to be changed to get another image date on the map!!!!
// ################################ create a composite for each day: ################################
var start = ee.Date('2017-01-01')
var finish = ee.Date('2021-04-01')
/*
// Check if we have ascending or descending orbits:
var test = ee.ImageCollection('COPERNICUS/S1_GRD').filterBounds(aoi);
var asc = test.filter(ee.Filter.eq('orbitProperties_pass', 'ASCENDING'));
print('test',asc)
*/
var days = finish.difference(start, 'days')
var dayOffsets = ee.List.sequence(0, days.subtract(1))
var allImagesInRangeS1 = ee.ImageCollection(dayOffsets
  .map(function (dayOffset) {
    var dayStart = start.advance(dayOffset, 'days')
    var dayFinish = dayStart.advance(1, 'days')
    var composite = ee.ImageCollection('COPERNICUS/S1_GRD')
      .filterMetadata('instrumentMode', 'equals', 'IW')
      //.filterMetadata('ASCENDING')   // check this out!
      .filter(ee.Filter.eq('transmitterReceiverPolarisation', ['VV', 'VH']))
      .filterDate(dayStart, dayFinish)
      .filterBounds(aoi)
      .median()
    return composite
      .set('empty', composite.bandNames().size().eq(0))
      .set('system:time_start', dayStart.millis())
  }))
  .filterMetadata('empty', 'equals', 0)
//print(allImagesInRangeS1)
/*
function band_clip(image) {
  var start = ee.Date('2017-01-01')
  var finish = ee.Date('2021-04-01')
  var day = start.advance(1, 'days')
  var s = ee.Algorithms.If(flag, "this is true", "this is false")
  return image.filterDate(day).clip(links)
  });
*/
//print(allImagesInRangeS1)
var dates = allImagesInRangeS1.map(flooding.filtering.dates).aggregate_array('date')
print("Dates with SAR-aquisition:", dates)
//Map.addLayer(allImagesInRangeS1, {bands: "VV", min:-20, max: -5}, "all images", false)
// ############################# landsat composite as reference: #######################################
var landsat = ee.ImageCollection("LANDSAT/LC08/C01/T1")
    .filterDate('2017-07-01', '2017-07-31')
    .filterBounds(aoi)
    .sort("CLOUD_COVER")
    //.first()
var composite = ee.Algorithms.Landsat.simpleComposite({
  collection: landsat,
  asFloat: true
})
Map.addLayer(composite, {bands: ["B4", "B3", "B2"], min:0, max: 0.3}, "Landsat Jul 2017", false)
// ################################ prepare the dataset: ###############################################
var smooth1 = allImagesInRangeS1.map(flooding.filtering.convol); // smooth the SAR images for further processing
var smooth = smooth1.map(flooding.filtering.clipping);    // filter out all outliers and clip to aoi
//print("clipped", smooth)
//Map.addLayer(smooth.first(), {bands: "VV", min:-20, max: -5}, "clipped", false)
var palette_mask = [
  "C0C0C0", // other
  '228B22', // SubV
  '4169E1', // open Water
  ]
// ################################ V1: threshold ###############################################
// map the data:
var displaydate_1 = dates.get(displaydate)
var displaydate_2 = dates.get(displaydate+1)
print("These dates are displayed on the map...", displaydate_1, displaydate_2)
print("===========These dates are available for display...===========",
  "First possible date (would mean 'displaydate = 1'):", dates.get(1),
  "Last possible date (would mean 'displaydate = 252'):", dates.get(-1))
var threshold = smooth.map(flooding.classification.threshold)
print("This is the ImageCollection of the simple thresholding result:", threshold)
var threshold1 = smooth.filterDate(displaydate_1).map(flooding.classification.threshold)
var threshold2 = smooth.filterDate(displaydate_2).map(flooding.classification.threshold)
Map.addLayer(allImagesInRangeS1.filterDate(displaydate_1).first().clip(aoi), {bands: "VV", min:-20, max: -5}, "SAR imagem (VV) used for processing, Eastern Orbit")
Map.addLayer(allImagesInRangeS1.filterDate(displaydate_2).first().clip(aoi), {bands: "VV", min:-20, max: -5}, "SAR image (VV) used for processing, Western Orbit")
Map.addLayer(threshold1.first(), {}, "Simple Threshold, Eastern Orbit", false)
Map.addLayer(threshold2.first(), {}, "Simple Threshold, Western Orbit", false)
/*
var rightside = allImagesInRangeS1.filterDate(displaydate_1).get("relativeOrbitNumber_start");
var leftside = allImagesInRangeS1.filterDate(displaydate_2).first().clip(aoi);
var test = ee.ImageCollection('COPERNICUS/S1_GRD').filterDate(displaydate_1)//.get("relativeOrbitNumber_start")
print("rel Onumber:",test)
print("leftside:", leftside)
print("rightside:", rightside)
var threshold_list = threshold.toList(117);
print(threshold_list.get(0))
*/
// ################################ V2: supervised classification ################################
// Classify the imageCollection.
var classified = smooth.map(flooding.classification.super_classify);
var classified1 = smooth.filterDate(displaydate_1).map(flooding.classification.super_classify);
var classified2 = smooth.filterDate(displaydate_2).map(flooding.classification.super_classify);
print("This is the ImageCollection of the Supervised Classification result:", classified)
// Display the classification result and the input image.
Map.addLayer(classified1.first(),
            {min: 0, max: 2, palette: palette_mask},
             'Supervised Classification, Eastern Orbit', false);
Map.addLayer(classified2.first(),
            {min: 0, max: 2, palette: palette_mask},
             'Supervised Classification, Western Orbit', false);
// visualize DEM to make visual interpretation of submerged vegetation classification.
//var elevation = ee.Image("USGS/SRTMGL1_003").clip(aoi)
//Map.addLayer(elevation, {min:900, max:1000, palette: ["purple", "blue", "red", 'yellow', "white"]}, 'elevation', false)
// ################################ V3: adaptive threshold ###############################################
var adaptive_threshold = smooth.filterDate('2017-01-01', '2018-01-01').map(flooding.classification.adaptive_threshold); //.filterDate is necessary to avoid possible errors (too many calculations)
print("This is the ImageCollection of the Adaptive Threshold result (year 2017):", adaptive_threshold)
// map the data:
var adaptive_threshold1 = smooth.filterDate(displaydate_1).map(flooding.classification.adaptive_threshold)
var adaptive_threshold2 = smooth.filterDate(displaydate_2).map(flooding.classification.adaptive_threshold)
//print(adaptive_threshold2)
Map.addLayer(adaptive_threshold1.first(), {}, "Adaptive Threshold, Eastern Orbit")
// map also the "other side" of the test site:
Map.addLayer(adaptive_threshold2.first(), {}, "Adaptive Threshold, Western Orbit")
// ############################## Get the Screenshots for the report: ####################################
// Helligkeitsvergleich verschiedener Orbits:
var img1 = allImagesInRangeS1.filterDate('2017-04-23').first().clip(aoi);
var img2 = allImagesInRangeS1.filterDate('2017-04-28').first().clip(aoi);
//Map.addLayer(img1, {bands: "VV", min:-20, max: -5}, "1")
//Map.addLayer(img2, {bands: "VV", min:-20, max: -5}, "2")
// ######################################## Display settings: ######################################## 
flooding.visualization.SAR_legend()
flooding.visualization.mask_legend()
Map.centerObject(aoi, 8)