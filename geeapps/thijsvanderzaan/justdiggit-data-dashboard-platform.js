var Dodoma = ui.import && ui.import("Dodoma", "table", {
      "id": "projects/ee-justdiggit/assets/Dodoma"
    }) || ee.FeatureCollection("projects/ee-justdiggit/assets/Dodoma"),
    EmashanaiRuma = ui.import && ui.import("EmashanaiRuma", "table", {
      "id": "projects/ee-justdiggit/assets/EmashanaiRumaOlo"
    }) || ee.FeatureCollection("projects/ee-justdiggit/assets/EmashanaiRumaOlo"),
    Embarigoi = ui.import && ui.import("Embarigoi", "table", {
      "id": "projects/ee-justdiggit/assets/EmbarigoiOlo"
    }) || ee.FeatureCollection("projects/ee-justdiggit/assets/EmbarigoiOlo"),
    Endoinyo = ui.import && ui.import("Endoinyo", "table", {
      "id": "projects/ee-justdiggit/assets/EndoinyoOlo"
    }) || ee.FeatureCollection("projects/ee-justdiggit/assets/EndoinyoOlo"),
    Enkii = ui.import && ui.import("Enkii", "table", {
      "id": "projects/ee-justdiggit/assets/EnkiiBunds"
    }) || ee.FeatureCollection("projects/ee-justdiggit/assets/EnkiiBunds"),
    Enkusero = ui.import && ui.import("Enkusero", "table", {
      "id": "projects/ee-justdiggit/assets/EnkuseroGrass"
    }) || ee.FeatureCollection("projects/ee-justdiggit/assets/EnkuseroGrass"),
    Esanarwua = ui.import && ui.import("Esanarwua", "table", {
      "id": "projects/ee-justdiggit/assets/Esanarwua"
    }) || ee.FeatureCollection("projects/ee-justdiggit/assets/Esanarwua"),
    Ikiito = ui.import && ui.import("Ikiito", "table", {
      "id": "projects/ee-justdiggit/assets/IkiitoOloBunds"
    }) || ee.FeatureCollection("projects/ee-justdiggit/assets/IkiitoOloBunds"),
    Ildepen = ui.import && ui.import("Ildepen", "table", {
      "id": "projects/ee-justdiggit/assets/IldepenOlo"
    }) || ee.FeatureCollection("projects/ee-justdiggit/assets/IldepenOlo"),
    Inchakita = ui.import && ui.import("Inchakita", "table", {
      "id": "projects/ee-justdiggit/assets/InchakitaOlo"
    }) || ee.FeatureCollection("projects/ee-justdiggit/assets/InchakitaOlo"),
    Ingurumausi = ui.import && ui.import("Ingurumausi", "table", {
      "id": "projects/ee-justdiggit/assets/IngurumausiOlo"
    }) || ee.FeatureCollection("projects/ee-justdiggit/assets/IngurumausiOlo"),
    Inkisanjani = ui.import && ui.import("Inkisanjani", "table", {
      "id": "projects/ee-justdiggit/assets/InkisanjaniBunds"
    }) || ee.FeatureCollection("projects/ee-justdiggit/assets/InkisanjaniBunds"),
    InkisanjaniGrass = ui.import && ui.import("InkisanjaniGrass", "table", {
      "id": "projects/ee-justdiggit/assets/InkisanjaniGrass"
    }) || ee.FeatureCollection("projects/ee-justdiggit/assets/InkisanjaniGrass"),
    KWSTreePlantingProjectOldare = ui.import && ui.import("KWSTreePlantingProjectOldare", "table", {
      "id": "projects/ee-justdiggit/assets/KWSTreePlantingProject"
    }) || ee.FeatureCollection("projects/ee-justdiggit/assets/KWSTreePlantingProject"),
    KukuA = ui.import && ui.import("KukuA", "table", {
      "id": "projects/ee-justdiggit/assets/KukuABunds"
    }) || ee.FeatureCollection("projects/ee-justdiggit/assets/KukuABunds"),
    KukuB = ui.import && ui.import("KukuB", "table", {
      "id": "projects/ee-justdiggit/assets/KukuBBunds"
    }) || ee.FeatureCollection("projects/ee-justdiggit/assets/KukuBBunds"),
    KukuD = ui.import && ui.import("KukuD", "table", {
      "id": "projects/ee-justdiggit/assets/KukuDBunds"
    }) || ee.FeatureCollection("projects/ee-justdiggit/assets/KukuDBunds"),
    Langata = ui.import && ui.import("Langata", "table", {
      "id": "projects/ee-justdiggit/assets/LangataGrass"
    }) || ee.FeatureCollection("projects/ee-justdiggit/assets/LangataGrass"),
    Lenkilelilio = ui.import && ui.import("Lenkilelilio", "table", {
      "id": "projects/ee-justdiggit/assets/LenkilelilioOlo"
    }) || ee.FeatureCollection("projects/ee-justdiggit/assets/LenkilelilioOlo"),
    Lenterit = ui.import && ui.import("Lenterit", "table", {
      "id": "projects/ee-justdiggit/assets/LenteritOlo"
    }) || ee.FeatureCollection("projects/ee-justdiggit/assets/LenteritOlo"),
    Lewuas = ui.import && ui.import("Lewuas", "table", {
      "id": "projects/ee-justdiggit/assets/Lewuas"
    }) || ee.FeatureCollection("projects/ee-justdiggit/assets/Lewuas"),
    Lodepe = ui.import && ui.import("Lodepe", "table", {
      "id": "projects/ee-justdiggit/assets/LodepeOlo"
    }) || ee.FeatureCollection("projects/ee-justdiggit/assets/LodepeOlo"),
    Loltemwai = ui.import && ui.import("Loltemwai", "table", {
      "id": "projects/ee-justdiggit/assets/LontemwaiOlo"
    }) || ee.FeatureCollection("projects/ee-justdiggit/assets/LontemwaiOlo"),
    Looldrokon = ui.import && ui.import("Looldrokon", "table", {
      "id": "projects/ee-justdiggit/assets/LooldrokonOlo"
    }) || ee.FeatureCollection("projects/ee-justdiggit/assets/LooldrokonOlo"),
    Meshanani = ui.import && ui.import("Meshanani", "table", {
      "id": "projects/ee-justdiggit/assets/MeshananiGrass"
    }) || ee.FeatureCollection("projects/ee-justdiggit/assets/MeshananiGrass"),
    Moilo = ui.import && ui.import("Moilo", "table", {
      "id": "projects/ee-justdiggit/assets/MolioGrass"
    }) || ee.FeatureCollection("projects/ee-justdiggit/assets/MolioGrass"),
    Narripi = ui.import && ui.import("Narripi", "table", {
      "id": "projects/ee-justdiggit/assets/NarripiOlo"
    }) || ee.FeatureCollection("projects/ee-justdiggit/assets/NarripiOlo"),
    Nkiito = ui.import && ui.import("Nkiito", "table", {
      "id": "projects/ee-justdiggit/assets/Nkiito"
    }) || ee.FeatureCollection("projects/ee-justdiggit/assets/Nkiito"),
    NoonkotiakExclosure = ui.import && ui.import("NoonkotiakExclosure", "table", {
      "id": "projects/ee-justdiggit/assets/NoonkotiakExclosure"
    }) || ee.FeatureCollection("projects/ee-justdiggit/assets/NoonkotiakExclosure"),
    Olasiti = ui.import && ui.import("Olasiti", "table", {
      "id": "projects/ee-justdiggit/assets/Olasiti"
    }) || ee.FeatureCollection("projects/ee-justdiggit/assets/Olasiti"),
    OldareExclosure = ui.import && ui.import("OldareExclosure", "table", {
      "id": "projects/ee-justdiggit/assets/OldareExclosure"
    }) || ee.FeatureCollection("projects/ee-justdiggit/assets/OldareExclosure"),
    OleMulata = ui.import && ui.import("OleMulata", "table", {
      "id": "projects/ee-justdiggit/assets/OleMulataOlo"
    }) || ee.FeatureCollection("projects/ee-justdiggit/assets/OleMulataOlo"),
    OleSayialel = ui.import && ui.import("OleSayialel", "table", {
      "id": "projects/ee-justdiggit/assets/OleSayialel"
    }) || ee.FeatureCollection("projects/ee-justdiggit/assets/OleSayialel"),
    Olkaria = ui.import && ui.import("Olkaria", "table", {
      "id": "projects/ee-justdiggit/assets/OlkariaGrass"
    }) || ee.FeatureCollection("projects/ee-justdiggit/assets/OlkariaGrass"),
    Olmoti = ui.import && ui.import("Olmoti", "table", {
      "id": "projects/ee-justdiggit/assets/OlmotiOlo"
    }) || ee.FeatureCollection("projects/ee-justdiggit/assets/OlmotiOlo"),
    PembamotoNorth = ui.import && ui.import("PembamotoNorth", "table", {
      "id": "projects/ee-justdiggit/assets/PembamotoBundsN"
    }) || ee.FeatureCollection("projects/ee-justdiggit/assets/PembamotoBundsN"),
    PembamotoSouth = ui.import && ui.import("PembamotoSouth", "table", {
      "id": "projects/ee-justdiggit/assets/PembamotoBundsS"
    }) || ee.FeatureCollection("projects/ee-justdiggit/assets/PembamotoBundsS"),
    RisaBund = ui.import && ui.import("RisaBund", "table", {
      "id": "projects/ee-justdiggit/assets/RisaBunds"
    }) || ee.FeatureCollection("projects/ee-justdiggit/assets/RisaBunds"),
    Risa = ui.import && ui.import("Risa", "table", {
      "id": "projects/ee-justdiggit/assets/RisaOlo"
    }) || ee.FeatureCollection("projects/ee-justdiggit/assets/RisaOlo"),
    Singida = ui.import && ui.import("Singida", "table", {
      "id": "projects/ee-justdiggit/assets/Singida"
    }) || ee.FeatureCollection("projects/ee-justdiggit/assets/Singida"),
    tanzaniaRegions = ui.import && ui.import("tanzaniaRegions", "table", {
      "id": "projects/ee-justdiggit/assets/TZA_adm1"
    }) || ee.FeatureCollection("projects/ee-justdiggit/assets/TZA_adm1"),
    tanzaniaDistricts = ui.import && ui.import("tanzaniaDistricts", "table", {
      "id": "projects/ee-justdiggit/assets/TZA_adm2"
    }) || ee.FeatureCollection("projects/ee-justdiggit/assets/TZA_adm2"),
    RomboBund = ui.import && ui.import("RomboBund", "table", {
      "id": "projects/ee-justdiggit/assets/Rombobundplot"
    }) || ee.FeatureCollection("projects/ee-justdiggit/assets/Rombobundplot"),
    EsilaleiBundPlot = ui.import && ui.import("EsilaleiBundPlot", "table", {
      "id": "projects/ee-justdiggit/assets/EsilaleiBunds"
    }) || ee.FeatureCollection("projects/ee-justdiggit/assets/EsilaleiBunds"),
    IlchalaiBundPlot = ui.import && ui.import("IlchalaiBundPlot", "table", {
      "id": "projects/ee-justdiggit/assets/IlchalaiBunds"
    }) || ee.FeatureCollection("projects/ee-justdiggit/assets/IlchalaiBunds"),
    OlorikaBundsStage1 = ui.import && ui.import("OlorikaBundsStage1", "table", {
      "id": "projects/ee-justdiggit/assets/OlorikaSt1"
    }) || ee.FeatureCollection("projects/ee-justdiggit/assets/OlorikaSt1");
////////////////////////////////////////////////////////////////////////////////////////////////////
//                                   JUSTDIGGIT DATA DASHBOARD
//   for help navigating this code, contact Gemma Newbold, Thijs van der Zaan or Sander de Haas
/////////////////////////////////////////////////////////////////////////////////////////////////////
//                                          CONTENTS
//(1) IMPORT DATASETS...................................................................
//(2) PRE PROCESS DATASETS.............................................................
//(3) PANELS................................................................................
//(4) MAPS..................................................................................
//(5) LEGENDS................................................................................
//    (5.1) LEGEND SETUP
//    (5.2) CUSTOMISING LEGENDS
//(6) FUNCTIONALITY - CHOOSE DATASET.............................................................
//(7) FUNCTIONALITY - CHOOSE LOCATION........................................................
//    (7.1) POLYGONS
//    (7.2) 1 LOCATION (REQUIRED)
//    (7.3) COMPARE 2 LOCATIONS (OPTIONAL)
//    (7.4) COMPARE AGAINST CONTROL BUFFER AREA (OPTIONAL)
//    (7.5) SELECT CUSTOM LOCATION FROM MAP
//(8) FUNCTIONALITY - CHOOSE TIME............................................................
//(9) STATISTICS........................................................................
//(10) BUTTONS..............................................................................
//    (10.1) RESET BUTTON
//    (10.2) GENERATE DATA BUTTON
//        (10.2.1) ERROR MESSAGES
//        (10.2.2) RETREIVE SELECTED OPTIONS - IF SELECTED CUSTOM LOCATION FROM MAP
//        (10.2.3) RETREIVE SELECTED OPTIONS - ALL OTHER CASES
//(11) SWITCH CASES (PER DATASET)..........................................................
//    (11.1) PRECIPITATION
//        (11.1.1) PLOT CHART
//        (11.1.2) CALCULATE STATISTICS
//        (11.1.3) PRINT LEGEND
//    (11.2) NORMALISED DIFFERENCE VEGETATION INDEX
//        (11.2.1) PLOT CHART
//        (11.2.2) CALCULATE STATISTICS       *see line 1543 for % bareground calculation method*
//        (11.2.3) PRINT LEGEND
//    (11.3) NET PRIMARY PRODUCTION
//        (11.3.1) PLOT CHART
//        (11.3.2) CALCULATE STATISTICS
//        (11.3.3) PRINT LEGEND
//    (11.4) LAND SURFACE TEMPERATURE
//        (11.4.1) PLOT CHART
//        (11.4.2) CALCULATE STATISTICS
//        (11.4.3) PRINT LEGEND
//    (11.5) SOIL MOISTURE
//        (11.5.1) PLOT CHART
//        (11.5.2) CALCULATE STATISTICS
//        (11.5.3) PRINT LEGEND
//    (11.6) ATMOSPHERIC TEMPERATURE
//        (11.6.1) PLOT CHART
//        (11.6.2) CALCULATE STATISTICS
//        (11.6.3) PRINT LEGEND
//    (11.7) OPTIMISED SOIL-ADJUSTED VEGETATION INDEX - PLANET NICFI
//        (11.7.1) PLOT CHART
//        (11.7.2) CALCULATE STATISTICS
//        (11.7.3) PRINT LEGEND
//    (11.8) OPTIMISED SOIL-ADJUSTED VEGETATION INDEX - SENTINEL 2
//        (11.8.1) PLOT CHART
//        (11.8.2) CALCULATE STATISTICS
//        (11.8.3) PRINT LEGEND
//(12) USER INTERFACE DISPLAY...............................................................
//    (12.1) ADD WIDGETS TO SELECTION MENU PANEL
//    (12.2) ADD PANELS TO ROOT
//////////////////////////////////////////////////////////////////////////////////////////////////////
//                                    (1) IMPORT DATASETS
//precipitation
var chirps = ee.ImageCollection("UCSB-CHG/CHIRPS/PENTAD");
//ndvi
var modisndvi = ee.ImageCollection("MODIS/006/MOD13Q1");
//npp
var wapor = ee.ImageCollection("FAO/WAPOR/2/L1_NPP_D");
//lst
var modis = ee.ImageCollection("MODIS/006/MOD11A2"); 
//soil moisture
var smap = ee.ImageCollection("NASA_USDA/HSL/SMAP10KM_soil_moisture");
//atmospheric temperature
var era5 = ee.ImageCollection("ECMWF/ERA5_LAND/MONTHLY");
//osavi
var sentinel = ee.ImageCollection("COPERNICUS/S2"); //better temporal resolution
var planet = ee.ImageCollection("projects/planet-nicfi/assets/basemaps/africa"); //better spacial resolution
//////////////////////////////////////////////////////////////////////////////////////////////
//                               (2) PRE PROCESSING DATASETS
//date range to run pre processing functions over
var rangeStart = '2016-01-01';
var rangeEnd = ee.Date(Date.now());
//ndvi
var modisndvicollection = modisndvi.select('NDVI').filterDate(rangeStart, rangeEnd);
var calcNDVInew = function(img){
  var outimg = img.expression(
                "(G*0.0001)", //scale factor
                {"G": img.select("NDVI")
                }).rename('NDVInew')
                .float();
  outimg = outimg.set('system:time_start',img.get('system:time_start')) ;
  return outimg;
};
var NDVInew = modisndvicollection.map(calcNDVInew);
//lst
var lstcollection = ee.ImageCollection(modis.filterDate(rangeStart, rangeEnd));
var calcDEGREESC = function(img){
  var outimg = img.expression(
                "LST*(0.02) - (273.15)", //convert to degrees C
                {"LST": img.select("LST_Day_1km")
                }).rename('DEGREESC')
                .float();
  outimg = outimg.set('system:time_start',img.get('system:time_start'));
  return outimg;
};
var LSTdegreesC = lstcollection.map(calcDEGREESC);
//atmospheric temperature
var era5collection = ee.ImageCollection(era5.filterDate(rangeStart, rangeEnd));
var calcDEGREESC2 = function(img){
  var outimg = img.expression(
                "AT - (273.15)", //convert to degrees C
                {"AT": img.select("temperature_2m")
                }).rename('DEGREESC2')
                .float();
  outimg = outimg.set('system:time_start',img.get('system:time_start'));
  return outimg;
};
var ERA5degreesC = era5collection.map(calcDEGREESC2);
//npp
var nppcollection = ee.ImageCollection(wapor.filterDate(rangeStart, rangeEnd));
var calcNPP = function(img){
  var outimg = img.expression(
                "(NPP*2)/3.667*0.001", //carbon conversion factor
                {"NPP": img.select("L1_NPP_D")
                }).rename('NPP')
                .float();
  outimg = outimg.set('system:time_start',img.get('system:time_start'));
  return outimg;
};
var NPPbiomas = nppcollection.map(calcNPP);
//osavi planet
var planetcollection = ee.ImageCollection(planet.filterDate(rangeStart, rangeEnd));
var calcOSAVI1 = function(img){
  var outimg = img.expression(
                "((NIR - RED)/(NIR + RED + 0.16))", //OSAVI equation https://www.sciencedirect.com/science/article/abs/pii/0034425795001867
                {"NIR": img.select("N"),
                 "RED": img.select("R")
                }).rename('OSAVI')
                .float();
  outimg = outimg.set('system:time_start',img.get('system:time_start'));
  return outimg;
};
var OSAVIplanet = planetcollection.map(calcOSAVI1);
//savi sentinel
var sentinelcollection = ee.ImageCollection(sentinel.filterDate(rangeStart, rangeEnd));
var calcOSAVI3 = function(img){
  var outimg = img.expression(
                "((NIR - RED)/(NIR + RED + 0.16))", //OSAVI equation https://www.sciencedirect.com/science/article/abs/pii/0034425795001867
                {"NIR": img.select("B8"),
                 "RED": img.select("B4")
                }).rename('OSAVI')
                .float();
  outimg = outimg.set('system:time_start',img.get('system:time_start'));
  return outimg;
};
var OSAVIsentinel = sentinelcollection.map(calcOSAVI3);
/////////////////////////////////////////////////////////////////////////////////////////////////
//                                    (3) PANELS SET UP
//analysis panel
var panelChart = ui.Panel();
panelChart.style().set({
  position: 'middle-right',
  width: '400px',
  height: '525px', 
  backgroundColor: 'E9F5EB',
});
//selection menu panel
var panelSelectionMenu = ui.Panel();
panelSelectionMenu.style().set({
  width: '350px',
  height: '525px',
  position: 'middle-left',
  backgroundColor: 'E9F5EB',
});
//panel to hold button
var panelButton = ui.Panel();
panelButton.style().set({
  position: 'bottom-left',
  backgroundColor: 'E9F5EB',
});
panelButton.setLayout(ui.Panel.Layout.Flow('horizontal'));
////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                       (4) MAPS
//set up
var map = ui.Map().setCenter(36.252, -3.68).setOptions('Hybrid').setZoom(6);
map.setControlVisibility({layerList: true, zoomControl: false, scaleControl: true, mapTypeControl: false, fullscreenControl: true, drawingToolsControl: false});
//colour palette bank
var palette = require('users/gena/packages:palettes');
var magma = palette.matplotlib.inferno[7].reverse();
var brightgreens = ['ffffff', 'cee6b4', 'abf296', '7cd411', '6aac2a', '4a9d05', '2c6805', '244b05'];
var deepgreens = ['f3efcc', 'ece7b4', 'a09f57', '5d8253', '406343', '32502e', '064420'];
var rainbow = ['blue', 'limegreen', 'yellow', 'darkorange', 'red'];
var blackandwhite = ['ffffff','000000'];
var vidris = palette.matplotlib.viridis[7];
//parameters for map visualisation
var lastImage = ee.Date(Date.now());
var startImage = lastImage.advance(-3, 'month');
var startImageSentinel = lastImage.advance(-1, 'month');
var startImageERA5 = lastImage.advance(-6, 'month');
//rainfall
var PRECIPmap = chirps.filterDate(startImage, lastImage).mean();
map.addLayer(PRECIPmap, {min: 0, max: 30, palette: magma}, 'Precipitation', false);
//ndvi
var NDVImap = NDVInew.select('NDVInew').filterDate(startImage, lastImage).mean();
map.addLayer(NDVImap, {min: 0, max: 0.8, palette: brightgreens}, 'NDVI', false);
//npp
var NPPmap = NPPbiomas.filterDate(startImage, lastImage).mean();
map.addLayer(NPPmap, {min: 0, max: 1.2, palette: deepgreens}, 'Net Primary Productivity', false);
//lst
var LSTmap = LSTdegreesC.filterDate(startImage, lastImage).mean();
map.addLayer(LSTmap, {min: 24, max: 40, palette: rainbow}, 'Land Surface Temperature', false);
//soil moisture
var soilMoisture = smap.select('susm').filterDate(startImage, lastImage).mean();
map.addLayer(soilMoisture, {min: 0.0, max: 125.0, palette: blackandwhite}, 'Soil Moisture', false);
//atmospheric temperature
var ATimage = era5collection
              .filter(ee.Filter.date(startImageERA5, lastImage))
              .mean();
var ATmap = ATimage.expression(
                "AT - (273.15)",
                {"AT": ATimage.select("temperature_2m"),
                })
                .float();
map.addLayer(ATmap, {min: 18, max: 28, palette: vidris}, 'Atmospheric Temperature', false);
//osavi planet NICFI
var OSAVIplanetmap = OSAVIplanet.select('OSAVI').filterDate(startImage, lastImage).mean();
map.addLayer(OSAVIplanetmap, {min: 0, max: 0.8, palette: brightgreens}, 'OSAVI (Planet NICFI)', false);
//osavi sentinel 2
var binary = ee.Image('MODIS/MOD44W/MOD44W_005_2000_02_24');
var binaryLandWaterMask = binary.select('water_mask');
var OSAVIsentinelimage = sentinel
              .filter(ee.Filter.date(startImageSentinel, lastImage))
              .mean()
              .updateMask(binaryLandWaterMask.eq(0)); //only visualises land pixels to speed up map processing
var OSAVIsentinelmap = OSAVIsentinelimage.expression(
                "((NIR - RED)/(NIR + RED + 0.16))",
                {"NIR": OSAVIsentinelimage.select("B8"),
                 "RED": OSAVIsentinelimage.select("B4")
                })
                .float();
map.addLayer(OSAVIsentinelmap, {min: 0, max: 0.8, palette: brightgreens}, 'OSAVI (Sentinel 2 MSI)', false);
//surface water
var countries = ee.FeatureCollection("USDOS/LSIB_SIMPLE/2017");
var DRcongo = countries.filter(ee.Filter.eq("country_co", "CG"));
var congo = countries.filter(ee.Filter.eq("country_co", "CF"));
var kenya = countries.filter(ee.Filter.eq("country_co", "KE"));
var tanzania = countries.filter(ee.Filter.eq("country_co", "TZ"));
var uganda = countries.filter(ee.Filter.eq("country_co", "UG"));
var malawi = countries.filter(ee.Filter.eq("country_co", "MI"));
var mozambique = countries.filter(ee.Filter.eq("country_co", "MZ"));
var burundi = countries.filter(ee.Filter.eq("country_co", "BY"));
var rwanda = countries.filter(ee.Filter.eq("country_co", "RW"));
var zambia = countries.filter(ee.Filter.eq("country_co", "ZA"));
var inlandWaterBodiesAfrica = ee.FeatureCollection([congo, DRcongo, kenya, tanzania, uganda, malawi, mozambique, burundi, rwanda, zambia]).flatten();
var waterBodies = ee.ImageCollection('GLCF/GLS_WATER');
var water = waterBodies.select('water').max();
var waterMasked = water.updateMask(water.eq(2));
var inlandWaterBodiesMap = waterMasked.clipToCollection(inlandWaterBodiesAfrica);
map.addLayer(inlandWaterBodiesMap, {palette: 'bee6ff'}, 'Inland Water Bodies', false);
//ocean
var background = ee.ImageCollection('HYCOM/sea_surface_elevation').filter(ee.Filter.date('2018-08-01', '2018-08-15'));
var globalOceans = background.select('surface_elevation');
map.addLayer(globalOceans, {palette: '014c72'}, 'Ocean', false, 0.5);
//function to reset the polygon layer added each time you run the analysis (eg. Site 1, Site 2 or Site 1 Doughnut)
var removePreviousLayers = function(){
  if(map.layers().length() == 10){}
  else if(map.layers().length() == 11){
    var layer10 = map.layers().get(10);
    map.remove(layer10);
  }else if(map.layers().length() == 12){
    var layer11 = map.layers().get(11);
    map.remove(layer11);
    var layer10 = map.layers().get(10);
    map.remove(layer10);
  }
};
///////////////////////////////////////////////////////////////////////////////////////////////
//                                         (5) LEGENDS
//(5.1) LEGEND SET UP
//panel to contain legend
var legendContainer = ui.Panel({
  style: {
    backgroundColor: 'E9F5EB',
    position: 'bottom-center',
    width: '275px',
    padding: '8px 15px'
  }
});
//title
var legendTitle = ui.Label({
  value: '',
  style: {
    fontWeight: 'bold',
    fontSize: '20px',
    stretch: 'horizontal', 
    textAlign: 'center',
    margin: '0 0 4px 0',
    padding: '0',
    backgroundColor: 'E9F5EB',
  }
});
legendContainer.add(legendTitle);
//block colour legend
var makeRow = function(color, name) {
  var colorBox = ui.Label({
    style: {
      backgroundColor: '#' + color,
      padding: '8px',
      margin: '0 0 4px 0',
    }
  });
  var description = ui.Label({
    value: name,
    style: {margin: '0 0 4px 6px', fontSize: '13px', backgroundColor: 'E9F5EB'}
  });
  return ui.Panel({
    widgets: [colorBox, description],
    layout: ui.Panel.Layout.Flow('horizontal'),
    style: {backgroundColor: 'E9F5EB'},
  });
};
//gradient thumbnail legend
function ColorBar(palette) {
  return ui.Thumbnail({
    image: ee.Image.pixelLonLat().select(0),
    params: {
      bbox: [0, 0, 1, 0.1],
      dimensions: '100x8',
      format: 'png',
      min: 0,
      max: 1,
      palette: palette,
    },
    style: {stretch: 'horizontal', margin: '0px 0px', backgroundColor: 'E9F5EB'},
  });
}
//title style
var LEGEND_TITLE_STYLE = {
  fontSize: '16px',
  fontWeight: 'bold',
  stretch: 'horizontal',
  textAlign: 'center',
  margin: '4px',
  backgroundColor: 'E9F5EB',
};
//footnote style
var LEGEND_FOOTNOTE_STYLE = {
  fontSize: '11px',
  stretch: 'horizontal',
  textAlign: 'center',
  margin: '4px',
  backgroundColor: 'E9F5EB',
};
////////////////////////////////////////////////////////////////////////////////////////////////
//(5.2) CUSTOMISED LEGEND FOR EACH DATASET
//npp
function makeLegendNPP() {
  var labelPanel = ui.Panel(
      [
        ui.Label('0', {margin: '4px 8px', backgroundColor: 'E9F5EB'}),
        ui.Label('0.6',{margin: '4px 8px', textAlign: 'center', stretch: 'horizontal', backgroundColor: 'E9F5EB'}),
        ui.Label('1.2', {margin: '4px 8px', backgroundColor: 'E9F5EB'})
      ],
      ui.Panel.Layout.flow('horizontal'),
      {backgroundColor: 'E9F5EB'});
  return ui.Panel([ColorBar(deepgreens), labelPanel]);
}
//ndvi and osavi (same scale for ease of comparison)
function makeLegendNDVI() {
  var labelPanel = ui.Panel(
      [
        ui.Label('0', {margin: '4px 8px', backgroundColor: 'E9F5EB'}),
        ui.Label('0.4', {margin: '4px 8px', textAlign: 'center', stretch: 'horizontal', backgroundColor: 'E9F5EB'}),
        ui.Label('0.8', {margin: '4px 8px', backgroundColor: 'E9F5EB'})
      ],
  ui.Panel.Layout.flow('horizontal'),
  {backgroundColor: 'E9F5EB'});
  return ui.Panel([ColorBar(brightgreens), labelPanel]);
}
//soil moisture
function makeLegendSM() {
  var labelPanel = ui.Panel(
      [
        ui.Label('0', {margin: '4px 8px', backgroundColor: 'E9F5EB'}),
        ui.Label('62', {margin: '4px 8px', textAlign: 'center', stretch: 'horizontal', backgroundColor: 'E9F5EB'}),
        ui.Label('125', {margin: '4px 8px', backgroundColor: 'E9F5EB'})
      ],
      ui.Panel.Layout.flow('horizontal'),
      {backgroundColor: 'E9F5EB'});
  return ui.Panel([ColorBar(blackandwhite), labelPanel]);
}
//precip
function makeLegendPRECIP() {
  var labelPanel = ui.Panel(
      [
        ui.Label('0', {margin: '4px 8px', backgroundColor: 'E9F5EB'}),
        ui.Label('15', {margin: '4px 8px', textAlign: 'center', stretch: 'horizontal', backgroundColor: 'E9F5EB'}),
        ui.Label('30', {margin: '4px 8px', backgroundColor: 'E9F5EB'})
      ],
      ui.Panel.Layout.flow('horizontal'),
      {backgroundColor: 'E9F5EB'});
  return ui.Panel([ColorBar(magma), labelPanel]);
}
//lst
function makeLegendLST() {
  var labelPanel = ui.Panel(
      [
        ui.Label('24', {margin: '4px 8px', backgroundColor: 'E9F5EB'}),
        ui.Label('32', {margin: '4px 8px', textAlign: 'center', stretch: 'horizontal', backgroundColor: 'E9F5EB'}),
        ui.Label('40', {margin: '4px 8px', backgroundColor: 'E9F5EB'})
      ],
      ui.Panel.Layout.flow('horizontal'),
      {backgroundColor: 'E9F5EB'});
  return ui.Panel([ColorBar(rainbow), labelPanel]);
}
//at
function makeLegendAT() {
  var labelPanel = ui.Panel(
      [
        ui.Label('18', {margin: '4px 8px', backgroundColor: 'E9F5EB'}),
        ui.Label('23', {margin: '4px 8px', textAlign: 'center', stretch: 'horizontal', backgroundColor: 'E9F5EB'}),
        ui.Label('28', {margin: '4px 8px', backgroundColor: 'E9F5EB'})
      ],
      ui.Panel.Layout.flow('horizontal'),
      {backgroundColor: 'E9F5EB'});
  return ui.Panel([ColorBar(vidris), labelPanel]);
}
//////////////////////////////////////////////////////////////////////////////////////////////////
//                              (6) CHOOSE DATASET FUNCTIONALITY
//keys
var label1 = ui.Label('1. Dataset',{fontSize: '20px', fontWeight: 'bold', backgroundColor: 'E9F5EB'});
var data = {
  'Precipitation' : chirps,
  'Normalised Difference Vegetation Index' : NDVInew,
  'Net Primary Production' : NPPbiomas,
  'Land Surface Temperature' : LSTdegreesC,
  'Soil Moisture' : smap,
  'Atmospheric Temperature' : ERA5degreesC,
  'Optimised Soil-Adjusted Vegetation Index (Planet NICFI)' : OSAVIplanet,
  'Optimised Soil-Adjusted Vegetation Index (Sentinel 2 MSI)' : OSAVIsentinel,
};
//dropdown menu
var selectData = ui.Select({
  placeholder: 'Select Dataset To Analyse',
  items: Object.keys(data)
});
//functions to print descriptions of each dataset
var description = ui.Label('', {width: '300px', stretch: 'vertical', textAlign: 'left', fontSize: '11px', backgroundColor: 'E9F5EB'});
selectData.onChange(function(){
  //precipitation
  if(selectData.getValue() == 'Precipitation'){
    description.setValue('Cumulative rainfall measured in each pentad (duration of 5 days) in mm, provided by CHIRPS.'); //Spatial resolution: 5566m, Temporal resolution: 5 day.
  }
  //ndvi
  else if(selectData.getValue() == 'Normalised Difference Vegetation Index'){
    description.setValue('Level of greeness of a pixel, indicating the presence of healthy vegetation. Index scale varies from 0 to 1. Calculated using Red and Near Infrared bands of a satellite image, provided by MODIS Terra.'); //Spatial resolution: 250m, Temporal resolution: 16 day.
  }
  //npp
  else if(selectData.getValue() == 'Net Primary Production'){
    description.setValue('Measure of the exchange of carbon between photosynthesising vegetation and the atmosphere, per unit area (g/m2), cumulative over a dekad (duration of 10 days). Provided by WAPOR.'); //Spatial resolution: 248m, Temporal resolution: 10 day.
  }
  //land surface temperature
  else if(selectData.getValue() == 'Land Surface Temperature'){
    description.setValue('Average temperature of the terrestrial land surface (in degrees Celcius), provided by MODIS Terra.'); //Spatial resolution: 1000m, Temporal resolution: Daily.
  }
  //soil moisture
  else if(selectData.getValue() == 'Soil Moisture'){
    description.setValue('Amount of moisture contained in the subsurface soil layer (in mm), provided by NASAs SMAP product. Representative of the amount of water available in the land to support regreening.'); //Spatial resolution: 10000m, Temporal resolution: 3 day.
  }
  //atmospheric temperature
  else if(selectData.getValue() == 'Atmospheric Temperature'){
    description.setValue('Monthly average temperature of the air 2m above the land surface, in degrees Celcius. Provided by ERA5 Climate Reanalysis, which combines the ECMWF climate model with observed values.'); //Spatial resolution: 11132m, Temporal resolution: Monthly.
  }
  //osavi planet NICFI
  else if(selectData.getValue() == 'Optimised Soil-Adjusted Vegetation Index (Planet NICFI)'){
    description.setValue('Level of greeness of a pixel, indicating the presence of healthy vegetation. Index scale varies from 0 to 1. Corrects for soil background reflectance, therefore performs better than NDVI in semi-arid rangelands with sparse vegetation coverage. Calculated using Red and Near Infrared bands of a satellite image, provided by Planet NICFI. Please note this layer is only visible for those who have downloaded Planet NICFI Tropical Forest Monitoring dataset to their Google Earth Engine user account.'); //Spatial resolution: 4.77m, Temporal resolution: Biannual until 01/09/2020, then Monthly.
  }
  //osavi sentinel 2
  else{
    description.setValue('Level of greeness of a pixel, indicating the presence of healthy vegetation. Index scale varies from 0 to 1. Corrects for soil background reflectance, therefore performs better than NDVI in semi-arid rangelands with sparse vegetation coverage. Calculated using Red and Near Infrared bands of a satellite image, provided by Sentinel 2. Please note that cloud coverage has not been masked, which may affect data accuracy.'); //Spatial resolution: 10m, Temporal resolution: .
  }
});
/////////////////////////////////////////////////////////////////////////////////////////////
//                            (7) CHOOSE LOCATION FUNCTIONALITY
//(7.1) POLYGONS
//set up variable name labels to feed into charts
var nameLabel1 = 'Site 1';
var nameLabel2 = 'Site 2';
//administrative district polygons for Tanzania
//arusha
//missing longido, meru, arusha rural, arusha urban?
var Arusha = tanzaniaRegions.filter(ee.Filter.eq('system:index','00000000000000000000'));
var Arumeru = tanzaniaDistricts.filter(ee.Filter.eq('system:index','00000000000000000000'));
var Arusha1 = tanzaniaDistricts.filter(ee.Filter.eq('system:index','00000000000000000001'));
var Karatu = tanzaniaDistricts.filter(ee.Filter.eq('system:index','00000000000000000002'));
var Monduli = tanzaniaDistricts.filter(ee.Filter.eq('system:index','00000000000000000003'));
var Ngorongoro = tanzaniaDistricts.filter(ee.Filter.eq('system:index','00000000000000000004'));
var Simanjiro = tanzaniaDistricts.filter(ee.Filter.eq('system:index','00000000000000000005'));
//dodoma
//missing bahi, chamwino, chemba?
var DodomaRural = tanzaniaDistricts.filter(ee.Filter.eq('system:index','00000000000000000009'));
var DodomaUrban = tanzaniaDistricts.filter(ee.Filter.eq('system:index','0000000000000000000a'));
var Kondoa = tanzaniaDistricts.filter(ee.Filter.eq('system:index','0000000000000000000b'));
var Kongwa = tanzaniaDistricts.filter(ee.Filter.eq('system:index','0000000000000000000c'));
var Mpwapwa = tanzaniaDistricts.filter(ee.Filter.eq('system:index','0000000000000000000d'));
//singida
//missing mkalama, ikungi?
var Iramba = tanzaniaDistricts.filter(ee.Filter.eq('system:index','00000000000000000073'));
var Manyoni = tanzaniaDistricts.filter(ee.Filter.eq('system:index','00000000000000000074'));
var SingidaRural = tanzaniaDistricts.filter(ee.Filter.eq('system:index','00000000000000000075'));
var SingidaUrban = tanzaniaDistricts.filter(ee.Filter.eq('system:index','00000000000000000076'));
//////////////////////////////////////////////////////////////////////////////////////////////////////////
//(7.2) 1 LOCATION (REQUIRED)
//first location dropdown menu
var label2 = ui.Label('2. Location',{fontSize: '20px', fontWeight: 'bold', backgroundColor: 'E9F5EB'});
var label7 = ui.Label('Choose one location (required)', {fontSize: '16px', fontWeight: 'bold', backgroundColor: 'E9F5EB'});
//keys
var places = {
  'Select Custom Location' : 12, //placeholder value
  'Kenya - Amboseli - Emashanai Ruma Olopololi' : EmashanaiRuma,
  'Kenya - Amboseli - Embarigoi Olopololi' : Embarigoi,
  'Kenya - Amboseli - Endoinyo Olopololi' : Endoinyo,
  'Kenya - Amboseli - Esanarwua Olopololi' : Esanarwua,
  'Kenya - Amboseli - Ikiito Olopololi and Bund Plot' : Ikiito,
  'Kenya - Amboseli - Ildepen Olopololi' : Ildepen,
  'Kenya - Amboseli - Inchakita Olopololi' : Inchakita,
  'Kenya - Amboseli - Ingurumausi Olopololi' : Ingurumausi,
  'Kenya - Amboseli - Kwsoldare Tree Planting Project' : KWSTreePlantingProjectOldare,
  'Kenya - Amboseli - Lenkilelilio Olopololi' : Lenkilelilio,
  'Kenya - Amboseli - Lenterit Olopololi' : Lenterit,
  'Kenya - Amboseli - Lewuas Olopololi' : Lewuas,
  'Kenya - Amboseli - Lodepe Olopololi' : Lodepe,
  'Kenya - Amboseli - Loltemwai Olopololi' : Loltemwai,
  'Kenya - Amboseli - Looldrokon Olopololi' : Looldrokon,
  'Kenya - Amboseli - Meshanani Grass Seed Bank' : Meshanani,
  'Kenya - Amboseli - Narripi Olopololi' : Narripi,
  'Kenya - Amboseli - Nkiito Olopololi' : Nkiito,
  'Kenya - Amboseli - Noonkotiak Exclosure' : NoonkotiakExclosure,
  'Kenya - Amboseli - Olasiti Olopololi' : Olasiti,
  'Kenya - Amboseli - Oldare Exclosure' : OldareExclosure,
  'Kenya - Amboseli - Ole Mutala Olopololi' : OleMulata,
  'Kenya - Amboseli - Ole Sayialel Olopololi' : OleSayialel,
  'Kenya - Amboseli - Olmoti Olopololi' : Olmoti,
  'Kenya - Amboseli - Risa Olopololi' : Risa,
  'Kenya - Amboseli - Risa Bund Plot' : RisaBund,
  'Kenya - Chyulu - Kuku Bund Plot A' : KukuA,
  'Kenya - Chyulu - Kuku Bund Plot B' : KukuB,
  'Kenya - Chyulu - Kuku Bund Plot D' : KukuD,
  'Kenya - Chyulu - Enkii Bund Plot' : Enkii,
  'Kenya - Chyulu - Inkisanjani Bund Plot' : Inkisanjani,
  'Kenya - Chyulu - Ilchalai Bund Plot' : IlchalaiBundPlot,
  'Kenya - Chyulu - Rombo Bunds Plot' : RomboBund,
  'Kenya - Chyulu - Olorika Bund Plot - Stage 1' : OlorikaBundsStage1,
  'Kenya - Chyulu - Inkisanjani Grass Seed Bank' : InkisanjaniGrass,
  'Kenya - Chyulu - Langata Grass Seed Bank' : Langata,
  'Kenya - Chyulu - Moilo Grass Seed Bank' : Moilo,
  'Tanzania - Arusha' : Arusha,
  'Tanzania - Arusha - Meru District' : Arumeru,
  'Tanzania - Arusha - Arusha District' : Arusha1,
  'Tanzania - Arusha - Karatu District' : Karatu,
  'Tanzania - Arusha - Monduli District' : Monduli,
  'Tanzania - Arusha - Ngorongoro District' : Ngorongoro,
  'Tanzania - Arusha - Simanjiro District' : Simanjiro,
  'Tanzania - Arusha - Esilalei Bund Plot' : EsilaleiBundPlot,
  'Tanzania - Dodoma' : Dodoma,
  'Tanzania - Dodoma - Dodoma Rural District' : DodomaRural,
  'Tanzania - Dodoma - Dodoma Urban District' : DodomaUrban,
  'Tanzania - Dodoma - Kondoa District' : Kondoa,
  'Tanzania - Dodoma - Kongwa District' : Kongwa,
  'Tanzania - Dodoma - Mpwapwa District' : Mpwapwa,
  'Tanzania - Dodoma - Pembamoto North Bund Plot' : PembamotoNorth,
  'Tanzania - Dodoma - Pembamoto South Bund Plot' : PembamotoSouth,
  'Tanzania - Singida' : Singida,
  'Tanzania - Singida - Iramba District' : Iramba,
  'Tanzania - Singida - Manyoni District' : Manyoni,
  'Tanzania - Singida - Singida Rural District' : SingidaRural,
  'Tanzania - Singida - Singida Urban District' : SingidaUrban,
};
//dropdown menu
var selectRegion = ui.Select({
  placeholder: 'Select Justdiggit Project Location',
  items: Object.keys(places),
  style: {color: 'ea812d'},
});
////////////////////////////////////////////////////////////////////////////////////////////////////////////
//(7.3) COMPARE 2 LOCATIONS (OPTIONAL)
//second location dropdown menu
var label8 = ui.Label('Compare two locations (optional)', {fontSize: '16px', fontWeight: 'bold', backgroundColor: 'E9F5EB'});
//keys
var placesOption2 = {
  'Kenya - Amboseli - Emashanai Ruma Olopololi' : EmashanaiRuma,
  'Kenya - Amboseli - Embarigoi Olopololi' : Embarigoi,
  'Kenya - Amboseli - Endoinyo Olopololi' : Endoinyo,
  'Kenya - Amboseli - Esanarwua Olopololi' : Esanarwua,
  'Kenya - Amboseli - Ikiito Olopololi and Bund Plot' : Ikiito,
  'Kenya - Amboseli - Ildepen Olopololi' : Ildepen,
  'Kenya - Amboseli - Inchakita Olopololi' : Inchakita,
  'Kenya - Amboseli - Ingurumausi Olopololi' : Ingurumausi,
  'Kenya - Amboseli - Kwsoldare Tree Planting Project' : KWSTreePlantingProjectOldare,
  'Kenya - Amboseli - Lenkilelilio Olopololi' : Lenkilelilio,
  'Kenya - Amboseli - Lenterit Olopololi' : Lenterit,
  'Kenya - Amboseli - Lewuas Olopololi' : Lewuas,
  'Kenya - Amboseli - Lodepe Olopololi' : Lodepe,
  'Kenya - Amboseli - Loltemwai Olopololi' : Loltemwai,
  'Kenya - Amboseli - Looldrokon Olopololi' : Looldrokon,
  'Kenya - Amboseli - Meshanani Grass Seed Bank' : Meshanani,
  'Kenya - Amboseli - Narripi Olopololi' : Narripi,
  'Kenya - Amboseli - Nkiito Olopololi' : Nkiito,
  'Kenya - Amboseli - Noonkotiak Exclosure' : NoonkotiakExclosure,
  'Kenya - Amboseli - Olasiti Olopololi' : Olasiti,
  'Kenya - Amboseli - Oldare Exclosure' : OldareExclosure,
  'Kenya - Amboseli - Ole Mutala Olopololi' : OleMulata,
  'Kenya - Amboseli - Ole Sayialel Olopololi' : OleSayialel,
  'Kenya - Amboseli - Olmoti Olopololi' : Olmoti,
  'Kenya - Amboseli - Risa Olopololi' : Risa,
  'Kenya - Amboseli - Risa Bund Plot' : RisaBund,
  'Kenya - Chyulu - Kuku Bund Plot A' : KukuA,
  'Kenya - Chyulu - Kuku Bund Plot B' : KukuB,
  'Kenya - Chyulu - Kuku Bund Plot D' : KukuD,
  'Kenya - Chyulu - Enkii Bund Plot' : Enkii,
  'Kenya - Chyulu - Inkisanjani Bund Plot' : Inkisanjani,
  'Kenya - Chyulu - Ilchalai Bund Plot' : IlchalaiBundPlot,
  'Kenya - Chyulu - Rombo Bunds Plot' : RomboBund,
  'Kenya - Chyulu - Olorika Bund Plot - Stage 1' : OlorikaBundsStage1,
  'Kenya - Chyulu - Inkisanjani Grass Seed Bank' : InkisanjaniGrass,
  'Kenya - Chyulu - Langata Grass Seed Bank' : Langata,
  'Kenya - Chyulu - Moilo Grass Seed Bank' : Moilo,
  'Tanzania - Arusha' : Arusha,
  'Tanzania - Arusha - Meru District' : Arumeru,
  'Tanzania - Arusha - Arusha District' : Arusha1,
  'Tanzania - Arusha - Karatu District' : Karatu,
  'Tanzania - Arusha - Monduli District' : Monduli,
  'Tanzania - Arusha - Ngorongoro District' : Ngorongoro,
  'Tanzania - Arusha - Simanjiro District' : Simanjiro,
  'Tanzania - Arusha - Esilalei Bund Plot' : EsilaleiBundPlot,
  'Tanzania - Dodoma' : Dodoma,
  'Tanzania - Dodoma - Dodoma Rural District' : DodomaRural,
  'Tanzania - Dodoma - Dodoma Urban District' : DodomaUrban,
  'Tanzania - Dodoma - Kondoa District' : Kondoa,
  'Tanzania - Dodoma - Kongwa District' : Kongwa,
  'Tanzania - Dodoma - Mpwapwa District' : Mpwapwa,
  'Tanzania - Dodoma - Pembamoto North Bund Plot' : PembamotoNorth,
  'Tanzania - Dodoma - Pembamoto South Bund Plot' : PembamotoSouth,
  'Tanzania - Singida' : Singida,
  'Tanzania - Singida - Iramba District' : Iramba,
  'Tanzania - Singida - Manyoni District' : Manyoni,
  'Tanzania - Singida - Singida Rural District' : SingidaRural,
  'Tanzania - Singida - Singida Urban District' : SingidaUrban,
};
//dropdown menu
var selectRegionOption2 = ui.Select({
        placeholder: 'Select A Second Justdiggit Project Location',
        items: Object.keys(placesOption2),
        disabled: true,
        style: {color: '19c35a'},
});
//checkbox to enable dropdown menu to choose second region
var checkboxRegionCompare = ui.Checkbox({
  label: 'Compare against another region', 
  disabled: false,
  style: {fontSize: '13px', backgroundColor: 'E9F5EB'},
});
checkboxRegionCompare.onChange(function(checked){
  if(checked){
    selectRegionOption2.setDisabled(false);
    checkboxBuffer.setValue(false);
  }
  else{
    selectRegionOption2.setValue(null, false);
    selectRegionOption2.setDisabled(true);
  }
});
/////////////////////////////////////////////////////////////////////////////////////////////////////////////
//(7.4) COMPARE AGAINST CONTROL BUFFER AREA (OPTIONAL)
var label9 = ui.Label('Compare against control area (optional)', {fontSize: '16px', fontWeight: 'bold', backgroundColor: 'E9F5EB'});
//checkbox to choose option to compare against control/buffer area
var checkboxBuffer = ui.Checkbox({
  label: 'Compare against surrounding control area', 
  disabled: false,
  style: {fontSize: '13px', backgroundColor: 'E9F5EB'},
});
checkboxBuffer.onChange(function(checked){
  if(checked){
    selectRegionOption2.setDisabled(true);
    selectRegionOption2.setValue(null, false);
    checkboxRegionCompare.setValue(false);
    sliderRadius.setDisabled(false);
  }else{
    sliderRadius.setDisabled(true);
  }
});
//slider to choose variable radius for buffer area
var sliderRadius = ui.Slider({
  min: 100,
  max: 3000,
  value: 1000,
  step: 100,
  style: {backgroundColor: 'E9F5EB', width: '300px'},
  disabled: true,
});
var radius = 1000;
sliderRadius.onChange(function(value){
  radius = value ; 
});
//////////////////////////////////////////////////////////////////////////////////////////////////////////////
//(7.5) SELECT CUSTOM LOCATION FROM MAP
//drawing tools setup
var drawingTools = map.drawingTools();
drawingTools.setShown(false);
//loop to reset/clear existing geometries
while (drawingTools.layers().length() > 0) {
  var layer = drawingTools.layers().get(0);
  drawingTools.layers().remove(layer);
}
//add placeholder layer to hold geometries drawn on the map
var dummyGeometry = ui.Map.GeometryLayer({geometries: null, name: 'geometry', color: 'ea812d'});
drawingTools.layers().add(dummyGeometry);
//THE FOLLOWING SECTION OF CODE ENSURES ONLY A MAXIMUM OF ONE SHAPE/GEOMETRY CAN BE DRAWN ON THE MAP
//WHEN THE USER GOES TO DRAW A SECOND SHAPE/GEOMETRY, THE PREVIOUS DRAWING IS DELETED/REPLACED 
//geometry clearing function
function clearGeometry() {
  var layers = drawingTools.layers();
  layers.get(0).geometries().remove(layers.get(0).geometries().get(0));
}
//rectangle button function
function drawRectangle() {
  clearGeometry();
  drawingTools.setShape('rectangle');
  drawingTools.draw();
}
//polygon button function
function drawPolygon() {
  clearGeometry();
  drawingTools.setShape('polygon');
  drawingTools.draw();
}
//point button function
function drawPoint() {
  clearGeometry();
  drawingTools.setShape('point');
  drawingTools.draw();
}
//function to reset cursor to hand grabber after drawing on the map
drawingTools.onDraw(function reset() {
  drawingTools.setShape(null);
});
//THE FOLLOWING SECTION OF CODE ALLOWS THE USER TO CHOOSE A DRAWING OPTION FROM 3 BUTTONS
//(RECTANGLE, MULTIPOINT POLYGON OR POINT)
//creating the buttons for the selection menu
var symbol = {
  rectangle: '⬛',
  polygon: '🔺',
  point: '📍',
};
var controlPanel = ui.Panel({
  widgets: [
    ui.Button({
      label: symbol.rectangle,
      onClick: drawRectangle,
      style: {stretch: 'horizontal'},
      disabled: true,
    }),
    ui.Button({
      label: symbol.polygon,
      onClick: drawPolygon,
      style: {stretch: 'horizontal'},
      disabled: true,
    }),
    ui.Button({
      label: symbol.point,
      onClick: drawPoint,
      style: {stretch: 'horizontal'},
      disabled: true,
    }),
    ],
  style: {position: 'bottom-center', backgroundColor: 'E9F5EB', width: '325px', stretch: 'horizontal'},
  layout: ui.Panel.Layout.flow('horizontal'),
});
//function to enable drawing option buttons when 'Select Custom Location' is chosen from the dropdown menu
selectRegion.onChange(function(selected){
  if(selectRegion.getValue() === 'Select Custom Location'){
    controlPanel.widgets().get(0).setDisabled(false);
    controlPanel.widgets().get(1).setDisabled(false);
    controlPanel.widgets().get(2).setDisabled(false);
  }else{
    controlPanel.widgets().get(0).setDisabled(true);
    controlPanel.widgets().get(1).setDisabled(true);
    controlPanel.widgets().get(2).setDisabled(true);
  }
});
/////////////////////////////////////////////////////////////////////////////////////////////////
//                                  (8) CHOOSE TIME FUNCTIONALITY
var label6 = ui.Label('3. Time', {fontSize: '20px', fontWeight: 'bold', backgroundColor: 'E9F5EB'});
//date range to display on the sliders
var start = '2016-01-01';
var end = ee.Date(Date.now());
//date slider to choose start date
var label3 = ui.Label('Choose start date', {fontSize: '16px', fontWeight: 'bold', backgroundColor: 'E9F5EB'});
var sliderStart = ui.DateSlider({
  start: '2016-01-01',
  end: ee.Date(Date.now()),
  value: start,
  period: 30, //sets frequency of date slider to monthly
  onChange:changeStartDate,
  style: {backgroundColor: 'E9F5EB'},
});
function changeStartDate(dateRange){
  start = dateRange.start();
}
//date slider to choose end date
var label4 = ui.Label('Choose end date', {fontSize: '16px', fontWeight: 'bold', backgroundColor: 'E9F5EB'});
var sliderEnd = ui.DateSlider({
  start: '2016-01-01',
  end: ee.Date(Date.now()),
  value: end,
  period: 30, //sets frequency of date slider to monthly
  onChange:changeEndDate,
  style: {backgroundColor: 'E9F5EB'},
});
function changeEndDate(dateRange){
  end = dateRange.start();
}
//function which clips the chosen dataset to the selected date range, which feeds into the analysis chart
var selectTimeFrame = function(input){
    var collection = ee.ImageCollection(input.filterDate(start, end));
    return collection;
};
//error message label (this is a message printed in red, just below the end date slider, to alert
//the user when not enough options have been selected to run the analysis), creates an empty placeholder
//string label to be filled later on in the code.
var errorMessage = ui.Label('', {color: 'red', backgroundColor: 'E9F5EB', stretch: 'vertical', fontSize: '13px'});
////////////////////////////////////////////////////////////////////////////////////////////////
//                                         (9) STATISTICS
//(9.1) GENERAL
//labels
var label5 = ui.Label('Statistical Summary', {fontSize: '20px', fontWeight: 'bold', backgroundColor: 'E9F5EB'});
function subtitle1(input) 
{
  var labelSite1 = ui.Label('Site 1',{fontSize: '16px', fontWeight: 'bold', backgroundColor: 'E9F5EB'});
  panelChart.add(labelSite1); 
}
function subtitle2(input) 
{
  var labelSite2 = ui.Label('Site 2',{fontSize: '16px', fontWeight: 'bold', backgroundColor: 'E9F5EB'});
  panelChart.add(labelSite2);
}
//style
var printStatisticStyle = {margin: 0, backgroundColor: 'E9F5EB', fontSize: '13px'};
//////////////////////////////////////////////////////////////////////////////////////////////////////
//(9.2) STATISTIC LABELS SPECIFIC TO EACH DATASET
//precipitation (stat1 - stat6)
function stat1(result) 
{
  var statLabel = 'Average 5 day precipitation for previous fortnight: ' + result + 'mm';
  panelChart.add(ui.Label(statLabel, printStatisticStyle));
}
function stat2(result) 
{
  var statLabel = 'Average 5 day precipitation for previous month: ' + result + 'mm';
  panelChart.add(ui.Label(statLabel, printStatisticStyle));
}
function stat3(result) 
{
  var statLabel = 'Average 5 day precipitation for previous year: ' + result + 'mm';
  panelChart.add(ui.Label(statLabel, printStatisticStyle));
}
function stat4(result) 
{
  var statLabel = 'Cumulative precipitation over time series: ' + result + 'mm';
  panelChart.add(ui.Label(statLabel, printStatisticStyle));
}
function stat5(result) 
{
  var statLabel = 'Heaviest rainfall event: ' + result + 'mm';
  panelChart.add(ui.Label(statLabel, printStatisticStyle));
}
function stat6(result) 
{
  var statLabel = 'Date of last heavy shower (> 20 mm): ' + result ;
  panelChart.add(ui.Label(statLabel, printStatisticStyle));
}
/////////////////////////////////////////////////////////////////////////////////////////////////////////////
//ndvi (stat7 - stat10)
function stat7(result) 
{
  var statLabel = 'Average NDVI for time series: ' + result;
  panelChart.add(ui.Label(statLabel, printStatisticStyle));
}
function stat8(result) 
{
  var statLabel = 'Maximum NDVI for time series: ' + result;
  panelChart.add(ui.Label(statLabel, printStatisticStyle));
}
function stat9(result) 
{
  var statLabel = 'Minimum NDVI for time series: ' + result;
  panelChart.add(ui.Label(statLabel, printStatisticStyle));
}
function stat10(result) 
{
  var statLabel = 'Percentage bareground for selected intervention site: ' + result + '%';
  panelChart.add(ui.Label(statLabel, printStatisticStyle));
}
/////////////////////////////////////////////////////////////////////////////////////////////////
//npp (stat11 - stat14)
function stat11(result) 
{
  var statLabel = 'Average NPP for time series: ' + result + ' g/m2';
  panelChart.add(ui.Label(statLabel, printStatisticStyle));
}
function stat12(result) 
{
  var statLabel = 'Maximum NPP for time series: ' + result + ' g/m2';
  panelChart.add(ui.Label(statLabel, printStatisticStyle));
}
function stat13(result) 
{
  var statLabel = 'Minimum NPP for time series: ' + result + ' g/m2';
  panelChart.add(ui.Label(statLabel, printStatisticStyle));
}
function stat14(result) 
{
  var statLabel = 'Total carbon sequestered by vegetation: ' + result + ' g/m2';
  panelChart.add(ui.Label(statLabel, printStatisticStyle));
}
//////////////////////////////////////////////////////////////////////////////////////////////
//lst (stat15 - stat19)
function stat15(result) 
{
  var statLabel = 'Average land surface temperature for previous fortnight: ' + result + ' degrees C';
  panelChart.add(ui.Label(statLabel, printStatisticStyle));
}
function stat16(result) 
{
  var statLabel = 'Average land surface temperature for previous month: ' + result + ' degrees C';
  panelChart.add(ui.Label(statLabel, printStatisticStyle));
}
function stat17(result) 
{
  var statLabel = 'Average land surface temperature for previous year: ' + result + ' degrees C';
  panelChart.add(ui.Label(statLabel, printStatisticStyle));
}
function stat18(result) 
{
  var statLabel = 'Maximum land surface temperature: ' + result + ' degrees C';
  panelChart.add(ui.Label(statLabel, printStatisticStyle));
}
function stat19(result) 
{
  var statLabel = 'Minimum land surface temperature: ' + result + ' degrees C';
  panelChart.add(ui.Label(statLabel, printStatisticStyle));
}
//////////////////////////////////////////////////////////////////////////////////////////////////////
//soil moisture (stat20 - stat22)
function stat20(result) 
{
  var statLabel = 'Average subsurface soil moisture: ' + result + ' mm';
  panelChart.add(ui.Label(statLabel, printStatisticStyle));
}
function stat21(result) 
{
  var statLabel = 'Maximum subsurface soil moisture: ' + result + ' mm';
  panelChart.add(ui.Label(statLabel, printStatisticStyle));
}
function stat22(result) 
{
  var statLabel = 'Minimum subsurface soil moisture: ' + result + ' mm';
  panelChart.add(ui.Label(statLabel, printStatisticStyle));
}
////////////////////////////////////////////////////////////////////////////////////////////////////////
//atmospheric temperature (stat23 - stat27)
function stat23(result) 
{
  var statLabel = 'Average atmospheric temperature for previous fortnight: ' + result + ' degrees C';
  panelChart.add(ui.Label(statLabel, printStatisticStyle));
}
function stat24(result) 
{
  var statLabel = 'Average atmospheric temperature for previous month: ' + result + ' degrees C';
  panelChart.add(ui.Label(statLabel, printStatisticStyle));
}
function stat25(result) 
{
  var statLabel = 'Average atmospheric temperature for previous year: ' + result + ' degrees C';
  panelChart.add(ui.Label(statLabel, printStatisticStyle));
}
function stat26(result) 
{
  var statLabel = 'Maximum atmospheric temperature: ' + result + ' degrees C';
  panelChart.add(ui.Label(statLabel, printStatisticStyle));
}
function stat27(result) 
{
  var statLabel = 'Minimum atmospheric temperature: ' + result + ' degrees C';
  panelChart.add(ui.Label(statLabel, printStatisticStyle));
}
/////////////////////////////////////////////////////////////////////////////////////////////////
//osavi (stat28 - stat31)
function stat28(result) 
{
  var statLabel = 'Average OSAVI for time series: ' + result;
  panelChart.add(ui.Label(statLabel, printStatisticStyle));
}
function stat29(result) 
{
  var statLabel = 'Maximum OSAVI for time series: ' + result;
  panelChart.add(ui.Label(statLabel, printStatisticStyle));
}
function stat30(result) 
{
  var statLabel = 'Minimum OSAVI for time series: ' + result;
  panelChart.add(ui.Label(statLabel, printStatisticStyle));
}
function stat31(result) 
{
  var statLabel = 'Percentage bareground for selected intervention site: ' + result + '%';
  panelChart.add(ui.Label(statLabel, printStatisticStyle));
}
/////////////////////////////////////////////////////////////////////////////////////////////////
//                                   (10) BUTTONS
//(10.1) RESET BUTTON
var reset = ui.Button({
  label: 'Reset The Selection Menu', 
  onClick: function(){
    checkboxBuffer.setValue(false);
    checkboxRegionCompare.setValue(false);
    selectData.setValue(null);
    selectRegion.setValue(null);
    selectRegionOption2.setValue(null);
    sliderStart.setValue('2016-01-01');
    sliderEnd.setValue(ee.Date(Date.now()));
    description.setValue('');
  },
  disabled: false, 
  style: {position: 'bottom-left', backgroundColor: 'E9F5EB'},
});
///////////////////////////////////////////////////////////////////////////////////////////////////////
//(10.2) GENERATE DATA BUTTON
//(10.2.1) ERROR MESSAGES
//set up
var button = ui.Button({
  label: 'Generate Data',
  style: {position: 'bottom-left', backgroundColor: 'E9F5EB'},
  onClick: function(){
    panelChart.clear();
//check if all necessary inputs have been met
//not met? print error messages
    var ValidInput = true;
    if(selectData.getValue()===null){
      errorMessage.setValue('Select a dataset to analyse');
      ValidInput = false;
    }else if(selectRegion.getValue()===null){
      errorMessage.setValue('Select at least 1 location');
      ValidInput = false;
    }else if(selectRegion.getValue() == 'Select Custom Location' && drawingTools.layers().get(0).geometries().length()==0){
      //if(drawingTools.layers().get(0).geometries().length()==0){
        errorMessage.setValue('Draw a geometry on the map');
        ValidInput = false;
      //}
    }else{
      errorMessage.setValue('');
    }
//met? run the analysis
    if(ValidInput){
      var subtitle2 = ui.Label('Analysis', {stretch: 'horizontal', textAlign: 'center', fontWeight: 'bold', fontSize: '30px', backgroundColor: 'E9F5EB'});
      panelChart.add(subtitle2);
      var exportNote = ui.Label('Click the button at the top right of the chart to export the data as a CSV file or download the chart as a PNG image. When statistics print as undefined, export the raw data values into Excel to carry out your own analysis.', {fontSize: '11px', stretch: 'horizontal', textAlign: 'center', backgroundColor: 'E9F5EB'});
      panelChart.add(exportNote);
      map.remove(panelChart);
      map.layers().get(0).setShown(false);
      map.layers().get(1).setShown(false);
      map.layers().get(2).setShown(false);
      map.layers().get(3).setShown(false);
      map.layers().get(4).setShown(false);
      map.layers().get(5).setShown(false);
      map.layers().get(6).setShown(false);
      map.layers().get(7).setShown(false);
      map.layers().get(8).setShown(false);
      map.layers().get(9).setShown(false);
      map.add(panelChart);
        if(map.widgets().length() == 3){}
        else{map.add(legendContainer);}
////////////////////////////////////////////////////////////////////////////////////////////////////////////
//(10.2.2) RETREIVE SELECTED OPTIONS - IF SELECTED CUSTOM LOCATION FROM MAP
        if(selectRegion.getValue() == 'Select Custom Location'){
          //retreive geometry drawn on map
            var aoi = drawingTools.layers().get(0).getEeObject();
            var feature = ee.Feature(aoi);
            var customGeometry = ee.FeatureCollection(feature); //must be a feature collection data type for the analysis to run
            var activeDictionary = ui.data.ActiveDictionary(places);
          //replace placeholder in 'Select Custom Location' key with the drawn geometry
            activeDictionary.set('Select Custom Location', customGeometry);
          //set variable name label
            nameLabel1 = 'Custom location on the map';
          //index active dictionary to get the custom drawn geometry to feed into analysis
            var customShape = activeDictionary.get('Select Custom Location');
            var option2 = selectRegionOption2.getValue();
            var option3 = selectData.getValue();
            var croppedDataset = selectTimeFrame(data[option3]);
            var geom;
//if chose to compare against control/buffer area
            if(checkboxBuffer.getValue() === true){
              nameLabel2 = selectRegion.getValue() + ' Control Area';
              var interventionSite = customShape.geometry();
              var buffer = interventionSite.buffer(radius);
              var doughnut = buffer.difference(interventionSite, 1);
              var rename = ee.FeatureCollection(customShape.merge(doughnut));
              geom = rename;
              map.centerObject(geom).setZoom(7);
              removePreviousLayers();
              map.addLayer(customShape.draw({color:'ea812d', strokeWidth: 5}), {}, "Site 1", true);
              map.addLayer(doughnut, {color:'19c35a'}, "Site 1 Doughnut", true);
              map.layers().get(8).setShown(true);
              map.layers().get(9).setShown(true);
              legendContainer.clear();
            }
//if chose one location only
            else if(option2 === null){
              geom = customShape;
              map.centerObject(geom);
              removePreviousLayers();
              map.addLayer(customShape.draw({color:'ea812d', strokeWidth: 5}), {}, "Site 1", true);
              map.layers().get(8).setShown(true);
              map.layers().get(9).setShown(true);
              legendContainer.clear();
            }
//if chose to compare two regions
            else{
              nameLabel2 = selectRegionOption2.getValue();
              var geoms = customShape.merge(placesOption2[option2]);
              geom = geoms;
              map.centerObject(geom);
              removePreviousLayers();
              map.addLayer(customShape.draw({color:'ea812d', strokeWidth: 5}), {}, "Site 1", true);
              map.addLayer(placesOption2[option2].draw({color:'19c35a', strokeWidth: 5}), {}, "Site 2", true);
              map.layers().get(8).setShown(true);
              map.layers().get(9).setShown(true);
              legendContainer.clear();
            }
        }
/////////////////////////////////////////////////////////////////////////////////////////////////////////////
//(10.2.3) RETREIVE SELECTED OPTIONS - ALL OTHER CASES
        else{
            nameLabel1 = selectRegion.getValue();
            var option1 = selectRegion.getValue();
            var option2 = selectRegionOption2.getValue();
            var option3 = selectData.getValue();
            var croppedDataset = selectTimeFrame(data[option3]);
            var geom;
//if chose to compare against control/buffer area
            if(checkboxBuffer.getValue() === true){
              nameLabel2 = selectRegion.getValue() + ' Control Area';
              var interventionSite = places[option1].geometry();
              var buffer = interventionSite.buffer(radius);
              var doughnut = buffer.difference(interventionSite, 1);
              var rename = ee.FeatureCollection(places[option1].merge(doughnut));
              geom = rename;
              map.centerObject(geom).setZoom(7);
              removePreviousLayers();
              map.addLayer(places[option1].draw({color:'ea812d', strokeWidth: 5}), {}, "Site 1", true);
              map.addLayer(doughnut, {color:'19c35a'}, "Site 1 Doughnut", true);
              map.layers().get(8).setShown(true);
              map.layers().get(9).setShown(true);
              legendContainer.clear();
            }
//if chose one location only
            else if(option2 === null){
              geom = places[option1];
              map.centerObject(geom);
              removePreviousLayers();
              map.addLayer(places[option1].draw({color:'ea812d', strokeWidth: 5}), {}, "Site 1", true);
              map.layers().get(8).setShown(true);
              map.layers().get(9).setShown(true);
              legendContainer.clear();
            }
//if chose to compare two regions
            else{
              nameLabel2 = selectRegionOption2.getValue();
              var geoms = places[option1].merge(placesOption2[option2]);
              geom = geoms;
              map.centerObject(geom);
              removePreviousLayers();
              map.addLayer(places[option1].draw({color:'ea812d', strokeWidth: 5}), {}, "Site 1", true);
              map.addLayer(placesOption2[option2].draw({color:'19c35a', strokeWidth: 5}), {}, "Site 2", true);
              map.layers().get(8).setShown(true);
              map.layers().get(9).setShown(true);
              legendContainer.clear();
            }
        }
//////////////////////////////////////////////////////////////////////////////////////////////
//                        (11) SWITCH CASES BASED ON SELECTED DATASET
      switch (option3) {
        case 'Precipitation':
          Precipitation(croppedDataset, geom);
        break;
        case 'Normalised Difference Vegetation Index':
          Greenness(croppedDataset, geom);
        break;
        case 'Net Primary Production':
          NetPrimaryProduction(croppedDataset, geom);
        break;
        case 'Land Surface Temperature':
          LandSurfaceTemperature(croppedDataset, geom);
        break;
        case 'Soil Moisture':
          SoilMoisture(croppedDataset, geom);
        break;
        case 'Atmospheric Temperature':
          AtmosphericTemperature(croppedDataset, geom);
        break;
        case 'Optimised Soil-Adjusted Vegetation Index (Planet NICFI)':
          OptimisedSoilAdjustedGreeness1(croppedDataset, geom);
        break;
        case 'Optimised Soil-Adjusted Vegetation Index (Sentinel 2 MSI)':
          OptimisedSoilAdjustedGreeness3(croppedDataset, geom);
        break;
      }
  }
}});
////////////////////////////////////////////////////////////////////////////////////////////
//                                  (11.1) PRECIPITATION
//(11.1.1) PLOT CHART
function Precipitation(croppedDataset, geom){
        map.setZoom(7);
        var plotPRECIPITATION;
        if(geom.toList(2).size().getInfo()===1){
      // plot 1 location
           plotPRECIPITATION = ui.Chart.image.seriesByRegion(croppedDataset, geom, ee.Reducer.mean(),'precipitation',5000,'system:time_start', 'system:index')
          .setSeriesNames([nameLabel1])
          .setChartType('ColumnChart').setOptions({
                  title: 'Average Precipitation',
                  hAxis: {title: 'Time', titleTextStyle: {italic: false, bold: true}},
                  vAxis: {title: 'Cumulative 5-day Precipitation (mm)', titleTextStyle: {italic: false, bold: true}},
                  colors: ['ea812d'],
          });
        }else{
      // plot more than 1 locations
          plotPRECIPITATION = ui.Chart.image.seriesByRegion(croppedDataset, geom, ee.Reducer.mean(),'precipitation',5000,'system:time_start', 'system:index')
          .setSeriesNames([nameLabel1, nameLabel2])
          .setChartType('ColumnChart').setOptions({
                  title: 'Average Precipitation',
                  hAxis: {title: 'Time', titleTextStyle: {italic: false, bold: true}},
                  vAxis: {title: 'Cumulative 5-day Precipitation (mm)', titleTextStyle: {italic: false, bold: true}},
                  colors: ['ea812d','19c35a'],
          });
        }
        panelChart.add(plotPRECIPITATION);
        map.layers().get(0).setShown(true);
        panelChart.add(label5);
//////////////////////////////////////////////////////////////////////////////////////////////
//(11.1.2) CALCULATE STATISTICS
// for one location
    if(geom.toList(2).size().getInfo()===1){
      //list
        var algorithm = function(image, list) {
          var mean = image.reduceRegion({
          reducer: ee.Reducer.mean(),
          geometry: geom,
          scale: 5000,
          maxPixels: 1e9
          });
          var l = ee.List(list);
          var listName = l.add(mean.getNumber('precipitation'));
          return listName;
        };
        var precipList = ee.List(croppedDataset.iterate(algorithm, ee.List([])));
      //calculate
        var precipMean = precipList.reduce(ee.Reducer.mean());
        var precipCumulative = ee.Number(precipList.reduce(ee.Reducer.sum())).format('%.2f');
        var precipMax = ee.Number(precipList.reduce(ee.Reducer.max())).format('%.2f');
        var lastHeavyShowerList = precipList.filter(ee.Filter.gt('item', 20));
        var lastHeavyShower = lastHeavyShowerList.get(-1);
        var LHSIndex = precipList.indexOf(lastHeavyShower);
        var dateSearch = ee.Image(croppedDataset.toList(precipList.length()).get(LHSIndex));
        var dateOfEvent = ee.Date(dateSearch.get("system:time_start")).format('dd / MM / xxxx');
        var precipListFortnight = precipList.slice(-3);
        var fortnightAverage = ee.Number(precipListFortnight.reduce(ee.Reducer.mean())).format('%.2f');
        var precipListMonth = precipList.slice(-6);
        var monthAverage = ee.Number(precipListMonth.reduce(ee.Reducer.mean())).format('%.2f');
        var precipListYear = precipList.slice(-73);
        var yearAverage = ee.Number(precipListYear.reduce(ee.Reducer.mean())).format('%.2f');
      //print
        fortnightAverage.evaluate(stat1);
        monthAverage.evaluate(stat2);
        yearAverage.evaluate(stat3);
        precipCumulative.evaluate(stat4);
        precipMax.evaluate(stat5);
        dateOfEvent.evaluate(stat6);
    }
//for more than one location (repeat twice for each site)
    else{
      //seperate the polygons from geom (combined feature collection)
        var site1 = geom.filterMetadata("system:index","equals","1_00000000000000000000").first().geometry();
        var site2 = geom.filterMetadata("system:index","equals","2_00000000000000000000").first().geometry();
      //list
        var algorithmSite1 = function(image, list) {
          var mean = image.reduceRegion({
          reducer: ee.Reducer.mean(),
          geometry: site1,
          scale: 5000,
          maxPixels: 1e9
          });
          var l = ee.List(list);
          var listName = l.add(mean.getNumber('precipitation'));
          return listName;
        };
        var precipListSite1 = ee.List(croppedDataset.iterate(algorithmSite1, ee.List([])));
      //calculate
        var precipMeanSite1 = precipListSite1.reduce(ee.Reducer.mean());
        var precipCumulativeSite1 = ee.Number(precipListSite1.reduce(ee.Reducer.sum())).format('%.2f');
        var precipMaxSite1 = ee.Number(precipListSite1.reduce(ee.Reducer.max())).format('%.2f');
        var lastHeavyShowerListSite1 = precipListSite1.filter(ee.Filter.gt('item', 20));
        var lastHeavyShowerSite1 = lastHeavyShowerListSite1.get(-1);
        var LHSIndexSite1 = precipListSite1.indexOf(lastHeavyShowerSite1);
        var dateSearchSite1 = ee.Image(croppedDataset.toList(precipListSite1.length()).get(LHSIndexSite1));
        var dateOfEventSite1 = ee.Date(dateSearchSite1.get("system:time_start")).format('dd / MM / xxxx');
        var precipListFortnightSite1 = precipListSite1.slice(-3);
        var fortnightAverageSite1 = ee.Number(precipListFortnightSite1.reduce(ee.Reducer.mean())).format('%.2f');
        var precipListMonthSite1 = precipListSite1.slice(-6);
        var monthAverageSite1 = ee.Number(precipListMonthSite1.reduce(ee.Reducer.mean())).format('%.2f');
        var precipListYearSite1 = precipListSite1.slice(-73);
        var yearAverageSite1 = ee.Number(precipListYearSite1.reduce(ee.Reducer.mean())).format('%.2f');
      //labels
        fortnightAverageSite1.evaluate(subtitle1);
        fortnightAverageSite1.evaluate(stat1);
        monthAverageSite1.evaluate(stat2);
        yearAverageSite1.evaluate(stat3);
        precipCumulativeSite1.evaluate(stat4);
        precipMaxSite1.evaluate(stat5);
        dateOfEventSite1.evaluate(stat6);
      //list
        var algorithmSite2 = function(image, list) {
          var mean = image.reduceRegion({
          reducer: ee.Reducer.mean(),
          geometry: site2,
          scale: 5000,
          maxPixels: 1e9
          });
          var l = ee.List(list);
          var listName = l.add(mean.getNumber('precipitation'));
          return listName;
        };
      //calculate
        var precipListSite2 = ee.List(croppedDataset.iterate(algorithmSite2, ee.List([])));
        var precipMeanSite2 = precipListSite2.reduce(ee.Reducer.mean());
        var precipCumulativeSite2 = ee.Number(precipListSite2.reduce(ee.Reducer.sum())).format('%.2f');
        var precipMaxSite2 = ee.Number(precipListSite2.reduce(ee.Reducer.max())).format('%.2f');
        var lastHeavyShowerListSite2 = precipListSite2.filter(ee.Filter.gt('item', 20));
        var lastHeavyShowerSite2 = lastHeavyShowerListSite2.get(-1);
        var LHSIndexSite2 = precipListSite2.indexOf(lastHeavyShowerSite2);
        var dateSearchSite2 = ee.Image(croppedDataset.toList(precipListSite2.length()).get(LHSIndexSite2));
        var dateOfEventSite2 = ee.Date(dateSearchSite2.get("system:time_start")).format('dd / MM / xxxx');
        var precipListFortnightSite2 = precipListSite2.slice(-3);
        var fortnightAverageSite2 = ee.Number(precipListFortnightSite2.reduce(ee.Reducer.mean())).format('%.2f');
        var precipListMonthSite2 = precipListSite2.slice(-6);
        var monthAverageSite2 = ee.Number(precipListMonthSite2.reduce(ee.Reducer.mean())).format('%.2f');
        var precipListYearSite2 = precipListSite2.slice(-73);
        var yearAverageSite2 = ee.Number(precipListYearSite2.reduce(ee.Reducer.mean())).format('%.2f');
      //labels
        fortnightAverageSite2.evaluate(subtitle2);
        fortnightAverageSite2.evaluate(stat1);
        monthAverageSite2.evaluate(stat2);
        yearAverageSite2.evaluate(stat3);
        precipCumulativeSite2.evaluate(stat4);
        precipMaxSite2.evaluate(stat5);
        dateOfEventSite2.evaluate(stat6);
        }
//////////////////////////////////////////////////////////////////////////////////////////////
//(11.1.3) PRINT LEGEND
      //legend
      var legend = ui.Panel(
           [
             ui.Label('Precipitation', LEGEND_TITLE_STYLE), makeLegendPRECIP(),
             ui.Label('average rainfall (cumulative mm per pentad)', LEGEND_FOOTNOTE_STYLE),
             ui.Label('Source: CHIRPS Pentad: Climate Hazards Group InfraRed Precipitation With Station Data', LEGEND_FOOTNOTE_STYLE),
             makeRow('014c72', 'Ocean'),
             makeRow('bee6ff','Inland Water Bodies'),
           ],
           ui.Panel.Layout.flow('vertical'),
          {width: '250px', position: 'bottom-center', backgroundColor: 'E9F5EB'});
      legendContainer.add(legend);
}
////////////////////////////////////////////////////////////////////////////////////////////////////////
//                        (11.2) NORMALISED DIFFERENCE VEGETATION INDEX
//(11.2.1) PLOT CHART
function Greenness(croppedDataset, geom){
        map.setZoom(7);
        var plotNDVI;
      //for one location
        if(geom.toList(2).size().getInfo()===1){
        plotNDVI = ui.Chart.image.seriesByRegion(croppedDataset, geom, ee.Reducer.mean(),'NDVInew',10,'system:time_start', 'system:index')
              .setSeriesNames(['Site 1'])
              .setChartType('LineChart').setOptions({
                title: 'Average NDVI Time Series',
                hAxis: {title: 'Time', titleTextStyle: {italic: false, bold: true}},
                vAxis: {title: 'Pixel Greeness (NDVI)', titleTextStyle: {italic: false, bold: true}},
                colors: ['ea812d'],
        });
      //for more than one location
        }else{
        plotNDVI = ui.Chart.image.seriesByRegion(croppedDataset, geom, ee.Reducer.mean(),'NDVInew',10,'system:time_start', 'system:index')
              .setSeriesNames(['Site 1', 'Site 2'])
              .setChartType('LineChart').setOptions({
                title: 'Average NDVI Time Series',
                hAxis: {title: 'Time', titleTextStyle: {italic: false, bold: true}},
                vAxis: {title: 'Pixel Greeness (NDVI)', titleTextStyle: {italic: false, bold: true}},
                colors: ['ea812d','19c35a'],
        });
        }
        panelChart.add(plotNDVI);
        map.layers().get(1).setShown(true);
        panelChart.add(label5);
////////////////////////////////////////////////////////////////////////////////////////
//(11.2.2) CALCULATE STATISTICS
// for one location
if(geom.toList(2).size().getInfo()===1){
      //list
        var algorithm = function(image, list) {
          var mean = image.reduceRegion({
          reducer: ee.Reducer.mean(),
          geometry: geom,
          scale: 5000,
          maxPixels: 1e9
          });
          var l = ee.List(list);
          var listName = l.add(mean.getNumber('NDVInew'));
          return listName;
        };
      //calculate
        var ndviList = ee.List(croppedDataset.iterate(algorithm, ee.List([])));
        var ndviMean = ee.Number(ndviList.reduce(ee.Reducer.mean())).format('%.2f');
        var ndviMax = ee.Number(ndviList.reduce(ee.Reducer.max())).format('%.2f');
        var ndviMin = ee.Number(ndviList.reduce(ee.Reducer.min())).format('%.2f');
      //% bareground
          var imageNDVI = croppedDataset.reduce(ee.Reducer.mode());
          var bareground = imageNDVI.lt(0.25);
          var baregroundMasked = bareground.where(bareground.gte(0.25), 0);
          var totalPixelCount = imageNDVI.reduceRegion({
            reducer: ee.Reducer.count(),
            geometry: geom,
            scale: 250,
            maxPixels: 3e9
          }).getNumber('NDVInew_mode');
          var baregroundPixelCount = bareground.reduceRegion({
            reducer: ee.Reducer.sum().unweighted(),
            geometry: geom,
            scale: 250,
            maxPixels: 3e9
          }).getNumber('NDVInew_mode');
          var percentage = baregroundPixelCount.divide(totalPixelCount).multiply(100).format('%.2f');
      //labels
        ndviMean.evaluate(stat7);
        ndviMax.evaluate(stat8);
        ndviMin.evaluate(stat9);
        percentage.evaluate(stat10);
}
//for more than one location (repeat twice for each site)
else{
    //seperate the polygons from geom (combined feature collection)
        var site1 = geom.filterMetadata("system:index","equals","1_00000000000000000000").first().geometry();
        var site2 = geom.filterMetadata("system:index","equals","2_00000000000000000000").first().geometry();
      //list
        var algorithmSite1 = function(image, list) {
          var mean = image.reduceRegion({
          reducer: ee.Reducer.mean(),
          geometry: site1,
          scale: 5000,
          maxPixels: 1e9
          });
          var l = ee.List(list);
          var listName = l.add(mean.getNumber('NDVInew'));
          return listName;
        };
        var ndviListSite1 = ee.List(croppedDataset.iterate(algorithmSite1, ee.List([])));
      //calculate
        var ndviMeanSite1 = ee.Number(ndviListSite1.reduce(ee.Reducer.mean())).format('%.2f');
        var ndviMaxSite1 = ee.Number(ndviListSite1.reduce(ee.Reducer.max())).format('%.2f');
        var ndviMinSite1 = ee.Number(ndviListSite1.reduce(ee.Reducer.min())).format('%.2f');
      //% bareground
        // STEP 1: reduce image collection to most commonly occuring value of each pixel
          var imageNDVISite1 = croppedDataset.reduce(ee.Reducer.mode());
        // STEP 2: create binary image of bareground VS vegetation, using bareground threshold 
        //         NDVI < 0.25 from https://www.nature.com/articles/s41598-020-61408-1
          var baregroundSite1 = imageNDVISite1.lt(0.25);
          var baregroundMaskedSite1 = baregroundSite1.where(baregroundSite1.gte(0.25), 0);
        // STEP 3: count all pixels
          var totalPixelCountSite1 = imageNDVISite1.reduceRegion({
            reducer: ee.Reducer.count(),
            geometry: site1,
            scale: 250,
            maxPixels: 3e9
          }).getNumber('NDVInew_mode');
        // STEP 4: count bareground pixels
          var baregroundPixelCountSite1 = baregroundSite1.reduceRegion({
            reducer: ee.Reducer.sum().unweighted(),
            geometry: site1,
            scale: 250,
            maxPixels: 3e9
          }).getNumber('NDVInew_mode');
        // STEP 5: percentage bareground calculation
          var percentageSite1 = baregroundPixelCountSite1.divide(totalPixelCountSite1).multiply(100).format('%.2f');
      //labels
        ndviMeanSite1.evaluate(subtitle1);
        ndviMeanSite1.evaluate(stat7);
        ndviMaxSite1.evaluate(stat8);
        ndviMinSite1.evaluate(stat9);
        percentageSite1.evaluate(stat10);
      //list
        var algorithmSite2 = function(image, list) {
          var mean = image.reduceRegion({
          reducer: ee.Reducer.mean(),
          geometry: site2,
          scale: 5000,
          maxPixels: 1e9
          });
          var l = ee.List(list);
          var listName = l.add(mean.getNumber('NDVInew'));
          return listName;
        };
        var ndviListSite2 = ee.List(croppedDataset.iterate(algorithmSite2, ee.List([])));
      //calculate
        var ndviMeanSite2 = ee.Number(ndviListSite2.reduce(ee.Reducer.mean())).format('%.2f');
        var ndviMaxSite2 = ee.Number(ndviListSite2.reduce(ee.Reducer.max())).format('%.2f');
        var ndviMinSite2 = ee.Number(ndviListSite2.reduce(ee.Reducer.min())).format('%.2f');
      //% bareground
          var imageNDVISite2 = croppedDataset.reduce(ee.Reducer.mode());
          var baregroundSite2 = imageNDVISite2.lt(0.25);
          var baregroundMaskedSite2 = baregroundSite2.where(baregroundSite2.gte(0.25), 0);
          var totalPixelCountSite2 = imageNDVISite2.reduceRegion({
            reducer: ee.Reducer.count(),
            geometry: site2,
            scale: 250,
            maxPixels: 3e9
          }).getNumber('NDVInew_mode');
          var baregroundPixelCountSite2 = baregroundSite2.reduceRegion({
            reducer: ee.Reducer.sum().unweighted(),
            geometry: site2,
            scale: 250,
            maxPixels: 3e9
          }).getNumber('NDVInew_mode');
          var percentageSite2 = baregroundPixelCountSite2.divide(totalPixelCountSite2).multiply(100).format('%.2f');
      //print
        ndviMeanSite2.evaluate(subtitle2);
        ndviMeanSite2.evaluate(stat7);
        ndviMaxSite2.evaluate(stat8);
        ndviMinSite2.evaluate(stat9);
        percentageSite2.evaluate(stat10);
}
////////////////////////////////////////////////////////////////////////////////////////////
//(11.2.3) PRINT LEGEND
      var legend = ui.Panel(
            [
              ui.Label('NDVI', LEGEND_TITLE_STYLE), makeLegendNDVI(),
              ui.Label('Normalised Difference Vegetation Index', LEGEND_FOOTNOTE_STYLE),
              ui.Label('Source: MOD13Q1.006 Terra Vegetation Indices 16-Day Global 250m', LEGEND_FOOTNOTE_STYLE),
              makeRow('014c72', 'Ocean'),
              makeRow('bee6ff','Inland Water Bodies'),
            ],
      ui.Panel.Layout.flow('vertical'),
      {width: '250px', position: 'bottom-center', backgroundColor: 'E9F5EB'});
      legendContainer.add(legend);
}
/////////////////////////////////////////////////////////////////////////////////////////////
//                        (11.3) NET PRIMARY PRODUCTIVITY
//(11.3.1) PLOT CHART
function NetPrimaryProduction(croppedDataset, geom){
        map.setZoom(7);
        var plotNPP;
//for one location
        if(geom.toList(2).size().getInfo()===1){
        plotNPP = ui.Chart.image.seriesByRegion(croppedDataset, geom, ee.Reducer.mean(),'NPP',250,'system:time_start', 'system:index')
              .setSeriesNames(['Site 1'])
              .setChartType('AreaChart').setOptions({
                title: 'Average Net Photosynthesis Time Series',
                hAxis: {title: 'Time', titleTextStyle: {italic: false, bold: true}},
                vAxis: {title: 'Net Photosynthesis\n(g/m^2)', titleTextStyle: {italic: false, bold: true}},
                colors: ['ea812d'],
        });
        }
//for more than one location
        else{
          plotNPP = ui.Chart.image.seriesByRegion(croppedDataset, geom, ee.Reducer.mean(),'NPP',250,'system:time_start', 'system:index')
              .setSeriesNames(['Site 1', 'Site 2'])
              .setChartType('AreaChart').setOptions({
                title: 'Average Net Photosynthesis Time Series',
                hAxis: {title: 'Time', titleTextStyle: {italic: false, bold: true}},
                vAxis: {title: 'Net Photosynthesis\n(g/m^2)', titleTextStyle: {italic: false, bold: true}},
                colors: ['ea812d','19c35a'],
        });
        }
        panelChart.add(plotNPP);
        map.layers().get(2).setShown(true);
        panelChart.add(label5);
////////////////////////////////////////////////////////////////////////////////////////
//(11.3.2) CALCULATE STATISTICS
//for one location
    if(geom.toList(2).size().getInfo()===1){
      //list
        var algorithm = function(image, list) {
          var mean = image.reduceRegion({
          reducer: ee.Reducer.mean(),
          geometry: geom,
          scale: 5000,
          maxPixels: 1e9
          });
          var l = ee.List(list);
          var listName = l.add(mean.getNumber('NPP'));
          return listName;
        };
        var nppList = ee.List(croppedDataset.iterate(algorithm, ee.List([])));
      //calculate
        var nppMean = ee.Number(nppList.reduce(ee.Reducer.mean())).format('%.2f');
        var nppMax = ee.Number(nppList.reduce(ee.Reducer.max())).format('%.2f');
        var nppMin = ee.Number(nppList.reduce(ee.Reducer.min())).format('%.2f');
      //total carbon sequestered (sum of npp over time series)
        var nppSum = ee.Number(nppList.reduce(ee.Reducer.sum())).format('%.2f');
      //labels
        nppMean.evaluate(subtitle1); 
        nppMean.evaluate(stat11);
        nppMax.evaluate(stat12);
        nppMin.evaluate(stat13);
        nppSum.evaluate(stat14);
    }
//for more than one location (repeat twice for each region)
    else{
      //separate geom into two individual sites
        var site1 = geom.filterMetadata("system:index","equals","1_00000000000000000000").first().geometry();
        var site2 = geom.filterMetadata("system:index","equals","2_00000000000000000000").first().geometry();
      //list
        var algorithmSite1 = function(image, list) {
          var mean = image.reduceRegion({
          reducer: ee.Reducer.mean(),
          geometry: site1,
          scale: 5000,
          maxPixels: 1e9
          });
          var l = ee.List(list);
          var listName = l.add(mean.getNumber('NPP'));
          return listName;
        };
        var nppListSite1 = ee.List(croppedDataset.iterate(algorithmSite1, ee.List([])));
      //calculate
        var nppMeanSite1 = ee.Number(nppListSite1.reduce(ee.Reducer.mean())).format('%.2f');
        var nppMaxSite1 = ee.Number(nppListSite1.reduce(ee.Reducer.max())).format('%.2f');
        var nppMinSite1 = ee.Number(nppListSite1.reduce(ee.Reducer.min())).format('%.2f');
      //total carbon sequestered (sum of npp over time series)
        var nppSumSite1 = ee.Number(nppListSite1.reduce(ee.Reducer.sum())).format('%.2f');
      //print
        nppMeanSite1.evaluate(subtitle1); 
        nppMeanSite1.evaluate(stat11);
        nppMaxSite1.evaluate(stat12);
        nppMinSite1.evaluate(stat13);
        nppSumSite1.evaluate(stat14);
      //list
        var algorithmSite2 = function(image, list) {
          var mean = image.reduceRegion({
          reducer: ee.Reducer.mean(),
          geometry: site2,
          scale: 5000,
          maxPixels: 1e9
          });
          var l = ee.List(list);
          var listName = l.add(mean.getNumber('NPP'));
          return listName;
        };
        var nppListSite2 = ee.List(croppedDataset.iterate(algorithmSite2, ee.List([])));
      //calculate
        var nppMeanSite2 = ee.Number(nppListSite2.reduce(ee.Reducer.mean())).format('%.2f');
        var nppMaxSite2 = ee.Number(nppListSite2.reduce(ee.Reducer.max())).format('%.2f');
        var nppMinSite2 = ee.Number(nppListSite2.reduce(ee.Reducer.min())).format('%.2f');
      //total carbon sequestered (sum of npp over time series)
        var nppSumSite2 = ee.Number(nppListSite2.reduce(ee.Reducer.sum())).format('%.2f');
      //print
        nppMeanSite2.evaluate(subtitle2); 
        nppMeanSite2.evaluate(stat11);
        nppMaxSite2.evaluate(stat12);
        nppMinSite2.evaluate(stat13);
        nppSumSite2.evaluate(stat14);
        }
//////////////////////////////////////////////////////////////////////////////////////////
//(11.3.3) PRINT LEGEND
        var legend = ui.Panel(
           [
             ui.Label('Net Primary Production', LEGEND_TITLE_STYLE), makeLegendNPP(),
             ui.Label('(g/m2)', LEGEND_FOOTNOTE_STYLE),
             ui.Label('Source: WAPOR Dekadal Net Primary Production', LEGEND_FOOTNOTE_STYLE),
             makeRow('014c72', 'Ocean'),
             makeRow('bee6ff','Inland Water Bodies'),
           ],
           ui.Panel.Layout.flow('vertical'),
           {width: '250px', position: 'bottom-center', backgroundColor: 'E9F5EB'}); 
        legendContainer.add(legend);
}
////////////////////////////////////////////////////////////////////////////////////////////
//                        (11.4) LAND SURFACE TEMPERATURE
//(11.4.1) PLOT CHART
function LandSurfaceTemperature(croppedDataset, geom){
        map.setZoom(7);
        var plotLST;
//for one location
          if(geom.toList(2).size().getInfo()===1){
            plotLST = ui.Chart.image.seriesByRegion(croppedDataset, geom, ee.Reducer.mean(),'DEGREESC',1000,'system:time_start', 'system:index')
            .setSeriesNames(['Site 1'])
            .setChartType('LineChart').setOptions({
                   title: 'Average Land Surface Temperature',
                    hAxis: {title: 'Time', titleTextStyle: {italic: false, bold: true}},
                    vAxis: {title: 'Temperature\n(Degrees C)', titleTextStyle: {italic: false, bold: true}},
                    colors: ['ea812d'],
            });
//for more than one location
          }else{
            plotLST = ui.Chart.image.seriesByRegion(croppedDataset, geom, ee.Reducer.mean(),'DEGREESC',500,'system:time_start', 'system:index')
            .setSeriesNames(['Site 1', 'Site 2'])
            .setChartType('LineChart').setOptions({
                   title: 'Average Land Surface Temperature',
                    hAxis: {title: 'Time', titleTextStyle: {italic: false, bold: true}},
                    vAxis: {title: 'Temperature\n(Degrees C)', titleTextStyle: {italic: false, bold: true}},
                    colors: ['ea812d','19c35a'],
            });
        }
        panelChart.add(plotLST);
        map.layers().get(3).setShown(true);
        panelChart.add(label5);
////////////////////////////////////////////////////////////////////////////////////////////////
//(11.4.2) CALCULATE STATISTICS
//for one location
if(geom.toList(2).size().getInfo()===1){
      //list
        var algorithm = function(image, list) {
          var mean = image.reduceRegion({
          reducer: ee.Reducer.mean(),
          geometry: geom,
          scale: 1000,
          maxPixels: 1e9
          });
          var l = ee.List(list);
          var listName = l.add(mean.getNumber('DEGREESC'));
          return listName;
        };
      //calculate
        var lstList = ee.List(croppedDataset.iterate(algorithm, ee.List([])));
        print(lstList);
        var lstMean = ee.Number(lstList.reduce(ee.Reducer.mean())).format('%.2f');
        print(lstMean);
        var lstListFortnight = lstList.slice(-3);
        var lstFortnightAverage = ee.Number(lstListFortnight.reduce(ee.Reducer.mean())).format('%.2f');
        print(lstFortnightAverage);
        var lstListMonth = lstList.slice(-6);
        var lstMonthAverage = ee.Number(lstListMonth.reduce(ee.Reducer.mean())).format('%.2f');
        print(lstMonthAverage);
        var lstListYear = lstList.slice(-73);
        var lstYearAverage = ee.Number(lstListYear.reduce(ee.Reducer.mean())).format('%.2f');
        print(lstYearAverage);
        var lstMax = ee.Number(lstList.reduce(ee.Reducer.max())).format('%.2f');
        print(lstMax);
        var lstMin = ee.Number(lstList.reduce(ee.Reducer.min())).format('%.2f');
        print(lstMin);
      //print
        lstFortnightAverage.evaluate(stat15);
        lstMonthAverage.evaluate(stat16);
        lstYearAverage.evaluate(stat17);
        lstMax.evaluate(stat18);
        lstMin.evaluate(stat19);
//for more than one location (print twice for each region)
}else{
    //separate geom into each individual polygon
        var site1 = geom.filterMetadata("system:index","equals","1_00000000000000000000").first().geometry();
        var site2 = geom.filterMetadata("system:index","equals","2_00000000000000000000").first().geometry();
      //list
        var algorithmSite1 = function(image, list) {
          var mean = image.reduceRegion({
          reducer: ee.Reducer.mean(),
          geometry: site1,
          scale: 5000,
          maxPixels: 1e9
          });
          var l = ee.List(list);
          var listName = l.add(mean.getNumber('NDVInew'));
          return listName;
        };
    //calculations  
      var lstListSite1 = ee.List(croppedDataset.iterate(algorithmSite1, ee.List([])));
        print(lstListSite1);
        var lstMeanSite1 = ee.Number(lstListSite1.reduce(ee.Reducer.mean())).format('%.2f');
        print(lstMeanSite1);
        var lstListFortnightSite1 = lstListSite1.slice(-3);
        var lstFortnightAverageSite1 = ee.Number(lstListFortnightSite1.reduce(ee.Reducer.mean())).format('%.2f');
        print(lstFortnightAverageSite1);
        var lstListMonthSite1 = lstListSite1.slice(-6);
        var lstMonthAverageSite1 = ee.Number(lstListMonthSite1.reduce(ee.Reducer.mean())).format('%.2f');
        print(lstMonthAverageSite1);
        var lstListYearSite1 = lstListSite1.slice(-73);
        var lstYearAverageSite1 = ee.Number(lstListYearSite1.reduce(ee.Reducer.mean())).format('%.2f');
        print(lstYearAverageSite1);
        var lstMaxSite1 = ee.Number(lstListSite1.reduce(ee.Reducer.max())).format('%.2f');
        print(lstMaxSite1);
        var lstMinSite1 = ee.Number(lstListSite1.reduce(ee.Reducer.min())).format('%.2f');
        print(lstMinSite1);
      //print
        lstMeanSite1.evaluate(subtitle1);
        lstFortnightAverageSite1.evaluate(stat15);
        lstMonthAverageSite1.evaluate(stat16);
        lstYearAverageSite1.evaluate(stat17);
        lstMaxSite1.evaluate(stat18);
        lstMinSite1.evaluate(stat19);
      //list
        var algorithmSite2 = function(image, list) {
          var mean = image.reduceRegion({
          reducer: ee.Reducer.mean(),
          geometry: site2,
          scale: 5000,
          maxPixels: 1e9
          });
          var l = ee.List(list);
          var listName = l.add(mean.getNumber('NDVInew'));
          return listName;
        };
    //calculations
      var lstListSite2 = ee.List(croppedDataset.iterate(algorithmSite2, ee.List([])));
        print(lstListSite2);
        var lstMeanSite2 = ee.Number(lstListSite2.reduce(ee.Reducer.mean())).format('%.2f');
        print(lstMeanSite2);
        var lstListFortnightSite2 = lstListSite2.slice(-3);
        var lstFortnightAverageSite2 = ee.Number(lstListFortnightSite2.reduce(ee.Reducer.mean())).format('%.2f');
        print(lstFortnightAverageSite2);
        var lstListMonthSite2 = lstListSite2.slice(-6);
        var lstMonthAverageSite2 = ee.Number(lstListMonthSite2.reduce(ee.Reducer.mean())).format('%.2f');
        print(lstMonthAverageSite2);
        var lstListYearSite2 = lstListSite2.slice(-73);
        var lstYearAverageSite2 = ee.Number(lstListYearSite2.reduce(ee.Reducer.mean())).format('%.2f');
        print(lstYearAverageSite2);
        var lstMaxSite2 = ee.Number(lstListSite2.reduce(ee.Reducer.max())).format('%.2f');
        print(lstMaxSite2);
        var lstMinSite2 = ee.Number(lstListSite2.reduce(ee.Reducer.min())).format('%.2f');
        print(lstMinSite2);
      //print
        lstMeanSite2.evaluate(subtitle2);
        lstFortnightAverageSite2.evaluate(stat15);
        lstMonthAverageSite2.evaluate(stat16);
        lstYearAverageSite2.evaluate(stat17);
        lstMaxSite2.evaluate(stat18);
        lstMinSite2.evaluate(stat19);
}
/////////////////////////////////////////////////////////////////////////////////////////
//(11.4.3) PRINT LEGEND
      var legend = ui.Panel(
            [
              ui.Label('Land Surface Temperature', LEGEND_TITLE_STYLE), makeLegendLST(),
              ui.Label('average temperature (degrees C)', LEGEND_FOOTNOTE_STYLE),
              ui.Label('Source: MODIS Terra Land Surface Temperature and Emissivity 8-Day Global 1km', LEGEND_FOOTNOTE_STYLE),
              makeRow('014c72', 'Ocean'),
              makeRow('bee6ff','Inland Water Bodies'),
            ],
      ui.Panel.Layout.flow('vertical'),
      {width: '250px', position: 'bottom-center', backgroundColor: 'E9F5EB'});
      legendContainer.add(legend);
}
///////////////////////////////////////////////////////////////////////////////////////////
//                             (11.5) SOIL MOISTURE
//(11.5.1) PLOT CHART
function SoilMoisture(croppedDataset, geom){
        map.setZoom(7);
        var plotSMAP;
//for one location
          if(geom.toList(2).size().getInfo()===1){
            plotSMAP = ui.Chart.image.seriesByRegion(croppedDataset, geom, ee.Reducer.mean(),'susm', 10000,'system:time_start', 'system:index')
              .setSeriesNames(['Site 1'])
              .setChartType('AreaChart').setOptions({
                title: 'Average Sub Surface Soil Moisture Time Series',
                hAxis: {title: 'Time', titleTextStyle: {italic: false, bold: true}},
                vAxis: {title: 'Soil Moisture (mm)', titleTextStyle: {italic: false, bold: true}},
                colors: ['ea812d'],
        });
//for more than one location
          }else{
            plotSMAP = ui.Chart.image.seriesByRegion(croppedDataset, geom, ee.Reducer.mean(),'susm', 10000,'system:time_start', 'system:index')
              .setSeriesNames(['Site 1', 'Site 2'])
              .setChartType('AreaChart').setOptions({
                title: 'Average Sub Surface Soil Moisture Time Series',
                hAxis: {title: 'Time', titleTextStyle: {italic: false, bold: true}},
                vAxis: {title: 'Soil Moisture (mm)', titleTextStyle: {italic: false, bold: true}},
                colors: ['ea812d','19c35a'],
            });
          }
        panelChart.add(plotSMAP);
        map.layers().get(4).setShown(true);
        panelChart.add(label5);
////////////////////////////////////////////////////////////////////////////////////////
//(11.5.2) CALCULATE STATISTICS
//for one location
if(geom.toList(2).size().getInfo()===1){
      //list
        var algorithm = function(image, list) {
          var mean = image.reduceRegion({
          reducer: ee.Reducer.mean(),
          geometry: geom,
          scale: 5000,
          maxPixels: 1e9
          });
          var l = ee.List(list);
          var listName = l.add(mean.getNumber('susm'));
          return listName;
        };
        var smList = ee.List(croppedDataset.iterate(algorithm, ee.List([])));
      //calculations
        var smMean = ee.Number(smList.reduce(ee.Reducer.mean())).format('%.2f');
        var smMax = ee.Number(smList.reduce(ee.Reducer.max())).format('%.2f');
        var smMin = ee.Number(smList.reduce(ee.Reducer.min())).format('%.2f');
      //labels
        smMean.evaluate(stat20);
        smMax.evaluate(stat21);
        smMin.evaluate(stat22);
//for more than one location (repeat twice for each region)
}else{
    //separate geom into two individual shapefiles
        var site1 = geom.filterMetadata("system:index","equals","1_00000000000000000000").first().geometry();
        var site2 = geom.filterMetadata("system:index","equals","2_00000000000000000000").first().geometry();
      //list
        var algorithmSite1 = function(image, list) {
          var mean = image.reduceRegion({
          reducer: ee.Reducer.mean(),
          geometry: site1,
          scale: 5000,
          maxPixels: 1e9
          });
          var l = ee.List(list);
          var listName = l.add(mean.getNumber('susm'));
          return listName;
        };
        var smListSite1 = ee.List(croppedDataset.iterate(algorithmSite1, ee.List([])));
      //calculations
        var smMeanSite1 = ee.Number(smListSite1.reduce(ee.Reducer.mean())).format('%.2f');
        var smMaxSite1 = ee.Number(smListSite1.reduce(ee.Reducer.max())).format('%.2f');
        var smMinSite1 = ee.Number(smListSite1.reduce(ee.Reducer.min())).format('%.2f');
      //labels
        smMeanSite1.evaluate(subtitle1);
        smMeanSite1.evaluate(stat20);
        smMaxSite1.evaluate(stat21);
        smMinSite1.evaluate(stat22);
      //list
        var algorithmSite2 = function(image, list) {
          var mean = image.reduceRegion({
          reducer: ee.Reducer.mean(),
          geometry: site2,
          scale: 5000,
          maxPixels: 1e9
          });
          var l = ee.List(list);
          var listName = l.add(mean.getNumber('susm'));
          return listName;
        };
        var smListSite2 = ee.List(croppedDataset.iterate(algorithmSite2, ee.List([])));
      //calculations
        var smMeanSite2 = ee.Number(smListSite2.reduce(ee.Reducer.mean())).format('%.2f');
        var smMaxSite2 = ee.Number(smListSite2.reduce(ee.Reducer.max())).format('%.2f');
        var smMinSite2 = ee.Number(smListSite2.reduce(ee.Reducer.min())).format('%.2f');
      //labels
        smMeanSite2.evaluate(subtitle2);
        smMeanSite2.evaluate(stat20);
        smMaxSite2.evaluate(stat21);
        smMinSite2.evaluate(stat22);
}
///////////////////////////////////////////////////////////////////////////////////////////
//(11.5.3) PRINT LEGEND
      var legend = ui.Panel(
           [
              ui.Label('Soil Moisture', LEGEND_TITLE_STYLE), makeLegendSM(),
              ui.Label('average subsurface soil moisture (mm)', LEGEND_FOOTNOTE_STYLE),
              ui.Label('Source: NASA-USDA Enhanced SMAP Global Soil Moisture Data', LEGEND_FOOTNOTE_STYLE),
              makeRow('014c72', 'Ocean'),
              makeRow('bee6ff','Inland Water Bodies'),
           ],
      ui.Panel.Layout.flow('vertical'),
      {width: '250px', position: 'bottom-center', backgroundColor: 'E9F5EB'});
      legendContainer.add(legend);
}
/////////////////////////////////////////////////////////////////////////////////////////////
//                     (11.6) ATMOSPHERIC TEMPERATURE
//(11.6.1) PLOT CHART
function AtmosphericTemperature(croppedDataset, geom){
        map.setZoom(7);
        var plotAT;
//for one location
          if(geom.toList(2).size().getInfo()===1){
            plotAT = ui.Chart.image.seriesByRegion(croppedDataset, geom, ee.Reducer.mean(),'DEGREESC2',100,'system:time_start', 'system:index')
           .setSeriesNames(['Site 1'])
           .setChartType('LineChart').setOptions({
                    title: 'Average Atmospheric Temperature (measured 2m above ground)',
                    hAxis: {title: 'Time', titleTextStyle: {italic: false, bold: true}},
                    vAxis: {title: 'Temperature\n(Degrees C)', titleTextStyle: {italic: false, bold: true}},
                    colors: ['ea812d'],
            });
//for more than one location
          }else{
            plotAT = ui.Chart.image.seriesByRegion(croppedDataset, geom, ee.Reducer.mean(),'DEGREESC2',100,'system:time_start', 'system:index')
           .setSeriesNames(['Site 1', 'Site 2'])
           .setChartType('LineChart').setOptions({
                    title: 'Average Atmospheric Temperature (measured 2m above ground)',
                    hAxis: {title: 'Time', titleTextStyle: {italic: false, bold: true}},
                    vAxis: {title: 'Temperature\n(Degrees C)', titleTextStyle: {italic: false, bold: true}},
                    colors: ['ea812d','19c35a'],
            });
          }
        panelChart.add(plotAT);
        map.layers().get(5).setShown(true);
        panelChart.add(label5);
//////////////////////////////////////////////////////////////////////////////////////////
//(11.6.2) CALCULATE STATISTICS
// for one location
if(geom.toList(2).size().getInfo()===1){
      //list
        var algorithm = function(image, list) {
          var mean = image.reduceRegion({
          reducer: ee.Reducer.mean(),
          geometry: geom,
          scale: 5000,
          maxPixels: 1e9
          });
          var l = ee.List(list);
          var listName = l.add(mean.getNumber('DEGREESC2'));
          return listName;
        };
        var atList = ee.List(croppedDataset.iterate(algorithm, ee.List([])));
      //calculations
        var atMean = ee.Number(atList.reduce(ee.Reducer.mean())).format('%.2f');
        var atListMonth = atList.slice(-1);
        var atMonthAverage = ee.Number(atListMonth.reduce(ee.Reducer.mean())).format('%.2f');
        var atListYear = atList.slice(-12);
        var atYearAverage = ee.Number(atListYear.reduce(ee.Reducer.mean())).format('%.2f');
        var atMax = ee.Number(atList.reduce(ee.Reducer.max())).format('%.2f');
        var atMin = ee.Number(atList.reduce(ee.Reducer.min())).format('%.2f');
      //print
        atMonthAverage.evaluate(stat24);
        atYearAverage.evaluate(stat25);
        atMax.evaluate(stat26);
        atMin.evaluate(stat27);
//for more than one location (repeat twice for both locations)
}else{
      //get individual polygons from geom
        var site1 = geom.filterMetadata("system:index","equals","1_00000000000000000000").first().geometry();
        var site2 = geom.filterMetadata("system:index","equals","2_00000000000000000000").first().geometry();
      //list
        var algorithmSite1 = function(image, list) {
          var mean = image.reduceRegion({
          reducer: ee.Reducer.mean(),
          geometry: site1,
          scale: 5000,
          maxPixels: 1e9
          });
          var l = ee.List(list);
          var listName = l.add(mean.getNumber('DEGREESC2'));
          return listName;
        };
        var atListSite1 = ee.List(croppedDataset.iterate(algorithmSite1, ee.List([])));
      //calculations
        var atMeanSite1 = ee.Number(atListSite1.reduce(ee.Reducer.mean())).format('%.2f');
        var atListMonthSite1 = atListSite1.slice(-1);
        var atMonthAverageSite1 = ee.Number(atListMonthSite1.reduce(ee.Reducer.mean())).format('%.2f');
        var atListYearSite1 = atListSite1.slice(-12);
        var atYearAverageSite1 = ee.Number(atListYearSite1.reduce(ee.Reducer.mean())).format('%.2f');
        var atMaxSite1 = ee.Number(atListSite1.reduce(ee.Reducer.max())).format('%.2f');
        var atMinSite1 = ee.Number(atListSite1.reduce(ee.Reducer.min())).format('%.2f');
      //print
        atMeanSite1.evaluate(subtitle1);
        atMonthAverageSite1.evaluate(stat24);
        atYearAverageSite1.evaluate(stat25);
        atMaxSite1.evaluate(stat26);
        atMinSite1.evaluate(stat27);
      //list
        var algorithmSite2 = function(image, list) {
          var mean = image.reduceRegion({
          reducer: ee.Reducer.mean(),
          geometry: site2,
          scale: 5000,
          maxPixels: 1e9
          });
          var l = ee.List(list);
          var listName = l.add(mean.getNumber('DEGREESC2'));
          return listName;
        };
        var atListSite2 = ee.List(croppedDataset.iterate(algorithmSite2, ee.List([])));
      //calculations
        var atMeanSite2 = ee.Number(atListSite2.reduce(ee.Reducer.mean())).format('%.2f');
        var atListMonthSite2 = atListSite2.slice(-1);
        var atMonthAverageSite2 = ee.Number(atListMonthSite2.reduce(ee.Reducer.mean())).format('%.2f');
        var atListYearSite2 = atListSite2.slice(-12);
        var atYearAverageSite2 = ee.Number(atListYearSite2.reduce(ee.Reducer.mean())).format('%.2f');
        var atMaxSite2 = ee.Number(atListSite2.reduce(ee.Reducer.max())).format('%.2f');
        var atMinSite2 = ee.Number(atListSite2.reduce(ee.Reducer.min())).format('%.2f');
      //print
        atMeanSite2.evaluate(subtitle2);
        atMonthAverageSite2.evaluate(stat24);
        atYearAverageSite2.evaluate(stat25);
        atMaxSite2.evaluate(stat26);
        atMinSite2.evaluate(stat27);
}
//////////////////////////////////////////////////////////////////////////////////////////
//(11.6.3) PRINT LEGEND
      var legend = ui.Panel(
            [
              ui.Label('Atmospheric Temperature', LEGEND_TITLE_STYLE), makeLegendAT(),
              ui.Label('average temperature (degrees C)', LEGEND_FOOTNOTE_STYLE),
              ui.Label('Source: ERA5-Land Monthly Averaged - ECMWF Climate Reanalysis', LEGEND_FOOTNOTE_STYLE),
              makeRow('014c72', 'Ocean'),
              makeRow('bee6ff','Inland Water Bodies'),
            ],
      ui.Panel.Layout.flow('vertical'),
      {width: '250px', position: 'bottom-center', backgroundColor: 'E9F5EB'});
      legendContainer.add(legend);
}
////////////////////////////////////////////////////////////////////////////////////////////////
//                  (11.7) OPTIMISED SOIL-ADJUSTED VEGETATION INDEX PLANET NICFI
//(11.7.1) PLOT CHART
function OptimisedSoilAdjustedGreeness1(croppedDataset, geom){
        map.setZoom(7);
        var plotOSAVI;
//for one location
        if(geom.toList(2).size().getInfo()===1){
        plotOSAVI = ui.Chart.image.seriesByRegion(croppedDataset, geom, ee.Reducer.mean(),'OSAVI',5,'system:time_start', 'system:index')
              .setSeriesNames(['Site 1'])
              .setChartType('LineChart').setOptions({
                title: 'Average OSAVI Time Series Derived From Planet NICFI',
                hAxis: {title: 'Time', titleTextStyle: {italic: false, bold: true}},
                vAxis: {title: 'Pixel Greeness (OSAVI)', titleTextStyle: {italic: false, bold: true}},
                colors: ['ea812d'],
        });
//for more than one location
        }else{
        plotOSAVI = ui.Chart.image.seriesByRegion(croppedDataset, geom, ee.Reducer.mean(),'OSAVI',5,'system:time_start', 'system:index')
              .setSeriesNames(['Site 1', 'Site 2'])
              .setChartType('LineChart').setOptions({
                title: 'Average OSAVI Time Series Derived From Planet NICFI',
                hAxis: {title: 'Time', titleTextStyle: {italic: false, bold: true}},
                vAxis: {title: 'Pixel Greeness (OSAVI)', titleTextStyle: {italic: false, bold: true}},
                colors: ['ea812d','19c35a'],
        });
        }
        panelChart.add(plotOSAVI);
        map.layers().get(6).setShown(true);
        panelChart.add(label5);
///////////////////////////////////////////////////////////////////////////////////////////
//(11.7.2) CALCULATE STATISTICS
//for one location
if(geom.toList(2).size().getInfo()===1){
      //list
        var algorithm = function(image, list) {
          var mean = image.reduceRegion({
          reducer: ee.Reducer.mean(),
          geometry: geom,
          scale: 5,
          maxPixels: 1e9
          });
          var l = ee.List(list);
          var listName = l.add(mean.getNumber('OSAVI'));
          return listName;
        };
        var osaviPlanetList = ee.List(croppedDataset.iterate(algorithm, ee.List([])));
      //calculations
        var osaviMean = ee.Number(osaviPlanetList.reduce(ee.Reducer.mean())).format('%.2f');
        var osaviMax = ee.Number(osaviPlanetList.reduce(ee.Reducer.max())).format('%.2f');
        var osaviMin = ee.Number(osaviPlanetList.reduce(ee.Reducer.min())).format('%.2f');
      //% bareground
          var imageOSAVIplanet = croppedDataset.reduce(ee.Reducer.mode());
          var bareground = imageOSAVIplanet.lt(0.25);
          var baregroundMasked = bareground.where(bareground.gte(0.25), 0);
          var totalPixelCount = imageOSAVIplanet.reduceRegion({
            reducer: ee.Reducer.count(),
            geometry: geom,
            scale: 5,
            maxPixels: 3e9
          }).getNumber('OSAVI_mode');
          var baregroundPixelCount = bareground.reduceRegion({
            reducer: ee.Reducer.sum().unweighted(),
            geometry: geom,
            scale: 5,
            maxPixels: 3e9
          }).getNumber('OSAVI_mode');
          var percentage = baregroundPixelCount.divide(totalPixelCount).multiply(100).format('%.2f');
      //print
        osaviMean.evaluate(stat28);
        osaviMax.evaluate(stat29);
        osaviMin.evaluate(stat30);
        percentage.evaluate(stat31);
//for more than one location (repeat twice, once for each location selected)
}else{
      //separate individual polygons from geom
        var site1 = geom.filterMetadata("system:index","equals","1_00000000000000000000").first().geometry();
        var site2 = geom.filterMetadata("system:index","equals","2_00000000000000000000").first().geometry();
      //list
        var algorithmSite1 = function(image, list) {
          var mean = image.reduceRegion({
          reducer: ee.Reducer.mean(),
          geometry: site1,
          scale: 5,
          maxPixels: 1e9
          });
          var l = ee.List(list);
          var listName = l.add(mean.getNumber('OSAVI'));
          return listName;
        };
        var osaviListSite1 = ee.List(croppedDataset.iterate(algorithmSite1, ee.List([])));
      //calculations
        var osaviMeanSite1 = ee.Number(osaviListSite1.reduce(ee.Reducer.mean())).format('%.2f');
        var osaviMaxSite1 = ee.Number(osaviListSite1.reduce(ee.Reducer.max())).format('%.2f');
        var osaviMinSite1 = ee.Number(osaviListSite1.reduce(ee.Reducer.min())).format('%.2f');
      //% bareground
          var imageOSAVISite1 = croppedDataset.reduce(ee.Reducer.mode());
          var baregroundSite1 = imageOSAVISite1.lt(0.25);
          var baregroundMaskedSite1 = baregroundSite1.where(baregroundSite1.gte(0.25), 0);
          var totalPixelCountSite1 = imageOSAVISite1.reduceRegion({
            reducer: ee.Reducer.count(),
            geometry: site1,
            scale: 5,
            maxPixels: 3e9
          }).getNumber('OSAVI_mode');
          var baregroundPixelCountSite1 = baregroundSite1.reduceRegion({
            reducer: ee.Reducer.sum().unweighted(),
            geometry: site1,
            scale: 5,
            maxPixels: 3e9
          }).getNumber('OSAVI_mode');
          var percentageSite1 = baregroundPixelCountSite1.divide(totalPixelCountSite1).multiply(100).format('%.2f');
      //print
        osaviMeanSite1.evaluate(subtitle1);
        osaviMeanSite1.evaluate(stat28);
        osaviMaxSite1.evaluate(stat29);
        osaviMinSite1.evaluate(stat30);
        percentageSite1.evaluate(stat31);
      //list
        var algorithmSite2 = function(image, list) {
          var mean = image.reduceRegion({
          reducer: ee.Reducer.mean(),
          geometry: site2,
          scale: 5,
          maxPixels: 1e9
          });
          var l = ee.List(list);
          var listName = l.add(mean.getNumber('OSAVI'));
          return listName;
        };
      //calculations
        var osaviListSite2 = ee.List(croppedDataset.iterate(algorithmSite2, ee.List([])));
        var osaviMeanSite2 = ee.Number(osaviListSite2.reduce(ee.Reducer.mean())).format('%.2f');
        var osaviMaxSite2 = ee.Number(osaviListSite2.reduce(ee.Reducer.max())).format('%.2f');
        var osaviMinSite2 = ee.Number(osaviListSite2.reduce(ee.Reducer.min())).format('%.2f');
      //% bareground
          var imageOSAVISite2 = croppedDataset.reduce(ee.Reducer.mode());
          var baregroundSite2 = imageOSAVISite2.lt(0.25);
          var baregroundMaskedSite2 = baregroundSite2.where(baregroundSite2.gte(0.25), 0);
          var totalPixelCountSite2 = imageOSAVISite2.reduceRegion({
            reducer: ee.Reducer.count(),
            geometry: site2,
            scale: 5,
            maxPixels: 3e9
          }).getNumber('OSAVI_mode');
          var baregroundPixelCountSite2 = baregroundSite2.reduceRegion({
            reducer: ee.Reducer.sum().unweighted(),
            geometry: site2,
            scale: 5,
            maxPixels: 3e9
          }).getNumber('OSAVI_mode');
          var percentageSite2 = baregroundPixelCountSite2.divide(totalPixelCountSite2).multiply(100).format('%.2f');
      //print
        osaviMeanSite2.evaluate(subtitle2);
        osaviMeanSite2.evaluate(stat28);
        osaviMaxSite2.evaluate(stat29);
        osaviMinSite2.evaluate(stat30);
        percentageSite2.evaluate(stat31);
}
///////////////////////////////////////////////////////////////////////////////////////////////
//(11.7.3) PRINT LEGEND
      var legend = ui.Panel(
            [
              ui.Label('OSAVI', LEGEND_TITLE_STYLE), makeLegendNDVI(),
              ui.Label('Optimised Soil-Adjusted Vegetation Index', LEGEND_FOOTNOTE_STYLE),
              ui.Label('Source: Planet & NICFI Basemaps for Tropical Forest Monitoring', LEGEND_FOOTNOTE_STYLE),
              makeRow('014c72', 'Ocean'),
              makeRow('bee6ff','Inland Water Bodies'),
            ],
      ui.Panel.Layout.flow('vertical'),
      {width: '250px', position: 'bottom-center', backgroundColor: 'E9F5EB'});
      legendContainer.add(legend);
}
/////////////////////////////////////////////////////////////////////////////////////////////////////
//                   (11.8) OPTIMISED SOIL-ADJUSTED VEGETATION INDEX SENTINEL 2
//(11.8.1) PLOT CHART
function OptimisedSoilAdjustedGreeness3(croppedDataset, geom){
        map.setZoom(7);
        var plotOSAVI;
//for one location
        if(geom.toList(2).size().getInfo()===1){
        plotOSAVI = ui.Chart.image.seriesByRegion(croppedDataset, geom, ee.Reducer.mean(),'OSAVI',10,'system:time_start', 'system:index')
              .setSeriesNames(['Site 1'])
              .setChartType('LineChart').setOptions({
                title: 'Average OSAVI Time Series Derived From Sentinel 2 MSI',
                hAxis: {title: 'Time', titleTextStyle: {italic: false, bold: true}},
                vAxis: {title: 'Pixel Greeness (OSAVI)', titleTextStyle: {italic: false, bold: true}},
                colors: ['ea812d'],
        });
//for more than one location
        }else{
        plotOSAVI = ui.Chart.image.seriesByRegion(croppedDataset, geom, ee.Reducer.mean(),'OSAVI',10,'system:time_start', 'system:index')
              .setSeriesNames(['Site 1', 'Site 2'])
              .setChartType('LineChart').setOptions({
                title: 'Average OSAVI Time Series Derived From Sentinel 2 MSI',
                hAxis: {title: 'Time', titleTextStyle: {italic: false, bold: true}},
                vAxis: {title: 'Pixel Greeness (OSAVI)', titleTextStyle: {italic: false, bold: true}},
                colors: ['ea812d','19c35a'],
        });
        }
        panelChart.add(plotOSAVI);
        map.layers().get(7).setShown(true);
        panelChart.add(label5);
/////////////////////////////////////////////////////////////////////////////////////////////
//(11.8.2) CALCULATE STATISTICS
//for one location
if(geom.toList(2).size().getInfo()===1){
      //list
        var algorithm = function(image, list) {
          var mean = image.reduceRegion({
          reducer: ee.Reducer.mean(),
          geometry: geom,
          scale: 10,
          maxPixels: 3e9
          });
          var l = ee.List(list);
          var listName = l.add(mean.getNumber('OSAVI'));
          return listName;
        };
        var osaviPlanetList = ee.List(croppedDataset.iterate(algorithm, ee.List([])));
      //calculations
        var osaviMean = ee.Number(osaviPlanetList.reduce(ee.Reducer.mean())).format('%.2f');
        var osaviMax = ee.Number(osaviPlanetList.reduce(ee.Reducer.max())).format('%.2f');
        var osaviMin = ee.Number(osaviPlanetList.reduce(ee.Reducer.min())).format('%.2f');
      //% bareground
          var imageOSAVIplanet = croppedDataset.reduce(ee.Reducer.mode());
          var bareground = imageOSAVIplanet.lt(0.25);
          var baregroundMasked = bareground.where(bareground.gte(0.25), 0);
          var totalPixelCount = imageOSAVIplanet.reduceRegion({
            reducer: ee.Reducer.count(),
            geometry: geom,
            scale: 10,
            maxPixels: 3e9
          }).getNumber('OSAVI_mode');
          var baregroundPixelCount = bareground.reduceRegion({
            reducer: ee.Reducer.sum().unweighted(),
            geometry: geom,
            scale: 10,
            maxPixels: 3e9
          }).getNumber('OSAVI_mode');
          var percentage = baregroundPixelCount.divide(totalPixelCount).multiply(100).format('%.2f');
      //print
        osaviMean.evaluate(stat28);
        osaviMax.evaluate(stat29);
        osaviMin.evaluate(stat30);
        percentage.evaluate(stat31);
//for more than one location (repeat twice, once for each location selected)
}else{
      //separate individual polygons from geom
        var site1 = geom.filterMetadata("system:index","equals","1_00000000000000000000").first().geometry();
        var site2 = geom.filterMetadata("system:index","equals","2_00000000000000000000").first().geometry();
      //list
        var algorithmSite1 = function(image, list) {
          var mean = image.reduceRegion({
          reducer: ee.Reducer.mean(),
          geometry: site1,
          scale: 10,
          maxPixels: 1e9
          });
          var l = ee.List(list);
          var listName = l.add(mean.getNumber('OSAVI'));
          return listName;
        };
        var osaviListSite1 = ee.List(croppedDataset.iterate(algorithmSite1, ee.List([])));
      //calculations
        var osaviMeanSite1 = ee.Number(osaviListSite1.reduce(ee.Reducer.mean())).format('%.2f');
        var osaviMaxSite1 = ee.Number(osaviListSite1.reduce(ee.Reducer.max())).format('%.2f');
        var osaviMinSite1 = ee.Number(osaviListSite1.reduce(ee.Reducer.min())).format('%.2f');
      //% bareground
          var imageOSAVISite1 = croppedDataset.reduce(ee.Reducer.mode());
          var baregroundSite1 = imageOSAVISite1.lt(0.25);
          var baregroundMaskedSite1 = baregroundSite1.where(baregroundSite1.gte(0.25), 0);
          var totalPixelCountSite1 = imageOSAVISite1.reduceRegion({
            reducer: ee.Reducer.count(),
            geometry: site1,
            scale: 10,
            maxPixels: 3e9
          }).getNumber('OSAVI_mode');
          var baregroundPixelCountSite1 = baregroundSite1.reduceRegion({
            reducer: ee.Reducer.sum().unweighted(),
            geometry: site1,
            scale: 10,
            maxPixels: 3e9
          }).getNumber('OSAVI_mode');
          var percentageSite1 = baregroundPixelCountSite1.divide(totalPixelCountSite1).multiply(100).format('%.2f');
      //print
        osaviMeanSite1.evaluate(subtitle1);
        osaviMeanSite1.evaluate(stat28);
        osaviMaxSite1.evaluate(stat29);
        osaviMinSite1.evaluate(stat30);
        percentageSite1.evaluate(stat31);
      //list
        var algorithmSite2 = function(image, list) {
          var mean = image.reduceRegion({
          reducer: ee.Reducer.mean(),
          geometry: site2,
          scale: 10,
          maxPixels: 1e9
          });
          var l = ee.List(list);
          var listName = l.add(mean.getNumber('OSAVI'));
          return listName;
        };
      //calculations
        var osaviListSite2 = ee.List(croppedDataset.iterate(algorithmSite2, ee.List([])));
        var osaviMeanSite2 = ee.Number(osaviListSite2.reduce(ee.Reducer.mean())).format('%.2f');
        var osaviMaxSite2 = ee.Number(osaviListSite2.reduce(ee.Reducer.max())).format('%.2f');
        var osaviMinSite2 = ee.Number(osaviListSite2.reduce(ee.Reducer.min())).format('%.2f');
      //% bareground
          var imageOSAVISite2 = croppedDataset.reduce(ee.Reducer.mode());
          var baregroundSite2 = imageOSAVISite2.lt(0.25);
          var baregroundMaskedSite2 = baregroundSite2.where(baregroundSite2.gte(0.25), 0);
          var totalPixelCountSite2 = imageOSAVISite2.reduceRegion({
            reducer: ee.Reducer.count(),
            geometry: site2,
            scale: 10,
            maxPixels: 3e9
          }).getNumber('OSAVI_mode');
          var baregroundPixelCountSite2 = baregroundSite2.reduceRegion({
            reducer: ee.Reducer.sum().unweighted(),
            geometry: site2,
            scale: 10,
            maxPixels: 3e9
          }).getNumber('OSAVI_mode');
          var percentageSite2 = baregroundPixelCountSite2.divide(totalPixelCountSite2).multiply(100).format('%.2f');
      //print
        osaviMeanSite2.evaluate(subtitle2);
        osaviMeanSite2.evaluate(stat28);
        osaviMaxSite2.evaluate(stat29);
        osaviMinSite2.evaluate(stat30);
        percentageSite2.evaluate(stat31);
}
///////////////////////////////////////////////////////////////////////////////////////////////
//(11.8.3) PRINT LEGEND
      var legend = ui.Panel(
            [
              ui.Label('OSAVI', LEGEND_TITLE_STYLE), makeLegendNDVI(),
              ui.Label('Optimised Soil-Adjusted Vegetation Index', LEGEND_FOOTNOTE_STYLE),
              ui.Label('Source: Sentinel-2 MSI: MultiSpectral Instrument, Level-1C', LEGEND_FOOTNOTE_STYLE),
              makeRow('014c72', 'Ocean'),
              makeRow('bee6ff','Inland Water Bodies'),
            ],
      ui.Panel.Layout.flow('vertical'),
      {width: '250px', position: 'bottom-center', backgroundColor: 'E9F5EB'});
      legendContainer.add(legend);
}
/////////////////////////////////////////////////////////////////////////////////////////////
//                              (12) USER INTERFACE DISPLAY
//(12.1) ADD WIDGETS TO SELECTION MENU PANEL
//title
var subtitle = ui.Label('Selection Menu', {stretch: 'horizontal', textAlign: 'center', fontWeight: 'bold', fontSize: '30px', backgroundColor: 'E9F5EB'});
panelSelectionMenu.add(subtitle);
//dataset
panelSelectionMenu.add(label1);
panelSelectionMenu.add(selectData);
panelSelectionMenu.add(ui.Label({
  value: 'Click here to view the specifications of each dataset', 
  style: {backgroundColor: 'E9F5EB', fontSize: '13px'}, 
  targetUrl: 'https://docs.google.com/presentation/d/1PduFvcIEt0hebPkqPX6JdL1o9WoCWFCYHHR_Ud6GJVc/edit?usp=sharing'
  })); //hyperlink to dataset specifications table in google drive
panelSelectionMenu.add(description);
//region
panelSelectionMenu.add(label2);
panelSelectionMenu.add(label7);
panelSelectionMenu.add(selectRegion);
var drawShapeNote = ui.Label('Choose custom drawing tool (rectangle, polygon or point) below, and then draw a shape on the map', {fontSize: '13px', stretch: 'horizontal', textAlign: 'left', backgroundColor: 'E9F5EB'});
panelSelectionMenu.add(drawShapeNote);
panelSelectionMenu.add(controlPanel);
panelSelectionMenu.add(label9);
panelSelectionMenu.add(checkboxBuffer);
var radiusNote = ui.Label('Choose variable buffer radius (in metres) below:', {fontSize: '13px', stretch: 'horizontal', textAlign: 'left', backgroundColor: 'E9F5EB'});
panelSelectionMenu.add(radiusNote);
panelSelectionMenu.add(sliderRadius);
panelSelectionMenu.add(label8);
panelSelectionMenu.add(checkboxRegionCompare);
panelSelectionMenu.add(selectRegionOption2);
//time
panelSelectionMenu.add(label6);
panelSelectionMenu.add(label3);
var calendarNote = ui.Label('Click Jump To Date to choose a date in calendar format', {fontSize: '11px', stretch: 'horizontal', textAlign: 'left', backgroundColor: 'E9F5EB'});
panelSelectionMenu.add(calendarNote);
panelSelectionMenu.add(sliderStart);
panelSelectionMenu.add(label4);
panelSelectionMenu.add(sliderEnd);
//error message
panelSelectionMenu.add(errorMessage);
//buttons
panelButton.add(button);
panelButton.add(reset);
panelSelectionMenu.add(panelButton);
//////////////////////////////////////////////////////////////////////////////////////////////
//(12.2) ADD PANELS TO ROOT
//set up
ui.root.clear();
ui.root.setLayout(ui.Panel.Layout.Flow('vertical'));
//title banner
var title = ui.Label('Justdiggit Data Dashboard', {stretch: 'horizontal', textAlign: 'center', fontWeight: 'bold', fontSize: '50px', color: 'ffffff', backgroundColor: '21bf59', margin: '0 0 0 0'}); //color: 'ffffff', backgroundColor: '21bf59'
ui.root.add(title);
//map
ui.root.add(map);
//selection menu
map.add(panelSelectionMenu);
//                                      End of script