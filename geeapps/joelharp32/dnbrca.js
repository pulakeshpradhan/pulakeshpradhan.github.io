var geometry = ui.import && ui.import("geometry", "geometry", {
      "geometries": [
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                -123.03828475594575,
                38.80039956650381
              ],
              [
                -123.03828475594575,
                38.52212839516454
              ],
              [
                -122.52948043465669,
                38.52212839516454
              ],
              [
                -122.52948043465669,
                38.80039956650381
              ]
            ]
          ],
          "geodesic": false,
          "evenOdd": true
        }
      ],
      "displayProperties": [],
      "properties": {},
      "color": "#cbfaff",
      "mode": "Geometry",
      "shown": true,
      "locked": false
    }) || /* color: #cbfaff */ee.Geometry.Polygon(
        [[[-123.03828475594575, 38.80039956650381],
          [-123.03828475594575, 38.52212839516454],
          [-122.52948043465669, 38.52212839516454],
          [-122.52948043465669, 38.80039956650381]]], null, false),
    imageVisParam = ui.import && ui.import("imageVisParam", "imageVisParam", {
      "params": {
        "opacity": 1,
        "bands": [
          "B8",
          "B4",
          "B3"
        ],
        "min": 395.54,
        "max": 2797.46,
        "gamma": 1
      }
    }) || {"opacity":1,"bands":["B8","B4","B3"],"min":395.54,"max":2797.46,"gamma":1},
    imageVisParam2 = ui.import && ui.import("imageVisParam2", "imageVisParam", {
      "params": {
        "opacity": 1,
        "bands": [
          "B12",
          "B8",
          "B4"
        ],
        "min": 160.82999999999998,
        "max": 2792.67,
        "gamma": 1
      }
    }) || {"opacity":1,"bands":["B12","B8","B4"],"min":160.82999999999998,"max":2792.67,"gamma":1},
    geometry2 = ui.import && ui.import("geometry2", "geometry", {
      "geometries": [
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                -122.82461833544885,
                38.7834927256655
              ],
              [
                -122.81706523486291,
                38.76957479355282
              ],
              [
                -122.83217143603478,
                38.75029932711974
              ],
              [
                -122.85414409228478,
                38.75940227949596
              ],
              [
                -122.87543010302697,
                38.75726051279331
              ],
              [
                -122.88160991259728,
                38.74708624322583
              ],
              [
                -122.89190959521447,
                38.72994735364229
              ],
              [
                -122.89602946826135,
                38.71548321654821
              ],
              [
                -122.88984965869103,
                38.710661186932526
              ],
              [
                -122.86993693896447,
                38.71119698406398
              ],
              [
                -122.85620402880822,
                38.71173277717969
              ],
              [
                -122.85620402880822,
                38.70476715345411
              ],
              [
                -122.8493375737301,
                38.69404948415328
              ],
              [
                -122.84041118212853,
                38.69136981587398
              ],
              [
                -122.83491801806603,
                38.69297762888698
              ],
              [
                -122.82255839892541,
                38.69458540576366
              ],
              [
                -122.81569194384728,
                38.69083387017279
              ],
              [
                -122.8053922612301,
                38.68708213784297
              ],
              [
                -122.7944059331051,
                38.68601017818524
              ],
              [
                -122.79028606005822,
                38.67850601091674
              ],
              [
                -122.79646586962853,
                38.67314540967336
              ],
              [
                -122.79303264208947,
                38.66403146623527
              ],
              [
                -122.78204631396447,
                38.655988788017254
              ],
              [
                -122.7779264409176,
                38.650626500787055
              ],
              [
                -122.78273295947228,
                38.646872660902915
              ],
              [
                -122.79371928759728,
                38.64580009909822
              ],
              [
                -122.78204631396447,
                38.638291716942696
              ],
              [
                -122.7779264409176,
                38.63131894344123
              ],
              [
                -122.78135966845666,
                38.625954809996564
              ],
              [
                -122.79303264208947,
                38.62541837458012
              ],
              [
                -122.81157207080041,
                38.63721902670461
              ],
              [
                -122.82393168994103,
                38.62917333822087
              ],
              [
                -122.80058574267541,
                38.612006184982825
              ],
              [
                -122.81294536181603,
                38.608786886298404
              ],
              [
                -122.82324504443322,
                38.60986000191001
              ],
              [
                -122.83354472705041,
                38.60342106749367
              ],
              [
                -122.82461833544885,
                38.5905414653687
              ],
              [
                -122.82805156298791,
                38.577659552384155
              ],
              [
                -122.81843852587853,
                38.571754570038586
              ],
              [
                -122.79303264208947,
                38.564775328776754
              ],
              [
                -122.78479289599572,
                38.54812978720036
              ],
              [
                -122.78410625048791,
                38.535240269310975
              ],
              [
                -122.76625346728478,
                38.526645974125415
              ],
              [
                -122.74153422900353,
                38.542222378241235
              ],
              [
                -122.73466777392541,
                38.55994314926493
              ],
              [
                -122.73192119189416,
                38.56853346599912
              ],
              [
                -122.73535441943322,
                38.58034347480994
              ],
              [
                -122.72986125537072,
                38.59537158698209
              ],
              [
                -122.70720195361291,
                38.572291406672356
              ],
              [
                -122.69415568896447,
                38.579806698347895
              ],
              [
                -122.70788859912072,
                38.604494263353715
              ],
              [
                -122.68934917040978,
                38.61146964523348
              ],
              [
                -122.65776347705041,
                38.640973372302724
              ],
              [
                -122.65433024951135,
                38.65813359051874
              ],
              [
                -122.66737651415978,
                38.671001056768375
              ],
              [
                -122.6735563237301,
                38.68601017818524
              ],
              [
                -122.6680631596676,
                38.701552021309475
              ],
              [
                -122.69484233447228,
                38.71441168252194
              ],
              [
                -122.67973613330041,
                38.72191208336963
              ],
              [
                -122.68042277880822,
                38.729411697070944
              ],
              [
                -122.6955289799801,
                38.733161208727374
              ],
              [
                -122.72505473681603,
                38.73583931084735
              ],
              [
                -122.74359416552697,
                38.74976382317965
              ],
              [
                -122.7559537846676,
                38.76047313874403
              ],
              [
                -122.7669401127926,
                38.767968703540745
              ],
              [
                -122.7724332768551,
                38.77706940218197
              ],
              [
                -122.77037334033166,
                38.78402797650606
              ],
              [
                -122.76007365771447,
                38.792591443498324
              ],
              [
                -122.77174663134728,
                38.79687279124689
              ],
              [
                -122.81213094328312,
                38.795802478419695
              ],
              [
                -122.82105733488469,
                38.790450673185546
              ]
            ]
          ],
          "evenOdd": true
        }
      ],
      "displayProperties": [],
      "properties": {},
      "color": "#0b4a8b",
      "mode": "Geometry",
      "shown": true,
      "locked": false
    }) || /* color: #0b4a8b */ee.Geometry.Polygon(
        [[[-122.82461833544885, 38.7834927256655],
          [-122.81706523486291, 38.76957479355282],
          [-122.83217143603478, 38.75029932711974],
          [-122.85414409228478, 38.75940227949596],
          [-122.87543010302697, 38.75726051279331],
          [-122.88160991259728, 38.74708624322583],
          [-122.89190959521447, 38.72994735364229],
          [-122.89602946826135, 38.71548321654821],
          [-122.88984965869103, 38.710661186932526],
          [-122.86993693896447, 38.71119698406398],
          [-122.85620402880822, 38.71173277717969],
          [-122.85620402880822, 38.70476715345411],
          [-122.8493375737301, 38.69404948415328],
          [-122.84041118212853, 38.69136981587398],
          [-122.83491801806603, 38.69297762888698],
          [-122.82255839892541, 38.69458540576366],
          [-122.81569194384728, 38.69083387017279],
          [-122.8053922612301, 38.68708213784297],
          [-122.7944059331051, 38.68601017818524],
          [-122.79028606005822, 38.67850601091674],
          [-122.79646586962853, 38.67314540967336],
          [-122.79303264208947, 38.66403146623527],
          [-122.78204631396447, 38.655988788017254],
          [-122.7779264409176, 38.650626500787055],
          [-122.78273295947228, 38.646872660902915],
          [-122.79371928759728, 38.64580009909822],
          [-122.78204631396447, 38.638291716942696],
          [-122.7779264409176, 38.63131894344123],
          [-122.78135966845666, 38.625954809996564],
          [-122.79303264208947, 38.62541837458012],
          [-122.81157207080041, 38.63721902670461],
          [-122.82393168994103, 38.62917333822087],
          [-122.80058574267541, 38.612006184982825],
          [-122.81294536181603, 38.608786886298404],
          [-122.82324504443322, 38.60986000191001],
          [-122.83354472705041, 38.60342106749367],
          [-122.82461833544885, 38.5905414653687],
          [-122.82805156298791, 38.577659552384155],
          [-122.81843852587853, 38.571754570038586],
          [-122.79303264208947, 38.564775328776754],
          [-122.78479289599572, 38.54812978720036],
          [-122.78410625048791, 38.535240269310975],
          [-122.76625346728478, 38.526645974125415],
          [-122.74153422900353, 38.542222378241235],
          [-122.73466777392541, 38.55994314926493],
          [-122.73192119189416, 38.56853346599912],
          [-122.73535441943322, 38.58034347480994],
          [-122.72986125537072, 38.59537158698209],
          [-122.70720195361291, 38.572291406672356],
          [-122.69415568896447, 38.579806698347895],
          [-122.70788859912072, 38.604494263353715],
          [-122.68934917040978, 38.61146964523348],
          [-122.65776347705041, 38.640973372302724],
          [-122.65433024951135, 38.65813359051874],
          [-122.66737651415978, 38.671001056768375],
          [-122.6735563237301, 38.68601017818524],
          [-122.6680631596676, 38.701552021309475],
          [-122.69484233447228, 38.71441168252194],
          [-122.67973613330041, 38.72191208336963],
          [-122.68042277880822, 38.729411697070944],
          [-122.6955289799801, 38.733161208727374],
          [-122.72505473681603, 38.73583931084735],
          [-122.74359416552697, 38.74976382317965],
          [-122.7559537846676, 38.76047313874403],
          [-122.7669401127926, 38.767968703540745],
          [-122.7724332768551, 38.77706940218197],
          [-122.77037334033166, 38.78402797650606],
          [-122.76007365771447, 38.792591443498324],
          [-122.77174663134728, 38.79687279124689],
          [-122.81213094328312, 38.795802478419695],
          [-122.82105733488469, 38.790450673185546]]]);
// Set start and end dates of a period BEFORE the fire. Make sure it is long enough for 
// Sentinel-2 to acquire an image (repetition rate = 5 days). Adjust these parameters, if
// your ImageCollections (see Console) do not contain any elements.
var prefire_start = '2018-11-10';   
var prefire_end = '2018-12-01';
// Now set the same parameters for AFTER the fire.
var postfire_start = '2019-11-10';
var postfire_end = '2019-12-01';
var imagery = ee.ImageCollection('COPERNICUS/S2');
// In the following lines imagery will be collected in an ImageCollection, depending on the
// location of our study area, a given time frame and the ratio of cloud cover.
var prefireImCol = ee.ImageCollection(imagery
    // Filter by dates.
    .filterDate(prefire_start, prefire_end)
    // Filter by location.
    .filterBounds(geometry));
// Select all images that overlap with the study area from a given time frame 
var postfireImCol = ee.ImageCollection(imagery
    // Filter by dates.
    .filterDate(postfire_start, postfire_end)
    // Filter by location.
    .filterBounds(geometry));
// Add the clipped images to the console on the right
print("Pre-fire Image Collection: ", prefireImCol); 
print("Post-fire Image Collection: ", postfireImCol);
// Function to mask clouds from the pixel quality band of Sentinel-2 SR data.
function maskS2sr(image) {
  // Bits 10 and 11 are clouds and cirrus, respectively.
  var cloudBitMask = ee.Number(2).pow(10).int();
  var cirrusBitMask = ee.Number(2).pow(11).int();
  // Get the pixel QA band.
  var qa = image.select('QA60');
  // All flags should be set to zero, indicating clear conditions.
  var mask = qa.bitwiseAnd(cloudBitMask).eq(0)
      .and(qa.bitwiseAnd(cirrusBitMask).eq(0));
  // Return the masked image, scaled to TOA reflectance, without the QA bands.
  return image.updateMask(mask)
      .copyProperties(image, ["system:time_start"]);
}
//Apply Cloud Mask
var prefire_CM_ImCol = prefireImCol.map(maskS2sr);
var postfire_CM_ImCol = postfireImCol.map(maskS2sr);
var pre_cm_mos = prefire_CM_ImCol.median().clip(geometry);
var post_cm_mos = postfire_CM_ImCol.median().clip(geometry);
Map.addLayer(pre_cm_mos);
Map.addLayer(post_cm_mos);
Map.addLayer(post_cm_mos, imageVisParam, 'Burned Area False Color');
Map.addLayer(post_cm_mos, imageVisParam2, 'Burned Area SWIR');
var preNBR = pre_cm_mos.normalizedDifference(['B8', 'B12']);
var postNBR = post_cm_mos.normalizedDifference(['B8', 'B12']);
Map.addLayer(preNBR, {}, 'Pre fire NBR');
Map.addLayer(postNBR, {}, 'Post fire NBR');
// The result is called delta NBR or dNBR
var dNBR_unscaled = preNBR.subtract(postNBR);
// Scale product to USGS standards
var dNBR = dNBR_unscaled.multiply(1000);
// Add the difference image to the console on the right
print("Difference Normalized Burn Ratio: ", dNBR);
//------------------------- Burn Ratio Product - Classification ----------------------------
// Define an SLD style of discrete intervals to apply to the image.
var sld_intervals =
  '<RasterSymbolizer>' +
    '<ColorMap type="intervals" extended="false" >' +
      '<ColorMapEntry color="#ffffff" quantity="-500" label="-500"/>' +
      '<ColorMapEntry color="#7a8737" quantity="-250" label="-250" />' +
      '<ColorMapEntry color="#acbe4d" quantity="-100" label="-100" />' +
      '<ColorMapEntry color="#0ae042" quantity="100" label="100" />' +
      '<ColorMapEntry color="#fff70b" quantity="270" label="270" />' +
      '<ColorMapEntry color="#ffaf38" quantity="440" label="440" />' +
      '<ColorMapEntry color="#ff641b" quantity="660" label="660" />' +
      '<ColorMapEntry color="#a41fd6" quantity="2000" label="2000" />' +
    '</ColorMap>' +
  '</RasterSymbolizer>';
// Add the image to the map using both the color ramp and interval schemes.
Map.addLayer(dNBR.sldStyle(sld_intervals), {}, 'dNBR classified');
//==========================================================================================
//                                    ADD A LEGEND
// set position of panel
var legend = ui.Panel({
  style: {
    position: 'bottom-left',
    padding: '8px 15px'
  }});
// Create legend title
var legendTitle = ui.Label({
  value: 'dNBR Classes',
  style: {fontWeight: 'bold',
    fontSize: '18px',
    margin: '0 0 4px 0',
    padding: '0'
    }});
// Add the title to the panel
legend.add(legendTitle);
// Creates and styles 1 row of the legend.
var makeRow = function(color, name) {
      // Create the label that is actually the colored box.
      var colorBox = ui.Label({
        style: {
          backgroundColor: '#' + color,
          // Use padding to give the box height and width.
          padding: '8px',
          margin: '0 0 4px 0'
        }});
      // Create the label filled with the description text.
      var description = ui.Label({
        value: name,
        style: {margin: '0 0 4px 6px'}
      });
      // return the panel
      return ui.Panel({
        widgets: [colorBox, description],
        layout: ui.Panel.Layout.Flow('horizontal')
      })};
//  Palette with the colors
var palette =['7a8737', 'acbe4d', '0ae042', 'fff70b', 'ffaf38', 'ff641b', 'a41fd6', 'ffffff'];
// name of the legend
var names = ['Enhanced Regrowth, High','Enhanced Regrowth, Low','Unburned', 'Low Severity',
'Moderate-low Severity', 'Moderate-high Severity', 'High Severity', 'NA'];
// Add color and and names
for (var i = 0; i < 8; i++) {
  legend.add(makeRow(palette[i], names[i]));
  }  
// add legend to map (alternatively you can also print the legend to the console)
Map.add(legend);
// Separate result into 8 burn severity classes
var thresholds = ee.Image([-1000, -251, -101, 99, 269, 439, 659, 2000]);
var classified = dNBR.lt(thresholds).reduce('sum').toInt();
// count number of pixels in entire layer
var allpix =  classified.updateMask(classified);  // mask the entire layer
var pixstats = allpix.reduceRegion({
  reducer: ee.Reducer.count(),               
  geometry: geometry2,
  scale: 20, 
  maxPixels: 1e9
  });
var allpixels = ee.Number(pixstats.get('sum')); // extract pixel count as a number
print(allpixels, 'allpixels')
// create an empty list to store area values in
var arealist = [];
// create a function to derive extent of one burn severity class
// arguments are class number and class name
var areacount = function(cnr, name) {
 var singleMask =  classified.updateMask(classified.eq(cnr));  // mask a single class
 var stats = singleMask.reduceRegion({
  reducer: ee.Reducer.count(),               // count pixels in a single class
  geometry: geometry2,
  scale: 20,
  maxPixels: 1e9
  });
var pix =  ee.Number(stats.get('sum'));
var hect = pix.multiply(400).divide(10000);                // Landsat pixel = 30m x 30m --> 900 sqm
var perc = pix.divide(allpixels).multiply(10000).round().divide(100);   // get area percent by class and round to 2 decimals
arealist.push({Class: name, Pixels: pix, Hectares: hect, Percentage: perc});
};
// severity classes in different order
var names2 = ['NA', 'High Severity', 'Moderate-high Severity',
'Moderate-low Severity', 'Low Severity','Unburned', 'Enhanced Regrowth, Low', 'Enhanced Regrowth, High'];
// execute function for each class
for (var i = 0; i < 8; i++) {
  areacount(i, names2[i]);
  }
print('Burned Area by Severity Class', arealist, '--> click list objects for individual classes');
// Demonstrates before/after imagery comparison with a variety of dates.
/*
 * Configure the imagery
 */
// These Sentinel-1 images track the major flooding in Myanmar during the 2018
// monsoon season: https://www.bbc.com/news/world-asia-44962585
var images = {
   'Before SWIR': pre_cm_mos.visualize({bands:["B12","B8","B4"], min: 74.68, max: 2747.32}),
  'Burned SWIR': post_cm_mos.visualize({bands:["B12","B8","B4"], min: 74.68, max: 2747.32}),
  'dNBR': dNBR.sldStyle(sld_intervals)
};
// Composite the Sentinel-1 ImageCollection for 7 days (inclusive) after the
// given date.
function getWeeklySentinelComposite(date) {
  var date = ee.Date(date);
  // Only include the VV polarization, for consistent compositing.
  var polarization = 'VV';
  var sentinel1 = ee.ImageCollection('COPERNICUS/S1_GRD')
                      .filterDate(date, date.advance(1, 'week'))
                      .filter(ee.Filter.listContains(
                          'transmitterReceiverPolarisation', polarization))
                      .filter(ee.Filter.eq('instrumentMode', 'IW'))
                      .select(polarization)
                      .mean();
  return sentinel1.visualize({min: -25, max: 0, palette: ['aqua', 'black']});
}
/*
 * Set up the maps and control widgets
 */
// Create the left map, and have it display layer 0.
var leftMap = ui.Map();
leftMap.setControlVisibility(false);
var leftSelector = addLayerSelector(leftMap, 0, 'top-left');
// Create the right map, and have it display layer 1.
var rightMap = ui.Map();
rightMap.setControlVisibility(false);
var rightSelector = addLayerSelector(rightMap, 1, 'top-right');
// Adds a layer selection widget to the given map, to allow users to change
// which image is displayed in the associated map.
function addLayerSelector(mapToChange, defaultValue, position) {
  var label = ui.Label('Choose an image to visualize');
  // This function changes the given map to show the selected image.
  function updateMap(selection) {
    mapToChange.layers().set(0, ui.Map.Layer(images[selection]));
  }
  // Configure a selection dropdown to allow the user to choose between images,
  // and set the map to update when a user makes a selection.
  var select = ui.Select({items: Object.keys(images), onChange: updateMap});
  select.setValue(Object.keys(images)[defaultValue], true);
  var controlPanel =
      ui.Panel({widgets: [label, select], style: {position: position}});
  mapToChange.add(controlPanel);
}
/*
 * Tie everything together
 */
// Create a SplitPanel to hold the adjacent, linked maps.
var splitPanel = ui.SplitPanel({
  firstPanel: leftMap,
  secondPanel: rightMap,
  wipe: true,
  style: {stretch: 'both'}
});
// Set the SplitPanel as the only thing in the UI root.
ui.root.widgets().reset([splitPanel]);
var linker = ui.Map.Linker([leftMap, rightMap]);
leftMap.setCenter(-122.7596, 38.7498, 12);