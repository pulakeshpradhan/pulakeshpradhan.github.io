var geometry_roi = ui.import && ui.import("geometry_roi", "geometry", {
      "geometries": [
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                100.81102138277328,
                17.47180562587906
              ],
              [
                101.41517143010942,
                14.878293364756033
              ],
              [
                101.99099415248159,
                13.18732460752271
              ],
              [
                102.43699794527328,
                13.304728375436115
              ],
              [
                103.06871181246078,
                13.99333012449838
              ],
              [
                103.85972743746078,
                14.291623406838852
              ],
              [
                105.22203212496078,
                14.14252567886228
              ],
              [
                105.81529384371078,
                14.802059982924808
              ],
              [
                105.50767665621078,
                16.030593123361438
              ],
              [
                104.89244228121078,
                16.95759346524085
              ],
              [
                104.91441493746078,
                17.566096399821014
              ],
              [
                103.72789149996078,
                18.63123900684719
              ],
              [
                102.34361415621078,
                18.63123900684719
              ],
              [
                101.33287196871078,
                18.547933964211957
              ]
            ]
          ],
          "evenOdd": true
        }
      ],
      "displayProperties": [],
      "properties": {},
      "color": "#3048d6",
      "mode": "Geometry",
      "shown": false,
      "locked": true
    }) || 
    /* color: #3048d6 */
    /* shown: false */
    /* locked: true */
    ee.Geometry.Polygon(
        [[[100.81102138277328, 17.47180562587906],
          [101.41517143010942, 14.878293364756033],
          [101.99099415248159, 13.18732460752271],
          [102.43699794527328, 13.304728375436115],
          [103.06871181246078, 13.99333012449838],
          [103.85972743746078, 14.291623406838852],
          [105.22203212496078, 14.14252567886228],
          [105.81529384371078, 14.802059982924808],
          [105.50767665621078, 16.030593123361438],
          [104.89244228121078, 16.95759346524085],
          [104.91441493746078, 17.566096399821014],
          [103.72789149996078, 18.63123900684719],
          [102.34361415621078, 18.63123900684719],
          [101.33287196871078, 18.547933964211957]]]),
    geometry_roi3 = ui.import && ui.import("geometry_roi3", "geometry", {
      "geometries": [
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                98.17759718435602,
                16.89772836606532
              ],
              [
                98.08415820378195,
                14.751539661030128
              ],
              [
                98.87357808393641,
                13.774559321413454
              ],
              [
                99.37428092886594,
                11.897357476581952
              ],
              [
                98.13060191381433,
                9.687567604949457
              ],
              [
                97.95077652589855,
                7.606245084528619
              ],
              [
                101.05556497090926,
                5.2965132628367435
              ],
              [
                102.6609889414004,
                6.0539329244822175
              ],
              [
                102.76024113816453,
                12.035587696044526
              ],
              [
                101.51744093435602,
                18.42607055426237
              ],
              [
                101.47349562185602,
                19.775622413763365
              ],
              [
                100.48472609060602,
                20.600523902366923
              ],
              [
                99.29820265310602,
                20.662214334653946
              ],
              [
                98.22154249685602,
                20.250474805013546
              ],
              [
                97.18882765310602,
                19.278611633050822
              ],
              [
                97.25474562185602,
                17.987747640414632
              ],
              [
                97.73814405935602,
                17.233810474344462
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                47.96835870718797,
                32.36245129357725
              ],
              [
                48.25400323843797,
                31.598309303437436
              ],
              [
                48.71542901968797,
                31.03517142466717
              ],
              [
                49.33066339468797,
                31.859950806678675
              ],
              [
                48.91318292593797,
                32.43666015845769
              ],
              [
                48.45175714468797,
                32.7143992324321
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        }
      ],
      "displayProperties": [],
      "properties": {},
      "color": "#d63000",
      "mode": "Geometry",
      "shown": false,
      "locked": false
    }) || 
    /* color: #d63000 */
    /* shown: false */
    ee.Geometry({
      "type": "GeometryCollection",
      "geometries": [
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                98.17759718435602,
                16.89772836606532
              ],
              [
                98.08415820378195,
                14.751539661030128
              ],
              [
                98.87357808393641,
                13.774559321413454
              ],
              [
                99.37428092886594,
                11.897357476581952
              ],
              [
                98.13060191381433,
                9.687567604949457
              ],
              [
                97.95077652589855,
                7.606245084528619
              ],
              [
                101.05556497090926,
                5.2965132628367435
              ],
              [
                102.6609889414004,
                6.0539329244822175
              ],
              [
                102.76024113816453,
                12.035587696044526
              ],
              [
                101.51744093435602,
                18.42607055426237
              ],
              [
                101.47349562185602,
                19.775622413763365
              ],
              [
                100.48472609060602,
                20.600523902366923
              ],
              [
                99.29820265310602,
                20.662214334653946
              ],
              [
                98.22154249685602,
                20.250474805013546
              ],
              [
                97.18882765310602,
                19.278611633050822
              ],
              [
                97.25474562185602,
                17.987747640414632
              ],
              [
                97.73814405935602,
                17.233810474344462
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                47.96835870718797,
                32.36245129357725
              ],
              [
                48.25400323843797,
                31.598309303437436
              ],
              [
                48.71542901968797,
                31.03517142466717
              ],
              [
                49.33066339468797,
                31.859950806678675
              ],
              [
                48.91318292593797,
                32.43666015845769
              ],
              [
                48.45175714468797,
                32.7143992324321
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        }
      ],
      "coordinates": []
    }),
    geometry_korea = ui.import && ui.import("geometry_korea", "geometry", {
      "geometries": [
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                125.44273256770734,
                36.192464228942924
              ],
              [
                125.17906069270734,
                32.97323019991105
              ],
              [
                126.98081850520734,
                32.75175259770902
              ],
              [
                129.79331850520734,
                35.40834675120257
              ],
              [
                130.23277163020734,
                36.40496809465562
              ],
              [
                129.41978334895734,
                37.84149958232295
              ],
              [
                128.6534430968437,
                38.80468883777087
              ],
              [
                128.08801125838443,
                38.28472833539263
              ],
              [
                127.04509504169212,
                38.275761861688714
              ],
              [
                126.67149206442603,
                37.82619189089002
              ],
              [
                126.49822158981999,
                37.769775335919846
              ],
              [
                125.64048153154687,
                37.68535267552797
              ],
              [
                125.83824038020734,
                37.12664194055704
              ]
            ]
          ],
          "evenOdd": true
        }
      ],
      "displayProperties": [],
      "properties": {},
      "color": "#d63000",
      "mode": "Geometry",
      "shown": false,
      "locked": false
    }) || 
    /* color: #d63000 */
    /* shown: false */
    ee.Geometry.Polygon(
        [[[125.44273256770734, 36.192464228942924],
          [125.17906069270734, 32.97323019991105],
          [126.98081850520734, 32.75175259770902],
          [129.79331850520734, 35.40834675120257],
          [130.23277163020734, 36.40496809465562],
          [129.41978334895734, 37.84149958232295],
          [128.6534430968437, 38.80468883777087],
          [128.08801125838443, 38.28472833539263],
          [127.04509504169212, 38.275761861688714],
          [126.67149206442603, 37.82619189089002],
          [126.49822158981999, 37.769775335919846],
          [125.64048153154687, 37.68535267552797],
          [125.83824038020734, 37.12664194055704]]]),
    geometry_roi2 = ui.import && ui.import("geometry_roi2", "geometry", {
      "geometries": [
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                7.133961439546583,
                5.838685774423639
              ],
              [
                7.881031752046583,
                5.620056985735953
              ],
              [
                9.485035658296583,
                6.690494227229473
              ],
              [
                10.341969252046583,
                7.932726491637477
              ],
              [
                7.375660658296583,
                8.215539178292168
              ]
            ]
          ],
          "evenOdd": true
        }
      ],
      "displayProperties": [],
      "properties": {},
      "color": "#d63000",
      "mode": "Geometry",
      "shown": false,
      "locked": false
    }) || 
    /* color: #d63000 */
    /* shown: false */
    ee.Geometry.Polygon(
        [[[7.133961439546583, 5.838685774423639],
          [7.881031752046583, 5.620056985735953],
          [9.485035658296583, 6.690494227229473],
          [10.341969252046583, 7.932726491637477],
          [7.375660658296583, 8.215539178292168]]]),
    geometry_korea_utara = ui.import && ui.import("geometry_korea_utara", "geometry", {
      "geometries": [
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                124.41018670312528,
                39.486453389744234
              ],
              [
                124.32229607812528,
                38.66771713801978
              ],
              [
                124.41018670312528,
                37.735322009184344
              ],
              [
                125.24514764062528,
                37.59617558723204
              ],
              [
                126.65139764062528,
                37.80479735773434
              ],
              [
                127.44241326562528,
                38.1166278064096
              ],
              [
                128.23342889062528,
                38.1166278064096
              ],
              [
                128.76077264062528,
                38.66771713801978
              ],
              [
                128.32131951562528,
                39.14646803893025
              ],
              [
                128.36526482812528,
                39.72345914342575
              ],
              [
                129.68362420312528,
                40.429600694012734
              ],
              [
                130.78225701562528,
                41.491507841906206
              ],
              [
                130.87014764062528,
                42.568661674978095
              ],
              [
                129.94729607812528,
                43.116426744215126
              ],
              [
                129.24417107812528,
                42.697984445559946
              ],
              [
                128.10159295312528,
                42.276703263895946
              ],
              [
                127.61819451562528,
                41.95071131398631
              ],
              [
                127.04690545312528,
                42.01604382696079
              ],
              [
                125.15725701562528,
                41.02902603304943
              ],
              [
                123.92678826562528,
                39.757250866679506
              ]
            ]
          ],
          "evenOdd": true
        }
      ],
      "displayProperties": [],
      "properties": {},
      "color": "#b4d615",
      "mode": "Geometry",
      "shown": false,
      "locked": false
    }) || 
    /* color: #b4d615 */
    /* shown: false */
    ee.Geometry.Polygon(
        [[[124.41018670312528, 39.486453389744234],
          [124.32229607812528, 38.66771713801978],
          [124.41018670312528, 37.735322009184344],
          [125.24514764062528, 37.59617558723204],
          [126.65139764062528, 37.80479735773434],
          [127.44241326562528, 38.1166278064096],
          [128.23342889062528, 38.1166278064096],
          [128.76077264062528, 38.66771713801978],
          [128.32131951562528, 39.14646803893025],
          [128.36526482812528, 39.72345914342575],
          [129.68362420312528, 40.429600694012734],
          [130.78225701562528, 41.491507841906206],
          [130.87014764062528, 42.568661674978095],
          [129.94729607812528, 43.116426744215126],
          [129.24417107812528, 42.697984445559946],
          [128.10159295312528, 42.276703263895946],
          [127.61819451562528, 41.95071131398631],
          [127.04690545312528, 42.01604382696079],
          [125.15725701562528, 41.02902603304943],
          [123.92678826562528, 39.757250866679506]]]),
    geometry_rec = ui.import && ui.import("geometry_rec", "geometry", {
      "geometries": [
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                33.006107748268825,
                -3.751379165132481
              ],
              [
                33.006107748268825,
                -3.9226556888182995
              ],
              [
                33.308231771706325,
                -3.9226556888182995
              ],
              [
                33.308231771706325,
                -3.751379165132481
              ]
            ]
          ],
          "geodesic": false,
          "evenOdd": true
        }
      ],
      "displayProperties": [],
      "properties": {},
      "color": "#d63000",
      "mode": "Geometry",
      "shown": false,
      "locked": false
    }) || 
    /* color: #d63000 */
    /* shown: false */
    ee.Geometry.Polygon(
        [[[33.006107748268825, -3.751379165132481],
          [33.006107748268825, -3.9226556888182995],
          [33.308231771706325, -3.9226556888182995],
          [33.308231771706325, -3.751379165132481]]], null, false),
    img_paddy_modis_2019 = ui.import && ui.import("img_paddy_modis_2019", "image", {
      "id": "users/rudiyanto/paddy_modis_2019"
    }) || ee.Image("users/rudiyanto/paddy_modis_2019"),
    gaul0 = ui.import && ui.import("gaul0", "table", {
      "id": "FAO/GAUL/2015/level0"
    }) || ee.FeatureCollection("FAO/GAUL/2015/level0");
Map.setOptions("HYBRID");
var img_paddy_modis=img_paddy_modis_2019.select('class');
Map.addLayer(img_paddy_modis.select('class'),{min:0,max:1,palette:['white','brown']},'img_paddy',0);
var planarPolygon = ee.Geometry(geometry_rec, null, true);
print(planarPolygon.area());
//var img_paddy=img_paddy.select('class');
//Map.addLayer(img_paddy,{},'img_paddy');
/*
var gaul0 = ee.FeatureCollection(
  'FAO/GAUL_SIMPLIFIED_500m/2015/level1').sort('ADM1_NAME')
var india = gaul0.filter(
  ee.Filter.eq('ADM0_NAME', 'India'))
print(india.aggregate_array('ADM1_NAME'))  
var gaul = ee.FeatureCollection(
  'FAO/GAUL_SIMPLIFIED_500m/2015/level1')
var india = gaul.filter(
  ee.Filter.eq('ADM0_NAME', 'India'))
print(india.aggregate_array('ADM1_NAME'))  
var shp_adm1 = (india.filter(ee.Filter.inList('ADM1_NAME',
['Uttarakhand','Punjab','Uttar Pradesh','Himachal Pradesh','Haryana','Delhi'])).sort('ADM0_CODE'));                                   
//Map.addLayer(shp_adm1, {color: 'red'}, 'Admin2 Boundaries')
var shp_adm1 = (india.filter(ee.Filter.inList('ADM1_NAME',
['Bihar','Jharkhand','West Bengal','Chhattisgarh','Orissa','Sikkim'])).sort('ADM0_CODE'));                                   
var shp_adm1 = (india.filter(ee.Filter.inList('ADM1_NAME',
['Andhra Pradesh','Tamil Nadu','Kerala'])).sort('ADM0_CODE'));  
var shp_adm1 = (india.filter(ee.Filter.inList('ADM1_NAME',
['Assam','Meghalaya','Mizoram','Manipur','Nagaland'])).sort('ADM0_CODE')); 
var shp_adm1 = (india.filter(ee.Filter.inList('ADM1_NAME',
['Karnataka','Maharashtra','Madhya Pradesh'])).sort('ADM0_CODE'));                                   
var shp_adm1 = (india.filter(ee.Filter.inList('ADM1_NAME',
['Gujarat','Rajasthan'])).sort('ADM0_CODE'));                                   
*/
/*
var gaul1 = ee.FeatureCollection(
  'FAO/GAUL_SIMPLIFIED_500m/2015/level1').sort('ADM1_NAME')
 var indonesia = gaul1.filter(
  ee.Filter.eq('ADM0_NAME', 'Indonesia'))
print(indonesia.aggregate_array('ADM1_NAME'))
var shp_adm1 = (indonesia.filter(ee.Filter.inList('ADM1_NAME',
['Banten','Jawa Barat','Jawa Tengah',
'Jawa Timur','Daerah Istimewa Yogyakarta',
'Dki Jakarta'])).sort('ADM0_CODE'));
*/
var select_country= [
  'Pakistan','Nepal','India','Bangladesh','Sri Lanka',
//'Iran  (Islamic Republic of)'
//'China','Japan','Taiwan','Dem People\'s Rep of Korea','Republic of Korea'
]
var select_country= [
 // 'Pakistan','Nepal','India','Bangladesh','Sri Lanka',
//'Iran  (Islamic Republic of)'
'China','Japan','Taiwan','Dem People\'s Rep of Korea','Republic of Korea'
]
var select_country= [
 // 'Pakistan','Nepal','India','Bangladesh','Sri Lanka',
//'Iran  (Islamic Republic of)'
//'China','Japan','Taiwan','Dem People\'s Rep of Korea','Republic of Korea'
//'India',//
'Myanmar','Thailand','Lao People\'s Democratic Republic',
'Malaysia','Indonesia','Viet Nam','Philippines',
'Cambodia'////,'Spain','Italy'
]
var shp_adm0 = (gaul0.filter(ee.Filter.inList('ADM0_NAME', select_country)).sort('ADM0_CODE'))
print('list of selected contries',shp_adm0 .aggregate_array('ADM0_NAME'))
Map.centerObject(shp_adm0 )
//var shp_adm1 = indonesia;
/*
var shp_adm1 = (china.filter(ee.Filter.inList('ADM1_NAME',
['Hainan Sheng','Guangdong Sheng','Fujian Sheng','Zhejiang Sheng','Shanghai Shi','Guangxi Zhuangzu Zizhiqu'])).sort('ADM0_CODE'));                                   
var shp_adm1 = (china.filter(ee.Filter.inList('ADM1_NAME',
['Yunnan Sheng','Guizhou Sheng','Chongqing Shi','Sichuan Sheng'])).sort('ADM0_CODE')); 
var shp_adm1 = (china.filter(ee.Filter.inList('ADM1_NAME',
['Hubei Sheng','Hunan Sheng','Jiangxi Sheng','Anhui Sheng','Jiangsu Sheng'])).sort('ADM0_CODE'));
var shp_adm1 = (china.filter(ee.Filter.inList('ADM1_NAME',
['Henan Sheng','Shandong Sheng','Hebei Sheng','Shanxi Sheng','Beijing Shi','Tianjin Shi'])).sort('ADM0_CODE'));                    
var shp_adm1 = (china.filter(ee.Filter.inList('ADM1_NAME',
['Gansu Sheng','Shaanxi Sheng','Ningxia'])).sort('ADM0_CODE')); 
var shp_adm1 = (china.filter(ee.Filter.inList('ADM1_NAME',
['Liaoning Sheng','Jilin Sheng','Heilongjiang Sheng'])).sort('ADM0_CODE'));                         
//var shp_adm1 = (china.filter(ee.Filter.inList('ADM1_NAME',
//['Nei Mongol Zizhiqu'])).sort('ADM0_CODE')); 
var shp_adm1 = (china.filter(ee.Filter.inList('ADM1_NAME',
['Yunnan Sheng','Guizhou Sheng','Chongqing Shi','Sichuan Sheng'])).sort('ADM0_CODE')); 
var shp_adm1 = (china.filter(ee.Filter.inList('ADM1_NAME',
['Hainan Sheng','Guangdong Sheng','Fujian Sheng','Zhejiang Sheng','Shanghai Shi','Guangxi Zhuangzu Zizhiqu'])).sort('ADM0_CODE'));                                   
var shp_adm1 = (china.filter(ee.Filter.inList('ADM1_NAME',
//['Ningxia Huizu Zizhiqu'])).sort('ADM0_CODE')); 
['Nei Mongol Zizhiqu'])).sort('ADM0_CODE'));
var shp_adm1 = (china.filter(ee.Filter.inList('ADM1_NAME',
//['Guangxi Zhuangzu Zizhiqu'])).sort('ADM0_CODE'));                                   
['Hainan Sheng','Guangdong Sheng','Fujian Sheng','Zhejiang Sheng','Shanghai Shi','Guangxi Zhuangzu Zizhiqu'])).sort('ADM0_CODE'));                                   
var shp_adm1 = (china.filter(ee.Filter.inList('ADM1_NAME',
['Gansu Sheng','Shaanxi Sheng','Ningxia Huizu Zizhiqu'])).sort('ADM0_CODE'));                                   
*/
// var shp_adm1 = gaul0.filter(
//  ee.Filter.eq('ADM0_NAME', 'South Korea'))
// var shp_adm1 = gaul0.filter(ee.Filter.inList('ADM0_NAME',
/////['Thailand'])).sort('ADM0_NAME');
//['United Republic of Tanzania'])).sort('ADM0_NAME');
//['Nigeria'])).sort('ADM0_NAME');
//['Indonesia'])).sort('ADM0_NAME');  
//print(china.aggregate_array('ADM1_NAME'))
//print('area ha',shp_adm1.geometry().area().divide(1e4))
//Map.addLayer(shp_adm1, {color: 'purple'}, 'Admin2 Boundaries',0)
var paddy_roi=shp_adm0.geometry();
//print('area_polygon (ha)',(geometry_roi).Polygon.area().divide(1e4))
//var geometry_roi=shp_adm1;//geometry_roi2;//geometry_korea_utara;//
var roi=  shp_adm0;//geometry_roi;//geometry_korea;//geometry_roi3;//geometry_roi2;
//var geometry_roi=roi;//geometry_korea;
//print('area_ha',roi.geometry().area().divide(1e4).round())
var hansenImage = ee.Image('UMD/hansen/global_forest_change_2015').clip(roi);
// Select the land/water mask.
var datamask = hansenImage.select('datamask');
// Create a binary mask.
var mask = datamask.eq(1);
//Map.centerObject(roi);
//
var date = new Date();
print('date now',date)
date.setDate( date.getDate()  );
date.setFullYear( date.getFullYear() - 1 );
print(date.getFullYear()+'-09-01');
var date0=date.getFullYear()+'-01-01'
// start and end date
var now = ee.Date(Date.now());//ee.Date('2020-11-03');;// 
//var startDate = ee.Date('2019-01-01');
var startDate = ee.Date(date0);
var endDate = now;//ee.Date('2020-08-30');
//var startDate = ee.Date('2019-01-01');
//var endDate = ee.Date('2020-12-31');
var dataset_aqua = ee.ImageCollection('MODIS/006/MYD09A1')
                  .filter(ee.Filter.date(startDate, endDate))
                  .filterBounds(roi);
 print('dataset_aqua',dataset_aqua);
var falseColorVis = {
  min: -100.0,
  max: 8000.0,
  bands: ['sur_refl_b02', 'sur_refl_b02', 'sur_refl_b01'],
};
//print('projection', dataset_aqua.first().projection());
print('Scale in meters:', dataset_aqua.first().projection().nominalScale());
//Map.setCenter(6.746, 46.529, 2);
Map.addLayer(dataset_aqua, falseColorVis, 'False Color',0);
//terra
var dataset_terra = ee.ImageCollection('MODIS/006/MOD09A1')
                    .filter(ee.Filter.date(startDate, endDate))
                  .filterBounds(roi);
print('dataset_terra',dataset_terra)                  
var falseColorVis = {
  min: -100.0,
  max: 8000.0,
  bands: ['sur_refl_b02', 'sur_refl_b02', 'sur_refl_b01'],
};
//Map.setCenter(6.746, 46.529, 2);
Map.addLayer(dataset_terra, falseColorVis, 'False Color',0);
// Get the date range of images in the collection.
var range = dataset_terra.reduceColumns(ee.Reducer.minMax(), ["system:time_start"])
print('Date range: ', ee.Date(range.get('min')), ee.Date(range.get('max')))
//print(datS2.sort('system:time_start',false).first().propertyNames())
var newdataset_terra=dataset_terra.sort('system:time_start',false).first()
print(newdataset_terra)
// Get the timestamp and convert it to a date.
var date_img = ee.Date(newdataset_terra.get('system:time_start'));
print('Timestamp:', date_img);  // ee.Date
var lastimg=dataset_aqua.limit(1, 'system:time_start', false).first();
print(lastimg.get('system:time_start'))
print(ee.Date(lastimg.get('system:time_start')));
print('aqua system:id',(lastimg.get('system:id')).getInfo());
var lastimg=dataset_terra.limit(1, 'system:time_start', false).first();
print(lastimg.get('system:time_start'))
print(ee.Date(lastimg.get('system:time_start')));
print('terra system:id',(lastimg.get('system:id')).getInfo());
// merge collections
var MOD_merged = dataset_aqua.merge(dataset_terra)
print(MOD_merged)
// sort by date
var MOD_merge_sorted = MOD_merged.sort("system:time_start")
print('MOD_merge_sorted',MOD_merge_sorted)
var MOD_merge_sorted_des = MOD_merged.sort("system:time_start",false)
print('MOD_merge_sorted_des first',MOD_merge_sorted_des.first())
print('MOD_merge_sorted_des first',ee.Date(MOD_merge_sorted_des.first().get('system:time_start')).getInfo());
var dataset=MOD_merge_sorted;
// Function to calculate and add an NDVI band
var addNDVI = function(image) {
return image.addBands(image.normalizedDifference(['sur_refl_b02', 'sur_refl_b01'] ).rename('ndvi'));
};  
var addNDWI = function(image) {
return image.addBands(image.normalizedDifference(['sur_refl_b01', 'sur_refl_b05'] ).rename('ndwi'));//water ndwi
//return image.addBands(image.normalizedDifference(['sur_refl_b02', 'sur_refl_b05'] ).rename('ndwi'));//snow lswi
}; 
var addNDSI = function(image) {
//return image.addBands(image.normalizedDifference(['sur_refl_b01', 'sur_refl_b05'] ).rename('ndwi'));//water
//return image.addBands(image.normalizedDifference(['sur_refl_b02', 'sur_refl_b05'] ).rename('ndsi'));//snow lswi
return image.addBands(image.normalizedDifference(['sur_refl_b04', 'sur_refl_b05'] ).rename('ndsi'));//snow ndsi
//return image.addBands(image.expression(
//  '2.5 * ((NIR - RED) / (NIR + 6 * RED - 7.5 * BLUE + 1))', {
//    'NIR' : image.select('sur_refl_b02').divide(10000),
//    'RED' : image.select('sur_refl_b01').divide(10000),
//    'BLUE' : image.select('sur_refl_b03').divide(10000)
//}).rename('ndsi'));//snow ndsi
}; 
//var datasetNDWI = dataset.map(addNDWI);
//print('datasetNDWI',datasetNDWI) 
//var NDWI=(datasetNDWI.select('ndwi')).reduce(ee.Reducer.percentile([10]))
//print('NDWI',NDWI) 
//Map.addLayer(NDWI.select('ndwi_p10').clip(roi) ,  {min: -1, max: 0.05}, 'min NDVI',1);
// Add NDVI band to image collection
var dataset = dataset.map(addNDVI);//.select(['nd'])
print('dataset',dataset) 
var NDVI=dataset;//.select('nd')
// For month
var month =1;
// Calculating number of intervals
var months = endDate.difference(startDate,'month').divide(month).toInt();
// Generating a sequence 
var sequence = ee.List.sequence(0, months); 
print(sequence)
var sequence_s1 = sequence.map(function(num){
    num = ee.Number(num);
    var Start_interval = startDate.advance(num.multiply(month), 'month');
    var End_interval = startDate.advance(num.add(1).multiply(month), 'month');
    var subset = NDVI.filterDate(Start_interval,End_interval);
    return subset.qualityMosaic('ndvi').set('system:time_start',Start_interval);
    //    return subset.max().set('system:time_start',Start_interval);
});
//var byMonthYear = ee.ImageCollection.fromImages(sequence_s1)
var listOfImages = ee.ImageCollection.fromImages(sequence_s1)
print('listOfImages',listOfImages)
var listOfImages = listOfImages.toList(listOfImages.size());
print(listOfImages)
var newList = listOfImages.map(function comprobeBandsNumber(ele){
  var new_list = ee.List([]); 
  var count = ee.Image(ele).bandNames().size();
  var comp = ee.Algorithms.If(count.eq(14), ele, 0);
  new_list = new_list.add(comp);
  return new_list;
}).flatten();
print('newList',newList)
//removing zeroes in new list
var newList = newList.removeAll([0]);
print("new list", newList);
//creating new collection
var byMonthYear = ee.ImageCollection(newList);
print("Collection MIC", byMonthYear);
print('byMonthYear',byMonthYear)
print('byMonthYear',byMonthYear)
var datasetNDWI = byMonthYear.map(addNDWI);
print('datasetNDWI',datasetNDWI) 
var datasetNDSI = byMonthYear.map(addNDSI);
print('datasetNDSI',datasetNDSI) 
//var NDWI=(datasetNDWI.select('ndwi')).reduce(ee.Reducer.percentile([90]))
//print('NDWI',NDWI) 
//Map.addLayer(NDWI.gt(0.1).clip(roi) ,  {min: 0, max: 1,palette:['red','blue']}, 'p90 NDVI',1);
//
var multibandndvi = byMonthYear.select('ndvi').toBands().clip(paddy_roi).updateMask(img_paddy_modis);//.updateMask(mask);//.updateMask(masksawah);
var multiband=multibandndvi;
var multibandndwi = datasetNDWI.select('ndwi').toBands().clip(paddy_roi).updateMask(img_paddy_modis);
var multibandndsi = datasetNDSI.select('ndsi').toBands().clip(paddy_roi).updateMask(img_paddy_modis);
print('multiband',multiband);
Map.addLayer(multiband.clip(roi) ,{min:0.1,max:0.7}, 'monthly NDVI',0);
//
// Reset the bandnames
var names = multiband.bandNames();
print('bandnames',names)
// rename the bandnames 
print(names.length());
var nMonths =(names.length()).subtract(1) ;
print(nMonths);
var pertama=NDVI.first();
print('pertama:',pertama);
print(pertama.get('system:index'));
print(pertama.get('system:time_start'));
var systime=pertama.get('system:time_start');
var startDate =(ee.Date(systime));
//var startDate = ee.Date(startDate);
// get a list of time strings to pass into a dictionary later on
var monList = ee.List.sequence(0, nMonths).map(function (n) {
  return startDate.advance(n, 'month').format('yyyy-MM');
})
print('monList',monList);
var multiband = multiband.rename(monList).updateMask(img_paddy_modis);//.clip(geometry);
var multibandndwi = multibandndwi.rename(monList).updateMask(img_paddy_modis);//.clip(geometry);
var multibandndvi = multibandndvi.rename(monList).updateMask(img_paddy_modis);//.clip(geometry);
var multibandndsi = multibandndsi.rename(monList).updateMask(img_paddy_modis);//.clip(geometry);
print('multiband_ndvi_rename',multiband);
// the bandnames
var namesNDVI = multiband.bandNames();
print('bandnames',namesNDVI);
// length the bandnames 
var lengthband = namesNDVI.length();
print('nameslength',lengthband);
var lastband=namesNDVI.length().subtract(1);
print(lastband)
var bandname1 = ee.String(multiband.bandNames().get(lastband));
print('bandname1_name',bandname1);
var lastband2=namesNDVI.length().subtract(2);
var bandname2=monList.get(lastband2).getInfo();
print('bandname2',bandname2);
var img_band1=multiband.select(bandname1);
var img_band2=multiband.select(bandname2);
var img_delta=img_band1.subtract(img_band2);
print('img_delta',img_delta);
// Display the result using a color ramp: dark red, red, orange, yellow, lime, green, dark green
// Define RGB visualization parameters.
var visParams = {
  min: 0.0,
  max: 1,
  palette: [
    'FFFFFF', 'CE7E45', 'DF923D', 'F1B555', 'FCD163', '99B718', '74A901',
    '66A000', '529400', '3E8601', '207401', '056201', '004C00', '023B01',
    '012E01', '011D01', '011301'
  ],
};
// Display the result using a color ramp: dark red, red, orange, yellow, lime, green, dark green
var ndviParams = {min: 0, max:0.8, palette: ['8B0000','FF0000', 'FF4500', 'FFFF00', '00FF00','008000', '006400']};
var ndsiParams = {min: -0.75, max:-0.15, palette: ['008800', '8B6600','000089']};
 var dndviParams = {min: -0.5, max:0.5, palette: ['FF0000', 'FFFF00','00FF00']};
// Clip NDVI to campus boundary and add to map
//Map.setCenter(-120.65995, 35.31203, 13);
var ym=multiband.bandNames().get(lastband).getInfo();
print(ym)
var ym2=bandname2;
print(ym2)
Map.addLayer(img_band2 , ndviParams , 'monthly NDVI '+ym2,1);
Map.addLayer(multiband.select(bandname1) , ndviParams , 'monthly NDVI '+ym,1);
Map.addLayer(img_delta.select(bandname1) , dndviParams , 'delta monthly NDVI '+ym+' '+ym2,1);
Map.addLayer(multibandndsi.select(bandname1) , ndsiParams , 'monthly NDSI '+ym,0);
Map.addLayer(multibandndwi.select(bandname1) , ndsiParams , 'monthly NDWI '+ym,0);
//Map.addLayer(imagesawahjawa, {color: 'FF00FF'}, 'sawah baku');
var multiband1_modis=multiband;//.updateMask(cropland)
print('multiband1_evi',multiband1_modis);
var multiband1_modis=multiband;//.updateMask(cropland)
print('multiband1_evi',multiband1_modis);
/*
var dataset_MCD12Q1 = ee.ImageCollection('MODIS/006/MCD12Q1');
//var igbpLandCover = ( dataset.select('LC_Type1').max().neq(12));
//var igbpLandCover_forest =  (dataset_MCD12Q1.select('LC_Type1').filterDate('2019-01-01','2020-12-31').max()).neq(2);
var datasetMCD12Q1 = ee.ImageCollection('MODIS/006/MCD12Q1')
.filterDate('2019-01-01','2020-12-31');
print(datasetMCD12Q1)
var igbpLandCover_11121314 =ee.ImageCollection([ datasetMCD12Q1.select('LC_Type1').first().eq(12),//Croplands
//datasetMCD12Q1.select('LC_Type1').first().eq(9),//Savannas: tree cover 10-30%
//datasetMCD12Q1.select('LC_Type1').first().eq(10),//Grasslands
datasetMCD12Q1.select('LC_Type1').first().eq(11),//Permanent Wetlands
datasetMCD12Q1.select('LC_Type1').first().eq(13),//Urban and Built-up 
datasetMCD12Q1.select('LC_Type1').first().eq(17),//,//Water Bodies
//datasetMCD12Q1.select('LC_Type1').first().eq(14)//Natural Vegetation
]).max();//.clip(roi);
//bangladesh
//var igbpLandCover_11121314 =ee.ImageCollection([ datasetMCD12Q1.select('LC_Type1').first()]).max();//.clip(roi);
print('igbpLandCover_11121314',igbpLandCover_11121314)
var igbpLandCoverVis = {
  min: 0.0,
  max: 1.0,
  palette: ['000000','f24f44'
   // '05450a', 'F86a10', '54a708', '78d203', '009900', 'c6b044', 'dcd159',
   // 'dade48', 'fbff13', 'b6ff05', '27ff87', 'c24f44', 'a5a5a5', 'ff6d4c',
   // '69fff8', 'f9ffa4', '1c0dff'
  ],
};
Map.addLayer(igbpLandCover_11121314.updateMask(igbpLandCover_11121314).updateMask(mask), {min:0,max:1,palette:['white','blue']}, 'IGBP Land Cover 11_17',0);
var multibandcluster= multibandndvi.addBands(multibandndwi).addBands(multibandndsi).updateMask(mask).clip(roi);//.updateMask(igbpLandCover_11121314)
//var multibandcluster= multibandndvi.addBands(multibandndwi).addBands(multibandndsi);//.updateMask(mask);
var multibandnames=multibandcluster.bandNames();
//var training =multibandcluster.sample({
//region: geometry_roi,
//scale: 1000,
//numPixels: 5000,
//geometries: true
//});
var training = multibandcluster.addBands(igbpLandCover_11121314)
    .stratifiedSample({
      numPoints: 5000,
      classBand: 'LC_Type1',
    //  projection: 'EPSG:3665',
      scale: 1000,
      region: geometry_roi,
     // tileScale:8,
      geometries: true
    })
print('training',training.limit(5))
// Instantiate the clusterer and train it.
var clusterer = ee.Clusterer.wekaKMeans(15).train(training,multibandnames);
// print('Schema', clusterer.schema())
print('clusterer',clusterer)
// Cluster the input using the trained clusterer.
var resultcluster = multibandcluster.cluster(clusterer).toByte();
print('result',resultcluster);
var clusters = [0, 1, 2, 3, 4, 
                5, 6,7,8,9,
                10,11,12,13,14,
                15,16,17,18,19,
                 20,21,22,23,24,
                25,26,27,28,29,
                30,31,32,33,34,
                35,36,37,38,39,
                40,41,42,43,44,
                45,46,47,48,49];
var re_clusters=[ 1, 2, 3, 4, 5,
                  6,7,8,9,10, 
                  11,12,13,14,15,
                  16,17,18,19,20,
                  21,22,23,24,25,
                  26,27,28,29,30,
                  31,32,33,34,35,
                  36,37,38,39,40,
                  41,42,43,44,45,
                  46,47,48,49,50]; 
var re_clusters1=[ 0, 0, 0, 0, 0,
                  0, 0, 0, 1, 1,
                  1, 0, 1, 0, 0,
                  0, 0, 0, 0, 0,
                  0, 0, 0, 0, 0,
                  0, 0, 0, 0, 0,
                  0, 0, 0, 0, 0,
                  0, 0, 0, 0, 0,
                  0, 0, 0, 0, 0,
                  0, 0, 0, 0, 0]; 
*/ 
 /*
var re_clusters1=[ 1, 2, 3, 4, 5,
                  6,7,8,9,10, 
                  11,12,13,14,15,
                  16,17,18,19,20,
                  21,22,23,24,25,
                  26,27,28,29,30,
                  31,32,33,34,35,
                  36,37,38,39,40,
                  41,42,43,44,45,
                  46,47,48,49,50]; 
*/
/*
//var result_recluster = result.remap(clusters, re_clusters).rename('cluster').toByte();
var result_recluster =  resultcluster.remap(clusters, re_clusters).rename('cluster').toByte();
var result_recluster1 = result_recluster.remap(re_clusters, re_clusters1).rename('cluster').toByte();
//
var areaImage = ee.Image.pixelArea().addBands(
      result_recluster1)
var areas = areaImage.divide(10000).reduceRegion({
      reducer: ee.Reducer.sum().group({
      groupField: 1,
      groupName: 'class',
    }),
    geometry: roi,
    scale: 500,
    maxPixels: 1e10
    }); 
print('area-ha',areas)
// Map the function over the collection and display the result.
// Display the clusters with random colors.
Map.addLayer(result_recluster.randomVisualizer(), {}, 'clusters',1);
Map.addLayer(result_recluster1, {min:0,max:1,palette:['red','blue']}, 'clusters_paddy',0);
var dataset = ee.ImageCollection('MODIS/006/MCD12Q1')
.filterDate('2019-01-01','2019-12-31');
print(dataset)
var igbpLandCover = dataset.select('LC_Type1').first().eq(12);//.clip(roi);
print(igbpLandCover)
var igbpLandCoverVis = {
  min: 0.0,
  max: 1.0,
  palette: ['000000','c24f44'
   // '05450a', 'F86a10', '54a708', '78d203', '009900', 'c6b044', 'dcd159',
   // 'dade48', 'fbff13', 'b6ff05', '27ff87', 'c24f44', 'a5a5a5', 'ff6d4c',
   // '69fff8', 'f9ffa4', '1c0dff'
  ],
};
print('dataset',dataset.select('LC_Type1').first())
// Note that different bands can have different projections and scale.
var LC_Type1scale = dataset.select('LC_Type1').first().projection().nominalScale();
print('LC_Type1 scale: ', LC_Type1scale); // ee.Number
var cropland=igbpLandCover.updateMask(igbpLandCover);
 var display_bound = ee.Image(0).updateMask(0).paint(paddy_roi, '000000', 2);
Map.addLayer( display_bound, {palette: '0000FF'}, 'boundary',1);
Map.addLayer(igbpLandCover.updateMask(igbpLandCover), igbpLandCoverVis, 'IGBP Land Cover',0);
//
var image_cluster0_modis=  //ee.Image.cat([S1_1.select(['VH','VV']),S1_2.select(['VH'])]);
ee.Image.cat([multibandndvi,result_recluster]);
print(image_cluster0_modis)
var image_cluster1_modis=  //ee.Image.cat([S1_1.select(['VH','VV']),S1_2.select(['VH'])]);
ee.Image.cat([multibandndwi,result_recluster]);
var image_cluster2_modis=  //ee.Image.cat([S1_1.select(['VH','VV']),S1_2.select(['VH'])]);
ee.Image.cat([multibandndsi,result_recluster]);
// Define a broad list of land cover categories.
var classNames = ee.List(['Water', 'Forest', 'Shrub', 'Grass', 'Urban']);
// Define a list of Landsat 8 wavelengths for X-axis labels.
//var wavelengths = [0.44, 0.48, 0.56, 0.65, 0.86, 1.61, 2.2];
// Define chart customization options.
var options = {
  lineWidth: 1,
  pointSize: 2,
  hAxis: {title: 'Date (Year-Month)'},
  vAxis: {title: 'NDVI'},
  title: 'Spectra in classified regions'
};
// Make the chart, set the options.
var chartclassndvi = ui.Chart.image.byClass(
    image_cluster0_modis, 'cluster', geometry_roi, ee.Reducer.mean(), 2000)//, classNames)//, wavelengths)
    .setOptions(options)
    .setChartType('ScatterChart');
// Print the chart.
print(chartclassndvi);
///
var optionsndsi = {
  lineWidth: 1,
  pointSize: 2,
  hAxis: {title: 'Date (Year-Month)'},
  vAxis: {title: 'NDSI'},
  title: 'Spectra in classified regions'
};
// Make the chart, set the options.
var chartclassndsi = ui.Chart.image.byClass(
    image_cluster2_modis, 'cluster', geometry_roi, ee.Reducer.mean(), 2000)//, classNames)//, wavelengths)
    .setOptions(optionsndsi)
    .setChartType('ScatterChart');
// Print the chart.
print(chartclassndsi);
///
var optionsndwi = {
  lineWidth: 1,
  pointSize: 2,
  hAxis: {title: 'Date (Year-Month)'},
  vAxis: {title: 'NDWI'},
  title: 'Spectra in classified regions'
};
// Make the chart, set the options.
var chartclassndwi = ui.Chart.image.byClass(
    image_cluster1_modis, 'cluster', geometry_roi, ee.Reducer.mean(), 2000)//, classNames)//, wavelengths)
    .setOptions(optionsndwi)
    .setChartType('ScatterChart');
// Print the chart.
print(chartclassndwi);
///
*/
///
// Create a panel next to the map
var panel = ui.Panel({style:{width: '400px'}});
ui.root.add(panel);
var label1 = ui.Label({
  value: 'Paddy Rice Explorer using MODIS-MOD09A1.006 and MYD09A1.006',
  style: {
    fontSize: '20px',
    color: 'black',
   // fontWeight: 'bold',
    padding: '5px',
  }
});
 var label2 = ui.Label({
  value: 'Developed by Rudiyanto',
  style: {
    fontSize: '16px',
    color: 'black',
   // fontWeight: 'bold',
    padding: '5px',
  }
});
 var label3 = ui.Label({
  value: 'Email: rudiyanto@umt.edu.my',
  style: {
    fontSize: '14px',
    color: 'black',
   // fontWeight: 'bold',
    padding: '5px',
  }
});
var label4 = ui.Label({
  value: date,
  style: {
    fontSize: '14px',
    color: 'black',
   // fontWeight: 'bold',
    padding: '5px',
  }
});
var label5 = ui.Label({
 // value: (MOD_merge_sorted_des.first().get('system:id')).getInfo(),
    value:ee.Date(lastimg.get('system:time_start')).format('yyyy-MM-dd').getInfo(),
  style: {
    fontSize: '14px',
    color: 'black',
   // fontWeight: 'bold',
    padding: '5px',
  }
});
 var instructions = ui.Label({
  value: 'Click on the map (ROI) to show MODIS NDVI, NDSI and NDWI chart',
  style: {
    fontSize: '16px',
    color: 'black',
   // fontWeight: 'bold',
    padding: '5px',
  }
}); 
var pointList = ee.List([]); // Empty list to store our clicked points
var count = 0; // Counter to label our points
function make_chart(coords){ // What happens when the map is clicked
 panel.clear();
 count += 1;
 // Make a point with our clicked coordinates
 var point = ee.Feature(ee.Geometry.Point([coords.lon,coords.lat]),{name: 'Point '+count});
 pointList = pointList.add(point); // Add to the list
 var collection = ee.FeatureCollection(pointList) // Turn all points into a collection
 Map.addLayer(collection.style({ // Show the points on the map
 color: 'blue',
 pointSize: 5,
 pointShape: '+'
 }));
//
 var chartndvi = ui.Chart.image.seriesByRegion({ // Create the chart
 imageCollection: byMonthYear.select(['ndvi']),//NDVIs,
 regions: collection,
 reducer: ee.Reducer.mean(),
 scale: 500,
 seriesProperty: 'name'
 })
 .setChartType('ScatterChart')
 .setOptions({ // Set the labelling
 lineWidth:2,
 pointSize:3,
 title: 'NDVI through the MODIS time series',
 vAxis: {title: 'NDVI'},
 hAxis: {title: 'Date'},
 });
  var charts1 = ui.Chart.image.seriesByRegion({ // Create the chart
 imageCollection: datasetNDWI.select(['ndwi']),//NDVIs,
 regions: collection,
 reducer: ee.Reducer.mean(),
 scale: 500,
 seriesProperty: 'name'
 })
 .setChartType('ScatterChart')
 .setOptions({ // Set the labelling
 lineWidth:2,
 pointSize:3,
 title: 'NDWI through the MODIS time series',
 vAxis: {title: 'NDWI'},
 hAxis: {title: 'Date'},
 });
   var charts2 = ui.Chart.image.seriesByRegion({ // Create the chart
 imageCollection: datasetNDSI.select(['ndsi']),//NDVIs,
 regions: collection,
 reducer: ee.Reducer.mean(),
 scale: 500,
 seriesProperty: 'name'
 })
 .setChartType('ScatterChart')
 .setOptions({ // Set the labelling
 lineWidth:2,
 pointSize:3,
 title: 'NDSI through the MODIS time series',
 vAxis: {title: 'NDSI'},
 hAxis: {title: 'Date'},
 });
 panel.add(label1);
 panel.add(label2);
 panel.add(label3);
 panel.add(label4);
 panel.add(label5);
 panel.add(instructions); 
 panel.add(chartndvi); // Add to the panel
  panel.add(charts2);
 panel.add(charts1);
// chart.clear;
}
panel.add(label1);
 panel.add(label2);
 panel.add(label3);
 panel.add(label4);
 panel.add(label5);
 panel.add(instructions); 
Map.onClick(make_chart);
Map.style().set('cursor', 'crosshair');
///
//Map.addLayer(image_sawah_sulawesi,{},'sulawesi')
/*
var dataset = ee.ImageCollection('USDA/NASS/CDL')
                  .filter(ee.Filter.date('2019-01-01', '2019-12-31'))
                  .first();
var cropLandcover =dataset.select('cropland')
print(cropLandcover )
//Map.setCenter(-100.55, 40.71, 4);
Map.addLayer(cropLandcover.randomVisualizer(), {}, 'Crop Landcover');
var urban = cropLandcover.eq(3)
Map.addLayer(urban,
 {min:0, max:1, palette: ['grey', 'blue']},
 'rice_usa')
 */
// var compositecluster= multibandndvi.addBands(resultcluster.rename('landcover'));//.addBands(multibandndwi).addBands(multibandndsi).updateMask(igbpLandCover_11121314).updateMask(mask);
//var compositecluster= multibandndvi.addBands(result_recluster.rename('landcover'));//.addBands(multibandndwi).addBands(multibandndsi).updateMask(igbpLandCover_11121314).updateMask(mask);
/*
//var multibandcluster= multibandndvi.addBands(multibandndwi).addBands(multibandndsi);//.updateMask(mask);
//var multibandnames=multibandcluster.bandNames();
var training =compositecluster.sample({
region: geometry_roi,
scale: 500,
numPixels: 100,
geometries: true
});
*/
/*
var training = compositecluster
    .stratifiedSample({
      numPoints: 30,
      classBand: 'landcover',
    //  projection: 'EPSG:3665',
      scale: 500,
      region: geometry_roi,
      tileScale:8,
      geometries: true
    })
print(training);
print(compositecluster);
var composite= multibandndvi
// We will create a chart of spectral signature for all classes
// We have multiple GCPs for each class
// Use a grouped reducer to calculate the average reflectance
// for each band for each class
// We have 12 bands so need to repeat the reducer 12 times
// We also need to group the results by class
// So we find the index of the landcover property and use it
// to group the results
var bands = composite.bandNames()
var numBands = bands.length()
var bandsWithClass = bands.add('landcover')
var classIndex = bandsWithClass.indexOf('landcover')
// Use .combine() to get a reducer capable of 
// computing multiple stats on the input
var combinedReducer = ee.Reducer.mean().combine({
  reducer2: ee.Reducer.stdDev(),
  sharedInputs: true})
// Use .repeat() to get a reducer for each band
// We then use .group() to get stats by class
var repeatedReducer = combinedReducer.repeat(numBands).group(classIndex)
var gcpStats = training.reduceColumns({
    selectors: bands.add('landcover'),
    reducer: repeatedReducer,
})
// Result is a dictionary, we do some post-processing to
// extract the results
var groups = ee.List(gcpStats.get('groups'))
//var classNames = ee.List(['urban', 'bare', 'water', 'vegetation'])
var classNames = ee.List(['0', '1', '2', '3','4','5','6','7','8','9',
'10', '11', '12', '13','14','15','16','17','18','19'])
var fc = ee.FeatureCollection(groups.map(function(item) {
  // Extract the means
  var values = ee.Dictionary(item).get('mean')
  var groupNumber = ee.Dictionary(item).get('group')
  var properties = ee.Dictionary.fromLists(bands, values)
  var withClass = properties.set('class', classNames.get(groupNumber))
  return ee.Feature(null, withClass)
}))
// Chart spectral signatures of training data
var options = {
  title: 'Average Spectral Signatures',
  hAxis: {title: 'Bands'},
  vAxis: {title: 'Reflectance', 
    viewWindowMode:'explicit',
    viewWindow: {
        max:0.9,
        min:0
    }},
  lineWidth: 1,
  pointSize: 2,
 // series: {
  //  0: {color: 'grey'}, 
 //   1: {color: 'brown'}, 
 //   2: {color: 'blue'}, 
 //   3: {color: 'green'},
//}
};
// Default band names don't sort propertly
// Instead, we can give a dictionary with
// labels for each band in the X-Axis
var bandDescriptions = {
  'B2': 'B02/Blue',
  'B3': 'B03/Green',
  'B4': 'B04/Red',
  'B8': 'B08/NIR',
  'B11': 'B11/SWIR-1',
  'B12': 'B12/SWIR-2'
}
// Create the chart and set options.
var chart = ui.Chart.feature.byProperty({
  features: fc,
 // xProperties: bandDescriptions,
  seriesProperty: 'class'
})
.setChartType('ScatterChart')
.setOptions(options);
print(chart)
*/
/*
var classChart = function(landcover, label, color) {
  var options = {
  title: 'Spectral Signatures for ' + label + ' Class',
  hAxis: {title: 'Bands'},
  vAxis: {title: 'Reflectance', 
    viewWindowMode:'explicit',
    viewWindow: {
        max:0.9,
        min:0
    }},
  lineWidth: 1,
  pointSize: 4,
  };
  var fc = training.filter(ee.Filter.eq('landcover', landcover))
  var chart = ui.Chart.feature.byProperty({
  features: fc,
 // xProperties: bandDescriptions,
  })
.setChartType('ScatterChart')
.setOptions(options);
print(chart)
}
*/
//classChart(0, 'Urban')
//classChart(1, 'Bare')
//classChart(2, 'Water')
//classChart(3, 'Vegetation')
//var dataset = ee.Image('CGIAR/SRTM90_V4').clip(roi);
//var elevation = dataset.select('elevation');
//var slope = ee.Terrain.slope(elevation);
//Map.setCenter(-112.8598, 36.2841, 10);
//Map.addLayer(elevation, {min: 0, max: 300,palette:['blue','orange','red']}, 'elevation',0);
//Map.addLayer(slope, {min: 0, max: 0.8,palette:['blue','yellow','orange','red']}, 'slope',0);
 var display_bound = ee.Image(0).updateMask(0).paint(paddy_roi, '000000', 1);
Map.addLayer( display_bound, {palette: '0000FF'}, 'boundary',1); 
//var display_bound = ee.Image(0).updateMask(0).paint(paddy_roi, '000000', 1);
//Map.addLayer( display_bound, {palette: '0000FF'}, 'boundary',1);
/**
 * Define UI components.
 */
var comp = {};
// Title.
comp.title = {};
comp.title.label = ui.Label('Phenology of rice paddy cultivation: rudiyanto@umt.edu.my', null, 
  'https://www.umt.edu.my');
// Legend.
comp.legend = {};
comp.legend.title = ui.Label();
comp.legend.colorbar = ui.Thumbnail({
  image: ee.Image.pixelLonLat().select(0),
  params: {
    bbox: [0, 0, 1, 0.1],
    dimensions: '100x10',
    format: 'png',
    min: 0,
    max: 1,
    palette: dndviParams.palette
  }
});
comp.legend.leftLabel = ui.Label('[min]');
comp.legend.centerLabel = ui.Label();
comp.legend.rightLabel = ui.Label('[max]');
comp.legend.labelPanel = ui.Panel({
  widgets: [
    comp.legend.leftLabel,
    comp.legend.centerLabel,
    comp.legend.rightLabel,
  ],
  layout: ui.Panel.Layout.flow('horizontal')
});
comp.legend.panel = ui.Panel([
  comp.legend.title,
  comp.legend.colorbar,
  comp.legend.labelPanel
], null, {width: '300px', position: 'bottom-right'});
/**
 * Compose the components.
 */
Map.add(comp.title.label);
Map.add(comp.legend.panel);
/**
 * Style the components.
 */
var style = {};
style.title = {};
style.title.label = {
  fontWeight: 'bold',
  fontSize: '16px'
};
style.legend = {};
style.legend.title = {
  fontWeight: 'bold',
  fontSize: '12px',
  color: '383838'
};
style.legend.colorbar = {
  stretch: 'horizontal',
  margin: '0px 8px',
  maxHeight: '20px'
};
style.legend.leftLabel = {
  margin: '4px 8px',
  fontSize: '12px'
};
style.legend.centerLabel = {
  margin: '4px 8px',
  fontSize: '12px',
  textAlign: 'center',
  stretch: 'horizontal'
};
style.legend.rightLabel = {
  margin: '4px 8px',
  fontSize: '12px'
};
style.legend.panel = {
};
style.title.label;
comp.title.label.style().set(style.title.label);
comp.legend.title.style().set(style.legend.title);
comp.legend.colorbar.style().set(style.legend.colorbar);
comp.legend.leftLabel.style().set(style.legend.leftLabel);
comp.legend.centerLabel.style().set(style.legend.centerLabel);
comp.legend.rightLabel.style().set(style.legend.rightLabel);
comp.legend.title.setValue('Senescent-------------dNDVI-------------Green-up');
comp.legend.leftLabel.setValue(dndviParams.min + 0);
comp.legend.centerLabel.setValue(dndviParams.max / 2 -0.25);// + 10);
comp.legend.rightLabel.setValue(dndviParams.max  + 0);
var img_ndvi_dt=img_band1.addBands(img_delta).rename('ndvi','dndvi');
print(img_ndvi_dt)
var img_class=img_ndvi_dt.expression(
"(b1 <= 0.5 && b2 > 0) ? 1 :" +
"(b1 > 0.5 && b1 <= 0.7 && b2 > 0 ) ? 2 :" +
"(b1 > 0.7 &&   b2 > 0) ? 3 :" +
"(b1 > 0.5 && b1 <= 0.7 && b2 < 0) ? 4 :" +
"(b1 <= 0.5 && b2 < 0) ? 5 : 6" ,{
  b1 : img_ndvi_dt.select('ndvi'), b2 : img_ndvi_dt.select('dndvi'),
  c1 : 0.2, c2a : 0.2, c2b : 0.4,
  c3 : 0.5, c4a : 0.2, c4b:0.4
});
//Map.addLayer(img_class.updateMask(img_paddy_modis),{min:1,max:6,palette:['blue','green','yellow','red']},'Phenology')
//Map.addLayer(img_class.clip(paddy_roi).updateMask(img_paddy_modis),{min:1,max:6,palette:['blue','green','yellow','red']},'Phenology')
/*
var Kls = Img.expression(
"(Vi2 <= Air ) ? 1 :" +
"(Vi2 > Air && Vi2 <= Bera) ? 6 :" +
"(Lbs == 1 && (Vi2-Vi1) >=0 && Vi2 > Bera && Vi2 <= V1_1 ) ? 2 :" +
"(Lbs == 1 && (Vi2-Vi1) >=0 && Vi2 > V1_1 && Vi2 <= Vm1 ) ? 3 :" +
"(Lbs == 1 && (Vi2-Vi1) < 0 && Vi2 > G2_1 && Vi2 < Vm1 ) ? 4 :" +
"(Lbs == 1 && (Vi2-Vi1) < 0 && Vi2 > Bera && Vi2 <= G2_1 ) ? 5 :" +
"(Lbs == 2 && (Vi2-Vi1) >=0 && Vi2 > Bera && Vi2 <= V1_2 ) ? 2 :" +
"(Lbs == 2 && (Vi2-Vi1) >=0 && Vi2 > V1_2 && Vi2 <= Vm2 ) ? 3:" +
"(Lbs == 2 && (Vi2-Vi1) < 0 && Vi2 > G2_2 && Vi2 < Vm2 ) ? 4:" +
"(Lbs == 2 && (Vi2-Vi1) < 0 && Vi2 > Bera && Vi2 <= G2_2 ) ? 5 :" + 
"(Lbs == 3 && (Vi2-Vi1) >=0 && Vi2 > Bera && Vi2 <= V1_3 ) ? 2 :" +
"(Lbs == 3 && (Vi2-Vi1) >=0 && Vi2 > V1_3 && Vi2 <= Vm3 ) ? 3:" +
"(Lbs == 3 && (Vi2-Vi1) < 0 && Vi2 > G2_3 && Vi2 < Vm3 ) ? 4:" +
"(Lbs == 3 && (Vi2-Vi1) < 0 && Vi2 > Bera && Vi2 <= G2_3 ) ? 5 :" + 
"(Lbs == 4 && (Vi2-Vi1) >=0 && Vi2 > Bera && Vi2 <= V1_4 ) ? 2 :" +
"(Lbs == 4 && (Vi2-Vi1) >=0 && Vi2 > V1_4 && Vi2 <=Vm4 ) ? 3:" +
"(Lbs == 4 && (Vi2-Vi1) < 0 && Vi2 > G2_4 && Vi2 < Vm4 ) ? 4:" +
"(Lbs == 4 && (Vi2-Vi1) < 0 && Vi2 > Bera && Vi2 <= G2_4 ) ? 5 :" + 
"(Lbs == 5 && (Vi2-Vi1) >=0 && Vi2 > Bera && Vi2 <= V1_5 ) ? 2 :" +
"(Lbs == 5 && (Vi2-Vi1) >=0 && Vi2 > V1_5 && Vi2 <= Vm5 ) ? 3:" +
"(Lbs == 5 && (Vi2-Vi1) < 0 && Vi2 > G2_5 && Vi2 < Vm5 ) ? 4:" +
"(Lbs == 5 && (Vi2-Vi1) < 0 && Vi2 > Bera && Vi2 <= G2_5 ) ? 5 :" + 
"(Lbs == 6 && (Vi2-Vi1) >=0 && Vi2 > Bera && Vi2 <= V1_6 ) ? 2 :" +
"(Lbs == 6 && (Vi2-Vi1) >=0 && Vi2 > V1_6 && Vi2 <= Vm6 ) ? 3:" +
"(Lbs == 6 && (Vi2-Vi1) < 0 && Vi2 > G2_6 && Vi2 < Vm6 ) ? 4:" +
"(Lbs == 6 && (Vi2-Vi1) < 0 && Vi2 > Bera && Vi2 <= G2_6 ) ? 5 :" + 
"(Lbs == 7 && (Vi2-Vi1) >=0 && Vi2 > Bera && Vi2 <= V1_7 ) ? 2 :" +
"(Lbs == 7 && (Vi2-Vi1) >=0 && Vi2 > V1_7 && Vi2 <= Vm7 ) ? 3:" +
"(Lbs == 7 && (Vi2-Vi1) < 0 && Vi2 > G2_7 && Vi2 < Vm7 ) ? 4:" +
"(Lbs == 7 && (Vi2-Vi1) < 0 && Vi2 > Bera && Vi2 <= G2_7 ) ? 5 : 7",  
{Vi1 : Img.select(Vi1),Vi2 : Img.select(Vi2),Lbs : Img.select(LBS),Air : 0.167, Bera : 0.194,
  V1_1 : Ba1[0],V1_2 : Ba2[0],V1_3 : Ba3[0],V1_4 : Ba4[0],V1_5 : Ba5[0],V1_6 : Ba6[0],V1_7 : Ba7[0],
  G2_1 : Ba1[1],G2_2 : Ba2[1],G2_3 : Ba3[1],G2_4 : Ba4[1],G2_5 : Ba5[1],G2_6 : Ba6[1],G2_7 : Ba7[1],
  Vm1 : VM1,Vm2 : VM2,Vm3 : VM3,Vm4 : VM4,Vm5 : VM5,Vm6 : VM6,Vm7 : VM7})
  */
  // Legend.
comp.legend2 = {};
comp.legend2.title = ui.Label();
comp.legend2.colorbar = ui.Thumbnail({
  image: ee.Image.pixelLonLat().select(0),
  params: {
    bbox: [0, 0, 1, 0.1],
    dimensions: '100x10',
    format: 'png',
    min: 0,
    max: 1,
    palette: ndviParams.palette
  }
});
comp.legend2.leftLabel = ui.Label('[min]');
comp.legend2.centerLabel = ui.Label();
comp.legend2.rightLabel = ui.Label('[max]');
comp.legend2.labelPanel = ui.Panel({
  widgets: [
    comp.legend2.leftLabel,
    comp.legend2.centerLabel,
    comp.legend2.rightLabel,
  ],
  layout: ui.Panel.Layout.flow('horizontal')
});
comp.legend2.panel = ui.Panel([
  comp.legend2.title,
  comp.legend2.colorbar,
  comp.legend2.labelPanel
], null, {width: '300px', position: 'bottom-left'});
/**
 * Compose the components.
 */
//Map.add(comp.title.label);
Map.add(comp.legend2.panel);
/**
 * Style the components.
 */
var style = {};
style.title = {};
style.title.label = {
  fontWeight: 'bold',
  fontSize: '16px'
};
style.legend = {};
style.legend.title = {
  fontWeight: 'bold',
  fontSize: '12px',
  color: '383838'
};
style.legend.colorbar = {
  stretch: 'horizontal',
  margin: '0px 8px',
  maxHeight: '20px'
};
style.legend.leftLabel = {
  margin: '4px 8px',
  fontSize: '12px'
};
style.legend.centerLabel = {
  margin: '4px 8px',
  fontSize: '12px',
  textAlign: 'center',
  stretch: 'horizontal'
};
style.legend.rightLabel = {
  margin: '4px 8px',
  fontSize: '12px'
};
style.legend.panel = {
};
style.title.label;
comp.title.label.style().set(style.title.label);
comp.legend2.title.style().set(style.legend.title);
comp.legend2.colorbar.style().set(style.legend.colorbar);
comp.legend2.leftLabel.style().set(style.legend.leftLabel);
comp.legend2.centerLabel.style().set(style.legend.centerLabel);
comp.legend2.rightLabel.style().set(style.legend.rightLabel);
comp.legend2.title.setValue('NDVI');
comp.legend2.leftLabel.setValue(ndviParams.min + 0);
comp.legend2.centerLabel.setValue(ndviParams.max / 2 -0);// + 10);
comp.legend2.rightLabel.setValue(ndviParams.max  + 0);