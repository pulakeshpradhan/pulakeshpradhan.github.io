var GrIS_Poly = ui.import && ui.import("GrIS_Poly", "geometry", {
      "geometries": [
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                -52.86018198743761,
                82.02356578261364
              ],
              [
                -57.25471323743761,
                81.72545658709431
              ],
              [
                -60.77033823743761,
                81.06840454465085
              ],
              [
                -62.00080698743761,
                80.62099347175662
              ],
              [
                -64.98908823743761,
                79.93867257557895
              ],
              [
                -66.04377573743761,
                79.0414344980247
              ],
              [
                -69.20783823743761,
                78.31705207543925
              ],
              [
                -68.85627573743761,
                77.69622995272317
              ],
              [
                -65.86799448743761,
                77.46944903536784
              ],
              [
                -66.92268198743761,
                76.84440465893486
              ],
              [
                -65.34065073743761,
                76.60219817846851
              ],
              [
                -61.12190073743761,
                76.43830054934502
              ],
              [
                -58.30940073743761,
                75.93471695766826
              ],
              [
                -56.20002573743761,
                75.09968672007922
              ],
              [
                -54.44221323743761,
                74.16838655401415
              ],
              [
                -52.50861948743761,
                72.66428620033675
              ],
              [
                -50.22346323743761,
                71.30584610464459
              ],
              [
                -48.99299448743761,
                69.78439969170202
              ],
              [
                -48.46565073743761,
                68.07919047857118
              ],
              [
                -48.64143198743761,
                66.4494058340922
              ],
              [
                -48.99299448743761,
                64.32770163865648
              ],
              [
                -48.11408823743761,
                62.193368354324896
              ],
              [
                -46.18049448743761,
                61.530210346268674
              ],
              [
                -44.42268198743761,
                61.94636497098074
              ],
              [
                -43.36799448743761,
                63.711704853594135
              ],
              [
                -40.90705698743761,
                65.51949559807322
              ],
              [
                -37.21565073743761,
                66.79812072387446
              ],
              [
                -34.05158823743761,
                68.07919047857118
              ],
              [
                -30.535963237437613,
                69.16816462274397
              ],
              [
                -30.184400737437613,
                70.20533315550074
              ],
              [
                -29.832838237437613,
                71.02208684336031
              ],
              [
                -29.129713237437613,
                72.71658710015714
              ],
              [
                -28.075025737437613,
                74.02388263879551
              ],
              [
                -25.262525737437613,
                74.73376637396335
              ],
              [
                -23.328931987437613,
                75.67609790573616
              ],
              [
                -23.328931987437613,
                76.4794584955772
              ],
              [
                -22.977369487437613,
                77.23855620551055
              ],
              [
                -22.625806987437613,
                77.9557036712965
              ],
              [
                -22.098463237437613,
                78.66770568240521
              ],
              [
                -23.328931987437613,
                79.27289615874966
              ],
              [
                -26.141431987437613,
                80.09106547292664
              ],
              [
                -27.547681987437613,
                80.67811258628073
              ],
              [
                -28.250806987437613,
                81.06840454465085
              ],
              [
                -31.590650737437613,
                81.59800260951562
              ],
              [
                -34.22736948743761,
                81.67470701441167
              ],
              [
                -37.03986948743761,
                81.67470701441167
              ],
              [
                -39.14924448743761,
                81.82603589320117
              ],
              [
                -43.01643198743761,
                81.75071605186494
              ],
              [
                -44.07111948743761,
                81.28410607986733
              ],
              [
                -46.53205698743761,
                81.1769092368005
              ],
              [
                -48.81721323743761,
                81.23067017344087
              ],
              [
                -51.80549448743761,
                81.36365470254358
              ]
            ]
          ],
          "evenOdd": true
        }
      ],
      "displayProperties": [],
      "properties": {},
      "color": "#f3feff",
      "mode": "Geometry",
      "shown": false,
      "locked": false
    }) || 
    /* color: #f3feff */
    /* shown: false */
    ee.Geometry.Polygon(
        [[[-52.86018198743761, 82.02356578261364],
          [-57.25471323743761, 81.72545658709431],
          [-60.77033823743761, 81.06840454465085],
          [-62.00080698743761, 80.62099347175662],
          [-64.98908823743761, 79.93867257557895],
          [-66.04377573743761, 79.0414344980247],
          [-69.20783823743761, 78.31705207543925],
          [-68.85627573743761, 77.69622995272317],
          [-65.86799448743761, 77.46944903536784],
          [-66.92268198743761, 76.84440465893486],
          [-65.34065073743761, 76.60219817846851],
          [-61.12190073743761, 76.43830054934502],
          [-58.30940073743761, 75.93471695766826],
          [-56.20002573743761, 75.09968672007922],
          [-54.44221323743761, 74.16838655401415],
          [-52.50861948743761, 72.66428620033675],
          [-50.22346323743761, 71.30584610464459],
          [-48.99299448743761, 69.78439969170202],
          [-48.46565073743761, 68.07919047857118],
          [-48.64143198743761, 66.4494058340922],
          [-48.99299448743761, 64.32770163865648],
          [-48.11408823743761, 62.193368354324896],
          [-46.18049448743761, 61.530210346268674],
          [-44.42268198743761, 61.94636497098074],
          [-43.36799448743761, 63.711704853594135],
          [-40.90705698743761, 65.51949559807322],
          [-37.21565073743761, 66.79812072387446],
          [-34.05158823743761, 68.07919047857118],
          [-30.535963237437613, 69.16816462274397],
          [-30.184400737437613, 70.20533315550074],
          [-29.832838237437613, 71.02208684336031],
          [-29.129713237437613, 72.71658710015714],
          [-28.075025737437613, 74.02388263879551],
          [-25.262525737437613, 74.73376637396335],
          [-23.328931987437613, 75.67609790573616],
          [-23.328931987437613, 76.4794584955772],
          [-22.977369487437613, 77.23855620551055],
          [-22.625806987437613, 77.9557036712965],
          [-22.098463237437613, 78.66770568240521],
          [-23.328931987437613, 79.27289615874966],
          [-26.141431987437613, 80.09106547292664],
          [-27.547681987437613, 80.67811258628073],
          [-28.250806987437613, 81.06840454465085],
          [-31.590650737437613, 81.59800260951562],
          [-34.22736948743761, 81.67470701441167],
          [-37.03986948743761, 81.67470701441167],
          [-39.14924448743761, 81.82603589320117],
          [-43.01643198743761, 81.75071605186494],
          [-44.07111948743761, 81.28410607986733],
          [-46.53205698743761, 81.1769092368005],
          [-48.81721323743761, 81.23067017344087],
          [-51.80549448743761, 81.36365470254358]]]);
// ** Polar Museum Outreach App **
// ** Neil Arnold, Scott Polar Research Institute, University of Cambridge **
// Centre the map
Map.setCenter(-45,75,3)
// ** Set image number **
//var myImNum = 1; // Set to your allocated numbers for each year
// ** Set year **
//var year = 2021; // Set as needed
// ** Now done with a button **
// Text box for image number.
var imtextbox = ui.Textbox({
  placeholder: 'Enter Year',
  onChange: function(yvalue) {
    var year = ee.Number(Number(yvalue));
    print(year);
// ** Set threshold if needed **
//var brThresh = 2; // Set as needed (2.5 = default; higher makes lakes smaller)
// Other parameters
var zoomScale = 7; // Set as needed; larger = higher zoom
// ** Load modules **
// Cloud masking
var cloudMask = require('users/nsa120/CamGeog1A:cloudMaskLS1A');
// Band ratios
var bandRat = require('users/nsa120/CamGeog1A:bandRatios1A');
// Lake stats
var lakeStats = require('users/nsa120/CamGeog1A:addLakeStats1A');
// ** Local Functions **
// Function to mask non-ice
var maskLand = function(image) {
  return image.updateMask(iceMask);    // Clip out land
};
// ** Get imagery **
// Load Land and Ice Masks and DEM
var iceMask = ee.Image('OSU/GIMP/2000_ICE_OCEAN_MASK').select(['ice_mask']);
var oceanMask = ee.Image('OSU/GIMP/2000_ICE_OCEAN_MASK').select(['ocean_mask']);
var DEM = ee.Image('UMN/PGC/ArcticDEM/V2/5m').select('elevation');
// Set up date range
var startDate = ee.Date.fromYMD(year,1,1);
var endDate = ee.Date.fromYMD(year,12,31);
// Landsat data
var L8Coll = ee.ImageCollection('LANDSAT/LC08/C01/T1_TOA')
  // location filter
  .filterBounds(GrIS_Poly)
  // Year
  .filterDate(startDate, endDate)
  // Summer months
  .filter(ee.Filter.calendarRange(6,9,'month'))
  // Filter cloudy scenes.
  .filter(ee.Filter.lt('CLOUD_COVER', 0.5))
  // Mask cloudy pixels
  .map(cloudMask.maskClouds)
  // Calculate NDWI
  .map(bandRat.addNDWI8)
  // Calculate blue/red ratio
  .map(bandRat.addBR8)
  // Bands needed... Kludge for L8 bands.
  .select(['B4', 'B3', 'B2', 'ndwi', 'br'],['B3', 'B2', 'B1', 'ndwi', 'br'])
  ;
// Sort by date
var sortedCollection = ee.ImageCollection(L8Coll.sort('DATE_ACQUIRED'));
print ('Sorted Image List', sortedCollection);
// ** Image Processing **
//Get List of Images
var listOfOrigImages = sortedCollection.toList(sortedCollection.size());
var numIm = listOfOrigImages.length();
// Text box for image number.
var imtextbox = ui.Textbox({
  placeholder: 'Enter Image Number',
  onChange: function(value) {
    var myImNum = ee.Number(Number(value));
    print(myImNum);
// Text box for b/r threshold.
var threshtextbox = ui.Textbox({
  placeholder: 'Enter Blue/Red Threshold',
  onChange: function(tvalue) {
    var brThresh = ee.Number(Number(tvalue));
// Everything else is now a function within this button!
// Get a single image
var myImage = ee.Image(listOfOrigImages.get(myImNum));
// Clip and mask it
var imGeom = myImage.geometry();
var localIceMask = iceMask.clip(imGeom);
var iceImage = myImage.updateMask(localIceMask);
var myDEM = DEM.clip(imGeom);
var iceDEM = myDEM.updateMask(localIceMask);
// Clip low elevation areas
var lowMask = myDEM.gte(100);
iceDEM = myDEM.updateMask(lowMask);
iceImage = iceImage.updateMask(lowMask);
// Image stats
var meanElev = iceDEM.reduceRegion({
  reducer: ee.Reducer.mean(),
  geometry: imGeom,
  scale: 30,
  bestEffort: true
});
var icePixArea = ee.Image.pixelArea().updateMask(localIceMask);
var totIceArea = icePixArea.reduceRegion({
  reducer: ee.Reducer.sum(),
  geometry: imGeom,
  scale: 30,
  //bestEffort: true
  maxPixels: 1e9
});
//print(totIceArea);
//Map.addLayer(icePixArea, {bands: ['area']}, 'Ice Pix Area');
var imLonLat = ee.Image.pixelLonLat().clip(imGeom);
var meanLonLat = imLonLat.reduceRegion({
  reducer: ee.Reducer.mean(),
  geometry: imGeom,
  scale: 30,
  bestEffort: true
});
// Lake stats
var depthImage = lakeStats.addLakeDepth(iceImage,brThresh,zoomScale);
var isLake = depthImage.select('isLake');
var lakePixArea = ee.Image.pixelArea().updateMask(isLake);
var totLakeArea = lakePixArea.reduceRegion({
  reducer: ee.Reducer.sum(),
  geometry: imGeom,
  scale: 30,
  maxPixels: 1e9
});
var meanLakeDepth = depthImage.select('lakeDepth').reduceRegion({
  reducer: ee.Reducer.mean(),
  geometry: imGeom,
  scale: 30,
  maxPixels: 1e9
});
var totLakeVol = depthImage.select('lakeDepth').multiply(ee.Image.pixelArea()).reduceRegion({
  reducer: ee.Reducer.sum(),
  geometry: imGeom,
  scale: 30,
  maxPixels: 1e9
});
var lakeElev = myDEM.updateMask(isLake);
var meanLakeElev = lakeElev.reduceRegion({
  reducer: ee.Reducer.mean(),
  geometry: imGeom,
  scale: 30,
  maxPixels: 1e9
});
// Put them all together
var myImageStats = ee.Dictionary({
  Image_Date: myImage.get('DATE_ACQUIRED'),
  Image_Id: myImage.get('LANDSAT_SCENE_ID'),
  Image_Ice_Area: totIceArea.get('area'),
  Image_Latitude:  meanLonLat.get('latitude'),
  Image_Longitude:  meanLonLat.get('longitude'),
  //Image_Path: myImage.get('WRS_PATH'),
  //Image_Row: myImage.get('WRS_ROW'),
  Image_Mean_Ice_Elev:  meanElev.get('elevation'),
  Image_BR_Thresh: brThresh,
  Mean_Lake_Elev: meanLakeElev.get('elevation'),
  Mean_Lake_Depth: meanLakeDepth.get('lakeDepth'),
  Total_Lake_Area: totLakeArea.get('area'),
  Total_Lake_Vol: totLakeVol.get('lakeDepth')
});
// ** Display results **
// Text Results
print ('My Image', depthImage);
print ('Image Statistics', myImageStats);
// Set up visuals
Map.centerObject(myImage,zoomScale);
var depthViz = {bands:'lakeDepth', min:0.0, max:3, palette: ['87CEEB', '000070']};
// Display (weird complex way so it updates via ui threshold value)
var iceMaskLayer = ui.Map.Layer(localIceMask, {min:0.0, max:1, palette:"000000,FFFFFF"}, 'Local Ice Mask');
Map.layers().set(0,iceMaskLayer);
var elevationLayer = ui.Map.Layer(myDEM, {bands: ['elevation'], min: 0, max: 1500}, 'Elevation');
Map.layers().set(1,elevationLayer);
var blueLayer = ui.Map.Layer(myImage, {bands: ['B1'], min: 0, max: 1}, 'Blue Reflectance');
Map.layers().set(2,blueLayer);
var redLayer = ui.Map.Layer(myImage, {bands: ['B3'], min: 0, max: 1}, 'Red Reflectance');
Map.layers().set(3,redLayer);
var rgbLayer = ui.Map.Layer(myImage, {bands: ['B3', 'B2', 'B1'], min: 0, max: 1}, 'RGB Image');
Map.layers().set(4,rgbLayer);
var lakeMaskLayer = ui.Map.Layer(isLake.updateMask(isLake),{palette: ['FF0000']}, 'Lake Mask');
Map.layers().set(5,lakeMaskLayer);
var lakeDepthLayer = ui.Map.Layer(depthImage, depthViz, 'Lake Depth');
//Map.layers().set(6,lakeDepthLayer);
// Export
var tmpFeature = ee.Feature(null, myImageStats);
var myImageResults = ee.FeatureCollection([tmpFeature]);
//print (myImageResults);
var exportTask = function () {
  Export.table.toDrive({
  collection: myImageResults,
  description: 'ImageStats_'.concat(yvalue, '_Image_', value),
  fileNamePrefix: 'ImageStats_'.concat(yvalue, '_Image_', value),
  fileFormat: 'CSV',
  selectors: ([
    'Image_Id',
    'Image_Date',
    'Image_Latitude',
    'Image_Longitude',
    //'Image_Path',
    //'Image_Row',
    'Image_Mean_Ice_Elev',
    'Image_Ice_Area',
    'Image_BR_Thresh',
    'Mean_Lake_Elev',
    'Mean_Lake_Depth',
    'Total_Lake_Area',
    'Total_Lake_Vol'])
  });
};
// Show the export button
panel.clear();
var exportButton = ui.Button('Click to Export', exportTask);
//exportButton.style().set('shown', false);
exportButton.style().set('position', 'bottom-right');
exportButton.style().set('padding', '0px');
panel.add(exportButton);
  // This is the end of the threshold text box function
  }
});
// Hide the image text box
imtextbox.style().set('shown', false);
// Add the threshold text box
threshtextbox.style().set('position', 'bottom-left');
Map.add(threshtextbox);
// This is the end of the image ui box function
  }
});
// Add the ui elements
// Image number text box
imtextbox.style().set('position', 'bottom-left');
Map.add(imtextbox);
// This is the end of the year ui box function
  }
});
// Add the ui elements
// Year text box
imtextbox.style().set('position', 'bottom-left');
Map.add(imtextbox);
// Create a panel for the export button
var panel = ui.Panel();
panel.style().set({
  width: '120px',
  height: '65px',
  position: 'bottom-right'
});
//panel.setLayout(ui.Panel.Layout.absolute());
Map.add(panel);