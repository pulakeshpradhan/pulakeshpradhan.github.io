var AOI_subset = ui.import && ui.import("AOI_subset", "geometry", {
      "geometries": [
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                14.727161424235874,
                51.29039867713924
              ],
              [
                14.727161424235874,
                51.24958661829409
              ],
              [
                14.81264878995853,
                51.24958661829409
              ],
              [
                14.81264878995853,
                51.29039867713924
              ]
            ]
          ],
          "geodesic": false,
          "evenOdd": true
        }
      ],
      "displayProperties": [],
      "properties": {},
      "color": "#ffc82d",
      "mode": "Geometry",
      "shown": false,
      "locked": false
    }) || 
    /* color: #ffc82d */
    /* shown: false */
    ee.Geometry.Polygon(
        [[[14.727161424235874, 51.29039867713924],
          [14.727161424235874, 51.24958661829409],
          [14.81264878995853, 51.24958661829409],
          [14.81264878995853, 51.29039867713924]]], null, false),
    AOI_investigation = ui.import && ui.import("AOI_investigation", "geometry", {
      "geometries": [
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                14.744307765484223,
                51.2779629400824
              ],
              [
                14.741689941267166,
                51.27928507752743
              ],
              [
                14.739672907279772,
                51.27808374407531
              ],
              [
                14.74035955223792,
                51.276083723535855
              ],
              [
                14.73645425539963,
                51.27460714284478
              ],
              [
                14.734179741542212,
                51.27248615341754
              ],
              [
                14.734565979753146,
                51.27162699038237
              ],
              [
                14.735853440631454,
                51.27044561504861
              ],
              [
                14.737055061830917,
                51.27051276374449
              ],
              [
                14.738256697055041,
                51.270707421971935
              ],
              [
                14.74143243675929,
                51.270472464888186
              ],
              [
                14.74241948993984,
                51.26875404761975
              ],
              [
                14.745466480019767,
                51.26790018813374
              ],
              [
                14.746839812489391,
                51.267524252624355
              ],
              [
                14.746668147716994,
                51.26653072888551
              ],
              [
                14.748041402340505,
                51.265000159226325
              ],
              [
                14.749693642998182,
                51.26525526212639
              ],
              [
                14.752000329878683,
                51.2657587998159
              ],
              [
                14.753936854604381,
                51.267205421199364
              ],
              [
                14.754757655107026,
                51.26811499818023
              ],
              [
                14.755817198352807,
                51.26851107969865
              ],
              [
                14.757885235524782,
                51.26804790461722
              ],
              [
                14.758923269082288,
                51.266430086516955
              ],
              [
                14.760283108020879,
                51.265913185494036
              ],
              [
                14.76147390853931,
                51.26612797023301
              ],
              [
                14.763297811100973,
                51.264154283448214
              ],
              [
                14.766055104675235,
                51.264583970323926
              ],
              [
                14.767095811109925,
                51.2647988006179
              ],
              [
                14.769263045714865,
                51.264530230321334
              ],
              [
                14.771559017175834,
                51.265510363116796
              ],
              [
                14.770134323875821,
                51.26723611559975
              ],
              [
                14.771765040758268,
                51.26860554726906
              ],
              [
                14.77189378413119,
                51.26931709895763
              ],
              [
                14.77657162708874,
                51.269813802523984
              ],
              [
                14.780434056168591,
                51.26900831582721
              ],
              [
                14.782193538773072,
                51.26779999702095
              ],
              [
                14.78079869704311,
                51.267453767806174
              ],
              [
                14.779232230088857,
                51.26659733851524
              ],
              [
                14.779640089495384,
                51.26359272941887
              ],
              [
                14.778427779913727,
                51.26199653455071
              ],
              [
                14.77842514134386,
                51.26138268767845
              ],
              [
                14.778937480693685,
                51.26071512798925
              ],
              [
                14.777605746662674,
                51.26048880152992
              ],
              [
                14.77661736307482,
                51.25977906342772
              ],
              [
                14.776745484383262,
                51.25804108096372
              ],
              [
                14.776530285415902,
                51.25716251923033
              ],
              [
                14.776400877612332,
                51.255639411289025
              ],
              [
                14.775016646747304,
                51.25500348034801
              ],
              [
                14.773804143415873,
                51.25361548505216
              ],
              [
                14.774823177026528,
                51.25233493588166
              ],
              [
                14.77697827496731,
                51.25265165621613
              ],
              [
                14.77805582280323,
                51.25248768138707
              ],
              [
                14.778790054124533,
                51.25296834374109
              ],
              [
                14.779838760199953,
                51.25349426457338
              ],
              [
                14.780477017931378,
                51.25266590902848
              ],
              [
                14.78124950185121,
                51.25127630144775
              ],
              [
                14.783223508386522,
                51.249832951407754
              ],
              [
                14.785121999189414,
                51.25047734830024
              ],
              [
                14.786733876146156,
                51.252411221741944
              ],
              [
                14.787144198078988,
                51.254291329282786
              ],
              [
                14.789485838477276,
                51.253136249620255
              ],
              [
                14.792428284077705,
                51.254640116653555
              ],
              [
                14.790765902040448,
                51.2562918926487
              ],
              [
                14.792938601240152,
                51.25819213758046
              ],
              [
                14.790335139598323,
                51.26172607812371
              ],
              [
                14.789533952580554,
                51.26262819353072
              ],
              [
                14.787874298519812,
                51.26600088385628
              ],
              [
                14.786872726596693,
                51.267499251792735
              ],
              [
                14.786214455538243,
                51.26784298321814
              ],
              [
                14.78901708921069,
                51.26782686099378
              ],
              [
                14.790197252807616,
                51.26773286864629
              ],
              [
                14.79311549690463,
                51.26971982687442
              ],
              [
                14.797256830207957,
                51.269008290899826
              ],
              [
                14.805239074065852,
                51.26801487193716
              ],
              [
                14.808650858431877,
                51.268605530391206
              ],
              [
                14.80808222872112,
                51.270565600939335
              ],
              [
                14.805861360783767,
                51.271733547630475
              ],
              [
                14.799080731382448,
                51.273961964146736
              ],
              [
                14.791699127099832,
                51.2761864801608
              ],
              [
                14.789521222171865,
                51.27713283019009
              ],
              [
                14.78631325062838,
                51.27786435124633
              ],
              [
                14.784254600638182,
                51.277944081974496
              ],
              [
                14.78056386848257,
                51.27841389797597
              ],
              [
                14.778246451217564,
                51.2781856898211
              ],
              [
                14.7788472661873,
                51.279850065747546
              ],
              [
                14.777087847326417,
                51.28150092745547
              ],
              [
                14.774813222351883,
                51.28411810962373
              ],
              [
                14.772367046790919,
                51.285943315189826
              ],
              [
                14.76657347400419,
                51.286560647762975
              ],
              [
                14.763268991533323,
                51.28626540277749
              ],
              [
                14.76206736151903,
                51.2851380862673
              ],
              [
                14.761659670972108,
                51.285996995870924
              ],
              [
                14.760822816147765,
                51.285943315158384
              ],
              [
                14.745373287864822,
                51.28186334338899
              ],
              [
                14.745612980252417,
                51.279161497962484
              ]
            ]
          ],
          "evenOdd": true
        }
      ],
      "displayProperties": [],
      "properties": {},
      "color": "#d63000",
      "mode": "Geometry",
      "shown": false,
      "locked": false
    }) || 
    /* color: #d63000 */
    /* shown: false */
    ee.Geometry.Polygon(
        [[[14.744307765484223, 51.2779629400824],
          [14.741689941267166, 51.27928507752743],
          [14.739672907279772, 51.27808374407531],
          [14.74035955223792, 51.276083723535855],
          [14.73645425539963, 51.27460714284478],
          [14.734179741542212, 51.27248615341754],
          [14.734565979753146, 51.27162699038237],
          [14.735853440631454, 51.27044561504861],
          [14.737055061830917, 51.27051276374449],
          [14.738256697055041, 51.270707421971935],
          [14.74143243675929, 51.270472464888186],
          [14.74241948993984, 51.26875404761975],
          [14.745466480019767, 51.26790018813374],
          [14.746839812489391, 51.267524252624355],
          [14.746668147716994, 51.26653072888551],
          [14.748041402340505, 51.265000159226325],
          [14.749693642998182, 51.26525526212639],
          [14.752000329878683, 51.2657587998159],
          [14.753936854604381, 51.267205421199364],
          [14.754757655107026, 51.26811499818023],
          [14.755817198352807, 51.26851107969865],
          [14.757885235524782, 51.26804790461722],
          [14.758923269082288, 51.266430086516955],
          [14.760283108020879, 51.265913185494036],
          [14.76147390853931, 51.26612797023301],
          [14.763297811100973, 51.264154283448214],
          [14.766055104675235, 51.264583970323926],
          [14.767095811109925, 51.2647988006179],
          [14.769263045714865, 51.264530230321334],
          [14.771559017175834, 51.265510363116796],
          [14.770134323875821, 51.26723611559975],
          [14.771765040758268, 51.26860554726906],
          [14.77189378413119, 51.26931709895763],
          [14.77657162708874, 51.269813802523984],
          [14.780434056168591, 51.26900831582721],
          [14.782193538773072, 51.26779999702095],
          [14.78079869704311, 51.267453767806174],
          [14.779232230088857, 51.26659733851524],
          [14.779640089495384, 51.26359272941887],
          [14.778427779913727, 51.26199653455071],
          [14.77842514134386, 51.26138268767845],
          [14.778937480693685, 51.26071512798925],
          [14.777605746662674, 51.26048880152992],
          [14.77661736307482, 51.25977906342772],
          [14.776745484383262, 51.25804108096372],
          [14.776530285415902, 51.25716251923033],
          [14.776400877612332, 51.255639411289025],
          [14.775016646747304, 51.25500348034801],
          [14.773804143415873, 51.25361548505216],
          [14.774823177026528, 51.25233493588166],
          [14.77697827496731, 51.25265165621613],
          [14.77805582280323, 51.25248768138707],
          [14.778790054124533, 51.25296834374109],
          [14.779838760199953, 51.25349426457338],
          [14.780477017931378, 51.25266590902848],
          [14.78124950185121, 51.25127630144775],
          [14.783223508386522, 51.249832951407754],
          [14.785121999189414, 51.25047734830024],
          [14.786733876146156, 51.252411221741944],
          [14.787144198078988, 51.254291329282786],
          [14.789485838477276, 51.253136249620255],
          [14.792428284077705, 51.254640116653555],
          [14.790765902040448, 51.2562918926487],
          [14.792938601240152, 51.25819213758046],
          [14.790335139598323, 51.26172607812371],
          [14.789533952580554, 51.26262819353072],
          [14.787874298519812, 51.26600088385628],
          [14.786872726596693, 51.267499251792735],
          [14.786214455538243, 51.26784298321814],
          [14.78901708921069, 51.26782686099378],
          [14.790197252807616, 51.26773286864629],
          [14.79311549690463, 51.26971982687442],
          [14.797256830207957, 51.269008290899826],
          [14.805239074065852, 51.26801487193716],
          [14.808650858431877, 51.268605530391206],
          [14.80808222872112, 51.270565600939335],
          [14.805861360783767, 51.271733547630475],
          [14.799080731382448, 51.273961964146736],
          [14.791699127099832, 51.2761864801608],
          [14.789521222171865, 51.27713283019009],
          [14.78631325062838, 51.27786435124633],
          [14.784254600638182, 51.277944081974496],
          [14.78056386848257, 51.27841389797597],
          [14.778246451217564, 51.2781856898211],
          [14.7788472661873, 51.279850065747546],
          [14.777087847326417, 51.28150092745547],
          [14.774813222351883, 51.28411810962373],
          [14.772367046790919, 51.285943315189826],
          [14.76657347400419, 51.286560647762975],
          [14.763268991533323, 51.28626540277749],
          [14.76206736151903, 51.2851380862673],
          [14.761659670972108, 51.285996995870924],
          [14.760822816147765, 51.285943315158384],
          [14.745373287864822, 51.28186334338899],
          [14.745612980252417, 51.279161497962484]]]);
//////////////////////////////////////////////////////////////
// Credits
//////////////////////////////////////////////////////////////
//base code adapted from: 
//https://gis.stackexchange.com/questions/312151/calculate-ndwi-from-image-collection-and-reclassify-to-land-water-in-google-eart?rq=1
//https://code.earthengine.google.com/9f890c110e98fa3391480543009c8028
// © Stephan Büttig @ Stephan.Buettig@smul.sachsen.de [LfULG]
// © Marie Lins     @ Marie.Lins@smul.sachsen.de      [BfUL]
var Contacts_Label = ui.Label({value: 'Contacts:', style: {fontSize: '11px',fontWeight: 'bold'}});
var Contact1_Label = ui.Label({value: 'Stephan Büttig', style: {fontSize: '11px',fontWeight: 'bold'}});
Contact1_Label.setUrl('mailto:Stephan.Buettig@smul.sachsen.de');
var Contact2_Label = ui.Label({value: 'Marie Lins', style: {fontSize: '11px',fontWeight: 'bold'}});
Contact2_Label.setUrl('mailto:Marie.Lins@smul.sachsen.de');
var Contacts_Panel = ui.Panel([
    ui.Panel([Contacts_Label,Contact1_Label,Contact2_Label],
      ui.Panel.Layout.Flow('horizontal'), {stretch: 'horizontal'})]
);
//////////////////////////////////////////////////////////////
// Default View
//////////////////////////////////////////////////////////////
//Set center of polygon objects and hide some map elements
Map.centerObject(AOI_subset);
Map.setControlVisibility({zoomControl: false, fullscreenControl: false});
//////////////////////////////////////////////////////////////
// Navigation panel und map elements
//////////////////////////////////////////////////////////////
//base code adapted from: 
//https://code.earthengine.google.com/aad2f3165e15ffc75368fed12fb7ae6b
// Find very first image date for lower selection limit
var NOW = new Date();
var INVESTIGATION_PERIOD = ((NOW.getTime())-(ee.ImageCollection('COPERNICUS/S1_GRD')
  .filterBounds(AOI_subset)
  .sort('system:time_start', true)
  .limit(1).first()
  .get('system:time_start').getInfo()))/(1000 * 60 * 60 * 24);
//Slide to set investiagtion period
function single_slider (slider_default) {
  // define UI elements
  var mini_panel = ui.Panel({
    widgets: [
        ui.Slider({
          min: -INVESTIGATION_PERIOD,
          max: 1,
          value: slider_default,
          step: 1,
          style: {
            width: '219px',
            fontSize: 0, // hide label
            margin: '0px -50px 0px 8px',
          }
        }),
        ui.Textbox({style: {
          width: '85px',
          margin: '0px'
        } })
      ],
    layout: ui.Panel.Layout.flow('horizontal'),
    style: {margin: '0px'},
    }
  );
  // helper functions with convenient names
  var listen_textbox = true;
  var listen_slider = true;
  mini_panel.slider = mini_panel.widgets().get(0);
  mini_panel.box = mini_panel.widgets().get(1);
  mini_panel.box.parent = mini_panel;
  mini_panel.value = mini_panel.slider.getValue;
  mini_panel.getDate = function() {
    mini_panel.box.style().set('color', 'black');
    if (listen_slider) {
      var date = new Date(NOW);
      date.setUTCDate(date.getUTCDate() + mini_panel.value());
      var pad = function(int) { return ('0' + int).slice(-2); };
      var date_string = date.getUTCFullYear() + '-' + pad(date.getUTCMonth()+1) + '-' + pad(date.getUTCDate());
      listen_textbox = false;
      mini_panel.box.setValue(date_string);
      listen_textbox = true;
      return date;
    }
  };
  // link textbox and slider
  mini_panel.slider.onSlide(mini_panel.getDate);
  mini_panel.box.onChange( function(text, box) {
    if (listen_textbox) {
      var newdate = new Date(text);
      var newval = Math.ceil((newdate - NOW)/(1000*3600*24));
      if (newval === 0 || newval && newval > -INVESTIGATION_PERIOD && newval < 2) {
        listen_slider = false;
        box.parent.slider.setValue(newval);
        listen_slider = true;
      }
      else
        box.style().set('color', 'red');
    }
  });
  // sync textbox and slider
  mini_panel.getDate();
  // return combined slider with textbox
  return mini_panel;
}
// Option to limit mask to water body bounds
var LimitWaterBodies_checkbox = ui.Checkbox('Limit mask to water body bounds', true);
// Textbox for water line contours
var Contours_checkbox = ui.Checkbox('Occourence contour [%]:', false);
Contours_checkbox.onChange(function(checked) {
  if (checked) {
     Contours_box.set('disabled', false);
  } else {
     Contours_box.setValue(90);
     Contours_box.set('disabled', true);
  }});
var Contours_box = ui.Textbox({value:'90'}).set('disabled', true);
    Contours_box.style().set({width: '70px',textAlign: 'center'});
var Contours_panel = ui.Panel([
    ui.Panel(
      [Contours_checkbox, Contours_box],
      ui.Panel.Layout.Flow('horizontal'), {stretch: 'horizontal'})]
);
// Textbox for min. mapping unit [mmu]
var MMU_checkbox = ui.Checkbox('Minimal mapping unit [px]:', false);
MMU_checkbox.onChange(function(checked) {
  if (checked) {
     MMU_box.set('disabled', false);
  } else {
     MMU_box.setValue(16);
     MMU_box.set('disabled', true);
  }});
var MMU_box = ui.Textbox({value:'16'}).set('disabled', true);
    MMU_box.style().set({width: '56px',textAlign: 'center'});
var MMU_panel = ui.Panel([
    ui.Panel(
      [MMU_checkbox, MMU_box],
      ui.Panel.Layout.Flow('horizontal'), {stretch: 'horizontal'})]
);
// textbox for min. occurrence threshold
var OccurrenceThreshold_label = ui.Label('Min. occurrence threshold [%]:');
var OccurrenceThreshold_box = ui.Textbox({value:'10'});
OccurrenceThreshold_box.style().set({width: '51px',textAlign: 'center'});
var OccurrenceThreshold_panel = ui.Panel([
    ui.Panel(
      [OccurrenceThreshold_label, OccurrenceThreshold_box],
      ui.Panel.Layout.Flow('horizontal'), {stretch: 'horizontal'})]
);
// Filter options
var SpeckleFiltering_Label = ui.Label('Speckle Filtering',{fontWeight: 'bold'});
//Smoothing filter options
var SmoothingFilter_Checkbox = ui.Checkbox('Smoothing filter', false);
SmoothingFilter_Checkbox.onChange(function(checked) {
  if (checked) {
     KernelRadius_Box.set('disabled', false);
  } else {
     KernelRadius_Box.setValue(50);
     KernelRadius_Box.set('disabled', true);
  }});
var KernelRadius_Label = ui.Label('Kernel radius [m]:');
var KernelRadius_Box = ui.Textbox({value:'50', disabled: true});
KernelRadius_Box.style().set({width: '50px'});
var SmoothingFilter_Panel = ui.Panel([
    SmoothingFilter_Checkbox,
    ui.Panel(
      [KernelRadius_Label, KernelRadius_Box],
      ui.Panel.Layout.Flow('horizontal'), {stretch: 'horizontal'})
      ]);
//Submit button
var submitButton = ui.Button({label: 'Run'});
submitButton.style().set('stretch', 'horizontal');
// Create a button to unhide the side panel later.
//base code adapted from: 
//https://gis.stackexchange.com/questions/344607/combine-checkbox-with-splitpanel-widget-in-google-earth-engine
//https://code.earthengine.google.com/397aa792d5237839ed9fd14fcd107190
var settings_button = ui.Button({
  label: 'Options', // label: '⚙️️',
  style: {backgroundColor: '#ffdb76', position: 'top-right'},
  onClick: function() {
    // Hide the button.
    settings_button.style().set('shown', false);
    close_button.style().set('shown', true);
    // Display the panel.
    side_panel.style().set('shown', true);
  }
});
//Header and close button
var header_label = ui.Label('Investigation Options',{fontSize: '20px', fontWeight: 'bold'});
var close_button = ui.Button({
                  label: '❌',
                  style: {position: 'top-right',
                          padding: '0px', margin: '0px',
                          shown: false
                  },
                  onClick: function () {
                  side_panel.style().set('shown', false);
                  settings_button.style().set('shown', true);
                  },
                });
var Header_panel = ui.Panel([
    ui.Panel(
      [header_label, close_button],
      ui.Panel.Layout.Flow('horizontal'), {stretch: 'horizontal'})]);
//Combine elements in panel
var startDate_label = ui.Label('Start of investigation period:');
var startDate_slide = single_slider(-90); //set start of investiagtion period 90 days before today
//var startDate_slide =  single_slider((ee.Date(NOW).format('DDD').getInfo())*-1+1); //set first day of the current year as start of investiagtion
var endDate_label = ui.Label('End of investigation period:');
var endDate_slide = single_slider(0);
var side_panel = ui.Panel({
  widgets: [Header_panel, startDate_label,startDate_slide,endDate_label,endDate_slide,LimitWaterBodies_checkbox,Contours_panel,MMU_panel,OccurrenceThreshold_panel,SpeckleFiltering_Label,SmoothingFilter_Panel,submitButton,Contacts_Panel],
});
ui.root.add(side_panel);
// Create label on the map
var label = ui.Label('Please zoom to area of investigation and define boundaries.',{backgroundColor: '#ffdb76'});
Map.add(label);
//Show zoomlevel in textbox on the map
var zoomLevel = ui.Label({
  value: 'Zoom level: '+Map.getZoom(),
  style: {position:'top-left', color:'black'} 
});
Map.add(zoomLevel);
Map.onChangeZoom(function(z,b){
  zoomLevel.setValue('Zoom level: '+z);
  if(z > 10 & z < 16){
    zoomLevel.style().set('color', 'black');
  } else{
    zoomLevel.style().set('color', 'red');
  }});
//############################################################
// Start calculation procedure with click on the submit button
//############################################################
submitButton.onClick(function() {
//////////////////////////////////////////////////////////////
// Set default parameters
//////////////////////////////////////////////////////////////
// Define visualization parameters in an object literal.
var s1_band='VV';
//lowest and highest percentile
//var p_low = 30; // is defined by textbox for "min. occurrence threshold [%]"
var p_high = 100;
//Clear map view an hide some map elements and add options button
side_panel.style().set('shown', false);
settings_button.style().set('shown', true);
Map.clear();
//Map.centerObject(AOI_subset);
Map.setControlVisibility({zoomControl: false, fullscreenControl: false});
Map.add(settings_button);
//Get investiagtion period from slider elements
var startDate = startDate_slide.getDate();
var endDate =  endDate_slide.getDate();
//Get min. occurrence threshold
var p_low = Number(OccurrenceThreshold_box.getValue()); 
// Make a variable of visualization parameters.
var visParams = {
  bands: [s1_band],
  min: -20,
  max: 0,
//
};
// Create callback functions for charts
function ChartCallback (xValue, yValue, seriesName,indexLayer_S1,indexLayer_WaterMask) {
    if (!xValue) return;  // Reset selection
    //remove S1-image and WaterMask-layers if already present
    var index_S1Image = indexLayer(/S1-Image\s\[\d{2}\.\d{2}\.\d{4}_\d{2}\:\d{2}\:\d{2}\]$/);
    if (index_S1Image !== -1) {Map.remove(Map.layers().get(index_S1Image))}
    var index_WaterMask = indexLayer(/WaterMask\s\[\d{2}\.\d{2}\.\d{4}_\d{2}\:\d{2}\:\d{2}\]$/);
    if (index_WaterMask !== -1) {Map.remove(Map.layers().get(index_WaterMask))}
   // Show the image for the clicked date.
    var equalDate = ee.Filter.equals('system:time_start', xValue);
    //Find image coresponding with clicked data and clip water classification to aoi
    var classification;
      if (LimitWaterBodies_checkbox.getValue()===true) {
        classification = ee.Image(s1.filter(equalDate).first()).select('waterMask').clip(AOI_investigation);
        }
      else {
        classification = ee.Image(s1.filter(equalDate).first()).select('waterMask');
        }    
    var SARimage = ee.Image(s1.filter(equalDate).first());
        var date_string = new Date(xValue).toLocaleDateString('de-DE', {year: 'numeric', month: '2-digit', day: '2-digit'})+'_'+ new Date(xValue).toLocaleTimeString('de-DE');
    //Make map layer based on S1-image and add this new layer
    var nameLayer_S1 = 'S1-Image ['+ new Date(xValue).toLocaleDateString('de-DE', {year: 'numeric', month: '2-digit', day: '2-digit'})+'_'+ new Date(xValue).toLocaleTimeString('de-DE')+']';
    Map.addLayer(SARimage, visParams,nameLayer_S1);
    //Add water classification on top of SAR image
    var nameLayer_WaterMask = 'WaterMask ['+date_string+']';
    Map.addLayer(classification,{min: 0, max: 1, palette: ['#FFFFFF','#1A2659']},nameLayer_WaterMask);
}
//////////////////////////////////////////////////////////////
// Generate image collection
//////////////////////////////////////////////////////////////
// import sentinel 1 and filter data series
var s1 = ee.ImageCollection('COPERNICUS/S1_GRD')                            // Use sentinel-1 Image collection
.filter(ee.Filter.listContains('transmitterReceiverPolarisation', s1_band)) // Filter by VV-Band
//.filter(ee.Filter.eq('instrumentMode', 'IW'))
//.filter(ee.Filter.eq('orbitProperties_pass', 'ASCENDING'))
.filterBounds(AOI_subset)                                                   // Filter by AOI (AOI_subset)
//.filterBounds(Map.getBounds(true))                                        // Filter by map bounds (Map.getBounds(true))
.filterDate(startDate, endDate)                                             // Filter by date
.filter(ee.Filter.contains({leftField: ".geo", rightValue: AOI_subset}))    // Filter partial S1-Images of AOI
.map(function(image){return image.clip(Map.getBounds(true))});              // Crop by map bounds
//Speckle Filtering
  if (SmoothingFilter_Checkbox.getValue()===true) {
    s1 = s1.map(function(image){return image.addBands(image.select(s1_band).focal_median(parseFloat(KernelRadius_Box.getValue()),'circle','meters').rename('VV_smoothed'))}); // Smooth S1-Images
  s1_band = 'VV_smoothed';
  }
// Get the median over time, in each band, in each pixel.
var s1_median = s1.median();
// Create a function to select images of s1_band
function select_s1_band(image){
  return image.select(s1_band);
}
//////////////////////////////////////////////////////////////
// Otsu Segmentation
//////////////////////////////////////////////////////////////
// Use Otsu (1979) method for image segmentation to create water-land mask
// Based on code from Nicholas Clinton (Google): https://code.earthengine.google.com/6f3abb73b6642198485e36000024827a
// Return the DN that maximizes interclass variance in B5 (in the region).
var otsu = function(histogram) {
  var counts = ee.Array(ee.Dictionary(histogram).get('histogram'));
  var means = ee.Array(ee.Dictionary(histogram).get('bucketMeans'));
  var size = means.length().get([0]);
  var total = counts.reduce(ee.Reducer.sum(), [0]).get([0]);
  var sum = means.multiply(counts).reduce(ee.Reducer.sum(), [0]).get([0]);
  var mean = sum.divide(total);
  var indices = ee.List.sequence(1, size);
  // Compute between sum of squares, where each mean partitions the data.
  var bss = indices.map(function(i) {
    var aCounts = counts.slice(0, 0, i);
    var aCount = aCounts.reduce(ee.Reducer.sum(), [0]).get([0]);
    var aMeans = means.slice(0, 0, i);
    var aMean = aMeans.multiply(aCounts)
        .reduce(ee.Reducer.sum(), [0]).get([0])
        .divide(aCount);
    var bCount = total.subtract(aCount);
    var bMean = sum.subtract(aCount.multiply(aMean)).divide(bCount);
    return aCount.multiply(aMean.subtract(mean).pow(2)).add(
           bCount.multiply(bMean.subtract(mean).pow(2)));
  });
  // Return the mean value corresponding to the maximum BSS.
  return means.sort(bss).get([-1]);
};
//////////////////////////////////////////////////////////////
// Map over entire collection – HINWEIS: Dies Funktion wird 3x durchlaufen, ist das ein Fehler bzw. notwenig oder erforderlich?
//////////////////////////////////////////////////////////////
  s1 = s1.map(function(image){
      var s1_selection = select_s1_band(image);
      var histogram = ee.Dictionary(s1_selection.reduceRegion({
          reducer: ee.Reducer.histogram(255,1),
          geometry: AOI_subset, 
           scale: 10,
           bestEffort: true})
       .get(s1_band));
  var threshold = otsu(histogram);
  //Mask water using otsu-threshold
  var waterMask = s1_selection.lt(ee.Number(threshold)).rename('waterMask');
  waterMask = waterMask.updateMask(waterMask);
    // Set minimal mapping unit [mmu]
  if (MMU_checkbox.getValue()===true) {
    var mmu = Number(MMU_box.getValue());
        waterMask = waterMask.connectedPixelCount(mmu).gte(mmu);
        waterMask = waterMask.updateMask(waterMask);
  }
  //print('unbekannter Mehrfachdurchlauf'); //diese Funktion sollte ggf. nur einmal durchlaufen werden
  // Calculate water area
  var waterArea = waterMask.reduceRegion({
    reducer: ee.Reducer.sum(),
    geometry: AOI_investigation,
    scale: 10});
  return image.addBands(waterMask).set('OtsuThreshold', threshold).set('waterArea', waterArea);
});
//Calculating water occurrence depending on limit option
var water_sum;
if (LimitWaterBodies_checkbox.getValue()===true) {
  water_sum = s1.map(function(image){return image.clip(AOI_investigation)}).reduce(ee.Reducer.sum());
}
else {
  water_sum = s1.reduce(ee.Reducer.sum());
}
var water_frequency = water_sum.divide(s1.size()).multiply(100);
var water_frequency_masked = water_frequency.updateMask(water_frequency.gte(p_low));
//////////////////////////////////////////////////////////////
// Otsu threshold for the median image
//////////////////////////////////////////////////////////////
//s1_median = select_s1_band(s1_median);
//var histogram = ee.Dictionary(s1_median.reduceRegion({
//  reducer: ee.Reducer.histogram(255),
//  geometry: AOI_subset, 
//  scale: 10,
//  bestEffort: true
//}).get(s1_band));
//var threshold = otsu(histogram);
//var waterMask_median = s1_median.lt(ee.Number(threshold)).rename('waterMask_median');
//var median_water_mask = waterMask_median.updateMask(waterMask_median);
//s1_median = s1_median.addBands(waterMask_median).set('Otsu_threshold', threshold);
//////////////////////////////////////////////////////////////
// Functional elements
//////////////////////////////////////////////////////////////
//base code adapted from: 
//https://gis.stackexchange.com/questions/344607/combine-checkbox-with-splitpanel-widget-in-google-earth-engine
//https://code.earthengine.google.com/397aa792d5237839ed9fd14fcd107190
// Function to index layer with specific name
// base code adapted from:
// https://gis.stackexchange.com/questions/291199/google-earth-engine-remove-layer-from-the-layer-manager?rq=1
    var indexLayer = function(name) {
    var layers = Map.layers();
    // list of layers names
    var names = [];
    layers.forEach(function(lay) {
      var lay_name = lay.getName();
      names.push(lay_name);
    });
    // get index
    return names.indexOf((function(){
      var i;
      for(i in names)
          if(name.test(names[i]))
              return names[i];
      })());
    };
//--------------------
// Export Map Button
//--------------------
var GDrive_Export = true;
var Export_button = ui.Button({
  label: 'Export', //label: '🗺️',
  style: {backgroundColor: '#ffdb76', position: 'top-right'},
  onClick: function () {
  var export_objects = [];
  export_objects.push({label: 'GDrive Export', value: 'GDrive'});
  export_objects.push({label: 'URL-Download', value: 'URL'});
          Map.add(ui.Select({
          items: export_objects,
          style: {position: 'top-right'},
          onChange: function(value, dropdown) {
          var layers = Map.layers();
          var layer_objects = [];
          if (value==='GDrive') {
            // Export to Google Drive
              layers.forEach(function (layer, index) {
                layer_objects.push({label: layer.getName(), value: layer});
              });
              layer_objects.push({label: 'export all', value: layers});
              Map.add(ui.Select({
                items: layer_objects,
                style: {position: 'top-right'},
                onChange: function(layer, dropdown) {
                  if (layer instanceof ui.Map.Layer) {
                    Export.image.toDrive({
                      image: layer.getEeObject().float().set('visualization', layer.getVisParams()),
                      description: layer.getName().replace(/[^a-z0-9]/gi, '_'),
                      folder: 'Watermask_Export',
                      crs: 'EPSG:3857', //WGS 84: Pseudo-Mercator -- Spherical Mercator, Google Maps, OpenStreetMap, Bing, ArcGIS, ESRI
                      scale: 5, // meters
                      region: Map.getBounds(true),
                      maxPixels: 1e11 // increase pixel limit to 1e11 pixels, allowing bigger files
                    });
                  }
                  else if (layer instanceof ui.data.ActiveList) {
                    layers.forEach(function (layer, index) {
                      Export.image.toDrive({
                        image: layer.getEeObject().float().set('visualization', layer.getVisParams()),
                        description: layer.getName().replace(/[^a-z0-9]/gi, '_'),
                        folder: 'Watermask_Export' + new Date().toISOString(),
                        crs: 'EPSG:3857', //WGS 84: Pseudo-Mercator -- Spherical Mercator, Google Maps, OpenStreetMap, Bing, ArcGIS, ESRI
                        scale: 5, // meters
                        region: Map.getBounds(true),
                        maxPixels: 1e11 // increase pixel limit to 1e11 pixels, allowing bigger files
                      });
                    });
                  }
                  else throw 'Invalid selection for export!';
                  Map.remove(dropdown);
                }
              }));
          } else if (value==='URL') {
          // Define a function to generate a download URL of each laye 
          //base code adapted from: 
          //https://twitter.com/stephan_buettig/status/1229857859355185153?s=20
          // Hide the button
            Export_button.style().set('shown', false);
            var downloadArgs = {
                    //name: 'Layer_Export',
                    crs: 'EPSG:3857', //WGS 84: Pseudo-Mercator -- Spherical Mercator, Google Maps, OpenStreetMap, Bing, ArcGIS, ESRI
                    scale: 5,
                    region: ee.Geometry.Rectangle(Map.getBounds()).toGeoJSONString()
                   };
            var URL_Labels = ui.Panel();
            // List download url for each layer
              layers.forEach(function (layer, index) {
                var url = Map.layers().get(index).getEeObject(index).getDownloadURL(downloadArgs);
                var label = ui.Label(layer.getName()).setUrl(url);
                URL_Labels.add(label);
            });
           // show panel with download-urls
              var Export_panel = ui.Panel({
                widgets: [ui.Panel([
                           ui.Label('Download layer as a zipped file',{fontWeight: 'bold'}),
                            ui.Button({
                             label: '❌',
                             style: {position: 'top-right',
                                     padding: '0px', margin: '0px',
                              },
                              onClick: function () {
                                Export_button.style().set('shown', true);
                                Map.remove(Export_panel);
                                },
                              }),
                            ],
                            ui.Panel.Layout.Flow('horizontal'), {stretch: 'horizontal'}),
                          URL_Labels],
                style: {position:'bottom-right'},
              });
           Map.add(Export_panel);
          }
          else throw 'Invalid selection for export!';
          Map.remove(dropdown);
        }}));
}});
Map.add(Export_button);
//--------------------
//Time-laps animation
//--------------------
// Create a button to show time-lapse animation and hide the button
var Timelapse_button = ui.Button({
  label: 'Time-lapse', //label: '🎞️️️',
  style: {backgroundColor: 'green', position: 'top-left'},
  onClick: function() {
    // Hide the button
    Timelapse_button.style().set('shown', false);
    print(s1);
    // Create time-lapse animation
    // Display parameters for time lapse
    var Timelapse = {
      bands: ['VV'],  //band combination
      //crs: 'EPSG:4326',       //set coordinate reference system
      //dimensions: '600',      //set image size of GIF
      region: AOI_subset,       //area of investigation
      min: -20,                 //Colour stretching from -20dB to 0 dB
      max: 0,
      framesPerSecond: 5};      //Display speed in frames per second
    //Generate time lapse in thumbnail window
    var TimelapseAnimation = ui.Thumbnail({
    image: s1,
    params: Timelapse,
    style: {
    position: 'bottom-left',
    width: '366px',
    }});
    // show panel with animation
    var timelapse_panel = ui.Panel({
      widgets: [ui.Panel([
                 ui.Label('Time-lapse animation ('+ startDate.toLocaleDateString('de-DE', {year: 'numeric', month: '2-digit', day: '2-digit'})+' – '+ endDate.toLocaleDateString('de-DE', {year: 'numeric', month: '2-digit', day: '2-digit'}) + ')',{fontWeight: 'bold'}),
                  ui.Button({
                   label: '❌',
                   style: {position: 'top-right',
                           padding: '0px', margin: '0px',
                    },
                    onClick: function () {
                      Timelapse_button.style().set('shown', true);
                      Map.remove(timelapse_panel);
                      },
                    }),
                  ],
                  ui.Panel.Layout.Flow('horizontal'), {stretch: 'horizontal'}),
                TimelapseAnimation],
      style: {position:'bottom-left'},
    });
    // Add time-laps animation to the map
    Map.add(timelapse_panel);
  }
});
Map.add(Timelapse_button);
//--------------------
// Point inspector
//--------------------
// separate ascending and descending columns
// function asc_des_columns (image) {
//  var band_names = image.bandNames().remove('angle');
//  var new_names = band_names.map(function(name) {
//    return ee.String(name).cat('_').cat(ee.String(image.get('orbitProperties_pass')).toLowerCase().slice(0,4));
//  });
//  return image.select(band_names, new_names)
// }
// var Sen1_asc_des = s1.map(asc_des_columns);
// Choose right band (s1_band) of images
 var Sen1_asc_des = s1.map(function(image) {
    return image.select(s1_band);
  });
// chart options
var vAxis_dB = {title: 'σ-0 [dB]',
                minValue: -40.0,
                maxValue: 0.0,
                gridlines: {count: 7}};
var options = {
  title: 'SAR backscatter time series',
  vAxis: vAxis_dB,
  hAxis: {title: 'acquisition start dates (UTC)'},
  lineWidth: 0,
  pointSize: 2,
  colors: ['#0000aa', '#aa0000','#9999ff', '#ff9999'],
};
// function to compute time series chart
function show_InspectorChart (coords, map) {
   if (Map.style().get('cursor')==='crosshair' && indexLayer(/^Clicked\spoint$/) === -1) {
    // get point from coordinates
    var coord_array = Object.keys(coords).map(function (key) {return coords[key];});
    var point = ee.Geometry.Point(coord_array);
    //Add a red dot to the map where the user clicked.
    Map.addLayer(point, {color: 'FF0000'}, 'Clicked point');
    // create chart
    options.title = 'SAR backscatter time series at ' + String((Math.round(coords.lat * 10000)/10000).toFixed(4)) + ' (lat), ' + String((Math.round(coords.lon * 10000)/10000).toFixed(4)) + ' (lon)';
    var InspectorChart = ui.Chart.image.series(Sen1_asc_des, point)
                .setOptions(options);
    InspectorChart.style().set({width: '750px', height: '280px', position: 'bottom-left',
                       padding: '0px', margin: '0px',
    });
    //Create callback function that adds image to the map coresponding with clicked data point on chart
    InspectorChart.onClick(ChartCallback);
    // figure out if click is on bottom or top half of the map
    var center_coords = Map.getCenter();
    var y_center = center_coords.coordinates().get(1);
    var position = (coords.lat > y_center.getInfo()) ? 'bottom-center' : 'top-center';
    // show chart
    var InspectorChart_panel = ui.Panel({
      widgets: [InspectorChart,
                ui.Button({
                  label: '❌',
                  style: {position: 'top-right',
                          padding: '0px', margin: '0px',
                  },
                  onClick: function () {
                    Map.remove(InspectorChart_panel); 
                    Map.style().set({cursor: 'hand'}),
                    inspector_button.style().set('shown', true);
                    //remove layer of clicked point
                    var index_PointLayer = indexLayer(/^Clicked\spoint$/);
                    if (index_PointLayer !== -1) {Map.remove(Map.layers().get(index_PointLayer))}
                    //remove S1-image and WaterMask-layers if present
                    var index_S1Image = indexLayer(/^S1-Image\s\[\d{2}\.\d{2}\.\d{4}_\d{2}\:\d{2}\:\d{2}\]$/);
                    if (index_S1Image !== -1) {Map.remove(Map.layers().get(index_S1Image))}
                    var index_WaterMask = indexLayer(/^WaterMask\s\[\d{2}\.\d{2}\.\d{4}_\d{2}\:\d{2}\:\d{2}\]$/);
                    if (index_WaterMask !== -1) {Map.remove(Map.layers().get(index_WaterMask))}
                  },
                }),
      ],
      layout: ui.Panel.Layout.absolute(),
      style: {width: '830px', height: '300px', position: position,
              padding: '0px', margin: '0px',
      },
    });
    Map.add(InspectorChart_panel);
}}
// Create a button to activate inspector mode
var inspector_button = ui.Button({
  label: 'Point inspector', //label: '📍️️',
  style: {backgroundColor: 'green', position: 'top-left'},
  onClick: function() {
    // Hide the button.
    inspector_button.style().set('shown', false);
    // Change cursor to crosshair.
    Map.style().set({cursor: 'crosshair'});
  }
});
// Add the button to the map and the panel to root.
Map.add(inspector_button);
// Show chart with click on map when inspector is active
Map.onClick(show_InspectorChart);
//////////////////////////////////////////////////////////////
// Create a button to show chart
//////////////////////////////////////////////////////////////
// Create a button to unhide the side panel.
var chart_button = ui.Button({
  label: 'Water area chart', //label: '📉️️',
  style: {backgroundColor: 'green', position: 'top-left'},
  onClick: function() {
    // Hide the button
    chart_button.style().set('shown', false);
    // Display the chart
// Create and print a time series chart of water pixels as area [ha] within AOI
var AreaChart = ui.Chart.image.series({
  imageCollection: s1.select('waterMask'),
  region: AOI_investigation,
  reducer: ee.Reducer.sum(),
  scale: 100,
})
  .setOptions({
      title: 'Area of the identified water mask',
      vAxis: {'title': 'A_water [ha]'},
      lineWidth: 1.5,
      pointSize: 2,
      gridlines: {count: 7}
    });
    AreaChart.style().set({width: '445px', height: '256px', position: 'bottom-left',
                       padding: '0px', margin: '0px'});
    var AreaChart_panel = ui.Panel({
      widgets: [AreaChart,
                ui.Button({
                  label: '❌',
                  style: {position: 'top-right',
                          padding: '0px', margin: '0px',
                  },
                  onClick: function () {
                    Map.remove(AreaChart_panel); 
                    chart_button.style().set('shown', true);
                    //remove S1-image and WaterMask-layers if present
                    var index_S1Image = indexLayer(/S1-Image\s\[\d{2}\.\d{2}\.\d{4}_\d{2}\:\d{2}\:\d{2}\]$/);
                    if (index_S1Image !== -1) {Map.remove(Map.layers().get(index_S1Image))}
                    var index_WaterMask = indexLayer(/WaterMask\s\[\d{2}\.\d{2}\.\d{4}_\d{2}\:\d{2}\:\d{2}\]$/);
                    if (index_WaterMask !== -1) {Map.remove(Map.layers().get(index_WaterMask))}
                  },
                }),
      ],
      layout: ui.Panel.Layout.absolute(),
      style: {width: '525px', height: '276px', position: 'bottom-right',
              padding: '0px', margin: '0px',
      },
    });
    Map.add(AreaChart_panel);
//Create callback function that adds image to the map coresponding with clicked data point on chart
AreaChart.onClick(ChartCallback);
  }
});
// Add the button to the map and the panel to root.
Map.add(chart_button);
//////////////////////////////////////////////////////////////
// Visualization and Printing
//////////////////////////////////////////////////////////////
// Print
//print('size full collection', s1_sorted.size());
//print('Full collection', s1);
//print('Median of collection', s1_median);
//print('Histogram of the median', ui.Chart.image.histogram(s1_median.select('VV'), AOI_subset, 10));
//print('Median Otsu threshold', s1_median.get('Otsu_threshold'));
//print('Otsu Threshold of collection', s1_mappedCollection.aggregate_array('Otsu_threshold'));
//print('Water area of collection', s1_mappedCollection.aggregate_array('Water_area'));
// Add median of s1-image as background
Map.addLayer(s1_median, visParams, 'S1-Image [median]');
// Add water mask of median
// Map.addLayer(median_water_mask.mask(median_water_mask), {palette: 'blue'}, 'Watermask [median]',0);
// Add water mask of relative occurrence
// Use ee-palettes color scheme (https://github.com/gee-community/ee-palettes)
var palettes = require('users/gena/packages:palettes');
var palette = palettes.crameri.oleron[50].reverse();
Map.addLayer(water_frequency_masked,{
  bands: ['waterMask_sum'],
  //fix color bar
  min: 0,
  max: 100,
  //variable color bar
  // min: p_low,
  // max: p_high,
  // palette: ['orange','yellow','lightblue','darkblue'] //"Yellowstone Grand Prismatic Spring" color scheme
  palette: palette
}, 'WaterMask [rel. occurrence]');
//Add contour lines if option is activated
// base code adapted from:
if (Contours_checkbox.getValue()===true) {
//var levels = ee.List.sequence(50, 90, 10); //repetitive contours
//var levels = [50,75,90]; //fix contour list
var Level_list = Contours_box.getValue().split(',');
var Contour_levels = function(Level_list){return ee.Number.parse(Level_list)};
var Levels = Level_list.map(Contour_levels).sort();
var Levels_min = Number(ee.List(Levels).get(0).getInfo());
var Levels_max = Number(ee.List(Levels.reverse()).get(0).getInfo());
var contours = Levels.map(function(level) {
  var contour = water_frequency_masked.select('waterMask_sum')
    .subtract(ee.Image.constant(level)).zeroCrossing()
    .multiply(ee.Image.constant(level)).toFloat();
  return contour.mask(contour);
});
contours = ee.ImageCollection(contours).mosaic();
Map.addLayer(contours, {min: Levels_min, max: Levels_max, palette: ['red','yellow']}, Contours_box.getValue()+'p_Contour');
//Map.addLayer(contours.focal_max(1.5, 'circle', 'pixels'), {min: Levels_min, max: Levels_max, palette: ['red','yellow']}, Contours_box.getValue()+'p_Contour');
}
//--------------------
//Add color bar
//--------------------
//base code adapted from: 
//https://gis.stackexchange.com/questions/290713/adding-map-key-to-map-or-console-in-google-earth-engine
//https://code.earthengine.google.com/9f890c110e98fa3391480543009c8028
function ColorBar(palette) {
  return ui.Thumbnail({
    image: ee.Image.pixelLonLat().select(0),
    params: {
      bbox: [0, 0, 1, 0.1],
      dimensions: '338x15',
      format: 'png',
      //fix color bar
      min: 0,
      max: 1,
      //variable color bar
      // min: p_low/100),
      // max: p_high/100,
      palette: palette,
    },
    style: {stretch: 'horizontal', margin: '0px 22px'},
  });
}
function makeLegend(lowLine, midLine, highLine,lowText, midText, highText, palette) {
  var  labelheader = ui.Label('Water occurrence during investigation period',{margin: '5px 17px', textAlign: 'center', stretch: 'horizontal', fontWeight: 'bold'});
  var labelLines = ui.Panel(
      [
        ui.Label(lowLine, {margin: '-4px 21px'}),
        ui.Label(midLine, {margin: '-4px 0px', textAlign: 'center', stretch: 'horizontal'}),
        ui.Label(highLine, {margin: '-4px 21px'})
      ],
      ui.Panel.Layout.flow('horizontal'));
      var labelPanel = ui.Panel(
      [
        ui.Label(lowText, {margin: '0px 14.5px'}),
        ui.Label(midText, {margin: '0px 0px', textAlign: 'center', stretch: 'horizontal'}),
        ui.Label(highText, {margin: '0px 1px'})
      ],
      ui.Panel.Layout.flow('horizontal'));
    return ui.Panel({
      widgets: [labelheader, ColorBar(palette), labelLines, labelPanel], 
      style: {position:'bottom-left'}});
}
Map.add(makeLegend('|', '|', '|', "0%", '50%', '100%', palette)); //fix color bar
//Map.add(makeLegend('|', '|', '|', p_low+"%", ((p_low+p_high)/2)+'%', p_high+'%', palette)); //variable color bar
});