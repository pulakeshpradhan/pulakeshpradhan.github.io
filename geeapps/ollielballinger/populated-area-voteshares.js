var oil = ui.import && ui.import("oil", "geometry", {
      "geometries": [
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                -103.65388259673593,
                47.64612929411284
              ],
              [
                -103.43964919829843,
                47.62021736406844
              ],
              [
                -102.95075759673593,
                47.289645106519764
              ],
              [
                -102.49482497954843,
                47.24864353510789
              ],
              [
                -101.98945388579843,
                47.83821577175266
              ],
              [
                -102.11030349517343,
                48.34089863055757
              ],
              [
                -102.93427810454843,
                48.82420874167649
              ],
              [
                -103.53303298736093,
                48.67933820465465
              ],
              [
                -104.07685622954843,
                48.136016138089666
              ],
              [
                -104.29658279204843,
                47.98181562621239
              ],
              [
                -104.04939040923593,
                47.79026059606469
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                -102.68726832672802,
                31.815044157357388
              ],
              [
                -102.13795192047802,
                31.5111370572958
              ],
              [
                -101.79188258454052,
                31.239121188489925
              ],
              [
                -101.29200465485302,
                31.300158706271635
              ],
              [
                -101.23157985016552,
                31.791702009754985
              ],
              [
                -101.54469020172802,
                32.08538142290448
              ],
              [
                -101.19312770172802,
                32.19701210249241
              ],
              [
                -101.25355250641552,
                32.544975237649936
              ],
              [
                -101.81385524079052,
                32.623660391215125
              ],
              [
                -102.34669215485302,
                32.49865760577068
              ],
              [
                -102.39613063141552,
                32.16911724562355
              ],
              [
                -102.62135035797802,
                31.791702009754985
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                -104.47832550640035,
                31.75740264966625
              ],
              [
                -103.93450226421285,
                31.48610330131579
              ],
              [
                -103.83562531108785,
                31.162323200416875
              ],
              [
                -103.34673370952535,
                31.101196658925943
              ],
              [
                -103.49205063016841,
                30.818997427853173
              ],
              [
                -103.26683090360591,
                31.1580537280734
              ],
              [
                -102.77793930204341,
                31.284888600033295
              ],
              [
                -103.04161117704341,
                31.495901234778295
              ],
              [
                -103.10203598173091,
                31.692417770613364
              ],
              [
                -102.79991195829341,
                31.851198487359127
              ],
              [
                -103.07457016141841,
                32.19118709018676
              ],
              [
                -103.49754379423091,
                32.63174219268105
              ],
              [
                -104.03587387235591,
                32.41405216774473
              ],
              [
                -104.37645004423091,
                32.34910648369967
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                -99.73762038841747,
                28.26736286407152
              ],
              [
                -98.40827468529247,
                28.330239452679926
              ],
              [
                -98.33137038841747,
                28.489682159356526
              ],
              [
                -98.07868484154247,
                28.60548952010835
              ],
              [
                -97.90839675560497,
                28.725986593914747
              ],
              [
                -98.00178054466747,
                28.78859026990575
              ],
              [
                -97.80402663841747,
                28.89444934852408
              ],
              [
                -97.71613601341747,
                28.841533272710524
              ],
              [
                -97.47443679466747,
                29.03862880734902
              ],
              [
                -97.19428542747997,
                29.230555077358616
              ],
              [
                -97.20527175560497,
                29.34553857344752
              ],
              [
                -97.03498366966747,
                29.38862399207977
              ],
              [
                -97.1048328623747,
                29.62629708791061
              ],
              [
                -97.3410389170622,
                29.540309863168694
              ],
              [
                -97.3794910654997,
                29.430330802157986
              ],
              [
                -97.6816150889372,
                29.219604097705343
              ],
              [
                -97.9837391123747,
                29.13807051599375
              ],
              [
                -98.2529041514372,
                28.936357334482274
              ],
              [
                -98.3902332529997,
                28.76314716239314
              ],
              [
                -98.6209461436247,
                28.681253323378
              ],
              [
                -99.0439197764372,
                28.681253323378
              ],
              [
                -99.1647693858122,
                28.792035547871812
              ],
              [
                -99.3350574717497,
                28.69089122113204
              ],
              [
                -99.6097156748747,
                28.67161453863955
              ],
              [
                -99.8569080576872,
                28.796849500895657
              ],
              [
                -99.5932361826872,
                28.65715469885434
              ],
              [
                -99.7085926279997,
                28.580001881875965
              ],
              [
                -99.8404285654997,
                28.372373315389968
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        }
      ],
      "displayProperties": [],
      "properties": {},
      "color": "#d63000",
      "mode": "Geometry",
      "shown": false,
      "locked": false
    }) || 
    /* color: #d63000 */
    /* shown: false */
    ee.Geometry.MultiPolygon(
        [[[[-103.65388259673593, 47.64612929411284],
           [-103.43964919829843, 47.62021736406844],
           [-102.95075759673593, 47.289645106519764],
           [-102.49482497954843, 47.24864353510789],
           [-101.98945388579843, 47.83821577175266],
           [-102.11030349517343, 48.34089863055757],
           [-102.93427810454843, 48.82420874167649],
           [-103.53303298736093, 48.67933820465465],
           [-104.07685622954843, 48.136016138089666],
           [-104.29658279204843, 47.98181562621239],
           [-104.04939040923593, 47.79026059606469]]],
         [[[-102.68726832672802, 31.815044157357388],
           [-102.13795192047802, 31.5111370572958],
           [-101.79188258454052, 31.239121188489925],
           [-101.29200465485302, 31.300158706271635],
           [-101.23157985016552, 31.791702009754985],
           [-101.54469020172802, 32.08538142290448],
           [-101.19312770172802, 32.19701210249241],
           [-101.25355250641552, 32.544975237649936],
           [-101.81385524079052, 32.623660391215125],
           [-102.34669215485302, 32.49865760577068],
           [-102.39613063141552, 32.16911724562355],
           [-102.62135035797802, 31.791702009754985]]],
         [[[-104.47832550640035, 31.75740264966625],
           [-103.93450226421285, 31.48610330131579],
           [-103.83562531108785, 31.162323200416875],
           [-103.34673370952535, 31.101196658925943],
           [-103.49205063016841, 30.818997427853173],
           [-103.26683090360591, 31.1580537280734],
           [-102.77793930204341, 31.284888600033295],
           [-103.04161117704341, 31.495901234778295],
           [-103.10203598173091, 31.692417770613364],
           [-102.79991195829341, 31.851198487359127],
           [-103.07457016141841, 32.19118709018676],
           [-103.49754379423091, 32.63174219268105],
           [-104.03587387235591, 32.41405216774473],
           [-104.37645004423091, 32.34910648369967]]],
         [[[-99.73762038841747, 28.26736286407152],
           [-98.40827468529247, 28.330239452679926],
           [-98.33137038841747, 28.489682159356526],
           [-98.07868484154247, 28.60548952010835],
           [-97.90839675560497, 28.725986593914747],
           [-98.00178054466747, 28.78859026990575],
           [-97.80402663841747, 28.89444934852408],
           [-97.71613601341747, 28.841533272710524],
           [-97.47443679466747, 29.03862880734902],
           [-97.19428542747997, 29.230555077358616],
           [-97.20527175560497, 29.34553857344752],
           [-97.03498366966747, 29.38862399207977],
           [-97.1048328623747, 29.62629708791061],
           [-97.3410389170622, 29.540309863168694],
           [-97.3794910654997, 29.430330802157986],
           [-97.6816150889372, 29.219604097705343],
           [-97.9837391123747, 29.13807051599375],
           [-98.2529041514372, 28.936357334482274],
           [-98.3902332529997, 28.76314716239314],
           [-98.6209461436247, 28.681253323378],
           [-99.0439197764372, 28.681253323378],
           [-99.1647693858122, 28.792035547871812],
           [-99.3350574717497, 28.69089122113204],
           [-99.6097156748747, 28.67161453863955],
           [-99.8569080576872, 28.796849500895657],
           [-99.5932361826872, 28.65715469885434],
           [-99.7085926279997, 28.580001881875965],
           [-99.8404285654997, 28.372373315389968]]]]);
Map.setCenter(-82.645, 36.004, 5)
//var baseChange = [{featureType: 'all', stylers: [{invert_lightness: true}]}];
//Map.setOptions('baseChange', {'baseChange': baseChange});
var counties= ee.FeatureCollection("users/ollielballinger/Election_2016_counties")
                .map(function(feature) {
              return feature.set({area: feature.geometry().area()})})
var precincts= ee.FeatureCollection("users/ollielballinger/Election_2016_precincts")
                .map(function(feature) {
              return feature.set({area: feature.geometry().area()})})
var test=precincts//.merge(counties)
var USA = ee.FeatureCollection("FAO/GAUL_SIMPLIFIED_500m/2015/level0").filter(ee.Filter.eq('ADM0_NAME', "United States of America"))
var VIIRS= ee.ImageCollection("NOAA/VIIRS/DNB/MONTHLY_V1/VCMCFG") 
                  .select('avg_rad')
                  .filterDate('2020-02-01','2020-03-01')
                  .mean()
                  .clip(USA)
                  .log10()
                  .divide(2)
var VIIRS=VIIRS.where(VIIRS.lt(0),0)
var outlines = ee.FeatureCollection('TIGER/2018/States')
                //.filter(ee.Filter.eq('STUSPS','NV'))
//Map.addLayer(outlines)
var state_outlines = ee.Image().byte().paint({
  featureCollection: outlines,
  width: 1
});
var county_outlines = ee.Image().byte().paint({
  featureCollection: counties.filter(ee.Filter.eq('county', "Harney County, Oregon")),
  width: 1
});
var precinct_outlines = ee.Image().byte().paint({
  featureCollection: precincts,
  width: 1
});
var VIIRS_vis = {min:0 ,
                max: 1, 
                palette:
                  ['#000004','#320a5a','#781b6c','#bb3654','#ec6824','#fbb41a','#fcffa4']}
var VIIRS_bin=VIIRS.gt(0)
var empty = ee.Image();
//var voteshare = empty.paint({featureCollection: test, color: 'voteshare'})
//var voteshare = ee.FeatureCollection("users/ollielballinger/Election_2016_Voteshares")
var filterInside = ee.Filter.bounds(oil);
var filterNot = filterInside.not();
var voteshare = empty.paint({featureCollection: test, color: 'voteshare'}).clip(outlines)
var voteshare_masked = empty.paint({featureCollection: test.filter(filterNot), color: 'voteshare'}).clip(outlines).updateMask(VIIRS).addBands(VIIRS)
//print(ui.Chart.image.histogram(voteshare, outlines, 200,50)
//  .setOptions({title: 'Pixel Color: Precincts',
//              }));
//print(ui.Chart.image.histogram(voteshare_masked.select('constant'), outlines, 200,50)
//  .setOptions({title: 'Pixel Color: Populated Area Voteshare',
//              }))
var mean_voteshare = voteshare.reduceRegion(ee.Reducer.mean(), outlines, 300);
var mean_PAV = voteshare_masked.reduceRegion(ee.Reducer.mean().splitWeights(), outlines, 300);
//print(mean_voteshare.get('constant'))
//print(mean_PAV.get('mean'))
//Map.addLayer(ee.Image(1), {min:0, max:1, palette:['black','white']}, 'Background')
Map.addLayer(voteshare.clip(outlines), {min:0, max:1, palette:['#007eff','#ff0000']}, 'Precinct Voteshares',false)
Map.addLayer(voteshare_masked.select('constant').clip(outlines), {min:0, max:1, palette:['#007eff','#ff0000']}, 'Populated Area Voteshare')
Map.addLayer(VIIRS, VIIRS_vis, 'Nighttime Lights',false)
Map.addLayer(state_outlines, {}, 'States');
//Map.addLayer(county_outlines.clip(outlines), {}, 'precincts');
var console = ui.Panel({
  layout: ui.Panel.Layout.flow('vertical'),
  style: {
    position: 'top-right',
    padding: '8px 15px',
    width: '350px'
  }
});
var title = ui.Label({
  value: 'Populated Area Voteshares',
  style: {
    fontWeight: 'bold',
    fontSize: '18px',
    margin: '0 0 4px 0',
    padding: '0'
    }
});
var viirsCheck=ui.Checkbox({
  value:false,
  label: 'Nighttime Lights',
  style: {
    fontWeight: 'bold',
    fontSize: '18px',
    margin: '0 0 6px 0',
    padding: '0'
    },
  onChange: function(checked) {
  Map.layers().get(3).setShown(checked)
  }})
var sentinelRGB=ui.Checkbox({
  value:false,
  label: 'Precinct Voteshares',
  style: {
    fontWeight: 'bold',
    fontSize: '18px',
    margin: '0 0 6px 0',
    padding: '0'
    },
  onChange: function(checked) {
  Map.layers().get(0).setShown(checked)
  }})
var sentinelIR=ui.Checkbox({
  value:true,
  label: 'Populated Area Voteshares',
  style: {
    fontWeight: 'bold',
    fontSize: '18px',
    margin: '0 0 6px 0',
    padding: '0'
    },
  onChange: function(checked) {
  Map.layers().get(1).setShown(checked)
  }})
var intro_label= ui.Label("This map adjusts precinct-level results from the 2016 U.S. Presidential Election to match the distributon of populated areas using nighttime lights data. Click on the \"Layers\" tab above to toggle between Nighttime Lights, Precinct Voteshares, and Populated Area Voteshares. A lot of data is being visualized, so please let the map load.", {whiteSpace: 'wrap'})
Map.add(console)
console.add(title)
console.add(intro_label)