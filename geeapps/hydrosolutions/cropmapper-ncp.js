var reservoirs = ui.import && ui.import("reservoirs", "geometry", {
      "geometries": [
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                114.19385073738295,
                36.25534071919825
              ],
              [
                114.19814227180677,
                36.26226170905789
              ],
              [
                114.20672534065443,
                36.280945318553194
              ],
              [
                114.20603869514662,
                36.28288262218757
              ],
              [
                114.20466540413099,
                36.29104644486573
              ],
              [
                114.20294879036146,
                36.29381364855141
              ],
              [
                114.19942980702513,
                36.295889448961866
              ],
              [
                114.1976701858299,
                36.29872574512092
              ],
              [
                114.19112541131074,
                36.29613161982331
              ],
              [
                114.18458102302748,
                36.29810262029837
              ],
              [
                114.17977450447279,
                36.30017784455232
              ],
              [
                114.17642717636045,
                36.30467401754675
              ],
              [
                114.1723930652638,
                36.303083065751416
              ],
              [
                114.1694748218556,
                36.305434832221714
              ],
              [
                114.16792986946302,
                36.30792486059486
              ],
              [
                114.16063438352899,
                36.3098617385039
              ],
              [
                114.16084896763198,
                36.314288196833324
              ],
              [
                114.15780196760329,
                36.309861781117476
              ],
              [
                114.15110705452162,
                36.31013815239795
              ],
              [
                114.14853213386732,
                36.31276635481401
              ],
              [
                114.14784558217355,
                36.31608602746589
              ],
              [
                114.14372561531263,
                36.31885237814667
              ],
              [
                114.14179451786686,
                36.32179150694641
              ],
              [
                114.13745999157936,
                36.32307084799947
              ],
              [
                114.13840411262709,
                36.31982056532177
              ],
              [
                114.12432787971693,
                36.316224380906064
              ],
              [
                114.11986468391615,
                36.308616521032086
              ],
              [
                114.12793276863295,
                36.30446646638171
              ],
              [
                114.13016436653334,
                36.29630404795215
              ],
              [
                114.13926241951185,
                36.29132316965086
              ],
              [
                114.14424059944349,
                36.286895455316476
              ],
              [
                114.14578555183607,
                36.2838512559723
              ],
              [
                114.15471194343763,
                36.278592813780044
              ],
              [
                114.15711520271498,
                36.27430276961156
              ],
              [
                114.16020510750013,
                36.273610804924886
              ],
              [
                114.16320927477682,
                36.27340315986723
              ],
              [
                114.16346667366224,
                36.26669082075735
              ],
              [
                114.16260836677748,
                36.260877560141445
              ],
              [
                114.1592605991807,
                36.259562638877746
              ],
              [
                114.15797350959974,
                36.257555502667955
              ],
              [
                114.16209338264662,
                36.25617127035746
              ],
              [
                114.17067645149427,
                36.259770223348006
              ],
              [
                114.17084811287123,
                36.261569637665694
              ],
              [
                114.17634127693373,
                36.262400122600496
              ],
              [
                114.18166277961927,
                36.25893971045125
              ],
              [
                114.18200610237318,
                36.257001812686994
              ],
              [
                114.17960284309584,
                36.25464858648743
              ],
              [
                114.1804611499806,
                36.25312587294041
              ],
              [
                114.18475268440443,
                36.25658654262596
              ],
              [
                114.18955920295912,
                36.25520229314661
              ],
              [
                114.19161913948255,
                36.25492544030753
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                114.32183392448042,
                36.398727468290375
              ],
              [
                114.32209141654585,
                36.40415050808623
              ],
              [
                114.3182290355644,
                36.40760447626361
              ],
              [
                114.31462414664838,
                36.4073972425029
              ],
              [
                114.31393750114057,
                36.40456499237457
              ],
              [
                114.3127358715019,
                36.403321532876674
              ],
              [
                114.31196339530561,
                36.404979474451885
              ],
              [
                114.31256421012495,
                36.407328164459834
              ],
              [
                114.30913098258588,
                36.410436615593376
              ],
              [
                114.30492527885053,
                36.41085106634732
              ],
              [
                114.30338032645795,
                36.41430473664045
              ],
              [
                114.30020459098432,
                36.41630779505104
              ],
              [
                114.29385312003706,
                36.41547894956013
              ],
              [
                114.29127819938276,
                36.41858707454338
              ],
              [
                114.29170735282514,
                36.42169507513972
              ],
              [
                114.28750164908979,
                36.423214496825985
              ],
              [
                114.28484089774702,
                36.42217853071943
              ],
              [
                114.281236008831,
                36.42345622026209
              ],
              [
                114.27853234214399,
                36.421936803305826
              ],
              [
                114.27733071250532,
                36.4153062723029
              ],
              [
                114.27291043204877,
                36.41461555943497
              ],
              [
                114.26552899283979,
                36.41730930488476
              ],
              [
                114.259263352581,
                36.427461813357915
              ],
              [
                114.25849087638471,
                36.430431343806866
              ],
              [
                114.25497181815717,
                36.43167436933776
              ],
              [
                114.24733288688276,
                36.43119097288539
              ],
              [
                114.24432881278608,
                36.42663308691366
              ],
              [
                114.24385674399946,
                36.422834644191816
              ],
              [
                114.23797734183881,
                36.42096988612659
              ],
              [
                114.23295624656294,
                36.41834533595018
              ],
              [
                114.23746235770795,
                36.41689488858892
              ],
              [
                114.23960812491987,
                36.41862160856679
              ],
              [
                114.24450047416303,
                36.42027922362725
              ],
              [
                114.24810536307905,
                36.420141090390246
              ],
              [
                114.25110943717573,
                36.41917415085153
              ],
              [
                114.25505764884565,
                36.40984947324037
              ],
              [
                114.2548859874687,
                36.40446137150983
              ],
              [
                114.25222523612592,
                36.40294158295008
              ],
              [
                114.25540097159956,
                36.403079746774736
              ],
              [
                114.25711758536909,
                36.40342515526161
              ],
              [
                114.2589200298271,
                36.40342515526161
              ],
              [
                114.26106579703901,
                36.404530452101724
              ],
              [
                114.26690228385542,
                36.404737693508885
              ],
              [
                114.27085049552534,
                36.40045459209864
              ],
              [
                114.27093632621381,
                36.399901916656106
              ],
              [
                114.27617199821088,
                36.39796752165514
              ],
              [
                114.27969105643842,
                36.397829348741276
              ],
              [
                114.28209431571577,
                36.399072896122725
              ],
              [
                114.2841542522392,
                36.39554946019734
              ],
              [
                114.28853161735151,
                36.39361495686709
              ],
              [
                114.28960450095747,
                36.39427131160766
              ],
              [
                114.29509766501997,
                36.391611313377624
              ],
              [
                114.32119019431684,
                36.398243866745936
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                113.82398113080535,
                36.83412252558594
              ],
              [
                113.82535442182098,
                36.83446600827814
              ],
              [
                113.82754310437713,
                36.836629913772114
              ],
              [
                113.8261698133615,
                36.83862202661213
              ],
              [
                113.82715686627898,
                36.83961806357444
              ],
              [
                113.82578357526336,
                36.83954937178661
              ],
              [
                113.8238094694284,
                36.8430182299571
              ],
              [
                113.82020458051238,
                36.84507886327883
              ],
              [
                113.8212345487741,
                36.8472768109477
              ],
              [
                113.82110580274139,
                36.851603835774306
              ],
              [
                113.81956085034881,
                36.85150081421979
              ],
              [
                113.81848796674285,
                36.853526879307495
              ],
              [
                113.81698592969451,
                36.85301178310477
              ],
              [
                113.81582721540008,
                36.851363451931135
              ],
              [
                113.8166426069406,
                36.849715085215315
              ],
              [
                113.81634219953094,
                36.84473542824817
              ],
              [
                113.81578430005584,
                36.843396016889805
              ],
              [
                113.81750091382537,
                36.84020194128002
              ],
              [
                113.82003291913543,
                36.83858768027862
              ],
              [
                113.81977542707,
                36.83762597667796
              ],
              [
                113.81535514661346,
                36.83608035627143
              ],
              [
                113.8174150831369,
                36.83590861874269
              ],
              [
                113.82110580274139,
                36.83604600879654
              ],
              [
                113.82295116254363,
                36.83480948942798
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        }
      ],
      "displayProperties": [],
      "properties": {
        "system:index": "0"
      },
      "color": "#d63000",
      "mode": "Feature",
      "shown": true,
      "locked": false
    }) || /* color: #d63000 */ee.Feature(
        ee.Geometry({
          "type": "GeometryCollection",
          "geometries": [
            {
              "type": "Polygon",
              "coordinates": [
                [
                  [
                    114.19385073738295,
                    36.25534071919825
                  ],
                  [
                    114.19814227180677,
                    36.26226170905789
                  ],
                  [
                    114.20672534065443,
                    36.280945318553194
                  ],
                  [
                    114.20603869514662,
                    36.28288262218757
                  ],
                  [
                    114.20466540413099,
                    36.29104644486573
                  ],
                  [
                    114.20294879036146,
                    36.29381364855141
                  ],
                  [
                    114.19942980702513,
                    36.295889448961866
                  ],
                  [
                    114.1976701858299,
                    36.29872574512092
                  ],
                  [
                    114.19112541131074,
                    36.29613161982331
                  ],
                  [
                    114.18458102302748,
                    36.29810262029837
                  ],
                  [
                    114.17977450447279,
                    36.30017784455232
                  ],
                  [
                    114.17642717636045,
                    36.30467401754675
                  ],
                  [
                    114.1723930652638,
                    36.303083065751416
                  ],
                  [
                    114.1694748218556,
                    36.305434832221714
                  ],
                  [
                    114.16792986946302,
                    36.30792486059486
                  ],
                  [
                    114.16063438352899,
                    36.3098617385039
                  ],
                  [
                    114.16084896763198,
                    36.314288196833324
                  ],
                  [
                    114.15780196760329,
                    36.309861781117476
                  ],
                  [
                    114.15110705452162,
                    36.31013815239795
                  ],
                  [
                    114.14853213386732,
                    36.31276635481401
                  ],
                  [
                    114.14784558217355,
                    36.31608602746589
                  ],
                  [
                    114.14372561531263,
                    36.31885237814667
                  ],
                  [
                    114.14179451786686,
                    36.32179150694641
                  ],
                  [
                    114.13745999157936,
                    36.32307084799947
                  ],
                  [
                    114.13840411262709,
                    36.31982056532177
                  ],
                  [
                    114.12432787971693,
                    36.316224380906064
                  ],
                  [
                    114.11986468391615,
                    36.308616521032086
                  ],
                  [
                    114.12793276863295,
                    36.30446646638171
                  ],
                  [
                    114.13016436653334,
                    36.29630404795215
                  ],
                  [
                    114.13926241951185,
                    36.29132316965086
                  ],
                  [
                    114.14424059944349,
                    36.286895455316476
                  ],
                  [
                    114.14578555183607,
                    36.2838512559723
                  ],
                  [
                    114.15471194343763,
                    36.278592813780044
                  ],
                  [
                    114.15711520271498,
                    36.27430276961156
                  ],
                  [
                    114.16020510750013,
                    36.273610804924886
                  ],
                  [
                    114.16320927477682,
                    36.27340315986723
                  ],
                  [
                    114.16346667366224,
                    36.26669082075735
                  ],
                  [
                    114.16260836677748,
                    36.260877560141445
                  ],
                  [
                    114.1592605991807,
                    36.259562638877746
                  ],
                  [
                    114.15797350959974,
                    36.257555502667955
                  ],
                  [
                    114.16209338264662,
                    36.25617127035746
                  ],
                  [
                    114.17067645149427,
                    36.259770223348006
                  ],
                  [
                    114.17084811287123,
                    36.261569637665694
                  ],
                  [
                    114.17634127693373,
                    36.262400122600496
                  ],
                  [
                    114.18166277961927,
                    36.25893971045125
                  ],
                  [
                    114.18200610237318,
                    36.257001812686994
                  ],
                  [
                    114.17960284309584,
                    36.25464858648743
                  ],
                  [
                    114.1804611499806,
                    36.25312587294041
                  ],
                  [
                    114.18475268440443,
                    36.25658654262596
                  ],
                  [
                    114.18955920295912,
                    36.25520229314661
                  ],
                  [
                    114.19161913948255,
                    36.25492544030753
                  ]
                ]
              ],
              "geodesic": true,
              "evenOdd": true
            },
            {
              "type": "Polygon",
              "coordinates": [
                [
                  [
                    114.32183392448042,
                    36.398727468290375
                  ],
                  [
                    114.32209141654585,
                    36.40415050808623
                  ],
                  [
                    114.3182290355644,
                    36.40760447626361
                  ],
                  [
                    114.31462414664838,
                    36.4073972425029
                  ],
                  [
                    114.31393750114057,
                    36.40456499237457
                  ],
                  [
                    114.3127358715019,
                    36.403321532876674
                  ],
                  [
                    114.31196339530561,
                    36.404979474451885
                  ],
                  [
                    114.31256421012495,
                    36.407328164459834
                  ],
                  [
                    114.30913098258588,
                    36.410436615593376
                  ],
                  [
                    114.30492527885053,
                    36.41085106634732
                  ],
                  [
                    114.30338032645795,
                    36.41430473664045
                  ],
                  [
                    114.30020459098432,
                    36.41630779505104
                  ],
                  [
                    114.29385312003706,
                    36.41547894956013
                  ],
                  [
                    114.29127819938276,
                    36.41858707454338
                  ],
                  [
                    114.29170735282514,
                    36.42169507513972
                  ],
                  [
                    114.28750164908979,
                    36.423214496825985
                  ],
                  [
                    114.28484089774702,
                    36.42217853071943
                  ],
                  [
                    114.281236008831,
                    36.42345622026209
                  ],
                  [
                    114.27853234214399,
                    36.421936803305826
                  ],
                  [
                    114.27733071250532,
                    36.4153062723029
                  ],
                  [
                    114.27291043204877,
                    36.41461555943497
                  ],
                  [
                    114.26552899283979,
                    36.41730930488476
                  ],
                  [
                    114.259263352581,
                    36.427461813357915
                  ],
                  [
                    114.25849087638471,
                    36.430431343806866
                  ],
                  [
                    114.25497181815717,
                    36.43167436933776
                  ],
                  [
                    114.24733288688276,
                    36.43119097288539
                  ],
                  [
                    114.24432881278608,
                    36.42663308691366
                  ],
                  [
                    114.24385674399946,
                    36.422834644191816
                  ],
                  [
                    114.23797734183881,
                    36.42096988612659
                  ],
                  [
                    114.23295624656294,
                    36.41834533595018
                  ],
                  [
                    114.23746235770795,
                    36.41689488858892
                  ],
                  [
                    114.23960812491987,
                    36.41862160856679
                  ],
                  [
                    114.24450047416303,
                    36.42027922362725
                  ],
                  [
                    114.24810536307905,
                    36.420141090390246
                  ],
                  [
                    114.25110943717573,
                    36.41917415085153
                  ],
                  [
                    114.25505764884565,
                    36.40984947324037
                  ],
                  [
                    114.2548859874687,
                    36.40446137150983
                  ],
                  [
                    114.25222523612592,
                    36.40294158295008
                  ],
                  [
                    114.25540097159956,
                    36.403079746774736
                  ],
                  [
                    114.25711758536909,
                    36.40342515526161
                  ],
                  [
                    114.2589200298271,
                    36.40342515526161
                  ],
                  [
                    114.26106579703901,
                    36.404530452101724
                  ],
                  [
                    114.26690228385542,
                    36.404737693508885
                  ],
                  [
                    114.27085049552534,
                    36.40045459209864
                  ],
                  [
                    114.27093632621381,
                    36.399901916656106
                  ],
                  [
                    114.27617199821088,
                    36.39796752165514
                  ],
                  [
                    114.27969105643842,
                    36.397829348741276
                  ],
                  [
                    114.28209431571577,
                    36.399072896122725
                  ],
                  [
                    114.2841542522392,
                    36.39554946019734
                  ],
                  [
                    114.28853161735151,
                    36.39361495686709
                  ],
                  [
                    114.28960450095747,
                    36.39427131160766
                  ],
                  [
                    114.29509766501997,
                    36.391611313377624
                  ],
                  [
                    114.32119019431684,
                    36.398243866745936
                  ]
                ]
              ],
              "evenOdd": true
            },
            {
              "type": "Polygon",
              "coordinates": [
                [
                  [
                    113.82398113080535,
                    36.83412252558594
                  ],
                  [
                    113.82535442182098,
                    36.83446600827814
                  ],
                  [
                    113.82754310437713,
                    36.836629913772114
                  ],
                  [
                    113.8261698133615,
                    36.83862202661213
                  ],
                  [
                    113.82715686627898,
                    36.83961806357444
                  ],
                  [
                    113.82578357526336,
                    36.83954937178661
                  ],
                  [
                    113.8238094694284,
                    36.8430182299571
                  ],
                  [
                    113.82020458051238,
                    36.84507886327883
                  ],
                  [
                    113.8212345487741,
                    36.8472768109477
                  ],
                  [
                    113.82110580274139,
                    36.851603835774306
                  ],
                  [
                    113.81956085034881,
                    36.85150081421979
                  ],
                  [
                    113.81848796674285,
                    36.853526879307495
                  ],
                  [
                    113.81698592969451,
                    36.85301178310477
                  ],
                  [
                    113.81582721540008,
                    36.851363451931135
                  ],
                  [
                    113.8166426069406,
                    36.849715085215315
                  ],
                  [
                    113.81634219953094,
                    36.84473542824817
                  ],
                  [
                    113.81578430005584,
                    36.843396016889805
                  ],
                  [
                    113.81750091382537,
                    36.84020194128002
                  ],
                  [
                    113.82003291913543,
                    36.83858768027862
                  ],
                  [
                    113.81977542707,
                    36.83762597667796
                  ],
                  [
                    113.81535514661346,
                    36.83608035627143
                  ],
                  [
                    113.8174150831369,
                    36.83590861874269
                  ],
                  [
                    113.82110580274139,
                    36.83604600879654
                  ],
                  [
                    113.82295116254363,
                    36.83480948942798
                  ]
                ]
              ],
              "geodesic": true,
              "evenOdd": true
            }
          ],
          "coordinates": []
        }),
        {
          "system:index": "0"
        }),
    CHN_counties = ui.import && ui.import("CHN_counties", "table", {
      "id": "users/hydrosolutions/Handan_counties_UTM_nocitydistricts"
    }) || ee.FeatureCollection("users/hydrosolutions/Handan_counties_UTM_nocitydistricts"),
    townships_Handan = ui.import && ui.import("townships_Handan", "table", {
      "id": "users/hydrosolutions/Townships_Handan"
    }) || ee.FeatureCollection("users/hydrosolutions/Townships_Handan"),
    NCP_counties = ui.import && ui.import("NCP_counties", "table", {
      "id": "users/hydrosolutions/NCP_sel_counties_UTM"
    }) || ee.FeatureCollection("users/hydrosolutions/NCP_sel_counties_UTM"),
    townships_NCP = ui.import && ui.import("townships_NCP", "table", {
      "id": "users/hydrosolutions/Townships_NCP"
    }) || ee.FeatureCollection("users/hydrosolutions/Townships_NCP"),
    geometry = ui.import && ui.import("geometry", "geometry", {
      "geometries": [],
      "displayProperties": [],
      "properties": {},
      "color": "#ffc82d",
      "mode": "Geometry",
      "shown": true,
      "locked": false
    }) || /* color: #ffc82d */ee.Geometry.MultiPoint();
////////USER INPUTS////////
//Pixel resolution of the TIF files to be exported
var export_grid_resolution=10;
//Pixel resolution for area calculations
var area_calc_grid_resolution=100;
//Coordinate reference system of the TIF files to be exported
var crs_selected=ee.String('EPSG:32650');// (replace by e.g. 'EPSG:4326', 'EPSG:32650')
var func = require('users/hydrosolutions/public_functions:greenhouse_functions'); 
//Threshold pixel percentage per object for object classification:
//var obj_th=25;
var year;
var year_ref;
var season_tmp=1; 
var previous_year=0;
var aoi_county;
var aoi_feat_area;
var unit_name_and_area;
var classified_binary;
var final_irrg_map;
var final_wheat_map;
var final_maize_map;
var crop_map_summer;
var maize_map_summer;
var crop_map_summer_ref;
var sensor_data_year; var s2_zero_cloud;
var fallow_OBIA_sieved;
var fallow_wo_OBIA;
var final_wheat_map_this_year; 
var final_irrg_map_this_year;
var final_wheat_map_toexport;
var wheat_fallow_areas;
var layer_fallow;
var layer_wheat; var layer_maize; var layer_green;
var iteration_id=0;
var iteration_id2=0;var iteration_id3=0; 
var townships=townships_Handan.filter(ee.Filter.eq('County', 'Guantao'));
var twn_names=ee.FeatureCollection(townships).aggregate_array('Township');
var newpref=0;
//var twn_names=ee.List(townships_Handan.aggregate_array('Township'));
var twn_no=twn_names.length();
var twn_tmp=townships.map(function(ft){return ee.Feature(null,ee.Dictionary({'Name':ee.Number(ee.Feature(ft).area()).divide(1000).divide(1000)}).rename(['Name'],[ee.Feature(ft).get('Township')]))});
print('Township Areas',ee.List.sequence(0,ee.Number(twn_no).subtract(1)).map(function(x){return ee.Feature(twn_tmp.toList(99).get(ee.Number(x))).toDictionary()}));
//var correct1=0;var correct2=0;var correct3=0;
var total_crop_area;
var total_greenhouse_area;
var runagain=0;
//UI ELEMENTS//
var root_widgets = ui.root.widgets();
var middleMap = ui.Map();
middleMap.setControlVisibility(false);
middleMap.setOptions("HYBRID");
var satelliteMap = ui.Map();
middleMap.setControlVisibility({zoomControl: true});
middleMap.setControlVisibility({scaleControl: true});
middleMap.setControlVisibility({layerList: true});
//middleMap.setControlVisibility({mapTypeControl: true});
satelliteMap.setControlVisibility(false);
satelliteMap.setControlVisibility({layerList: true});
middleMap.setControlVisibility({fullscreenControl: true});
var CC=1;
var first_county = ee.Feature(CHN_counties.toList(66).get(CC));
print('CHN_counties',CHN_counties)
//Map.centerObject(first_county,11); 
var title = ui.Label('Use the slider to see a satellite image of the selected year');
title.style().set('position', 'bottom-center');
middleMap.centerObject(first_county);//13
middleMap.add(title);
satelliteMap.centerObject(first_county);
var d = ee.Image().paint(first_county, 0, 2);
middleMap.addLayer(d,null,'Area of Interest');
satelliteMap.addLayer(d,null,'Area of Interest');
//var dd = ee.Image().paint(CHN_counties, 0, 1);
var dd = ee.Image().paint(NCP_counties, 0, 1);
middleMap.addLayer(dd,null, "NCP Counties");
satelliteMap.addLayer(dd,null, "NCP Counties");
var hydrosolutions = ui.Label({ value : "hydrosolutions.ch:", style : { shown:true ,color:'blue', fontWeight: '600', fontSize: '11px',margin: '4px 1px 2px 1px',height:'12px'}, 
  targetUrl : "https://www.hydrosolutions.ch/projects/cropmapper-ncp"  } );
var manual = ui.Label({ value : " CropMapper Guide", style : { shown:true ,fontFamily:"arial",color:'black', fontWeight: '500', fontSize: '11px',margin: '4px 1px 2px 1px',height:'12px'}, targetUrl : "https://30867c33-1fc0-4c0a-9951-79ede3db345a.filesusr.com/ugd/858ea7_e5d7931312cc45e3a722e479a4d5ec10.pdf"  } );
var hydrosolutions_manual=ui.Panel({widgets: [hydrosolutions,manual],layout: ui.Panel.Layout.flow('horizontal'),style: {position: 'top-center',height: '22px',padding:"2px"}});
//hydrosolutions.style().set('position', 'top-center');
hydrosolutions_manual.style().set('position', 'top-center');
middleMap.add(hydrosolutions_manual);
var Logo_HydroSolutions= ee.Image("projects/ee-hsol/assets/logo_hsol_projected").resample('bicubic').resample('bicubic')
print('Logo_HydroSolutions',Logo_HydroSolutions);
var logo_hsol=ui.Thumbnail({
  image:Logo_HydroSolutions,//,
  params:{bands:['b1','b2','b3'],
  min:0,max:255},
  style:{width:'140px',height:'auto', margin: 'auto'}});
var Logos_PANEL=ui.Panel({
    style: {
    width: '150px',
    height: 'auto',
    padding: '10px',
    position: 'bottom-left'
    },
    widgets:[logo_hsol,
    ]
  });
middleMap.add(Logos_PANEL);
var splitPanel = ui.SplitPanel({
  firstPanel: middleMap,
  secondPanel: satelliteMap,
  wipe: true,
  style: {stretch: 'both'}
});
var continueButton=ui.Button({label: 'Submit',style: {backgroundColor: 'blue',padding: '2px'}});
var continueButton_green = ui.Button({label: 'Submit',style: {backgroundColor: 'blue',padding: '2px'}});
var continueButton_green2 = ui.Button({label: 'Continue',style: {backgroundColor: 'blue',padding: '2px'}});
var continueButton2=ui.Button({label: 'Continue',style: {backgroundColor: 'blue',padding: '2px'}});
var continueButton2b=ui.Button({label: 'Continue',style: {backgroundColor: 'blue',padding: '2px'}});
var continueButton3=ui.Button({label: 'Continue',style: {backgroundColor: 'blue',padding: '2px'}});
//var continueButton4=ui.Button({label: 'Download to Drive',style: {backgroundColor: 'blue',padding: '2px'}});
var correctButton2=ui.Button({label: 'Resubmit',style: {backgroundColor: 'red',padding: '2px'}});
var correctButton2b=ui.Button({label: 'Resubmit',style: {backgroundColor: 'red',padding: '2px'}});
var correctButton3=ui.Button({label: 'Resubmit',style: {backgroundColor: 'red',padding: '2px'}});
var correctButton3b=ui.Button({label: 'Resubmit',style: {backgroundColor: 'red',padding: '2px'}});
var correctButton4=ui.Button({label: 'Resubmit',style: {backgroundColor: 'red',padding: '2px'}});
var correctButton_green=ui.Button({label: 'Resubmit',style: {}});
var correctButton_green2=ui.Button({label: 'Resubmit',style: {backgroundColor: 'red',padding: '2px'}});
var okpanel3=ui.Panel([ui.Label('or', {fontWeight: '450', fontSize: '12px', margin: '15px 1px 1px 5px'}), continueButton3], ui.Panel.Layout.Flow('horizontal'));
var okcontinue_panel3= ui.Panel([correctButton3], ui.Panel.Layout.Flow('horizontal'));
okcontinue_panel3.add(okpanel3);
var okcontinue_panel3b= ui.Panel([correctButton3b], ui.Panel.Layout.Flow('horizontal'));
//var okpanel4=ui.Panel([ui.Label('or', {fontWeight: '450', fontSize: '12px', margin: '15px 1px 1px 5px'}), continueButton4], ui.Panel.Layout.Flow('horizontal'));
var okcontinue_panel4= ui.Panel([correctButton4], ui.Panel.Layout.Flow('horizontal'));
var thisyear_winter;
if (new Date().getMonth()>=4){//starting May
  thisyear_winter=new Date().getFullYear();
} else {
  thisyear_winter=(new Date().getFullYear()) - 1;
}
print('thisyear_winter',thisyear_winter)
var year_list_winter=ee.List.sequence(2016,ee.Number(thisyear_winter)).map(function(nb){
        return {label: ee.String(ee.Number(nb).int()), value: nb};
  });   
var ref_map=1;
var thisyear_summer;
if (new Date().getMonth()>=9){//starting October
  thisyear_summer=new Date().getFullYear();
  ref_map=2;
} else {
  thisyear_summer=(new Date().getFullYear()) - 1;
}  
var year_list_summer=ee.List.sequence(2016,ee.Number(thisyear_summer)).map(function(nb){
        return {label: ee.String(ee.Number(nb).int()), value: nb};
  });   
var thisyear=[thisyear_summer, thisyear_winter];
var list_of_years=[year_list_summer.getInfo(), year_list_winter.getInfo()];
var year_tmp=thisyear_winter;
var refyear_select=ui.Select({
    items: list_of_years[1].slice(0,-1),
    onChange: function(key){
      year_ref=key;//ee.Number(key);
      runagain=1;
    }
}).setValue(2017);//year_tmp - 1
var ref_crop_map=1;
var refmap_select=ui.Select({
    style: {maxWidth: '175px'},
    items: [ 
    {label:  'Winter Wheat Maps', value: 1},
    {label:  'Winter Crop Area Maps', value: 2},
     ],
    onChange: function(key){
      ref_crop_map=key;//ee.Number(key);
    }
}).setValue(1);
var sensor_priority=1;
var sensor_priority_obia=1;
var sensor_priority_select = ui.Select({
  items: [ 
  {label:  'Sentinel-2', value: 1},
  {label:  'Landsat 8', value: 2}   ],
  style: {margin: '5px 1px 1px 2px'},
  onChange: function(key){
    sensor_priority=key;//ee.Number(key);
    sensor_priority_obia=ee.Number(key);
  }
}).setValue(1);
var sensor_priority_summer=1;
var sensor_priority_select_b = ui.Select({
  items: [ 
  {label:  'Sentinel-2', value: 1},
  {label:  'Landsat 8', value: 2}   ],
  style: {margin: '5px 1px 1px 2px'},
  onChange: function(key){
    sensor_priority_summer=key;//ee.Number(key);
    sensor_priority_obia=ee.Number(key);
  }
}).setValue(1);
var sensor_priority_green=0;
var sensor_greenhouse_select = ui.Select({
  items: [ 
  {label:  'Sentinel-2', value: 0},
  {label:  'Landsat 8', value: 1},
  {label:  'Landsat 7/8', value: 3},],
  //style: {margin: '5px 1px 1px 2px'},
  onChange: function(key){
    sensor_priority_green=key;//ee.Number(key);
  }
}).setValue(0);
var wheat_most_common=1;
var most_common_crop_select = ui.Select({
  items: [ 
  {label:  'Yes', value: 1},
  {label:  'No', value: 0}   ],
  style: {margin: '5px 1px 1px 2px'},
  onChange: function(key){
    wheat_most_common=key;//ee.Number(key);
  }
}).setValue(1);
var maize_most_common=1;
var maize_most_common_select = ui.Select({
  items: [ 
  {label:  'Yes', value: 1},
  {label:  'No', value: 0}   ],
  style: {margin: '5px 1px 1px 2px'},
  onChange: function(key){
    maize_most_common=key;//ee.Number(key);
  }
}).setValue(1);
//var province_names=ee.List(ee.FeatureCollection(CHN_counties).aggregate_array('Name'));
//var county_names=ee.Dictionary.fromLists(province_names.distinct(), province_names.distinct()).keys();
//ee.List(CHN_counties.aggregate_array('Name'));
var county_names=ee.List(CHN_counties.aggregate_array('Name'));
var county_names=ee.Dictionary.fromLists(county_names.distinct(), county_names.distinct()).keys().getInfo();
//var ncp_prefecture_names=ee.List(NCP_counties.filter(ee.Filter.eq('NAME_1', 'Hebei')).aggregate_array('NAME_2'));
var ncp_prefecture_names=ee.List(townships_NCP.filter(ee.Filter.eq('Province', 'Hebei')).aggregate_array('Prefecture'));
var ncp_prefecture_names=ee.Dictionary.fromLists(ncp_prefecture_names.distinct(), ncp_prefecture_names.distinct()).keys().getInfo();
print('ncp_prefecture_names',ncp_prefecture_names)
//var ncp_province_names=ee.List(townships_NCP.aggregate_array('Province'));
var ncp_province_names=ee.List(NCP_counties.aggregate_array('NAME_1'));
var ncp_province_names=ee.Dictionary.fromLists(ncp_province_names.distinct(), ncp_province_names.distinct()).keys().getInfo();
var ncp_county_names=ee.List(townships_NCP.filter(ee.Filter.eq('Prefecture', 'Handan')).aggregate_array('County'));
//var ncp_county_names=ee.List(NCP_counties.filter(ee.Filter.eq('NAME_2', 'Handan')).aggregate_array('NAME_3'));
var ncp_county_names=ee.Dictionary.fromLists(ncp_county_names.distinct(), ncp_county_names.distinct()).keys().getInfo();
var county_name="Guantao";
print('county_names',county_names);
function redraw(key){
  // get the selected county
  middleMap.clear();
  middleMap.add(hydrosolutions_manual);
  middleMap.add(Logos_PANEL);
  middleMap.setControlVisibility(false);
  middleMap.setOptions("HYBRID");
  middleMap.add(title);
  middleMap.setControlVisibility({zoomControl: true});
  middleMap.setControlVisibility({scaleControl: true});
  middleMap.setControlVisibility({layerList: true});
  //middleMap.setControlVisibility({mapTypeControl: true});
  middleMap.setControlVisibility({fullscreenControl: true});
  //var selectedCounty = ee.Feature(NCP_counties.filter(ee.Filter.eq('NAME_3', key)).first());
  var selectedCounty = ee.Feature(townships_NCP.filter(ee.Filter.eq('County', key)).union(100).first());
  //var selectedCounty = ee.Feature(CHN_counties.filter(ee.Filter.eq('Name', key)).first());
  if (newpref === 0) {
    middleMap.centerObject(selectedCounty);
    title.setValue('Use the slider to see a satellite image of the selected year.');
    title.style().set({color: 'black',fontWeight: '200'});
  }
  newpref = 0;
  first_county=selectedCounty;
  //county_name=selectedCounty.get('NAME_3');
  county_name=key;
  d = ee.Image().paint(first_county, 0, 2);
  middleMap.layers().set(0,ui.Map.Layer(dd,null, "NCP Counties"));
  middleMap.layers().set(1,ui.Map.Layer(d,{palette: 'yellow'},'Area of Interest'));
  //satelliteMap.layers().set(0,ui.Map.Layer(d,null,'Area of Interest'));
  plotsatelliteimage(year_tmp);
  townships=townships_NCP.filter(ee.Filter.eq('County', key));
  twn_names=ee.FeatureCollection(townships).aggregate_array('Township');
  twn_no=twn_names.length();
  print('N° of Townships',twn_no);
  panel_inputs.remove(panel_greenhouses);
  panel_inputs.remove(panel_greenhouses2);
  panel_inputs.remove(panel_winter);
  panel_inputs.remove(panel_wheat);
  panel_inputs.remove(panel_maize);
  panel_inputs.remove(panel_summer);
  panel_inputs.remove(panel_fallow);
}
var checkbox_irrgmap = ui.Checkbox('Create Cropped Area Map Download Link',false);
var checkbox_irrgmap_panel=ui.Panel([], ui.Panel.Layout.Flow('horizontal')).add(checkbox_irrgmap);
var checkbox_wheatmap = ui.Checkbox('Create Wheat Map Download Link',false);
var checkbox_wheatmap_panel=ui.Panel([], ui.Panel.Layout.Flow('horizontal')).add(checkbox_wheatmap);
var checkbox_maizemap = ui.Checkbox('Create Maize Map Download Link',false);
var checkbox_maizemap_panel=ui.Panel([], ui.Panel.Layout.Flow('horizontal')).add(checkbox_maizemap);
var checkbox_fallowmap = ui.Checkbox('Create Fallow Area Map Download Link',false);
var checkbox_fallowmap_panel=ui.Panel([], ui.Panel.Layout.Flow('horizontal')).add(checkbox_fallowmap);
var checkbox_greenmap = ui.Checkbox('Create Greenhouse Map Download Link',false);
var checkbox_green_panel=ui.Panel([], ui.Panel.Layout.Flow('horizontal')).add(checkbox_greenmap);
checkbox_irrgmap.setValue(false,false);
checkbox_wheatmap.setValue(false,false);
checkbox_fallowmap.setValue(false,false);
checkbox_greenmap.setValue(false,false);
var plz_wait_green=ui.Label('Please wait...', {color: 'red', fontWeight: '450', fontSize: '12px', margin: '7px 1px 1px 10px'});
var slider = ui.Slider({style: {stretch: 'both',width:'80px',fontWeight: '450', fontSize: '12px', margin: '1px 1px 1px 1px'}}).setValue(1);
slider.onSlide(function(value) {
  middleMap.layers().get(3).setShown(true);
  middleMap.layers().get(3).setOpacity(value);
});
var slider2 = ui.Slider({direction: 'horizontal',style: {width:'80px',fontWeight: '450', fontSize: '12px', margin: '1px 0px 1px 1px'}}).setValue(1);
slider2.onSlide(function(value) {
  middleMap.layers().get(2).setShown(true);
  middleMap.layers().get(2).setOpacity(value);
});
var slider3 = ui.Slider({direction: 'horizontal',style: {width:'80px',fontWeight: '450', fontSize: '12px', margin: '1px 0px 1px 1px'}}).setValue(1);
slider3.onSlide(function(value) {
  middleMap.layers().get(1).setShown(true);
  middleMap.layers().get(1).setOpacity(value);
});
var sliderPanel = ui.Panel({style :{position : "top-left",width: "120px"}});//
var wait_for_cropno=ui.Label('Please wait...', {color: 'red', fontWeight: '450', fontSize: '12px', margin: '7px 1px 1px 10px'});
var panel_winter = ui.Panel({
    layout: ui.Panel.Layout.flow('vertical'),
    style: {width: '295px'},
    widgets: [
          ui.Label({style: {backgroundColor: 'black',padding: '1px',width: '260px',height: '2px',margin: '1px 1px 1px 10px'}}),
          ui.Label('Cropped Area January-May', {fontWeight: '450', fontSize: '16px', margin: '15px 1px 1px 10px'}),
          ui.Panel([ui.Label('When compositing the maps from different sensors, give priority to..', {fontWeight: '350', fontSize: '12px', margin: '5px 1px 1px 10px',width: '195px'}), sensor_priority_select], ui.Panel.Layout.Flow('horizontal')),
          ui.Panel([correctButton2,ui.Label('or', {fontWeight: '450', fontSize: '12px', margin: '15px 1px 1px 5px'}), continueButton2], ui.Panel.Layout.Flow('horizontal'))
    ]
});
var panel_summer = ui.Panel({
    layout: ui.Panel.Layout.flow('vertical'),
    style: {width: '295px'},
    widgets: [
          ui.Label({style: {backgroundColor: 'black',padding: '1px',width: '260px',height: '2px',margin: '1px 1px 1px 10px'}}),
          ui.Label('Cropped Area July-September', {fontWeight: '450', fontSize: '16px', margin: '15px 1px 1px 10px'}),
          ui.Panel([ui.Label('When compositing the maps from different sensors, give priority to..', {fontWeight: '350', fontSize: '12px', margin: '5px 1px 1px 10px',width: '195px'}), sensor_priority_select_b], ui.Panel.Layout.Flow('horizontal')),
          ui.Panel([correctButton2b,ui.Label('or', {fontWeight: '450', fontSize: '12px', margin: '15px 1px 1px 5px'}), continueButton2b], ui.Panel.Layout.Flow('horizontal'))
    ]
});
var panel_wheat = ui.Panel({
    layout: ui.Panel.Layout.flow('vertical'),
    style: {width: '295px'},
    widgets: [
      ui.Label({style: {backgroundColor: 'black',padding: '1px',width: '260px',height: '2px',margin: '1px 1px 1px 10px'}}),
      ui.Label('Winter Wheat Area', {fontWeight: '450', fontSize: '16px', margin: '15px 1px 1px 10px'}),
      ui.Panel([ui.Label('Consider wheat as the most common summer harvest crop in this county?', {fontWeight: '350', fontSize: '12px', margin: '5px 1px 1px 10px',width: '200px'}), most_common_crop_select], ui.Panel.Layout.Flow('horizontal')),
      okcontinue_panel3
    ]
});
var panel_maize = ui.Panel({
    layout: ui.Panel.Layout.flow('vertical'),
    style: {width: '295px'},
    widgets: [
      ui.Label({style: {backgroundColor: 'black',padding: '1px',width: '260px',height: '2px',margin: '1px 1px 1px 10px'}}),
      ui.Label('Summer Maize Area', {fontWeight: '450', fontSize: '16px', margin: '15px 1px 1px 10px'}),
      ui.Panel([ui.Label('Consider maize as the most common autumn harvest crop in this county?', {fontWeight: '350', fontSize: '12px', margin: '5px 1px 1px 10px',width: '200px'}), maize_most_common_select], ui.Panel.Layout.Flow('horizontal')),
      okcontinue_panel3b
    ]
});
var panel_greenhouses = ui.Panel({
    layout: ui.Panel.Layout.flow('vertical'),
    style: {width: '295px'},
    widgets: [
          ui.Label({style: {backgroundColor: 'black',padding: '1px',width: '260px',height: '2px',margin: '1px 1px 1px 10px'}}),
          ui.Label('Plastic Greenhouses', {fontWeight: '450', fontSize: '16px', margin: '15px 1px 1px 10px'}),
          ui.Panel([ui.Label('Select a Sensor', {fontWeight: '350', fontSize: '12px', margin: '15px 1px 1px 10px',width: '95px'}), 
            sensor_greenhouse_select.setDisabled(true), correctButton_green], ui.Panel.Layout.Flow('horizontal')),
          //ui.Panel([correctButton_green,ui.Label('or', {fontWeight: '450', fontSize: '12px', margin: '15px 1px 1px 5px'}), continueButton_green2], ui.Panel.Layout.Flow('horizontal'))
    ]
});
var obia_checkbox=ui.Checkbox({label: 'Use Object Based Image Analysis (OBIA) to reduce noise',
  value: true,
  style: {fontSize: '12px', margin: '7px 1px 1px 10px',maxWidth: '280px'}});
var obia_checkbox_fallow=ui.Checkbox({label: 'Use Object Based Image Analysis (OBIA) to post-process the map',
  value: true,
  style: {fontSize: '12px', margin: '7px 1px 1px 10px',maxWidth: '280px'}});
var green_checkbox_summer=ui.Checkbox({label: 'No open-air crop growing in summer',
  value: true,
  style: {fontSize: '12px', margin: '7px 1px 1px 10px',maxWidth: '280px'}});
var green_checkbox_winter=ui.Checkbox({label: 'No open-air crop growing in winter',
  value: false,
  style: {fontSize: '12px', margin: '7px 1px 1px 10px',maxWidth: '280px'}});
var noise_fallow;
var textbox_mu = ui.Textbox({
  style: {width: '60px'},
  onChange: function(text) {
    var area_threshold_in_mu=ee.Number.parse(ee.String(text));
    noise_fallow=area_threshold_in_mu.multiply(666.666).divide(100).ceil();
    print('noise_fallow',noise_fallow);
}
}).setValue('2');
var minfs;
var area_threshold_in_mu2;
var textbox_mu2 = ui.Textbox({
  style: {width: '60px'},
  onChange: function(text) {
    area_threshold_in_mu2=ee.Number.parse(ee.String(text));
  }
}).setValue('2');
var panel_greenhouses2 = ui.Panel({
    layout: ui.Panel.Layout.flow('vertical'),
    style: {width: '295px'},
    widgets: [
          ui.Label({style: {backgroundColor: 'black',padding: '1px',width: '260px',height: '2px',margin: '1px 1px 1px 10px'}}),
          ui.Label('Post-processing', {fontWeight: '450', fontSize: '16px', margin: '15px 1px 1px 10px'}),
          ui.Label('Minimum area per greenhouse [units: mu]', {fontSize: '12px', margin: '7px 1px 1px 10px'}),
          textbox_mu2, 
          obia_checkbox,
          ui.Label('Post-process with crop area maps: ', {fontSize: '12px', margin: '7px 1px 1px 10px'}),
          green_checkbox_summer,
          green_checkbox_winter,
          correctButton_green2
    ]
});
var refyear_checkbox=  ui.Checkbox({label: 'Update Map of Fallow Areas with the Summer Crop Map of the same Year',
      value: false,
      onChange: function(key){if (refyear_checkbox.getValue()===true) {ref_map=2} else {ref_map=1}},
      //onChange: function(key){if (ref_map==1) {ref_map=2} else {ref_map=1}},
      style: {fontSize: '12px', margin: '7px 1px 1px 10px',maxWidth: '280px'}})
//--> value 'false' and setDisabled(true) if 4<month<10 and year_tmp= this year
var panel_fallow = ui.Panel({
  // Create a panel with vertical flow layout.
    layout: ui.Panel.Layout.flow('vertical'),
    style: {width: '295px'},
    widgets: [
      ui.Label({style: {backgroundColor: 'black',padding: '1px',width: '260px',height: '2px',margin: '1px 1px 1px 10px'}}),
      ui.Label('Fallow Area', {fontWeight: '450', fontSize: '16px', margin: '15px 1px 1px 10px'}),
    ui.Panel([ui.Label('Maps to compare:', {width: '100px',fontSize: '12px', margin: '15px 1px 1px 10px'}), refmap_select], ui.Panel.Layout.Flow('horizontal')),
    ui.Panel([ui.Label('Reference Year:', {width: '100px',fontSize: '12px', margin: '15px 1px 1px 10px'}), refyear_select], ui.Panel.Layout.Flow('horizontal')),
      ui.Label('Minimum Area of Fallow Area Plots [units: mu]', {fontSize: '12px', margin: '7px 1px 1px 10px'}),
    textbox_mu,  
    obia_checkbox_fallow,
    //refyear_checkbox,
    okcontinue_panel4
    ]
});
var years_select = ui.Select({
  items: list_of_years[1],
  /*[ 
  {label:  '2016', value: 2016},
  {label:  '2017', value: 2017},
  {label:  '2018', value: 2018},
  {label:  '2019', value: 2019},
  {label:  '2020', value: 2020}
   ],*/
  onChange: function(key){
    year_tmp=key;//ee.Number.parse(key).getInfo();
    panel_inputs.remove(panel_greenhouses);
    panel_inputs.remove(panel_greenhouses2);
    panel_inputs.remove(panel_winter);
    panel_inputs.remove(panel_wheat);
    panel_inputs.remove(panel_maize);
    panel_inputs.remove(panel_summer);
    panel_inputs.remove(panel_fallow);
    if (key===2016){
      okcontinue_panel3.remove(okpanel3);
    } else {
      if (key===thisyear[1]){
        if (thisyear[0]!==thisyear[1]){
           refyear_checkbox.setValue(false);
           //print('ref_map',ref_map);
           //refyear_checkbox.setDisabled(true);
        }
      } else {           
        refyear_checkbox.setValue(true);
        //refyear_checkbox.setDisabled(false);
      }
      okcontinue_panel3.remove(okpanel3); 
      okcontinue_panel3.add(okpanel3);   
      var listofkeys=ee.List.sequence(2016,ee.Number(key).subtract(1)).map(function(nb){
        return {label: ee.String(ee.Number(nb).int()), value: nb};
      });   
      listofkeys.evaluate(function(result){
        refyear_select.items().reset(result);
        refyear_select.setValue(Math.min(2017,key - 1));
      });
    }
  }
}).setValue(year_tmp, false);
var season_select = ui.Select({
  style: {margin: '5px 1px 1px 10px'},
  items: [ 
  {label:  'Winter', value: 1},
  {label:  'Summer', value: 0},
   ],
  onChange: function(key){
    sensor_priority_select_b.setValue(1);
    sensor_priority_select.setValue(1);
    panel_inputs.remove(panel_winter);
    panel_inputs.remove(panel_wheat);
    panel_inputs.remove(panel_maize);
    panel_inputs.remove(panel_summer);
    panel_inputs.remove(panel_fallow);
    season_tmp=key;//ee.Number(key);
    years_select.items().reset(list_of_years[key]);
    var plac=Math.min(year_tmp,thisyear[key]);
    years_select.setValue(plac);
    years_select.setPlaceholder(plac.toString());
  }
}).setValue(1,false);
var season_select_panel = ui.Panel({layout: ui.Panel.Layout.flow('vertical'),widgets: 
    [ui.Label('Select a Season', {fontWeight: '450', fontSize: '12px', margin: '1px 1px 1px 10px'}),
    season_select]});
var product_select = ui.Select({
  items: [ 
  {label:  'Crops', value: 1},
  {label:  'Greenhouses', value: 0},
   ],
  onChange: function(key){
    if (key===1){
      prod_season_panel.add(season_select_panel);
      panel_button.remove(continueButton_green);
      panel_button.add(continueButton);
    } else {
      prod_season_panel.remove(season_select_panel);
      panel_button.add(continueButton_green);
      panel_button.remove(continueButton);
    }
    panel_inputs.remove(panel_greenhouses);
    panel_inputs.remove(panel_greenhouses2);
    panel_inputs.remove(panel_winter);
    panel_inputs.remove(panel_wheat);
    panel_inputs.remove(panel_maize);
    panel_inputs.remove(panel_summer);
    panel_inputs.remove(panel_fallow);
  }
}).setValue(1, false);
var crop_label1=ui.Label('GREEN-HOUSES',{color: 'red',width: '50px',fontWeight: '450', fontSize: '12px', margin: '6px 3px 5px 10px'});
var crop_label2=ui.Label('CROPS',{color: 'red',width: '50px',fontWeight: '450', fontSize: '12px', margin: '13px 1px 5px 3px'});
var slider_switch = ui.Slider({min:0,step: 1,direction:'horizontal', style: {margin: '11px 1px 10px 1px',backgroundColor:'white',height:'18px',width:'52px'}})
  .setValue(1);
var thumbnail_wheat = ui.Thumbnail({
image: ee.Image(1).visualize({min: 1, max: 1, palette: ['yellow']}),
params: {bbox:'0,0,10,100', dimensions:'16x16'},
style: {padding: '0px', margin: '1px 1px 1px 0px'}
});
var thumbnail_crop = ui.Thumbnail({
image: ee.Image(1).visualize({min: 1, max: 1, palette: ['green']}),
params: {bbox:'0,0,10,100', dimensions:'16x16'},
style: {padding: '0px', margin: '1px 1px 1px 0px'}
});
var slider2_panel=ui.Panel([slider2,thumbnail_wheat], ui.Panel.Layout.Flow('horizontal'));
var slider3_panel=ui.Panel([slider3,thumbnail_crop], ui.Panel.Layout.Flow('horizontal'));
slider_switch.onSlide(function(value) {
  var plac;
    if (slider_switch.getValue()===1){
      prod_season_panel.add(season_select_panel);
      panel_button.remove(continueButton_green);
      panel_button.add(continueButton);
      years_select.items().reset(list_of_years[slider_switch.getValue()]);
      plac=Math.min(year_tmp,thisyear[slider_switch.getValue()]);
      years_select.setValue(plac);
      years_select.setPlaceholder(plac.toString());
    } else {
      prod_season_panel.remove(season_select_panel);
      panel_button.add(continueButton_green);
      panel_button.remove(continueButton);
      years_select.items().reset(list_of_years[0]);
      plac=Math.min(year_tmp,thisyear[0]);
      years_select.setValue(plac);
      years_select.setPlaceholder(plac.toString());
      //years_select.items().reset(list_of_years[slider_switch.getValue()])
    }
    panel_inputs.remove(panel_greenhouses);
    panel_inputs.remove(panel_greenhouses2);
    panel_inputs.remove(panel_winter);
    panel_inputs.remove(panel_wheat);
    panel_inputs.remove(panel_maize);
    panel_inputs.remove(panel_summer);
    panel_inputs.remove(panel_fallow);
})
var slider_switch_panel = ui.Panel([/*ui.Panel([ui.Label('CROPS',{textAlign: "center",color: 'red',width: '35px',fontWeight: '450', fontSize: '10px', margin: '7px 1px 1px 1px'}),
  ui.Label('<->',{color: 'red',width: '15px',fontWeight: '450', fontSize: '10px', margin: '7px 1px 1px 1px'}),
  ui.Label(' GREENHOUSES',{color: 'red',width: '80px',fontWeight: '450', fontSize: '10px', margin: '7px 1px 1px 1px'})],ui.Panel.Layout.Flow('horizontal')),*/
  crop_label1, slider_switch, crop_label2], ui.Panel.Layout.Flow('horizontal'));
var product_select_panel = ui.Panel({layout: ui.Panel.Layout.flow('vertical'),widgets: 
    [ui.Label('Select a Product', {fontWeight: '450', fontSize: '12px', margin: '1px 1px 1px 10px'}),
    slider_switch_panel]});
var prod_season_panel =ui.Panel({layout: ui.Panel.Layout.flow('horizontal'),widgets: 
    [product_select_panel, season_select_panel]});
var sel_county=ui.Select({
  //items: county_names,
  items: ncp_county_names,
  onChange: function(key){
    //var selectedCounty = ee.Feature(NCP_counties.filter(ee.Filter.eq('NAME_3', key)).first());
    //middleMap.centerObject(selectedCounty);
    redraw(key);
  },
  style : {margin: '7px 1px 1px 10px'}
}).setPlaceholder('Guantao');
var sel_prefecture=ui.Select({
  items: ncp_prefecture_names,
  onChange: function(key){
    newpref = 1;
    var selectedPrefecture=ee.FeatureCollection(townships_NCP.filter(ee.Filter.eq('Prefecture', ee.String(sel_prefecture.getValue()))).union(1000));
    //var selectedPrefecture = ee.FeatureCollection(NCP_counties.filter(ee.Filter.eq('NAME_2', ee.String(sel_prefecture.getValue()))).union(1000));
    middleMap.centerObject(selectedPrefecture.first());
    var ncp_county_names_list=ee.List(townships_NCP.filter(ee.Filter.eq('Prefecture', key)).aggregate_array('County'));
    //var ncp_county_names_list=ee.List(NCP_counties.filter(ee.Filter.eq('NAME_2', key)).aggregate_array('NAME_3'));
    ncp_county_names=ee.Dictionary.fromLists(ncp_county_names_list.distinct(), ncp_county_names_list.distinct()).keys().getInfo();
    sel_county.items().reset(ncp_county_names);
    sel_county.setValue(ncp_county_names[0]);  
    var counties_of_prefecture=ncp_county_names_list.map(function(key){return ee.Feature(townships_NCP.filter(ee.Filter.eq('County', key)).union(1000).first())})
    //var d1= ee.Image().paint(NCP_counties.filter(ee.Filter.eq('NAME_2', key)),0,1);
    var d1= ee.Image().paint(ee.FeatureCollection(counties_of_prefecture),0,1);
    middleMap.addLayer(d1,{palette: 'red'}, "Prefecture Counties");
    satelliteMap.layers().set(3,ui.Map.Layer(d1,{palette: 'red'}, "Prefecture Counties"));
  }
  ,style : {margin: '7px 1px 1px 10px'}
}).setPlaceholder('Handan');
var sel_province=ui.Select({
  items: ncp_province_names,
  onChange: function(key){
    var ncp_prefecture_names_list=ee.List(townships_NCP.filter(ee.Filter.eq('Province', key)).aggregate_array('Prefecture'));
    //var ncp_prefecture_names_list=ee.List(NCP_counties.filter(ee.Filter.eq('NAME_1', key)).aggregate_array('NAME_2'));
    ncp_prefecture_names=ee.Dictionary.fromLists(ncp_prefecture_names_list.distinct(), ncp_prefecture_names_list.distinct()).keys().getInfo();
    sel_prefecture.items().reset(ncp_prefecture_names);
    sel_prefecture.setValue(ncp_prefecture_names[0]);  
  }
  ,style : {margin: '7px 1px 1px 10px'}
}).setPlaceholder('Hebei');
var panel_inputs = ui.Panel({
  // Create a panel with vertical flow layout.
    layout: ui.Panel.Layout.flow('vertical'),
    style: {width: '300px',border: '1px solid black'},
    widgets: [
      ui.Label('USER INPUT', {fontWeight: '450', fontSize: '16px', margin: '7px 1px 1px 10px'}),
      ui.Label('Use this App to generate high-resolution (10-20 m) maps of main crops (Wheat/Maize), fallow area (Winter season) or greenhouses. Maps can be derived separately for any county in the North China Plain based on unsupervised learning algorithms.', {fontSize: '12px', margin: '7px 1px 1px 10px',maxWidth: '280px'}),
      ui.Panel({layout: ui.Panel.Layout.flow('horizontal'),widgets:[
        ui.Panel({layout: ui.Panel.Layout.flow('vertical'),widgets: 
          [ui.Label('Select a Province', {fontWeight: '450', fontSize: '12px', margin: '7px 1px 1px 10px'}),
          sel_province]}),
        ui.Panel({layout: ui.Panel.Layout.flow('vertical'),widgets: 
          [ui.Label('Select a Prefecture', {fontWeight: '450', fontSize: '12px', margin: '7px 1px 1px 10px'}),
          sel_prefecture]})]}),
      ui.Panel({layout: ui.Panel.Layout.flow('vertical'),widgets: 
        [ui.Label('Select a County', {fontWeight: '450', fontSize: '12px', margin: '7px 1px 1px 10px'}),
        sel_county]}),
      ui.Label('YEAR for which the map will be derived', {fontWeight: '450', fontSize: '12px', margin: '7px 1px 1px 10px'}),
      ui.Panel([years_select]),
      prod_season_panel,
    ]
});
var panel_button = ui.Panel({
    widgets: [
      continueButton
    ]
});
panel_inputs.add(panel_button);
var panel_outputs = ui.Panel({
  // Create a panel with vertical flow layout.
    layout: ui.Panel.Layout.flow('vertical'),
    style: {width: '375px'},
    widgets: [
      ui.Label('OUTPUTS', {fontWeight: '450', fontSize: '16px', margin: '7px 1px 1px 10px'}),
      ]
});
var panel_right = ui.Panel({
  // Create a panel with vertical flow layout.
    layout: ui.Panel.Layout.flow('vertical'),
    style: {width: '380px',border: '1px solid black'},
    widgets: [
      panel_outputs,
      ]
});
ui.root.widgets().reset([splitPanel,panel_inputs,panel_right]);
var linker = ui.Map.Linker([satelliteMap, middleMap]);
panel_outputs.widgets().set(0, ui.Label('OUTPUTS', {fontWeight: '450', fontSize: '16px', margin: '7px 1px 1px 10px'}));
// create vizualization parameters
var viz = {min: -1, max: 1, palette: ["red","white","#0ce9ff"]};
// set position of panel
var legend = ui.Panel({
  style: {
    position: 'top-left',
    padding: '1px 1px',
    maxWidth: '80px'
  }
});
// Create legend title
var legendTitle = ui.Label({
  value: 'Legend',
  style: {
    fontWeight: 'bold',
    fontSize: '12px',
    margin: '0 0 1px 0',
    padding: '0',
    maxWidth: '75px'
    }
});
// Add the title to the panel
legend.add(legendTitle);
// create the legend image
var lon = ee.Image.pixelLonLat().select('latitude');
var gradient = lon.multiply((viz.max-viz.min)/100.0).add(viz.min);
var legendImage = gradient.visualize(viz);
// create text on top of legend
var legend_max = ui.Label('Fallow Area', {fontWeight: '450', fontSize: '10px', margin: '0px 1px 1px 1px'});
legend.add(legend_max);
// create thumbnail from the image
var thumbnail = ui.Thumbnail({
image: legendImage,
params: {bbox:'0,0,10,100', dimensions:'10x30'},
style: {padding: '0px', position: 'bottom-center'}
});
// add the thumbnail to the legend
legend.add(thumbnail);
// create text on top of legend
var legend_min = ui.Label('Fallow only in reference year', {fontWeight: '450', fontSize: '10px', margin: '0px 1px 1px 1px'});
legend.add(legend_min);
var mapoverit=function(feat){
  //return ee.Feature(feat).get('NAME_3');
  return ee.Feature(feat).get('Name');
};
//var names=CHN_counties.toList(61).map(mapoverit);
//print('names',names)
var srtm = ee.Image('USGS/SRTMGL1_003');
//var srtmProjection = srtm.projection();
var slope = ee.Terrain.slope(srtm);
//USER INPUT: SLOPE THRESHOLD (see Ragettli et al. 2019, RSE)
var slope_th=10;
//USER INPUT: MAXIMUM ELEVATION WHERE IRRIGATION IS POSSIBLE IN AOI (I think this is not an issue in Kyzylkum..)
var srtm_th=1000; //m a.s.l.
//Map.addLayer(slope.updateMask(slope.gt(slope_th)).clip(ee.Feature(CHN_counties.toList(61).get(CC))), {min: 0, max: slope_th, palette: palette},'slope',false);
//Map.addLayer(srtm.updateMask(srtm.gt(srtm_th)).clip(ee.Feature(CHN_counties.toList(61).get(CC))), {min: 0, max: srtm_th, palette: palette},'elevation',false);
var monthdays=ee.List([31,28,31,30,31,30,31,31,30,31,30,31])
//print('year_list',year_list)
//visualize classification
var palette =['white', 'green'];
var vizParams_s2 = {bands: ['B4', 'B3', 'B2'], min: 0, max: 3000};
var maskClouds = function(image) {
  //var scored = ee.Algorithms.Landsat.simpleCloudScore(image);
  return image.updateMask(image.select(['cloud']).lt(30));
};
//This function adds a NDVI band to all images
var addNDVI_l8 = function(image) {
  var ndvi = image.normalizedDifference(['B5', 'B4']).rename('NDVI');
  return image.addBands(ndvi.where(image.select('cloud').gte(30),0));
  };
var addLWSI_l8 = function(image) {
  var ndvi = image.normalizedDifference(['B5', 'B6']).rename('LWSI');
  return image.addBands(ndvi);
  };     
var listofmins = function(list){
    var dictT = ee.Dictionary(list);
    return dictT.get('min');
};
var maskClouds_s2=function(image){
  var mask = ee.Image(1).where(image.select('QA60').lt(1024), 0).rename('cloud');
  return image.updateMask(mask.select('cloud').not());
};
var cloudscore_s2 = function(image) {
  var mask = ee.Image(1).where(image.select('QA60').lt(1024),ee.Image(1).where(image.select('B1').gt(0),0)).rename('cloud');
  return image.addBands(mask);
};
var addQualityBands = function(image) {
  var ndvi=image.normalizedDifference(['B8', 'B4']);
  // Opaque and cirrus cloud masks cause bits 10 and 11 in QA60 to be set,
  // so values less than 1024 are cloud-free
  var mask = ee.Image(1).where(image.select('QA60').lt(1024),ee.Image(1).where(image.select('B1').gt(0),0)).rename('cloud');
  var cloudPixels = ee.Number(mask.select("cloud").reduceRegion({'reducer': ee.Reducer.mean(), 
                 'geometry': first_county.geometry(), 'scale': 20,'maxPixels': 1e13,'tileScale':16}).get('cloud'));
  return image
    // NDVI
    .addBands(ndvi.rename('NDVI').where(mask.eq(1),0))
    .addBands(image.normalizedDifference(['B8', 'B11']).rename('LWSI'))
    // time in days
    .addBands(image.metadata('system:time_start')).set({'cloud_cover': cloudPixels.multiply(100)})
    .updateMask(mask.not());
}; 
///SENTINEL2
// Function to mask clouds using the Sentinel-2 QA band.
function maskS2clouds(image) {
  var qa = image.select('QA60');
  // Bits 10 and 11 are clouds and cirrus, respectively.
  var cloudBitMask = ee.Number(2).pow(10).int();
  var cirrusBitMask = ee.Number(2).pow(11).int();
  // Both flags should be set to zero, indicating clear conditions.
  var mask = qa.bitwiseAnd(cloudBitMask).eq(0).and(
             qa.bitwiseAnd(cirrusBitMask).eq(0));
  // Return the masked and scaled data, without the QA bands.
  return image
      .updateMask(mask)
}
// This field contains UNIX time in milliseconds. 
var timeField = 'system:time_start';
var add_time_data=function(image) {
  var date = ee.Date(image.get(timeField)); 
  var years = date.difference(ee.Date('1970-01-01'), 'year'); 
  return image 
    // Add a time band. 
    .addBands(ee.Image(years).rename('t').float()) 
    // Add a constant band. 
    .addBands(ee.Image.constant(1));
};  
var plotsatelliteimage=function(year){  
  satelliteMap.clear();//remove(controlPanel);
  satelliteMap.setControlVisibility(false);
  satelliteMap.setControlVisibility({layerList: true});    
  sensor_data_year=ee.ImageCollection('COPERNICUS/S2').filterBounds(first_county.geometry()).map(add_time_data)
      .filterDate(ee.Date.fromYMD(year,1, 1), ee.Date.fromYMD(year, 10, 31)).map(addQualityBands).map(cloudscore_s2).map(maskS2clouds)
      //.filter(ee.Filter.lte('CLOUDY_PIXEL_PERCENTAGE', 50))
      .filter(ee.Filter.lte('cloud_cover', 70));//pretty high value. maybe 50% is enough.
  print('sensor_data_year',sensor_data_year);
  var image_select;
  if (season_tmp==1){
    image_select=sensor_data_year.select(['B4', 'B3', 'B2','NDVI','LWSI','cloud'])
          .filterDate(ee.Date.fromYMD(year,1, 1), ee.Date.fromYMD(year, 5, 31));
    s2_zero_cloud=sensor_data_year.select(['B4', 'B3', 'B2','NDVI','LWSI','cloud'])
      .filterDate(ee.Date.fromYMD(year,3, 10), ee.Date.fromYMD(year, 5, 31)).sort('cloud_cover').first();
  } else {
    image_select=sensor_data_year.select(['B4', 'B3', 'B2','NDVI','LWSI','cloud'])
          .filterDate(ee.Date.fromYMD(year,6, 1), ee.Date.fromYMD(year, 10, 31));
    s2_zero_cloud=sensor_data_year.select(['B4', 'B3', 'B2','NDVI','LWSI','cloud'])
      .filterDate(ee.Date.fromYMD(year,7, 10), ee.Date.fromYMD(year, 9, 30)).sort('cloud_cover').first();
  }
  var sensor_str="Sentinel-2";
  satelliteMap.layers().set(0, ui.Map.Layer(s2_zero_cloud,{min:500,max:2500},sensor_str + " image"));
  var image_select_and_name=image_select.map(function(img){
    return ee.Image(img).set('Name',ee.String(sensor_str).cat(ee.String(" RGB, DOY ")).cat((ee.String('00').cat(ee.Date(ee.Image(img).get(timeField)).format('D'))).slice(-3)).cat(ee.String(' (')).cat(ee.Date(ee.Image(img).get(timeField)).format('d MMMM YYYY')).cat(ee.String(')')));
  });
  var img_names=ee.ImageCollection(image_select_and_name).aggregate_array('Name');
  var img_list=ee.Dictionary.fromLists(img_names.distinct(), img_names.distinct()).keys();
  print('img_names',img_list);
  print('county_name' ,county_name);
  var county_name0=county_name;
  var iteration_id_tmp0 = iteration_id;
  var year0 = year_tmp;
  var label_part2=ee.String(" RGB, ").cat(ee.Date(s2_zero_cloud.get(timeField)).format('d MMMM YYYY'));
  label_part2.evaluate(function(result){
    if (county_name.localeCompare(county_name0)===0){//in case the user has already moved forward...
      if (iteration_id_tmp0==iteration_id){//in case the user has already moved forward...
        if (year0==year_tmp){//in case the user has already moved forward...
        print('year_tmp',year_tmp);
    var label_leftmap=  ui.Label(sensor_str + result);
    img_list.evaluate(function(result2){
    var img_select = ui.Select({
        items: result2,
        style: {position:'top-right',padding:'1px'},
        onChange: function(key){
            var img1 = ee.Image(image_select_and_name.filter(ee.Filter.eq('Name', key)).mosaic());//.first());//
            satelliteMap.layers().set(0, ui.Map.Layer(img1,{min:500,max:2500},sensor_str + " image"));
        }
    }).setPlaceholder(sensor_str + result);
    satelliteMap.add(img_select);
    });
    }}}
  });
  satelliteMap.layers().set(1,ui.Map.Layer(dd,null,'NCP Counties'));
  satelliteMap.layers().set(2,ui.Map.Layer(d,{palette: 'yellow'},'Area of Interest'));
};
var classify_s2=function(month) {
  //var month=7;
  var x1 = ee.Number(month).subtract(1);
//SENTINEL2 data   
  var s2 = ee.ImageCollection('COPERNICUS/S2').filterBounds(aoi_county.geometry())
      .filterDate(ee.Date.fromYMD(year,ee.Number(month), 1), ee.Date.fromYMD(year, ee.Number(month), monthdays.get(x1)));
  /////////
  var conditional2 = s2.map(addQualityBands).map(cloudscore_s2);
  //thif filter may cause problems with counties that include 2 paths: it would be better to filter 'cloud_cover' per county (mosaic first)
  var collection = conditional2.filter(ee.Filter.lt('CLOUDY_PIXEL_PERCENTAGE', 10));
  var withmask = collection.map(maskClouds_s2);
  var l7_empty=ee.Image(0).rename('NDVI').float().addBands(ee.Image(0).rename('LWSI').float()).addBands(ee.Image(1).rename('cloud')).addBands(ee.Image(9999).rename('QA60'));
  var l7_doif= ee.Algorithms.If(withmask.size().eq(0),ee.ImageCollection.fromImages([l7_empty]),withmask);
  var l7_doif_clouds= ee.Algorithms.If(collection.size().eq(0),ee.ImageCollection.fromImages([l7_empty]),collection);
  var greenest; var greenest_clouds;
  if (season_tmp==1){
    greenest = ee.ImageCollection(l7_doif).sort('cloud_cover').first();
    greenest_clouds = ee.ImageCollection(l7_doif_clouds).sort('cloud_cover').first().select('cloud');
  } else { 
    greenest = ee.ImageCollection(l7_doif).qualityMosaic('NDVI');
    var greenest_clouds0 = ee.ImageCollection(l7_doif_clouds).qualityMosaic('NDVI');
    greenest_clouds =ee.Image(1).where(greenest_clouds0.select('QA60').lt(1024), 0).rename('cloud');
  }
  //var greenest = ee.ImageCollection(l7_doif).min();
  //var greenest_clouds0 = ee.ImageCollection(l7_doif_clouds).min();
  ///////////////
  var image_sample_hv =greenest.select('LWSI').sample({
    region: aoi_county.geometry(),
    numPixels:1000,
    scale: 20,
    tileScale:16
  });
  var clusterer_hv = ee.Clusterer.wekaKMeans(2).train(image_sample_hv);
  var image_sample_NDVI =greenest.select('NDVI').sample({
    region: aoi_county.geometry(),
    numPixels:1000,
    scale: 20,
    tileScale:16
    });
  var clusterer_ndvi = ee.Clusterer.wekaKMeans(2).train(image_sample_NDVI);
    //sample again to create a FC with both NDVI and H-V
  var image_sample =greenest.select('NDVI').addBands(greenest.select('LWSI')).sample({
    region: aoi_county.geometry(),
    numPixels:1000,
    scale: 20,
    tileScale:16
  });
  // Recluster the training data and compute the mean NDVI for each cluster.
  var clusters = image_sample.cluster(clusterer_hv, "cluster");
  var groups = clusters.reduceColumns(ee.Reducer.mean().group(0), ["cluster", "NDVI"]);
  // Extract the cluster IDs and the means.
  groups = ee.List(groups.get("groups"));
  var ids = groups.map(function(d) {return ee.Dictionary(d).get('group')});
  var means = groups.map(function(d) {return ee.Dictionary(d).get('mean')});
  // Sort the IDs using the means as keys.
  var sorted = ee.Array(ids).sort(means).toList();
  var cImage = greenest.select('LWSI').cluster(clusterer_hv);
  // Remap the clustered image to put the clusters in order.
  var ordered_hv = cImage.remap(sorted, ids);
  // Recluster the training data and compute the mean NDVI for each cluster.
  var clusters2 = image_sample_NDVI.cluster(clusterer_ndvi, "cluster");
  var groups2 = clusters2.reduceColumns(ee.Reducer.mean().group(0), ["cluster", "NDVI"]);
  // Extract the cluster IDs and the means.
  groups2 = ee.List(groups2.get("groups"));
  var ids2 = groups2.map(function(d) {return ee.Dictionary(d).get('group')});
  var means2 = groups2.map(function(d) {return ee.Dictionary(d).get('mean')});
  // Sort the IDs using the means as keys.
  var sorted2 = ee.Array(ids2).sort(means2).toList();
  var cImage2 = greenest.select('NDVI').cluster(clusterer_ndvi);
  // Remap the clustered image to put the clusters in order.
  var ordered_ndvi = cImage2.remap(sorted2, ids);
  //print(ordered_ndvi)
//identify the cluster associated to irrg land cover
  var check_sample_size= ee.Algorithms.If(withmask.size().eq(0),0,image_sample.size());
  var clust_non_irrg= 1;//ee.Algorithms.If(ee.Number(check_sample_size).eq(0),0,ee.Algorithms.If(ee.Number(histogram0.get('NDVI_mean')).lt(ee.Number(histogram1.get('NDVI_mean'))),0,1));
  var ordered_hv2=ee.Algorithms.If(ee.Number(check_sample_size).eq(0),ee.Image(0),ordered_hv);
  var ordered_ndvi2=ee.Algorithms.If(ee.Number(check_sample_size).eq(0),ee.Image(0),ordered_ndvi);
  var irrg_map0a=ee.Image(0).where(ee.Image(ordered_hv2).eq(ee.Number(1)),1);
  var irrg_map0b=ee.Image(0).where(ee.Image(ordered_ndvi2).eq(ee.Number(1)),1);
  var irrg_map1=irrg_map0a.where(irrg_map0b.eq(0),0);
  var irrg_map2=irrg_map1.byte().rename(['classification']).where(slope.gt(slope_th),0).where(srtm.gt(srtm_th),0);
  var greenest_doif=ee.Algorithms.If(ee.Number(check_sample_size).eq(0),ee.Image(0).rename('NDVI').float().addBands(ee.Image(100).rename('LWSI').float()),greenest.select(['NDVI','LWSI']));
  var s2_result = irrg_map2.addBands(ee.Image(greenest_doif)).addBands(greenest_clouds).float()
    .clip(aoi_county.geometry());
  return s2_result.select(['classification','cloud','NDVI']);
};
// This function adds a cloud score band to landsat imagery
var cloudscore = function(image) {
  var scored = ee.Algorithms.Landsat.simpleCloudScore(image);
  var image2 = ee.Image(100).clip(aoi_county.geometry()).rename('cloud').where(scored.select('cloud').lte(30),0).where(scored.select('cloud').gt(30),1);
  var cloudPixels = ee.Number(image2.select("cloud").reduceRegion({'reducer': ee.Reducer.mean(), 
                 'geometry': aoi_county.geometry(), 'scale': 30,'maxPixels': 1e13,'tileScale':16}).get('cloud'));
  return image.addBands(ee.Image(100).rename('cloud').where(scored.select(['cloud']).lt(100),scored.select(['cloud']))).set({'cloud_cover': cloudPixels});  
};  
var classify_l8=function(month) {
  var x1 = ee.Number(month).subtract(1);
  var l7 = ee.ImageCollection('LANDSAT/LC08/C01/T1_TOA').filterBounds(aoi_county.geometry())
      .filterDate(ee.Date.fromYMD(year,ee.Number(month), 1), ee.Date.fromYMD(year, ee.Number(month), monthdays.get(x1)));
  var withNDVI = ee.ImageCollection(l7).map(cloudscore).map(addNDVI_l8).map(addLWSI_l8);
  var withscore = withNDVI;
  var withmask = withNDVI.map(maskClouds);
  var l7_empty=ee.Image(0).rename('NDVI').float().addBands(ee.Image(0).rename('LWSI').float()).addBands(ee.Image(1).rename('cloud'));
  var l7_doif= ee.Algorithms.If(withscore.size().eq(0),ee.ImageCollection.fromImages([l7_empty]),withmask);
  var l7_doif_clouds= ee.Algorithms.If(withscore.size().eq(0),ee.ImageCollection.fromImages([l7_empty]),withscore);
  var greenest_clouds0; var greenest;
  if (season_tmp==1){
    greenest = ee.ImageCollection(l7_doif).sort('cloud_cover').first();
    greenest_clouds0 = ee.ImageCollection(l7_doif_clouds).sort('cloud_cover').first().select('cloud');
  } else {
    greenest = ee.ImageCollection(l7_doif).qualityMosaic('NDVI');
    greenest_clouds0 = ee.ImageCollection(l7_doif_clouds).qualityMosaic('NDVI').select('cloud');
  }
  //var greenest = ee.ImageCollection(l7_doif).min();
  //var greenest_clouds0 = ee.ImageCollection(l7_doif_clouds).min().select('cloud');
  var greenest_clouds =ee.Image(100).where(greenest_clouds0.lt(100), greenest_clouds0).rename('cloud');
  //var l7rgb = ee.Image.rgb(greenest.select('B7'), greenest.select('B5'), greenest.select('B4'));//.divide(10000);
  //var l7hsv = l7rgb.rgbToHsv();
  var image_sample_hv =greenest.select('LWSI').sample({
    region:  aoi_county.geometry(),
    numPixels:1000,
    scale: 30,
    tileScale:16
  });
  var clusterer_hv = ee.Clusterer.wekaKMeans(2).train(image_sample_hv);
  var image_sample_NDVI =greenest.select('NDVI').sample({
    region:  aoi_county.geometry(),
    numPixels:1000,
    scale: 30,
    tileScale:16
  });
  var clusterer_ndvi = ee.Clusterer.wekaKMeans(2).train(image_sample_NDVI);
  //sample again to create a FC with both NDVI and H-V
  var image_sample =greenest.select('NDVI').addBands(greenest.select('LWSI')).sample({
    region:  aoi_county.geometry(),
    numPixels:1000,
    scale: 30,
    tileScale:16
  });
  // Recluster the training data and compute the mean NDVI for each cluster.
  var clusters = image_sample.cluster(clusterer_hv, "cluster");
  var groups = clusters.reduceColumns(ee.Reducer.mean().group(0), ["cluster", "NDVI"]);
  // Extract the cluster IDs and the means.
  groups = ee.List(groups.get("groups"));
  var ids = groups.map(function(d) {return ee.Dictionary(d).get('group')});
  var means = groups.map(function(d) {return ee.Dictionary(d).get('mean')});
  // Sort the IDs using the means as keys.
  var sorted = ee.Array(ids).sort(means).toList();
  var cImage = greenest.select('LWSI').cluster(clusterer_hv);
  // Remap the clustered image to put the clusters in order.
  var ordered_hv = cImage.remap(sorted, ids);
  // Recluster the training data and compute the mean NDVI for each cluster.
  var clusters2 = image_sample_NDVI.cluster(clusterer_ndvi, "cluster");
  var groups2 = clusters2.reduceColumns(ee.Reducer.mean().group(0), ["cluster", "NDVI"]);
  // Extract the cluster IDs and the means.
  groups2 = ee.List(groups2.get("groups"));
  var ids2 = groups2.map(function(d) {return ee.Dictionary(d).get('group')});
  var means2 = groups2.map(function(d) {return ee.Dictionary(d).get('mean')});
  // Sort the IDs using the means as keys.
  var sorted2 = ee.Array(ids2).sort(means2).toList();
  var cImage2 = greenest.select('NDVI').cluster(clusterer_ndvi);
  // Remap the clustered image to put the clusters in order.
  var ordered_ndvi = cImage2.remap(sorted2, ids);
  //identify the cluster associated to irrg land cover
  var check_sample_size= ee.Algorithms.If(withscore.size().eq(0),0,image_sample.size());
  var clust_non_irrg= 1;//ee.Algorithms.If(ee.Number(check_sample_size).eq(0),0,ee.Algorithms.If(ee.Number(histogram0.get('NDVI_mean')).lt(ee.Number(histogram1.get('NDVI_mean'))),0,1));
  var ordered_hv2=ee.Algorithms.If(ee.Number(check_sample_size).eq(0),ee.Image(0),ordered_hv);
  var ordered_ndvi2=ee.Algorithms.If(ee.Number(check_sample_size).eq(0),ee.Image(0),ordered_ndvi);
  var irrg_map0a=ee.Image(0).where(ee.Image(ordered_hv2).eq(ee.Number(clust_non_irrg)),1);
  var irrg_map0b=ee.Image(0).where(ee.Image(ordered_ndvi2).eq(ee.Number(clust_non_irrg)),1);
  var irrg_map1=irrg_map0a.where(irrg_map0b.eq(0),0);
  var irrg_map2=irrg_map1.byte().rename(['classification']).where(slope.gt(slope_th),0).where(srtm.gt(srtm_th),0);
  var greenest_doif=ee.Algorithms.If(ee.Number(check_sample_size).eq(0),ee.Image(0).rename('NDVI').float().addBands(ee.Image(0).rename('LWSI').float()).addBands(ee.Image(100).rename('cloud')),greenest);
  var l7_result = irrg_map2.addBands(greenest_clouds.float().where(greenest_clouds.lt(30),0).where(greenest_clouds.gte(30),1)).addBands(ee.Image(greenest_doif).select(['NDVI','LWSI']).float())
    .clip(aoi_county.geometry());
  return l7_result.select(['classification','cloud']);
};
var seeds20=ee.Algorithms.Image.Segmentation.seedGrid(5);
function obia_per_year (img_input){
  var image=ee.Image(img_input);
  var collection; var mosaic_2017_NDVI;
  var collection_s2; var collection_l8
  if (season_tmp==1){
    collection_s2 = sensor_data_year
    .filterDate(ee.Date.fromYMD(year,3, 10), ee.Date.fromYMD(year, 5, 31))
    // Pre-filter to get less cloudy granules.
    //here it would be better to filter cloud cover over county
    .filter(ee.Filter.lt('CLOUDY_PIXEL_PERCENTAGE', 20))
    //.map(maskS2clouds);
    .filter(ee.Filter.calendarRange(3, 5, 'month'));
  } else {
    collection_s2 = sensor_data_year
    // Pre-filter to get less cloudy granules.
    //here it would be better to filter cloud cover over county
    .filter(ee.Filter.lt('CLOUDY_PIXEL_PERCENTAGE', 20))
    //.map(maskS2clouds)
    /*var seasons = ee.List.sequence(1, 12, 3).map(function(month) {
      return collection.filter(ee.Filter.calendarRange(month, ee.Number(month).add(3), 'month')).min();
    });*/
    .filter(ee.Filter.calendarRange(9, 10, 'month'));
  }
  var sensor_data_year_l8 = ee.ImageCollection('LANDSAT/LC08/C01/T1_TOA').filterBounds(aoi_county.geometry())
    .filterDate(ee.Date.fromYMD(year,1, 1), ee.Date.fromYMD(year, 10, 31))
    .map(cloudscore).map(addNDVI_l8).map(addLWSI_l8).map(maskClouds);
  if (season_tmp==1){
    collection_l8 = sensor_data_year_l8
    .filterDate(ee.Date.fromYMD(year,3, 10), ee.Date.fromYMD(year, 4, 30))
    //Landsat cloud masking works better than for Sentinel
    //.filter(ee.Filter.lt('CLOUDY_PIXEL_PERCENTAGE', 20))
    .filter(ee.Filter.calendarRange(3, 4, 'month'));
  } else {
    collection_l8 = sensor_data_year_l8
    //.filter(ee.Filter.lt('CLOUDY_PIXEL_PERCENTAGE', 20))
    .filter(ee.Filter.calendarRange(9, 10, 'month'));
  }
  print('collection_s2.size()',collection_s2.size())
  //collection = ee.ImageCollection(ee.Algorithms.If(collection_s2.size().eq(0),collection_l8,collection_s2));
  collection = ee.ImageCollection(ee.Algorithms.If(sensor_priority_obia.eq(2),collection_l8,collection_s2));
  print('collection',collection);
  //middleMap.layers().set(1,ui.Map.Layer(collection.min(), {bands: ['NDVI'],min: 0, max: 1, palette: palette}, "mosaic"+ year));
  if (step2==1){
    mosaic_2017_NDVI=collection.min().select(['B4','B3','B2','NDVI']);//,['NDVI','LWSI']
  } else {
    mosaic_2017_NDVI=collection.min().select(['B4','NDVI','LWSI']);//,
  }
  var snic = ee.Algorithms.Image.Segmentation.SNIC({
    image: mosaic_2017_NDVI,//.clip(aoi), 
    compactness: 0,
    connectivity: 8,
    seeds: seeds20.reproject(crs_selected, null, 10)//5 or 10?
  });
  var clusters = snic.select('clusters');
  var img=image.reproject(crs_selected, null, 10).rename('b1');//.clip(guantao_county);
  var clust_irrg;  
  if (step2===0){
    //clust_irrg = img.addBands(clusters).reduceConnectedComponents(ee.Reducer.mode(), 'clusters', 256).select('b1');
    var clust_irrg1a = img.where(img.eq(-1),0).addBands(clusters).reduceConnectedComponents(ee.Reducer.mean(), 'clusters', 256).select('b1');
    var clust_irrg1 = clust_irrg1a.where(clust_irrg1a.lte(ee.Number(0.5)),0).rename('b1').round().int8();
    var clust_irrg1b = img.where(img.eq(1),0).addBands(clusters).reduceConnectedComponents(ee.Reducer.mean(), 'clusters', 256).select('b1');
    var clust_irrg2 = clust_irrg1b.where(clust_irrg1b.gte(ee.Number(-0.5)),0).rename('b1').round().int8();
    clust_irrg = clust_irrg1.where(clust_irrg2.eq(-1),-1);
  } else {
    var obj_th;
    if (season_tmp==1){
      obj_th=30;
    } else {
      obj_th=50;
    }
    var clust_irrg0a = img.addBands(clusters).reduceConnectedComponents(ee.Reducer.mean(), 'clusters', 256).select('b1').rename('b1_raw');
    clust_irrg = clust_irrg0a.where(clust_irrg0a.gt(ee.Number(obj_th).divide(ee.Number(100))),1).where(clust_irrg0a.lte(ee.Number(obj_th).divide(ee.Number(100))),0).rename('b1');
  }  
  return clust_irrg;
}
///////////////////////////////
plotsatelliteimage(year_tmp);
var task1_start= function() {
  panel_outputs.clear();
  panel_right.clear();
  continueButton2b.setDisabled(false);
  continueButton2b.style().set({backgroundColor: 'blue',padding: '2px'});  
  continueButton2.setDisabled(false);
  continueButton2.style().set({backgroundColor: 'blue',padding: '2px'});
  continueButton3.setDisabled(false);
  continueButton3.style().set({backgroundColor: 'blue',padding: '2px'});
  panel_right.widgets().set(0,panel_outputs),
  year = year_tmp;
  iteration_id=iteration_id + 1;
  iteration_id2=iteration_id2 + 1;
  iteration_id3=iteration_id3 + 1;  
  //correct1=0;correct2=0;correct3=0;
  previous_year=0;
  middleMap.centerObject(first_county);
  title.setValue('Use the slider to see a satellite image of the selected year.');
  title.style().set({color: 'black',fontWeight: '200'});
  middleMap.clear();
  middleMap.add(hydrosolutions_manual);
  middleMap.add(Logos_PANEL);
  middleMap.setControlVisibility(false);
  middleMap.setOptions("HYBRID");
  middleMap.add(title);
  middleMap.setControlVisibility({zoomControl: true});
  middleMap.setControlVisibility({scaleControl: true});
  middleMap.setControlVisibility({layerList: true});
  //middleMap.setControlVisibility({mapTypeControl: true});
  middleMap.setControlVisibility({fullscreenControl: true});
  middleMap.add(sliderPanel);
  middleMap.layers().set(0,ui.Map.Layer(d,{palette: 'yellow'},'Area of Interest'));
  //middleMap.layers().set(1,ui.Map.Layer(dd,null,'NCP Counties'));
  checkbox_irrgmap.setDisabled(false);
  if (checkbox_irrgmap_panel.widgets().length()>1){
    checkbox_irrgmap_panel.remove(checkbox_irrgmap_panel.widgets().get(1));
  }
  checkbox_greenmap.setDisabled(false);
  if (checkbox_green_panel.widgets().length()>1){
    checkbox_green_panel.remove(checkbox_green_panel.widgets().get(1));
  }
  checkbox_fallowmap.setDisabled(false);
  if (checkbox_fallowmap_panel.widgets().length()>1){
    checkbox_fallowmap_panel.remove(checkbox_fallowmap_panel.widgets().get(1));
  }
  checkbox_wheatmap.setDisabled(false);
  if (checkbox_wheatmap_panel.widgets().length()>1){
    checkbox_wheatmap_panel.remove(checkbox_wheatmap_panel.widgets().get(1));
  }  
  checkbox_maizemap.setDisabled(false);
  if (checkbox_maizemap_panel.widgets().length()>1){
    checkbox_maizemap_panel.remove(checkbox_maizemap_panel.widgets().get(1));
  }    
  panel_inputs.remove(panel_greenhouses);
  panel_inputs.remove(panel_greenhouses2);
  panel_inputs.remove(panel_winter);
  panel_inputs.remove(panel_wheat);
  panel_inputs.remove(panel_fallow);
  panel_inputs.remove(panel_summer);
  panel_inputs.remove(panel_maize);
  panel_outputs.widgets().set(0, ui.Label('OUTPUTS', {fontWeight: '450', fontSize: '16px', margin: '7px 1px 1px 10px'}));
  aoi_feat_area=first_county.geometry().area(100).multiply(1e-6);
  print('aoi_feat_area',aoi_feat_area);
  //Calculate Area of area of interest
  //county_name.evaluate(function(result) {
    var unit_name=ui.Label({value: "Selected County: " + county_name + ", Selected Year: " + year_tmp, style: {fontWeight: '450', fontSize: '12px', margin: '7px 1px 1px 10px' }});
    panel_outputs.widgets().set(1,unit_name );
    panel_outputs.widgets().set(2,wait_for_cropno);
  //});
  aoi_feat_area.evaluate(function(result) {
    var unit_area=ui.Label({value: "Total Area in sq. km: " + result.toFixed(2) , style: {fontWeight: '450', fontSize: '12px', margin: '7px 1px 1px 10px'}});
    panel_outputs.widgets().set(2,unit_area );
    if (previous_year===0){
      panel_outputs.widgets().set(3, ui.Label('Please wait...', {color: 'red', fontWeight: '450', fontSize: '12px', margin: '7px 1px 1px 10px'}));
      panel_outputs.widgets().set(4, ui.Label('', {color: 'red', fontWeight: '450', fontSize: '12px', margin: '7px 1px 1px 10px'}));
    }
  });
  // Load the Sentinel-2 ImageCollection.
    plotsatelliteimage(year);  
};
var sensor_data_year;
var cluster_map_post_2;
var cluster_map_post_3;
var greenhouse_map_before_obia;
var res_sel=ee.Number(ee.Algorithms.If(ee.Number(sensor_priority_green).eq(0),20,30));
var aoi_selected;
continueButton_green.onClick(function(){
  thumbnail_crop.setImage(ee.Image(1).visualize({min: 1, max: 1, palette: ["red"]}));
  thumbnail_wheat.setImage(ee.Image(1).visualize({min: 1, max: 1, palette: ["#0ce9ff"]}));
  task1_start();
  task1_green();
  task2_green();
});
var task1_green= function() {
  panel_inputs.add(panel_greenhouses);
  aoi_selected = first_county.geometry();
  var cc_threshold = 10;
  var scc_threshold = 20;
  var nd_threshold = 90;
  sensor_data_year = func.task1_loadnewdata(year, sensor_priority_green, aoi_selected).filter(ee.Filter.lte('nodata_cover', nd_threshold))
        .filter(ee.Filter.lte('CLOUD_COVER', scc_threshold)).filter(ee.Filter.lte('cloud_cover', cc_threshold));
  //print('sensor_data_year',sensor_data_year)
  var cluster_map1 = ee.Image(1); // no pixels to mask
    //first round: find plastic greenhouse surface from February to mid-May
  var start_date = ee.Date.fromYMD(ee.Number(year), 2, 1);
  var end_date = ee.Date.fromYMD(ee.Number(year), 5, 15);
  var pgi_th = 0;
  var min_pgi_1to12_1 = func.task2_min_pgi(start_date, end_date, cluster_map1, sensor_data_year);
  var harmonic_model = func.task2_harmonic(start_date, end_date, sensor_data_year);
  var cluster_map_1 = func.task2_clustermap(res_sel, pgi_th,harmonic_model,min_pgi_1to12_1,start_date, end_date, ee.List(['PGI']), aoi_selected);
  var index_of_min = func.task2_indexofmin(cluster_map_1, harmonic_model, aoi_selected, res_sel);
  // minfs: zero in first round
  var cluster_map_post = func.task3(cluster_map_1, index_of_min, res_sel);
  // second round: find plastic greenhouse surface from December to September
  start_date = ee.Date.fromYMD(ee.Number(year).subtract(1), 12, 1);
  end_date = ee.Date.fromYMD(ee.Number(year), 9, 30);
  pgi_th = -0.1; //no further masking of pixels with pgi
  var min_pgi_1to12_2 = func.task2_min_pgi(start_date, end_date, cluster_map_post, sensor_data_year);
  var harmonic_model_2 = func.task2_harmonic(start_date, end_date, sensor_data_year);
  var cluster_map_2 = func.task2_clustermap(res_sel, pgi_th,harmonic_model_2,min_pgi_1to12_2,start_date, end_date, ee.List(['PGI', 'RPGI']), aoi_selected);
  var index_of_min_2 = func.task2_indexofmin(cluster_map_2, harmonic_model_2, aoi_selected);
  cluster_map_post_2 = func.task3(cluster_map_2, index_of_min_2, res_sel);
  print('cluster_map_post_2',cluster_map_post_2);
  middleMap.layers().set(1,ui.Map.Layer(cluster_map_post_2.updateMask(cluster_map_post_2.neq(0)).reproject(crs_selected, null, res_sel), {min: 0, max: 1, palette: ["white","red"]}, "Greenhouses").setOpacity(0.5));
    sliderPanel.clear();
    sliderPanel.widgets().set(0,ui.Label('OPACITY SLIDERS', {fontWeight: '450', fontSize: '11px', margin: '1px 1px 4px 1px'}));
    sliderPanel.widgets().set(1,ui.Label('Greenhouse Area', {fontWeight: '450', fontSize: '10px', margin: '1px 1px 1px 1px'}));
    sliderPanel.widgets().set(2,slider3_panel);
    //slider3.setValue(1);
};
/*continueButton_green2.onClick(function(){
  task2_green();
});*/
var greenhouse_map;
var task2_green= ui.util.debounce( function() {
  panel_inputs.remove(panel_greenhouses2);
  panel_inputs.add(panel_greenhouses2);
  checkbox_greenmap.setValue(false,false);
  checkbox_greenmap.setDisabled(false);
  checkbox_green_panel.remove(plz_wait_green);
  var obj_th=30;
  var totalArea = ee.Number(400);
  minfs = area_threshold_in_mu2.multiply(666.666).divide(totalArea).ceil();
  print('noise_greenhouses',minfs);
  cluster_map_post_3 = func.task4(cluster_map_post_2, minfs, res_sel, aoi_selected);
  greenhouse_map_before_obia = cluster_map_post_3;
  //post-process with irrigated area map
  previous_year=1;
  if (green_checkbox_summer.getValue() === true){//post-process with summer crop map
    task1_summer();
    final_irrg_map = crop_map_summer.select('classification');
    greenhouse_map_before_obia = greenhouse_map_before_obia.where(final_irrg_map.eq(1), 0);
  } 
  if (green_checkbox_winter.getValue()===true) {//post-process only with winter crop map
    task1();
    greenhouse_map_before_obia = greenhouse_map_before_obia.where(final_irrg_map.eq(1), 0);
  }  
  //post-process with OBIA
  //var greenhouse_map_obia;
  if (obia_checkbox.getValue() === true){
    greenhouse_map = func.task5(greenhouse_map_before_obia, sensor_data_year, obj_th);
  } else {
    greenhouse_map = greenhouse_map_before_obia.rename('b1');//.reproject(crs_selected, null, 10);
  }
  //calculate areas
  green_area();
  print('greenhouse_map',greenhouse_map);
  middleMap.layers().set(2,ui.Map.Layer(greenhouse_map.updateMask(greenhouse_map.neq(0)).reproject(crs_selected, null, 10), {min: 0, max: 1, palette: ["white","#0ce9ff"]}, "Final Greenhouse Map"));
    slider3.setValue(0.5);
    //previous_layer.setShown(false);
    sliderPanel.clear();
    sliderPanel.widgets().set(0,ui.Label('OPACITY SLIDERS', {fontWeight: '450', fontSize: '11px', margin: '1px 1px 4px 1px'}));
    sliderPanel.widgets().set(1,ui.Label('Greenhouse Area', {fontWeight: '450', fontSize: '10px', margin: '1px 1px 1px 1px'}));
    sliderPanel.widgets().set(2,slider2_panel);
    sliderPanel.widgets().set(3,ui.Label('Before Post-processing', {fontWeight: '450', fontSize: '10px', margin: '1px 1px 1px 1px'}));
    sliderPanel.widgets().set(4,slider3_panel);
    slider2.setValue(1);
    //layer_green=middleMap.layers().get(3);
  var cz=middleMap.getZoom();
  if (cz < 13){
    middleMap.setZoom(13);
    title.setValue('To prevent map display failure, please do not zoom out.');
    title.style().set({color: 'red',fontWeight: '500'});
  } 
}, 100);
correctButton_green.onClick(function(){
  //panel_inputs.remove(panel_greenhouses2);
  /*if (sliderPanel.widgets().length()>=5){
    middleMap.remove(layer_wheat);
  } */ 
  task1_start();
  task1_green();
  task2_green();
});
correctButton_green2.onClick(function(){
  iteration_id=iteration_id + 1;
  panel_outputs.widgets().set(4, ui.Label({},{fontWeight: '450', fontSize: '12px'}).setValue( " "));
  task2_green();
});
continueButton.onClick(function(){
  thumbnail_crop.setImage(ee.Image(1).visualize({min: 1, max: 1, palette: ["green"]}));
  thumbnail_wheat.setImage(ee.Image(1).visualize({min: 1, max: 1, palette: ["yellow"]}));
  task1_start();
  if (season_tmp==1){
    panel_inputs.add(panel_winter);
    task1();
  } else {
    panel_inputs.add(panel_summer);
    task1_summer();
  }
});
var task1= function() {
  aoi_county=first_county.difference(reservoirs);
  var s2_list0 = ee.List.sequence(1,4).map(classify_s2);
  //postprocessing2: irrigation duration
  var classified_s2=ee.ImageCollection(s2_list0).sum();
  //var initial_result =s2_list0.slice(0,4);
  //postprocessing2: irrigation duration
  //var classified_s2_1to4=ee.ImageCollection(initial_result).sum().select(['classification','cloud']);
  //var all_years_l8=function(yr){
  //STEP1: PROCESS LANDSAT8 DATA
  var l8_list0 = ee.List.sequence(1,4).map(classify_l8);
    //postprocessing2: irrigation duration
    var classified_l8=ee.ImageCollection(l8_list0).sum().select(['classification','cloud']);
  //middleMap.addLayer(classified_l8, {bands: ['classification'],min: 0, max: 5, palette: palette}, "l8 irrg. area 2019",false);
  //var initial_result_l8 =l8_list0.slice(0,4);
  //postprocessing2: irrigation duration
  //var classified_l8_1to4=ee.ImageCollection(initial_result_l8).sum().select(['classification','cloud']);
  //middleMap.addLayer(classified_l8_1to4, {bands: ['classification'],min: 0, max: 4, palette: palette}, "l8 slice irrg. area 2019",false);
  //PRIORITY TO SENTINEL or LANDSAT
  var l8= classified_l8.select('classification');
  //var l8_slice= classified_l8_1to4.select('classification');
  var s2= classified_s2.select('classification');
  //var s2_slice= classified_s2_1to4.select('classification');
  var s2c= classified_s2.select('cloud');
  var l8c= classified_l8.select('cloud');
  var s2l8b0; var s2l8b;var s2l8a0_slice; var s2l8a_slice; var check_mask; var s2l8; var classified;
  if (sensor_priority == 1){
    //Case 1: At least one of ouf four monthly S2 maps indicate that the pixel is irrigated, or
    s2l8= ee.Image(0).rename('classification').where(s2.gte(1),3)
    //Case 2: at least one of four monthly L8 maps ,
      //      pixel data not available in at least three out of four monthly S2 maps
      .where(s2c.gte(3),l8.where(l8.gte(1),2))
    classified= s2l8.clip(first_county).int8();//.reproject(crs_selected, null, 20)
  } else {
    s2l8= ee.Image(0).rename('classification').where(l8.gte(1),3)
      .where(l8c.gte(3),s2.where(s2.gte(1),2));
    classified= s2l8.clip(first_county).int8();//.reproject(crs_selected, null, 20)
  }
  if (previous_year===0){
    sliderPanel.clear();
    sliderPanel.widgets().set(0,ui.Label('OPACITY SLIDERS', {fontWeight: '450', fontSize: '11px', margin: '1px 1px 4px 1px'}));
    sliderPanel.widgets().set(1,ui.Label('Cropped Area', {fontWeight: '450', fontSize: '10px', margin: '1px 1px 1px 1px'}));
    sliderPanel.widgets().set(2,slider3_panel);
    checkbox_irrgmap.setValue(false,false);
    checkbox_wheatmap.setValue(false,false);
    checkbox_fallowmap.setValue(false,false);
    checkbox_irrgmap.setDisabled(false);
    if (checkbox_irrgmap_panel.widgets().length()>1){
      checkbox_irrgmap_panel.remove(checkbox_irrgmap_panel.widgets().get(1));
    }
    checkbox_fallowmap.setDisabled(false);
    if (checkbox_fallowmap_panel.widgets().length()>1){
      checkbox_fallowmap_panel.remove(checkbox_fallowmap_panel.widgets().get(1));
    }
    checkbox_wheatmap.setDisabled(false);
    if (checkbox_wheatmap_panel.widgets().length()>1){
      checkbox_wheatmap_panel.remove(checkbox_wheatmap_panel.widgets().get(1));
    }  
  //var layers = middleMap.layers();
    //var layers_length_now=layers.length()-1;
    middleMap.layers().set(1,ui.Map.Layer(classified.updateMask(classified.gt(0)).reproject(crs_selected, null, 10), {bands: ['classification'],min: 0, max: 1, palette: palette}, "irrg. area "+ year));
    slider3.setValue(1);
    /*middleMap.layers().set(2,ui.Map.Layer(ee.Image(s2_list0.get(0)).updateMask(ee.Image(s2_list0.get(0)).select('classification').gt(0)), {bands: ['classification'],min: 0, max: 1, palette: palette}, "irrg. Jan "+ year));
    middleMap.layers().set(3,ui.Map.Layer(ee.Image(s2_list0.get(1)).updateMask(ee.Image(s2_list0.get(1)).select('classification').gt(0)), {bands: ['classification'],min: 0, max: 1, palette: palette}, "irrg. Feb "+ year));
    middleMap.layers().set(4,ui.Map.Layer(ee.Image(s2_list0.get(2)).updateMask(ee.Image(s2_list0.get(2)).select('classification').gt(0)), {bands: ['classification'],min: 0, max: 1, palette: palette}, "irrg. Mar "+ year));
    middleMap.layers().set(5,ui.Map.Layer(ee.Image(s2_list0.get(3)).updateMask(ee.Image(s2_list0.get(3)).select('classification').gt(0)), {bands: ['classification'],min: 0, max: 1, palette: palette}, "irrg. Apr "+ year));
    middleMap.layers().set(6,ui.Map.Layer(ee.Image(s2_list0.get(4)).updateMask(ee.Image(s2_list0.get(4)).select('classification').gt(0)), {bands: ['classification'],min: 0, max: 1, palette: palette}, "irrg. Mai "+ year));
    */
  } 
  var img0=classified.select('classification');
  var classified_binary=img0.where(img0.gt(0),1);
  //var irrg_sieved = sieve_images(classified_binary);
  //print('sieved',sieved);
  //middleMap.addLayer(irrg_sieved, {bands: ['classification'],min: 0, max: 1, palette: palette}, "irrg. area sieved 2019",false);
  final_irrg_map=classified_binary;//irrg_sieved;
  if (previous_year===0){
    print('final_irrg_map',final_irrg_map);
    final_irrg_map_this_year=final_irrg_map;
    task1_area();
  }
};
var green_twnshps;
var crop_twnshps;
var wheat_twnshps;
var maize_twnshps;
var summer_twnshps;
var fallow_twnshps;
var area_image;
var task1_area=function() {
  if (season_tmp==1){
    area_image=final_irrg_map.multiply(ee.Image.pixelArea()).multiply(1e-6);    
  } else {
    area_image=crop_map_summer.select('classification').multiply(ee.Image.pixelArea()).multiply(1e-6);
  }
  crop_twnshps = area_image.reduceRegions({
    collection: townships,
    reducer: ee.Reducer.sum(),
    scale: 100,
    tileScale: 8
  }); 
  print('crop_twnshps',crop_twnshps);
  var area = area_image.reduceRegion({
    reducer: ee.Reducer.sum(),
    geometry: first_county.geometry(),
    scale: 100,
    maxPixels: 1e13,
    tileScale: 12,
  }); 
  var areas_values=area.values();//.sort().reverse();
  total_crop_area=ee.Number(areas_values.reduce(ee.Reducer.sum()));
  print('total_crop_area',total_crop_area);
  var iteration_id_tmp0=iteration_id;
  // Request the value from the server.
  total_crop_area.evaluate(function(result) {
    // When the server returns the value, show it.
      if (iteration_id_tmp0==iteration_id){//in case the user has already moved forward...
        if (isNaN(result)){
          panel_outputs.widgets().set(3, ui.Label({},{color: 'red',fontWeight: '600', fontSize: '12px'}).setValue( "Earth Engine Capacity Exceeded or No Data Available"));
          panel_outputs.widgets().set(4, ui.Label({},{fontWeight: '450', fontSize: '12px'}).setValue( "Try clicking on 'Resubmit' "));
        } else {
          var TotalCropAreaLabel = ui.Label({},{fontWeight: '450', fontSize: '12px', margin: '7px 1px 1px 10px'}).setValue( "Total Cropped Area in sq. km:  " + result.toFixed(2));
            panel_outputs.widgets().set(3, TotalCropAreaLabel);
            panel_outputs.widgets().set(4, checkbox_irrgmap_panel);
        }
      }
  });
  var iteration_id_tmp1X=iteration_id+iteration_id2+iteration_id3  
    var cat_strings=function(x) {
    //var ind=ee.Number(x).add(1);
    var ft1=ee.Feature(crop_twnshps.toList(99).get(ee.Number(x)));
    var name_chn=ee.String(ft1.get('乡'));
    var name_eng=ee.String(ft1.get('Township'));
    var crop_tmp=ee.Number(ft1.get('sum'));
    var dict={c: [{v: name_chn},{v: name_eng}, {v: crop_tmp}]};
    return dict;
  };
  var dict_for_table = ee.List.sequence(0,twn_no.subtract(1)).map(cat_strings);  
  panel_right.widgets().set(1,ui.Label('TABLE', {fontWeight: '350', fontSize: '14px', margin: '7px 1px 1px 10px'})),
  panel_right.widgets().set(2, ui.Label('Please wait...', {color: 'red', fontWeight: '450', fontSize: '12px', margin: '7px 1px 1px 10px'}));
  panel_right.widgets().set(3, ui.Label(" "));
  dict_for_table.evaluate(function(result) {  
    var dataTable = {
      cols: [{label: 'Name CHN', type: 'string'},
            {label: 'Township', type: 'string'},
            {label: 'Total Crop Area (km2)', type: 'number'}],
      rows: result};
    var options = {
      height: 400
    };  
    var charttable1 = new ui.Chart(dataTable, 'Table',options);
      if (iteration_id_tmp1X==iteration_id+iteration_id2+iteration_id3){//in case the user has already moved forward...
          panel_right.widgets().set(2, ui.Label("Attention, only approximate area estimates are provided here. For accurate area calculations please contact hs@hydrosolutions.ch",
            {color: 'red', fontWeight: '350', fontSize: '12px', margin: '7px 1px 1px 10px'}));
        }  
          panel_right.widgets().set(3, charttable1);
  });
};
var green_area=function() {
    //post-process with irrigated area map
  /*previous_year=1;
  if (green_checkbox_summer.getValue() === true){//post-process with summer crop map
    task1_summer();
    final_irrg_map = crop_map_summer.select('classification');
    greenhouse_map_before_obia = cluster_map_post_3.where(final_irrg_map.eq(1), 0);
  } else {//post-process only with winter crop map
    task1();
    greenhouse_map_before_obia = cluster_map_post_3.where(final_irrg_map.eq(1), 0);
  } */  
  area_image=greenhouse_map_before_obia.multiply(ee.Image.pixelArea()).multiply(1e-6);    
  green_twnshps = area_image.reduceRegions({
    collection: townships,
    reducer: ee.Reducer.sum(),
    scale: 100,
    tileScale: 8
  }); 
  print('green_twnshps',green_twnshps);
  var area = area_image.reduceRegion({
    reducer: ee.Reducer.sum(),
    geometry: first_county.geometry(),
    scale: 100,
    maxPixels: 1e13,
    tileScale: 12,
  }); 
  var areas_values=area.values();//.sort().reverse();
  total_greenhouse_area=ee.Number(areas_values.reduce(ee.Reducer.sum()));
  print('total_greenhouse_area',total_greenhouse_area);
  var iteration_id_tmp0=iteration_id;
  panel_outputs.widgets().set(3, ui.Label('Please wait...', {color: 'red', fontWeight: '450', fontSize: '12px', margin: '7px 1px 1px 10px'}));
  // Request the value from the server.
  total_greenhouse_area.evaluate(function(result) {
    // When the server returns the value, show it.
      if (iteration_id_tmp0==iteration_id){//in case the user has already moved forward...
        if (isNaN(result)){
          panel_outputs.widgets().set(3, ui.Label({},{color: 'red',fontWeight: '600', fontSize: '12px'}).setValue( "Earth Engine Capacity Exceeded or No Data Available"));
          panel_outputs.widgets().set(4, ui.Label({},{fontWeight: '450', fontSize: '12px'}).setValue( "Try clicking on 'Resubmit' "));
        } else {
          var TotalCropAreaLabel = ui.Label({},{fontWeight: '450', fontSize: '12px', margin: '7px 1px 1px 10px'}).setValue( "Total Greenhouse Area in sq. km:  " + result.toFixed(2));
            panel_outputs.widgets().set(3, TotalCropAreaLabel);
            panel_outputs.widgets().set(4, checkbox_green_panel);
        }
      }
  });
  var iteration_id_tmp1X=iteration_id+iteration_id2+iteration_id3 ; 
    var cat_strings=function(x) {
    //var ind=ee.Number(x).add(1);
    var ft1=ee.Feature(green_twnshps.toList(99).get(ee.Number(x)));
    var name_chn=ee.String(ft1.get('乡'));
    var name_eng=ee.String(ft1.get('Township'));
    var crop_tmp=ee.Number(ft1.get('sum'));
    var dict={c: [{v: name_chn},{v: name_eng}, {v: crop_tmp}]};
    return dict;
  };
  var dict_for_table = ee.List.sequence(0,twn_no.subtract(1)).map(cat_strings);  
  panel_right.widgets().set(1,ui.Label('TABLE', {fontWeight: '350', fontSize: '14px', margin: '7px 1px 1px 10px'})),
  panel_right.widgets().set(2, ui.Label('Please wait...', {color: 'red', fontWeight: '450', fontSize: '12px', margin: '7px 1px 1px 10px'}));
  panel_right.widgets().set(3, ui.Label(" "));
  dict_for_table.evaluate(function(result) {  
    var dataTable = {
      cols: [{label: 'Name CHN', type: 'string'},
            {label: 'Township', type: 'string'},
            {label: 'Greenhouse Area (km2)', type: 'number'}],
      rows: result};
    var options = {
      height: 400
    };  
    var charttable1 = new ui.Chart(dataTable, 'Table',options);
      if (iteration_id_tmp1X==iteration_id+iteration_id2+iteration_id3){//in case the user has already moved forward...
          panel_right.widgets().set(2, ui.Label("Attention, only approximate area estimates are provided here. For accurate area calculations please contact hs@hydrosolutions.ch",
          {color: 'red', fontWeight: '350', fontSize: '12px', margin: '7px 1px 1px 10px'}));
      }  
          panel_right.widgets().set(3, charttable1);
  });
};
/////////////
correctButton2.onClick(function(){
  year=year_tmp;  
  panel_inputs.remove(panel_wheat);
  panel_inputs.remove(panel_fallow);
  continueButton2.setDisabled(false);
  continueButton2.style().set({backgroundColor: 'blue',padding: '2px'});
  continueButton3.setDisabled(false);
  continueButton3.style().set({backgroundColor: 'blue',padding: '2px'});
  //print('sliderPanel.widgets().length()',sliderPanel.widgets().length())
  if (sliderPanel.widgets().length()==7){
    middleMap.remove(layer_fallow);
    middleMap.remove(legend);
  }
  if (sliderPanel.widgets().length()>=5){
    middleMap.remove(layer_wheat);
  }  
  var layers_no=panel_outputs.widgets().length();
  for (var i=3; i<layers_no; i++) {
    panel_outputs.widgets().remove(panel_outputs.widgets().get(i));
  }
  panel_outputs.widgets().set(3, ui.Label('Please wait...', {color: 'red', fontWeight: '450', fontSize: '12px', margin: '7px 1px 1px 10px'}));
  panel_outputs.widgets().set(4, ui.Label('', {color: 'red', fontWeight: '450', fontSize: '12px', margin: '7px 1px 1px 10px'}));
  runagain=1;
  iteration_id=iteration_id + 1;
  iteration_id2=iteration_id2 + 1;
  iteration_id3=iteration_id3 + 1;
  previous_year=0;
  task1();
});
correctButton2b.onClick(function(){
  year=year_tmp;  
  panel_inputs.remove(panel_maize);
  continueButton2b.setDisabled(false);
  continueButton2b.style().set({backgroundColor: 'blue',padding: '2px'});
  if (sliderPanel.widgets().length()>=5){
    middleMap.remove(layer_maize);
  }  
  var layers_no=panel_outputs.widgets().length();
  for (var i=3; i<layers_no; i++) {
    panel_outputs.widgets().remove(panel_outputs.widgets().get(i));
  }
  panel_outputs.widgets().set(3, ui.Label('Please wait...', {color: 'red', fontWeight: '450', fontSize: '12px', margin: '7px 1px 1px 10px'}));
  panel_outputs.widgets().set(4, ui.Label('', {color: 'red', fontWeight: '450', fontSize: '12px', margin: '7px 1px 1px 10px'}));
  runagain=1;
  iteration_id=iteration_id + 1;
  iteration_id2=iteration_id2 + 1;
  iteration_id3=iteration_id3 + 1;
  task1_summer();
});
continueButton2.onClick(function(){
  year=year_tmp;
  previous_year=0;
//correct1=0;
  panel_inputs.remove(panel_wheat);
  panel_inputs.remove(panel_fallow);
  panel_inputs.add(panel_wheat);
  //if (previous_year===0){
    panel_outputs.widgets().set(5, ui.Label('Please wait...', {color: 'red', fontWeight: '450', fontSize: '12px', margin: '7px 1px 1px 10px'}));
    panel_outputs.widgets().set(6, ui.Label('', {color: 'red', fontWeight: '450', fontSize: '12px', margin: '7px 1px 1px 10px'}));
  //}
  iteration_id2=iteration_id;
  task2();
  continueButton2.setDisabled(true);
  continueButton2.style().set({backgroundColor: '#919191',padding: '2px'});  
});
var step2;
continueButton2b.onClick(function(){
  year=year_tmp;
  //panel_inputs.remove(panel_maize);
  panel_inputs.add(panel_maize);
  panel_outputs.widgets().set(5, ui.Label('Please wait...', {color: 'red', fontWeight: '450', fontSize: '12px', margin: '7px 1px 1px 10px'}));
  panel_outputs.widgets().set(6, ui.Label('', {color: 'red', fontWeight: '450', fontSize: '12px', margin: '7px 1px 1px 10px'}));
  iteration_id2=iteration_id;
  task2_summer();
  continueButton2b.setDisabled(true);
  continueButton2b.style().set({backgroundColor: '#919191',padding: '2px'});  
});
var task2 = function() {
  aoi_county=first_county;//ee.Feature(CHN_counties.toList(61).get(x));
  /*var sentinel1 = ee.ImageCollection('COPERNICUS/S1_GRD').filterBounds(aoi_county.geometry())
        .filterDate(ee.Date.fromYMD(year,4, 1), ee.Date.fromYMD(year, 4, monthdays.get(ee.Number(4).subtract(1))));
      var s1b=sentinel1.map(function(img){
          return ee.Image(img).set({'SENSING_TIME': ee.Date(ee.Image(img).get('system:time_start')).format('YYYY-MM-dd')});
      });
      var img_list_s1=s1b.aggregate_array('SENSING_TIME').distinct();
    print('img_list_s1',img_list_s1);
    var sensor_data_mosaic=ee.ImageCollection(img_list_s1.map(function(x){
      var img1=ee.Image(s1b.filter(ee.Filter.eq('SENSING_TIME', x)).first());
      var img1_mosaic = ee.Image(s1b.filter(ee.Filter.eq('SENSING_TIME', x)).mosaic())
        .copyProperties(img1)
      .set('system:time_start',img1.get('system:time_start'));
          var image2 = ee.Image(100).rename('cloud').where(ee.Image(img1_mosaic).select('VV').gt(-99),0);
      var cloudPixels = ee.Number(image2.select("cloud").reduceRegion({'reducer': ee.Reducer.mean(), 
                 'geometry': aoi_county.geometry(), 'scale': 500,'tileScale': 2}).get('cloud'));
      return img1_mosaic
        .set({'nodata_cover': cloudPixels});
    }));
    var s1_mosaic=sensor_data_mosaic.filter(ee.Filter.lte('nodata_cover', 10))
    print('s1_mosaic, just to check',s1_mosaic)*/
  var classify_s1=function(month) {
    //var month=5;
    var x1 = ee.Number(month).subtract(1);
  //SENTINEL1 data   
  //var smoothed = sentinel1.map(func.leeSigma)
    var sentinel1 = ee.ImageCollection('COPERNICUS/S1_GRD').filterBounds(aoi_county.geometry())
        .filterDate(ee.Date.fromYMD(year,ee.Number(month), 1), ee.Date.fromYMD(year, ee.Number(month), monthdays.get(ee.Number(month).subtract(1))));
        //.map(func.leeSigma);
    //NEW ADDITION 8 Nov 2020
    var s1b=sentinel1.map(function(img){
        return ee.Image(img).set({'SENSING_TIME': ee.Date(ee.Image(img).get('system:time_start')).format('YYYY-MM-dd')});
    });
    var img_list_s1=s1b.aggregate_array('SENSING_TIME').distinct();
    var sensor_data_mosaic=ee.ImageCollection(img_list_s1.map(function(x){
      var img1=ee.Image(s1b.filter(ee.Filter.eq('SENSING_TIME', x)).first());
      var img1_mosaic = ee.Image(s1b.filter(ee.Filter.eq('SENSING_TIME', x)).mosaic())
        .copyProperties(img1)
        .set('system:time_start',img1.get('system:time_start'));
      var image2 = ee.Image(100).rename('cloud').where(ee.Image(img1_mosaic).select('VV').gt(-99),0);
      var cloudPixels = ee.Number(image2.select("cloud").reduceRegion({'reducer': ee.Reducer.mean(), 
                 'geometry': aoi_county.geometry(), 'scale': 500,'tileScale': 2}).get('cloud'));
      return img1_mosaic
        .set({'nodata_cover': cloudPixels});
    }));
    sentinel1=sensor_data_mosaic.filter(ee.Filter.lte('nodata_cover', 10));
    ////////////
    var vh = sentinel1
      .filter(ee.Filter.listContains('transmitterReceiverPolarisation', 'VV'))
      .filter(ee.Filter.listContains('transmitterReceiverPolarisation', 'VH'));
    var vhAscending = vh.filter(ee.Filter.eq('orbitProperties_pass', 'ASCENDING'));
    var reduceNeighborhoodOutput_VH = vhAscending.select('VH').mean().reduceNeighborhood({
      reducer: ee.Reducer.variance(), 
      kernel: ee.Kernel.circle(50, "meters"),//ee.Kernel.square(60, "meters"),
    });
    var reduceNeighborhoodOutput_VV = vhAscending.select('VV').mean().reduceNeighborhood({
      reducer: ee.Reducer.variance(), 
      kernel: ee.Kernel.circle(50, "meters"),//ee.Kernel.square(60, "meters"),
    });
    //////////////////////////////////////////////////////////////////////
    var s1_count=vhAscending.select('VH').count().rename('vh_count').addBands(vhAscending.select('VV').count().rename('vv_count'));
    var s1_counted_per=s1_count.reduceRegion({reducer: ee.Reducer.percentile([5,95]),
      scale: 1000,
      maxPixels: 1e10,
      tileScale:2,
      geometry: first_county.geometry()});
    var s1_counted_delta=ee.Number(s1_counted_per.get('vh_count_p95')).subtract(ee.Number(s1_counted_per.get('vh_count_p5'))).abs();
    var s1_data_full=vhAscending.select('VV').mean().rename('VV_mean')
      .addBands(reduceNeighborhoodOutput_VV.rename('VV_variance'))
      .addBands(vhAscending.select('VH').mean().rename('VH_mean'))
      .addBands(reduceNeighborhoodOutput_VH.rename('VH_variance'));
    var s1_data_min=ee.Image(vhAscending.select('VV').min().rename('VV_min')
      .addBands(vhAscending.select('VH').min().rename('VH_min'))
      .addBands(vhAscending.select('VV').min().reduceNeighborhood({
      reducer: ee.Reducer.variance(), 
      kernel: ee.Kernel.circle(50, "meters")}).rename('VVmin_variance'))
      .addBands(vhAscending.select('VH').min().reduceNeighborhood({
      reducer: ee.Reducer.variance(), 
      kernel: ee.Kernel.circle(50, "meters")}).rename('VHmin_variance')));
    var s1_data_max=ee.Image(vhAscending.select('VV').max().rename('VV_max')
      .addBands(vhAscending.select('VH').max().rename('VH_max'))
      .addBands(vhAscending.select('VV').max().reduceNeighborhood({
      reducer: ee.Reducer.variance(), 
      kernel: ee.Kernel.circle(50, "meters")}).rename('VVmax_variance'))
      .addBands(vhAscending.select('VH').max().reduceNeighborhood({
      reducer: ee.Reducer.variance(), 
      kernel: ee.Kernel.circle(50, "meters")}).rename('VHmax_variance')));
    var s1_min=ee.Number(vhAscending.select('VV').min().reduceNeighborhood({
      reducer: ee.Reducer.variance(), 
      kernel: ee.Kernel.circle(5, "pixels")}).rename('VVmin_variance').reduceRegion({reducer: ee.Reducer.minMax(),
      scale: 100,
      maxPixels: 1e10,
      tileScale:8,
      bestEffort: true,
      geometry: first_county.geometry()}).get('VVmin_variance_min'));  
    var s1_data=ee.Image(ee.Algorithms.If(s1_counted_delta.gt(0),ee.Image(ee.Algorithms.If(s1_min.eq(0),s1_data_max,s1_data_min)),s1_data_full));
    /*var img0 = s1_data.set('footprint', ee.ImageCollection(vhAscending.select(['VV', 'VH'])).geometry());
    // check this footprint: in rare cases the mosaic does not cover the whole area - in such cases get rid of the image
    var area_frac = ee.Number(ee.Feature(ee.Image(1).clip(first_county.geometry()).reduceToVectors({geometry: img0.get('footprint'), maxPixels: 1e8, scale: 500}).union(100).first()).area()).divide(ee.Number(first_county.area()));
    s1_data=ee.Image(ee.Algorithms.If(area_frac.lt(0.9),ee.Image(0).rename('VV').float().addBands(ee.Image(0).rename('VH').float()), s1_data));
    */ 
    var img2= final_irrg_map.select('classification');
    var full_sample = s1_data.updateMask(img2.select('classification').gt(0)).sample({
      region:aoi_county.geometry().simplify(100),
      numPixels: 1000,
      scale: 10,
      //tileScale:4
    });
    var clusterer_crop = ee.Clusterer.wekaKMeans(2).train(full_sample);
    var cImage = s1_data.cluster(clusterer_crop).clip(aoi_county.geometry()).not().rename('classification');
    return cImage;
  };
  var s1_list0 = ee.List.sequence(4,5).map(classify_s1);
//middleMap.addLayer(ee.Image(s1_list0.get(0)), {bands: ['classification'],min: 0, max: 1, palette: ['green', '#ff5252']}, 'crop Apr 2019',false);
//middleMap.addLayer(ee.Image(s1_list0.get(1)), {bands: ['classification'],min: 0, max: 1, palette: ['green', '#ff5252']}, 'crop May 2019',false);
//////////////////////////////////////
//var all_months_s1=function(x) {
//var x=1;
  var s1_april=ee.Image(s1_list0.get(0));
  var s1_may=ee.Image(s1_list0.get(1));
  var img_s2_irrg=final_irrg_map.select('classification');
  //make sure the two images are not inverted
  //var img1=ee.Image(s2_NDVI.toList(61).get(x));
  var img1=img_s2_irrg.rename('NDVI');
  var sample=s1_april.addBands(img1).sample({
      region: first_county.geometry(),
      numPixels:1000,
      scale: 100,
      //tileScale:16
    });
  var groups = sample.reduceColumns(ee.Reducer.mean().group(), ["classification", "NDVI"]);
  // Extract the cluster IDs and the means.
  groups = ee.List(groups.get("groups"));
  var ids = groups.map(function(d) {return ee.Dictionary(d).get('group')});
  var means = groups.map(function(d) {return ee.Dictionary(d).get('mean')});
  //print('means',means)
  // Sort the IDs using the means as keys.
  var sorted = ee.Array(ids).sort(means).toList();
  // Remap the clustered image to put the clusters in order.
  var ordered_april = s1_april.remap(sorted, ids).rename('classification');
  var histogram0 = s1_may.updateMask(ordered_april.eq(0)).reduceRegion({
    reducer: ee.Reducer.histogram(255, 2).combine('mode', null, true),
    geometry:first_county.geometry(),
    scale: 100,//20,
    tileScale:8,
    bestEffort: true
  });
  var clust_non_irrg= ee.Algorithms.If(ee.Number(histogram0.get('classification_mode')).eq(0),s1_may,s1_may.not());
  var s1_may01=ee.Image(clust_non_irrg);
  var s1_img=ordered_april.add(s1_may01);
  var img_final=s1_img.updateMask(img_s2_irrg.eq(1));
  var classified_s1 = img_final.where(img_final.gt(1),1).clip(first_county);
  var sample_clas=classified_s1.sample({
    region: first_county.geometry(),
    numPixels:1000,
    scale: 10,
    //tileScale:16
  }).reduceColumns(ee.Reducer.mean(), ['classification']).get('mean');
  print('sample_clas',sample_clas);
  classified_s1=ee.Image(ee.Algorithms.If(ee.Number(sample_clas).lt(0.5),classified_s1.not(),classified_s1));
  if (wheat_most_common === 0){
    classified_s1=classified_s1.not();
  }
  final_wheat_map=classified_s1;//wheat_sieved_s1;//ee.ImageCollection(wheat_sieved_s1).max();
  var layers = middleMap.layers();
  var layers_length_now=layers.length()-1;
  var previous_layer = layers.get(layers_length_now);
  if (previous_year===0){
    step2=1;
    var wheat_OBIA=ee.Image(obia_per_year(classified_s1)).updateMask(img_s2_irrg.eq(1));
    step2=0;
    print('wheat_OBIA',wheat_OBIA)
    checkbox_wheatmap.setValue(false,false);
    checkbox_fallowmap.setValue(false,false);
    checkbox_fallowmap.setDisabled(false);
    if (checkbox_fallowmap_panel.widgets().length()>1){
      checkbox_fallowmap_panel.remove(checkbox_fallowmap_panel.widgets().get(1));
    }
    checkbox_wheatmap.setDisabled(false);
    if (checkbox_wheatmap_panel.widgets().length()>1){
      checkbox_wheatmap_panel.remove(checkbox_wheatmap_panel.widgets().get(1));
    } 
    slider3.setValue(0);
    previous_layer.setShown(false);
    sliderPanel.clear();
    sliderPanel.widgets().set(0,ui.Label('OPACITY SLIDERS', {fontWeight: '450', fontSize: '11px', margin: '1px 1px 4px 1px'}));
    sliderPanel.widgets().set(1,ui.Label('Wheat Area', {fontWeight: '450', fontSize: '10px', margin: '1px 1px 1px 1px'}));
    sliderPanel.widgets().set(2,slider2_panel);
    sliderPanel.widgets().set(3,ui.Label('Cropped Area', {fontWeight: '450', fontSize: '10px', margin: '1px 1px 1px 1px'}));
    sliderPanel.widgets().set(4,slider3_panel);
    var cz=middleMap.getZoom();
    if (cz < 12){
      middleMap.setZoom(12);
      title.setValue('To prevent map display failure, please do not zoom out.');
      title.style().set({color: 'red',fontWeight: '500'});
    } 
    //middleMap.layers().set(2,ui.Map.Layer(classified_s1.updateMask(classified_s1).reproject(crs_selected, null, 10), {bands: ['classification'],min: 0, max: 1, palette: ['white', 'yellow']},year + ' Wheat'));
    middleMap.layers().set(2,ui.Map.Layer(wheat_OBIA.updateMask(wheat_OBIA).reproject(crs_selected, null, 10), {bands: ['b1'],min: 0, max: 1, palette: ['white', 'yellow']},year + ' Wheat OBIA'));
    layer_wheat=middleMap.layers().get(2);
    slider2.setValue(1);
  }
//create a function that calculates area that has been classified as irrigated
//var area_calc = function(x) {
//var image=wheat_sieved_s1;//ee.Image(wheat_sieved_s1.get(x));
  if (previous_year===0){
    final_wheat_map_toexport=final_wheat_map.rename('classification').reproject(crs_selected, null, 10);
    //final_wheat_map_toexport=wheat_OBIA.rename('classification').reproject(crs_selected, null, 10);
    print('final_wheat_map_this_year',final_wheat_map_toexport);
    task2_area();
    Export.image.toDrive({
      image:final_wheat_map_toexport.select('classification'),
      description: 'Wheat_' + year_tmp + '_' + sel_county.getValue(),
      scale: 10,
      maxPixels: 1e13,
      region:first_county.geometry()
    }); 
  }
};
var task2_area=function() {
  //Area Calculation
  var crop_str; var area_image_crop;
  if (season_tmp==1){
    area_image_crop=final_wheat_map_toexport.multiply(ee.Image.pixelArea()).multiply(1e-6);
    crop_str="Winter Wheat (km2)";
  } else {
    area_image_crop=final_maize_map.multiply(ee.Image.pixelArea()).multiply(1e-6);
    crop_str="Summer Maize (km2)";
  }
  wheat_twnshps = area_image_crop.reduceRegions({
    collection: townships,
    reducer: ee.Reducer.sum(),
    scale: 100,
    tileScale: 8
  }); 
  //print('wheat_twnshps',wheat_twnshps)  
  var area_wheat = area_image_crop.reduceRegion({
      reducer: ee.Reducer.sum(),
      geometry: first_county.geometry(),
      scale: 100,
      maxPixels: 1e13,
      tileScale: 12
    }); 
  var wheat_areas_values=area_wheat.values();//.sort().reverse();
  var total_wheat_area=ee.Number(wheat_areas_values.reduce(ee.Reducer.sum()));
  print('total wheat/maize area',total_wheat_area);
  var iteration_id_tmp2=iteration_id2;
  // Request the value from the server.
  total_wheat_area.evaluate(function(result) {
    // When the server returns the value, show it.
      if (iteration_id_tmp2==iteration_id2){//in case the user has already moved forward...
        if (isNaN(result)){
          panel_outputs.widgets().set(5, ui.Label({},{color: 'red',fontWeight: '600', fontSize: '12px'}).setValue( "Earth Engine Capacity Exceeded or No Data Available"));
          panel_outputs.widgets().set(6, ui.Label({},{fontWeight: '450', fontSize: '12px'}).setValue( "Try clicking on 'Resubmit' "));
        } else {
          if (season_tmp==1){
            var TotalWheatAreaLabel = ui.Label({},{fontWeight: '450', fontSize: '12px', margin: '7px 1px 1px 10px'}).setValue( "Total Wheat Area in sq. km:  " + result.toFixed(2));
            panel_outputs.widgets().set(5, TotalWheatAreaLabel);
            panel_outputs.widgets().set(6, checkbox_wheatmap_panel);
          } else {
            var TotalMaizeAreaLabel = ui.Label({},{fontWeight: '450', fontSize: '12px', margin: '7px 1px 1px 10px'}).setValue( "Total Maize Area in sq. km:  " + result.toFixed(2));
            panel_outputs.widgets().set(5, TotalMaizeAreaLabel);
            panel_outputs.widgets().set(6, checkbox_maizemap_panel);           
          }
        }
      } 
  });
  var iteration_id_tmp2X=iteration_id+iteration_id2+iteration_id3;
    var cat_strings=function(x) {
    //var ind=ee.Number(x).add(1);
    var ft1=ee.Feature(crop_twnshps.toList(99).get(ee.Number(x)));
    var name_chn=ee.String(ft1.get('乡'));
    var name_eng=ee.String(ft1.get('Township'));
    var crop_tmp=ee.Number(ft1.get('sum'));
    var ft2=ee.Feature(wheat_twnshps.toList(99).get(ee.Number(x)));
    var wheat_tmp=ee.Number(ft2.get('sum'));
    var dict={c: [{v: name_chn},{v: name_eng}, {v: crop_tmp},{v: wheat_tmp}]};
    return dict;
  };
  var dict_for_table = ee.List.sequence(0,twn_no.subtract(1)).map(cat_strings);  
  print('Winter Wheat /Summer Maize table',dict_for_table);
  panel_right.widgets().set(2, ui.Label('Please wait... The table will be updated...', {color: 'red', fontWeight: '450', fontSize: '12px', margin: '7px 1px 1px 10px'}));
  dict_for_table.evaluate(function(result) {  
    var dataTable = {
      cols: [{label: 'Name CHN', type: 'string'},
            {label: 'Township', type: 'string'},
             {label: 'Toal Crop Area (km2)', type: 'number'},
             {label: crop_str, type: 'number'}],
      rows: result};
    var options = {
      height: 400
    };  
    var charttable1 = new ui.Chart(dataTable, 'Table',options);
      if (iteration_id_tmp2X==iteration_id+iteration_id2+iteration_id3){//in case the user has already moved forward...
          panel_right.widgets().set(2, ui.Label("Attention, only approximate area estimates are provided here. For accurate area calculations please contact hs@hydrosolutions.ch",
            {color: 'red', fontWeight: '350', fontSize: '12px', margin: '7px 1px 1px 10px'}));
      }  
          panel_right.widgets().set(3, charttable1);
    });
};
correctButton3.onClick(function(){
  year=year_tmp;  
  continueButton3.setDisabled(false);
  continueButton3.style().set({backgroundColor: 'blue',padding: '2px'});
  panel_inputs.remove(panel_fallow);
  var layers_no=panel_outputs.widgets().length();
  for (var i=5; i<layers_no; i++) {
    panel_outputs.widgets().remove(panel_outputs.widgets().get(i));
  }
  if (sliderPanel.widgets().length()==7){
    middleMap.remove(layer_fallow);
    middleMap.remove(legend);
  }
  panel_outputs.widgets().set(5, ui.Label('Please wait...', {color: 'red', fontWeight: '450', fontSize: '12px', margin: '7px 1px 1px 10px'}));
  panel_outputs.widgets().set(6, ui.Label('', {color: 'red', fontWeight: '450', fontSize: '12px', margin: '7px 1px 1px 10px'}));
  //correct2=1;
  runagain=1;
  iteration_id2=iteration_id2 + 1;
  iteration_id3=iteration_id3 + 1;
  previous_year=0;
  final_irrg_map=final_irrg_map_this_year;
  task2();
});
correctButton3b.onClick(function(){
  year=year_tmp;  
  var layers_no=panel_outputs.widgets().length();
  for (var i=5; i<layers_no; i++) {
    panel_outputs.widgets().remove(panel_outputs.widgets().get(i));
  }
  panel_outputs.widgets().set(5, ui.Label('Please wait...', {color: 'red', fontWeight: '450', fontSize: '12px', margin: '7px 1px 1px 10px'}));
  panel_outputs.widgets().set(6, ui.Label('', {color: 'red', fontWeight: '450', fontSize: '12px', margin: '7px 1px 1px 10px'}));
  runagain=1;
  iteration_id2=iteration_id2 + 1;
  iteration_id3=iteration_id3 + 1;
  previous_year=0;
  task2_summer();
});
continueButton3.onClick(function(){
  year=year_tmp;
  panel_inputs.remove(panel_fallow);
  panel_inputs.add(panel_fallow);
  final_wheat_map_this_year=final_wheat_map.rename('classification');
  final_irrg_map_this_year=final_irrg_map.rename('classification');
  //correct1=0; correct2=0; correct3=0;
  iteration_id3=iteration_id2 + 1;
  task3();
  panel_outputs.widgets().set(7, ui.Label('Please wait...', {color: 'red', fontWeight: '450', fontSize: '12px', margin: '7px 1px 1px 10px'}));
  continueButton3.setDisabled(true);
  continueButton3.style().set({backgroundColor: '#919191',padding: '2px'});
});
var task1_summer= function() {
  aoi_county=first_county.difference(reservoirs);
  var s2_list0 = ee.List.sequence(7,9).map(classify_s2);
  var classified_s2=ee.ImageCollection(s2_list0).sum();
  var l8_list0 = ee.List.sequence(7,9).map(classify_l8);
  var classified_l8=ee.ImageCollection(l8_list0).sum();
  var l8= classified_l8.select('classification');
  var s2= classified_s2.select('classification');
  var l8c= classified_l8.select('cloud');
  var s2c= classified_s2.select('cloud');
  var s2l8c=l8c.add(s2c);
  var s2l8;
  if (sensor_priority_summer == 1){
    s2l8 = s2.where(s2.gte(1),2).where(s2c.eq(3),l8.where(l8.gte(1),1));
  } else {
    s2l8 = l8.where(l8.gte(1),2).where(l8c.eq(3),s2.where(s2.gte(1),1));
  }
  var classified= s2l8.int8();//.reproject(crs_selected, null, 20)
  var img_cloud=s2l8c.where(s2l8c.lt(6),0).where(s2l8c.eq(6),1)
  crop_map_summer = img_cloud.addBands(classified.where(classified.gt(0),1));
  if (previous_year===0){
    sliderPanel.clear();
    sliderPanel.widgets().set(0,ui.Label('OPACITY SLIDERS', {fontWeight: '450', fontSize: '11px', margin: '1px 1px 4px 1px'}));
    sliderPanel.widgets().set(1,ui.Label('Cropped Area', {fontWeight: '450', fontSize: '10px', margin: '1px 1px 1px 1px'}));
    sliderPanel.widgets().set(2,slider3_panel);
    checkbox_irrgmap.setValue(false,false);
    checkbox_irrgmap.setDisabled(false);
    if (checkbox_irrgmap_panel.widgets().length()>1){
      checkbox_irrgmap_panel.remove(checkbox_irrgmap_panel.widgets().get(1));
    }
    checkbox_maizemap.setValue(false,false);
    checkbox_maizemap.setDisabled(false);
    if (checkbox_maizemap_panel.widgets().length()>1){
      checkbox_maizemap_panel.remove(checkbox_maizemap_panel.widgets().get(1));
    }   
    middleMap.layers().set(1,ui.Map.Layer(crop_map_summer.updateMask(classified.gt(0)).reproject(crs_selected, null, 10), {bands: ['classification'],min: 0, max: 1, palette: palette}, "irrg. area "+ year));
    slider3.setValue(1);
    task1_area();
  }
};
var task2_summer= function() {
  aoi_county=first_county;
  var sentinel1 = ee.ImageCollection('COPERNICUS/S1_GRD').filterBounds(aoi_county.geometry())
      //.filterDate(ee.Date.fromYMD(year,7, 15), ee.Date.fromYMD(year,10, 15));
      .filterDate(ee.Date.fromYMD(year,6, 1), ee.Date.fromYMD(year,10, 31))
      .map(func.leeSigma);
      //NEW ADDITION 8 Nov 2020
  var s1b=sentinel1.map(function(img){
      return ee.Image(img).set({'SENSING_TIME': ee.Date(ee.Image(img).get('system:time_start')).format('YYYY-MM-dd')});
  });
  var img_list_s1=s1b.aggregate_array('SENSING_TIME').distinct();
  print('img_list_s1',img_list_s1);
  var sensor_data_mosaic=ee.ImageCollection(img_list_s1.map(function(x){
    var img1=ee.Image(s1b.filter(ee.Filter.eq('SENSING_TIME', x)).first());
    var img1_mosaic = ee.Image(s1b.filter(ee.Filter.eq('SENSING_TIME', x)).mosaic())
      .copyProperties(img1)
      .set('system:time_start',img1.get('system:time_start'));
    var image2 = ee.Image(100).rename('cloud').where(ee.Image(img1_mosaic).select('VV').gt(-99),0);
    var cloudPixels = ee.Number(image2.select("cloud").reduceRegion({'reducer': ee.Reducer.mean(), 
               'geometry': aoi_county.geometry(), 'scale': 500,'tileScale': 2}).get('cloud'));
    return img1_mosaic
      .set({'nodata_cover': cloudPixels});
  }));
  print('sensor_data_mosaic nodata',sensor_data_mosaic.aggregate_array('nodata_cover'))
  sentinel1=sensor_data_mosaic.filter(ee.Filter.lte('nodata_cover', 10));
  print('sentinel1 mosaic',sentinel1)
  //////
  var vh = sentinel1
    .filter(ee.Filter.listContains('transmitterReceiverPolarisation', 'VV'))
    .filter(ee.Filter.listContains('transmitterReceiverPolarisation', 'VH'));
  var vhAscending = vh.filter(ee.Filter.eq('orbitProperties_pass', 'ASCENDING'));
  var vhAscending_selected = ee.List.sequence(6, 10).map(function(mm) {
    var img = vhAscending.select(['VV','VH']).filter(ee.Filter.calendarRange(mm, mm, 'month')).median()
      .rename(['VV_mean','VH_mean']);
      //really can't figure out whats the problem with the code below - works e.g. for Quzhou 2016 but for Guantao 2019 leads to very small footprints although the image cover the entire county and more!
    /*    var s1_empty=ee.Image(0).rename('VV').float().addBands(ee.Image(0).rename('VH').float());
    var img0=vhAscending.select(['VV','VH']).filter(ee.Filter.calendarRange(mm, mm, 'month')).median()
      .set('footprint',ee.ImageCollection(vhAscending.select(['VV','VH']).filter(ee.Filter.calendarRange(mm, mm, 'month'))).median().geometry());    
    var area_frac=ee.Number(ee.Feature(ee.Image(1).clip(aoi_county)
      //check this footprint: in rare cases the mosaic does not cover the whole area - in such cases get rid of the image
      .reduceToVectors({geometry: img0.get('footprint'), maxPixels: 1e8, scale: 500})
      .union(100).first()).area())
      .divide(ee.Number(aoi_county.area()));
    var s1_doif= ee.ImageCollection(ee.Algorithms.If( vhAscending.select(['VV','VH']).filter(ee.Filter.calendarRange(mm, mm, 'month')).size().eq(0),
      ee.ImageCollection.fromImages([s1_empty]),ee.Image(ee.Algorithms.If(area_frac.lt(0.9),ee.ImageCollection.fromImages([s1_empty]),vhAscending.select(['VV','VH']).filter(ee.Filter.calendarRange(mm, mm, 'month'))))));
    var img = s1_doif.median()
      .rename(['VV_mean','VH_mean']).set('area_frac',area_frac).set('area_frac',area_frac);*/
    return img;
  });
  //print('vhAscending_selected summer',vhAscending_selected)
  var vhAscending_quantiles = vhAscending.select(['VV','VH'])
    //.filterDate(ee.Date.fromYMD(year,7, 1), ee.Date.fromYMD(year,9, 30))
    .reduce(ee.Reducer.percentile([10,25,50,75,95]));
  //print('vhAscending_quantiles',vhAscending_quantiles);
  var VV_mean_all_months = /*ee.Image(vhAscending_selected.get(0)).select('VV_mean').rename('VV_mean1')
    .addBands(*/ee.Image(vhAscending_selected.get(1)).select('VV_mean').rename('VV_mean2')
    .addBands(ee.Image(vhAscending_selected.get(2)).select('VV_mean').rename('VV_mean3'))
    .addBands(ee.Image(vhAscending_selected.get(3)).select('VV_mean').rename('VV_mean4'))
    //.addBands(ee.Image(vhAscending_selected.get(4)).select('VV_mean').rename('VV_mean5'))
    //.addBands(ee.Image(s1_data_tostack.toList(8).get(5)).select('VV_mean').rename('VV_mean6'));
  var VH_mean_all_months = /*ee.Image(vhAscending_selected.get(0)).select('VH_mean').rename('VH_mean1')
    .addBands(*/ee.Image(vhAscending_selected.get(1)).select('VH_mean').rename('VH_mean2')
    .addBands(ee.Image(vhAscending_selected.get(2)).select('VH_mean').rename('VH_mean3'))
    .addBands(ee.Image(vhAscending_selected.get(3)).select('VH_mean').rename('VH_mean4'))
    //.addBands(ee.Image(vhAscending_selected.get(4)).select('VH_mean').rename('VH_mean5'))  
    //.addBands(ee.Image(s1_data_tostack.toList(8).get(5)).select('VH_mean').rename('VH_mean6'));
  var img2= crop_map_summer.select('classification');
  var full_sample = VV_mean_all_months.addBands(VH_mean_all_months)
    //.addBands(vhAscending_quantiles)
    .updateMask(img2.select('classification').eq(1)).sample({
    region:aoi_county.geometry(),
    numPixels: 1000,
    scale: 10,
    //tileScale: 16
  });
  var clusterer_crop = ee.Clusterer.wekaKMeans(2).train(full_sample);
  var s1_list0 = VV_mean_all_months.addBands(VH_mean_all_months)
    //.addBands(vhAscending_quantiles)
    .cluster(clusterer_crop).clip(aoi_county.geometry()).rename('classification');
  print('s1_list summer',s1_list0);
  var img1=crop_map_summer;//.select('classification');
  //IDENTIFY WHICH CLUSTER CAN BE ASSOCIATED TO MAIZE:
  //1. Add the irrigated area map as a band to the S1 clusters of the first monthly S1 map
  //2. Sample 1000 pixels from within the county borders (except from areas with no irrg. data)
  //3. Group the pixels by S1 clusters and take the mean of the binary irrigation signal of each group
  //4. Associate the label 'MAIZE' to the S1 cluster with the higher irrigation frequency
  var img_s2_irrg=img1.select('classification').rename(['IRRG']);
  var sample=s1_list0.addBands(img_s2_irrg).updateMask(img1.select('cloud').eq(0)).sample({
      region: aoi_county.geometry(),
      numPixels:1000,
      scale: 100,
      //tileScale: 16
    });
  var groups = sample.reduceColumns(ee.Reducer.mean().group(), ["classification", "IRRG"]);
  //print('groups2',sample.reduceColumns(ee.Reducer.count().group(), ["classification", "IRRG"]));
  // Extract the cluster IDs and the means.
  groups = ee.List(groups.get("groups"));
  var ids = groups.map(function(d) {return ee.Dictionary(d).get('group')});
  var means = groups.map(function(d) {return ee.Dictionary(d).get('mean')});
  // Sort the IDs using the means as keys.
  var sorted = ee.Array(ids).sort(means).toList();
  // Remap the clustered image to put the clusters in order.
  var ordered_aug = s1_list0.remap(sorted, ids).rename('classification');
  var classified_s1=ordered_aug.updateMask(img_s2_irrg.eq(1));
  if (maize_most_common === 0){
    classified_s1=classified_s1.not();
  }
  print('maize before OBIA',classified_s1);
  step2=1;
  var maize_OBIA=ee.Image(obia_per_year(classified_s1)).updateMask(img_s2_irrg.eq(1));
  step2=0;
  final_maize_map=maize_OBIA.rename('classification').reproject(crs_selected, null, 10)
    .clip(aoi_county.geometry());
  print('final_maize_map',final_maize_map);
  /*Export.image.toDrive({
    image:final_maize_map,
    description: 'Maize_' + year_tmp + '_' + sel_county.getValue(),
    scale: 10,
    maxPixels: 1e13,
    region:first_county.geometry()
  });*/
  var layers = middleMap.layers();
  var layers_length_now=layers.length()-1;
  var previous_layer = layers.get(layers_length_now);
  slider3.setValue(0);
  previous_layer.setShown(false);
  sliderPanel.clear();
  sliderPanel.widgets().set(0,ui.Label('OPACITY SLIDERS', {fontWeight: '450', fontSize: '11px', margin: '1px 1px 4px 1px'}));
  sliderPanel.widgets().set(1,ui.Label('Maize Area', {fontWeight: '450', fontSize: '10px', margin: '1px 1px 1px 1px'}));
  sliderPanel.widgets().set(2,slider2_panel);
  sliderPanel.widgets().set(3,ui.Label('Cropped Area', {fontWeight: '450', fontSize: '10px', margin: '1px 1px 1px 1px'}));
  sliderPanel.widgets().set(4,slider3_panel);
  middleMap.layers().set(2,ui.Map.Layer(final_maize_map.updateMask(final_maize_map).reproject(crs_selected, null, 10), {bands: ['classification'],min: 0, max: 1, palette: ['white', 'yellow']},year + ' Maize'));
  //middleMap.layers().set(3,ui.Map.Layer(classified_s1.updateMask(classified_s1), {bands: ['classification'],min: 0, max: 1, palette: ['white', 'red']},year + ' Maize raw',false));
  //middleMap.layers().set(0,ui.Map.Layer(VV_mean_all_months.addBands(VH_mean_all_months).addBands(vhAscending_quantiles), {bands: ['VV_mean2']},year + ' Radar',false));
  layer_maize=middleMap.layers().get(2);
  slider2.setValue(1);
  var cz=middleMap.getZoom();
  if (cz < 12){
    middleMap.setZoom(12);
    title.setValue('To prevent map display failure, please do not zoom out.');
    title.style().set({color: 'red',fontWeight: '500'});
  } 
    Export.image.toDrive({
      image:final_maize_map.select('classification'),
      description: 'Maize_' + year_tmp + '_' + sel_county.getValue(),
      scale: 10,
      maxPixels: 1e13,
      region:first_county.geometry()
    }); 
  task2_area();
};
var task3= function() {
  checkbox_fallowmap.setValue(false,false);
  checkbox_fallowmap.setDisabled(false);
  if (checkbox_fallowmap_panel.widgets().length()>1){
    checkbox_fallowmap_panel.remove(checkbox_fallowmap_panel.widgets().get(1));
  }
  //AND THEN RUN IT FOR THE PREVIOUS YEAR TO GET FALLOW AREA!
  year=year_ref;//year - 1 ;
  previous_year=1;
  //runagain: if the user just wants to change the minimum plot area no need to obtain the reference map again
  if (runagain==1){
    task1();
    if (ref_crop_map==1){
      task2();
    }
    runagain=0;
  }
  //
  task4();
  var cz=middleMap.getZoom();
  if (cz < 13){
    middleMap.setZoom(13);
  } 
};
correctButton4.onClick(function(){
  year=year_tmp;
  panel_outputs.widgets().set(7, ui.Label('Please wait...', {color: 'red', fontWeight: '450', fontSize: '12px', margin: '7px 1px 1px 10px'}));
  panel_outputs.widgets().set(8, ui.Label('', {color: 'red', fontWeight: '450', fontSize: '12px', margin: '7px 1px 1px 10px'}));
  //correct3=1;correct2=1;correct1=1;
  iteration_id3=iteration_id3 + 1;
  middleMap.remove(legend);
  task3();
});
var task4= function() {
  year=year_tmp;
  var img0; var img1;
  if (ref_crop_map==1){
    //wheat map contains holes because it has been updated with the crop map --> fill holes with zero
    img0=ee.Image(0).where(final_wheat_map.select('classification').eq(1),1).int8().clip(first_county);
    img1=ee.Image(0).where(final_wheat_map_this_year.eq(1),1).int8().clip(first_county);
  } else {
    img0=final_irrg_map.int8().clip(first_county);
    img1=final_irrg_map_this_year.int8().clip(first_county);
  }
  if (ref_map==2){
    season_tmp=0;
    task1_summer();
    season_tmp=1;
    crop_map_summer_ref=crop_map_summer.select('classification');
  } else {
    crop_map_summer_ref=ee.Image(1).rename('classification');
  }
  //If there are also no crops in summer the area is now fallow because it is not used anymore for agriculture
  var img_difference0=img0.subtract(img1).rename('classification')
    .where(crop_map_summer_ref.eq(0),0);
  //Fallow area this and previous year must be confirmed
  var img_difference= img_difference0.where(img_difference0.eq(1),img_difference0.where(final_irrg_map_this_year.eq(1),0))
    .where(img_difference0.eq(-1),img_difference0.where(final_irrg_map.eq(1),0));
  var layers = middleMap.layers();
  slider2.setValue(0);
  slider3.setValue(0);
  layers.get(1).setShown(false);
  layers.get(2).setShown(false);
  sliderPanel.clear();
  sliderPanel.widgets().set(0,ui.Label('OPACITY SLIDERS', {fontWeight: '450', fontSize: '11px', margin: '1px 1px 4px 1px'}));
  sliderPanel.widgets().set(1,ui.Label('Fallow Area', {fontWeight: '450', fontSize: '10px', margin: '1px 1px 1px 1px'}));
  sliderPanel.widgets().set(2,slider);
  sliderPanel.widgets().set(3,ui.Label('Wheat Area', {fontWeight: '450', fontSize: '10px', margin: '1px 1px 1px 1px'}));
  sliderPanel.widgets().set(4,slider2_panel);
  sliderPanel.widgets().set(5,ui.Label('Cropped Area', {fontWeight: '450', fontSize: '10px', margin: '1px 1px 1px 1px'}));
  sliderPanel.widgets().set(6,slider3_panel);
  var img2;
  if (obia_checkbox_fallow.getValue() === true){
    var fallow_OBIA=ee.Image(obia_per_year(img_difference));//;
    img2=fallow_OBIA.rename('classification').reproject(crs_selected, null, 10);//.updateMask(fallow_OBIA.neq(0))
  } else {
    img2 = img_difference.rename('classification').reproject(crs_selected, null, 10);
  }
  //correct inconsistencies
  var img3a=img2.where(img0.eq(0),img2.where(img1.eq(0),0)); //marked as fallow but no crop in any year
  var img3b= img3a.where(img3a.eq(1),img3a.where(final_irrg_map_this_year.eq(1),0))
    .where(img3a.eq(-1),img3a.where(final_irrg_map.eq(1),0));
  var img3=img3b.where(crop_map_summer_ref.eq(0),0); //no crop area in summer
  fallow_wo_OBIA=img_difference.reproject(crs_selected, null, 10);
  var smallClusters = ee.Image(ee.Algorithms.If(noise_fallow.gt(1),img3.rename('sieve').connectedPixelCount(noise_fallow, false),ee.Image(2).rename('sieve')));//.reproject(crs_selected, null, 10);
  var smallClusters_zero = img3.rename('sieve').updateMask(img3.eq(0)).not().connectedPixelCount(5, false);
  fallow_OBIA_sieved= img3.select(['classification']).where(smallClusters.select(['sieve']).lt(noise_fallow),0)
    .where(smallClusters_zero.select(['sieve']).lt(5),img3.focal_mode({radius: 1, kernelType :'square',units: 'pixels'}))
    .int8().clip(aoi_county.geometry());
  print('fallow_OBIA_sieved',fallow_OBIA_sieved);
  /*if (correct3===0){
    middleMap.addLayer(img_difference.updateMask(img_difference.neq(0)), {bands: ['classification'],min: -1, max: 1, palette: ["red","white","green"]}, "img difference",false);
    middleMap.addLayer(fallow_OBIA_sieved.updateMask(fallow_OBIA_sieved.neq(0)), {bands: ['classification'],min: -1, max: 1, palette: ["red","white","green"]}, "Wheat Fallow Area ");
  } else {*/
    middleMap.layers().set(3,ui.Map.Layer(fallow_OBIA_sieved.updateMask(fallow_OBIA_sieved.neq(0)).reproject(crs_selected, null, 10), {bands: ['classification'],min: -1, max: 1, palette: ["red","white","#0ce9ff"]}, "Wheat Fallow Area"));
    //middleMap.layers().set(4,ui.Map.Layer(img_difference.updateMask(img_difference.neq(0)), {bands: ['classification'],min: -1, max: 1, palette: ["red","white","green"]}, "img difference",false));
    slider.setValue(1);
    layer_fallow=middleMap.layers().get(3);
  //}
  middleMap.add(legend);
  task4_area();
  /*Export.image.toDrive({
      image:fallow_OBIA_sieved,
      description: 'fallow_OBIA_sieved',
      scale: 10,
      maxPixels: 1e13,
      region:first_county.geometry()
    });*/
};
////////////////////////////////
var task4_area=function() {
  //Area Calculation
  //wo OBIA to not run out of memory
  //fallow_twnshps = fallow_OBIA_sieved.reduceResolution({reducer: ee.Reducer.mode(),maxPixels: 1024}).reproject({crs: 'EPSG:32650',scale:100}).multiply(ee.Image.pixelArea()).multiply(1e-6)
  var smallClusters = ee.Image(ee.Algorithms.If(noise_fallow.gt(1),fallow_wo_OBIA.rename('sieve').connectedPixelCount(noise_fallow, false),ee.Image(2).rename('sieve')));//.reproject(crs_selected, null, 10);
  var fallow_wo_OBIA_sieved= fallow_wo_OBIA.select(['classification']).where(smallClusters.select(['sieve']).lt(noise_fallow),0)
  fallow_twnshps = fallow_wo_OBIA_sieved.reduceResolution({reducer: ee.Reducer.mode(),maxPixels: 1024}).reproject({crs: 'EPSG:32650',scale:100}).multiply(ee.Image.pixelArea()).multiply(1e-6)
    .reduceRegions({
    collection: townships,
    reducer: ee.Reducer.sum(),
    scale: 100,
    tileScale: 8
  }); 
  print('fallow_twnshps',fallow_twnshps);
  //var area_fallow = fallow_OBIA_sieved.reduceResolution({reducer: ee.Reducer.mode(),maxPixels: 1024}).reproject({crs: 'EPSG:32650',scale:100}).multiply(ee.Image.pixelArea()).multiply(1e-6)
  var area_fallow = fallow_wo_OBIA_sieved.reduceResolution({reducer: ee.Reducer.mode(),maxPixels: 1024}).reproject({crs: 'EPSG:32650',scale:100}).multiply(ee.Image.pixelArea()).multiply(1e-6)
    .reduceRegion({
      reducer: ee.Reducer.sum(),
      geometry: first_county.geometry(),
      scale: 100,
      maxPixels: 1e13,
      tileScale: 12
    }); 
  var wheat_fallow_values=area_fallow.values();//.sort().reverse();
  var total_fallow_area=ee.Number(wheat_fallow_values.reduce(ee.Reducer.sum()));
  print('total_fallow_area',total_fallow_area);
  var iteration_id_tmp3=iteration_id3;
  // Request the value from the server.
  total_fallow_area.evaluate(function(result) {
    // When the server returns the value, show it.
      if (iteration_id_tmp3==iteration_id3){//in case the user has already moved forward...
        if (isNaN(result)){
          panel_outputs.widgets().set(7, ui.Label({},{color: 'red',fontWeight: '600', fontSize: '12px'}).setValue( "Earth Engine Capacity Exceeded or No Data Available"));
          panel_outputs.widgets().set(8, ui.Label({},{fontWeight: '450', fontSize: '12px'}).setValue( "Try clicking on 'Resubmit' "));
        } else {
            var TotalFallowAreaLabel = ui.Label({},{fontWeight: '450', fontSize: '12px', margin: '7px 1px 1px 10px'}).setValue( "Total Fallow Area in sq. km:  " + result.toFixed(2));
            panel_outputs.widgets().set(7, TotalFallowAreaLabel);
            panel_outputs.widgets().set(8, checkbox_fallowmap_panel);
        }
      } 
  });
  var iteration_id_tmp3X=iteration_id+iteration_id2+iteration_id3;
  var cat_strings=function(x) {
    //var ind=ee.Number(x).add(1);
    var ft1=ee.Feature(crop_twnshps.toList(99).get(ee.Number(x)));
    var name_chn=ee.String(ft1.get('乡'));
    var name_eng=ee.String(ft1.get('Township'));
    var crop_tmp=ee.Number(ft1.get('sum'));
    var ft2=ee.Feature(wheat_twnshps.toList(99).get(ee.Number(x)));
    var wheat_tmp=ee.Number(ft2.get('sum'));
    var ft3=ee.Feature(fallow_twnshps.toList(99).get(ee.Number(x)));
    var fallow_tmp=ee.Number(ft3.get('sum'));
    var dict={c: [{v: name_chn},{v: name_eng}, {v: crop_tmp},{v: wheat_tmp},{v: fallow_tmp}]};
    return dict;
  };
  var dict_for_table = ee.List.sequence(0,twn_no.subtract(1)).map(cat_strings);  
  //print('Fallow table',dict_for_table);
  panel_right.widgets().set(2, ui.Label('Please wait... The table will be updated...', {color: 'red', fontWeight: '450', fontSize: '12px', margin: '7px 1px 1px 10px'}));
  dict_for_table.evaluate(function(result) {  
    var dataTable = {
      cols: [{label: 'Name CHN', type: 'string'},
            {label: 'Township', type: 'string'},
             {label: 'Crop Winter (km2)', type: 'number'},
             {label: 'Winter Wheat (km2)', type: 'number'},
            {label: 'Fallow Winter (km2)', type: 'number'}],
      rows: result};
    var options = {
      height: 400
    };  
    var charttable1 = new ui.Chart(dataTable, 'Table',options);
      if (iteration_id_tmp3X==iteration_id+iteration_id2+iteration_id3){//in case the user has already moved forward...
          panel_right.widgets().set(2, ui.Label("Attention, only approximate area estimates are provided here. For accurate area calculations please contact hs@hydrosolutions.ch",
            {color: 'red', fontWeight: '350', fontSize: '12px', margin: '7px 1px 1px 10px'}));
          panel_right.widgets().set(3, charttable1);
      }
  });
};
var maptodownload; var strtmp;
checkbox_irrgmap.onChange(function(checked) {
    var plz_wait=ui.Label('Please wait...', {color: 'red', fontWeight: '450', fontSize: '12px', margin: '7px 1px 1px 10px'});
    checkbox_irrgmap_panel.add(plz_wait);
    checkbox_irrgmap.setDisabled(true);
    // Request the value from the server.
    first_county.simplify(100).bounds(100).geometry().evaluate(function(result) {
      var region = JSON.stringify(result);
      var background = ee.Image(0);
      if (season_tmp==1){
        maptodownload=final_irrg_map.select('classification');
        strtmp="_winter";
      } else {
        maptodownload=crop_map_summer.select('classification');
        strtmp="_summer";
      }
      var cluster_mapBlended = background.blend(maptodownload);
      var download_tif_label = ui.Label({ value : "Download Cropped Area Map as TIF", style : { shown:true },targetUrl : cluster_mapBlended.int32().getDownloadURL({scale: 100, region: region, name :"CropMap"+strtmp})} );
      //panel_new.remove(panel_new.widgets().get(3));
      panel_outputs.widgets().set(4, download_tif_label);
      checkbox_irrgmap_panel.remove(plz_wait);
    });
});
checkbox_wheatmap.onChange(function(checked) {
    var plz_wait=ui.Label('Please wait...', {color: 'red', fontWeight: '450', fontSize: '12px', margin: '7px 1px 1px 10px'});
    checkbox_wheatmap_panel.add(plz_wait);
    checkbox_wheatmap.setDisabled(true);
    // Request the value from the server.
    first_county.simplify(100).bounds(100).geometry().evaluate(function(result2) {
      var region = JSON.stringify(result2);
      var background = ee.Image(0);
      var cluster_mapBlended = background.blend(final_wheat_map_toexport.select('classification'));
      var download_tif_label2 = ui.Label({ value : "Download Wheat Map as TIF", style : { shown:true },targetUrl : cluster_mapBlended.int32().getDownloadURL({scale: 100, region: region, name :"WheatMap"})} );
      panel_outputs.widgets().set(6, download_tif_label2);
      checkbox_wheatmap_panel.remove(plz_wait);
    });
});  
checkbox_maizemap.onChange(function(checked) {
    var plz_wait=ui.Label('Please wait...', {color: 'red', fontWeight: '450', fontSize: '12px', margin: '7px 1px 1px 10px'});
    checkbox_maizemap_panel.add(plz_wait);
    checkbox_maizemap.setDisabled(true);
    // Request the value from the server.
    first_county.simplify(100).bounds(100).geometry().evaluate(function(result2) {
      var region = JSON.stringify(result2);
      var background = ee.Image(0);
      var cluster_mapBlended = background.blend(final_maize_map.select('classification'));
      var download_tif_label2 = ui.Label({ value : "Download Maize Map as TIF", style : { shown:true },targetUrl : cluster_mapBlended.int32().getDownloadURL({scale: 100, region: region, name :"MaizeMap"})} );
      panel_outputs.widgets().set(6, download_tif_label2);
      checkbox_maizemap_panel.remove(plz_wait);
    });
});  
checkbox_fallowmap.onChange(function(checked) {
    var plz_wait=ui.Label('Please wait...', {color: 'red', fontWeight: '450', fontSize: '12px', margin: '7px 1px 1px 10px'});
    checkbox_fallowmap_panel.add(plz_wait);
    checkbox_fallowmap.setDisabled(true);
    // Request the value from the server.
    first_county.simplify(100).bounds(100).geometry().evaluate(function(result3) {
      var region = JSON.stringify(result3);
      var background = ee.Image(0).rename('classification');
      var cluster_mapBlended = background.blend(fallow_OBIA_sieved).where(fallow_OBIA_sieved.eq(-1),-1);
      var download_tif_label3 = ui.Label({ value : "Download Fallow Area Map as TIF", style : { shown:true },targetUrl : cluster_mapBlended.int8().getDownloadURL({scale: 100,  region: region, name :"FallowMap"})} );
      panel_outputs.widgets().set(8, download_tif_label3);
      checkbox_fallowmap_panel.remove(plz_wait);
    });
});  
checkbox_greenmap.onChange(function(checked) {
    Export.image.toDrive({
      image:greenhouse_map.int8(),
      description: 'GreenhouseMap_OBIA',
      scale: 10,
      maxPixels: 1e13,
      region:aoi_selected.simplify(500)//.geometry()
    });
    checkbox_green_panel.add(plz_wait_green);
    checkbox_greenmap.setDisabled(true);
    // Request the value from the server.
    first_county.simplify(100).bounds(100).geometry().evaluate(function(result3) {
      var region = JSON.stringify(result3);
      var background = ee.Image(0).rename('clusters');
      var cluster_mapBlended = background.blend(cluster_map_post_2);
      var download_tif_label3 = ui.Label({ value : "Download Greenhouse Map as TIF", style : { shown:true },targetUrl : cluster_mapBlended.int8().getDownloadURL({scale: 100,  region: region, name: "GreenhouseMap"})} );
      panel_outputs.widgets().set(4, download_tif_label3);
      checkbox_green_panel.remove(plz_wait_green);
    });
});