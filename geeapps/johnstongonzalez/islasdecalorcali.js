/**** Start of imports. If edited, may not auto-convert in the playground. ****/
var bu1 = 
    /* color: #3fd61e */
    /* shown: false */
    ee.FeatureCollection(
        [ee.Feature(
            ee.Geometry.Point([-76.47446937088596, 3.436506732792156]),
            {
              "tipo": "bosqueurbano",
              "tiponum": 0,
              "system:index": "0"
            }),
        ee.Feature(
            ee.Geometry.Point([-76.47379881863223, 3.435805257410896]),
            {
              "tipo": "bosqueurbano",
              "tiponum": 0,
              "system:index": "1"
            }),
        ee.Feature(
            ee.Geometry.Point([-76.47346086029636, 3.435457196915828]),
            {
              "tipo": "bosqueurbano",
              "tiponum": 0,
              "system:index": "2"
            }),
        ee.Feature(
            ee.Geometry.Point([-76.47365934376346, 3.4349859763510224]),
            {
              "tipo": "bosqueurbano",
              "tiponum": 0,
              "system:index": "3"
            }),
        ee.Feature(
            ee.Geometry.Point([-76.47339648728, 3.434627205992292]),
            {
              "tipo": "bosqueurbano",
              "tiponum": 0,
              "system:index": "4"
            }),
        ee.Feature(
            ee.Geometry.Point([-76.47298879150974, 3.434359466830761]),
            {
              "tipo": "bosqueurbano",
              "tiponum": 0,
              "system:index": "5"
            }),
        ee.Feature(
            ee.Geometry.Point([-76.47269911293613, 3.4333795408592955]),
            {
              "tipo": "bosqueurbano",
              "tiponum": 0,
              "system:index": "6"
            }),
        ee.Feature(
            ee.Geometry.Point([-76.47170420006522, 3.432430497122267]),
            {
              "tipo": "bosqueurbano",
              "tiponum": 0,
              "system:index": "7"
            }),
        ee.Feature(
            ee.Geometry.Point([-76.471124842918, 3.4322002409182257]),
            {
              "tipo": "bosqueurbano",
              "tiponum": 0,
              "system:index": "8"
            }),
        ee.Feature(
            ee.Geometry.Point([-76.4712321312786, 3.4316326323642614]),
            {
              "tipo": "bosqueurbano",
              "tiponum": 0,
              "system:index": "9"
            }),
        ee.Feature(
            ee.Geometry.Point([-76.47064204529532, 3.431043604263055]),
            {
              "tipo": "bosqueurbano",
              "tiponum": 0,
              "system:index": "10"
            }),
        ee.Feature(
            ee.Geometry.Point([-76.46906490639456, 3.4296513545807765]),
            {
              "tipo": "bosqueurbano",
              "tiponum": 0,
              "system:index": "11"
            }),
        ee.Feature(
            ee.Geometry.Point([-76.46995479687884, 3.4314435574680417]),
            {
              "tipo": "bosqueurbano",
              "tiponum": 0,
              "system:index": "12"
            }),
        ee.Feature(
            ee.Geometry.Point([-76.46959538087084, 3.4311115597899713]),
            {
              "tipo": "bosqueurbano",
              "tiponum": 0,
              "system:index": "13"
            })]),
    ba1 = 
    /* color: #ff4210 */
    /* shown: false */
    ee.FeatureCollection(
        [ee.Feature(
            ee.Geometry.Point([-76.47544312939242, 3.435693379945189]),
            {
              "tipo": "barrio",
              "tiponum": 1,
              "system:index": "0"
            }),
        ee.Feature(
            ee.Geometry.Point([-76.47526610359743, 3.435024032648161]),
            {
              "tipo": "barrio",
              "tiponum": 1,
              "system:index": "1"
            }),
        ee.Feature(
            ee.Geometry.Point([-76.47474575504854, 3.434461780555925]),
            {
              "tipo": "barrio",
              "tiponum": 1,
              "system:index": "2"
            }),
        ee.Feature(
            ee.Geometry.Point([-76.47477794155672, 3.4340815908582787]),
            {
              "tipo": "barrio",
              "tiponum": 1,
              "system:index": "3"
            }),
        ee.Feature(
            ee.Geometry.Point([-76.47425759300783, 3.4341030100002037]),
            {
              "tipo": "barrio",
              "tiponum": 1,
              "system:index": "4"
            }),
        ee.Feature(
            ee.Geometry.Point([-76.47381234631136, 3.433738884522218]),
            {
              "tipo": "barrio",
              "tiponum": 1,
              "system:index": "5"
            }),
        ee.Feature(
            ee.Geometry.Point([-76.47355485424593, 3.4329035373128125]),
            {
              "tipo": "barrio",
              "tiponum": 1,
              "system:index": "6"
            }),
        ee.Feature(
            ee.Geometry.Point([-76.47273356541827, 3.4320218757285614]),
            {
              "tipo": "barrio",
              "tiponum": 1,
              "system:index": "7"
            }),
        ee.Feature(
            ee.Geometry.Point([-76.47209519967272, 3.4315720726673007]),
            {
              "tipo": "barrio",
              "tiponum": 1,
              "system:index": "8"
            }),
        ee.Feature(
            ee.Geometry.Point([-76.47211129292681, 3.431127624196394]),
            {
              "tipo": "barrio",
              "tiponum": 1,
              "system:index": "9"
            }),
        ee.Feature(
            ee.Geometry.Point([-76.47174651250079, 3.4306456918859283]),
            {
              "tipo": "barrio",
              "tiponum": 1,
              "system:index": "10"
            }),
        ee.Feature(
            ee.Geometry.Point([-76.47042686566546, 3.4290553135374076]),
            {
              "tipo": "barrio",
              "tiponum": 1,
              "system:index": "11"
            }),
        ee.Feature(
            ee.Geometry.Point([-76.4711188755913, 3.429708600586615]),
            {
              "tipo": "barrio",
              "tiponum": 1,
              "system:index": "12"
            }),
        ee.Feature(
            ee.Geometry.Point([-76.4699655257149, 3.4287768631840527]),
            {
              "tipo": "barrio",
              "tiponum": 1,
              "system:index": "13"
            })]);
/***** End of imports. If edited, may not auto-convert in the playground. *****/
/////////////////////////////////////////////////////////////////
//  WORKFLOW
/*-
    0. Funciones
    1. Archivos externos (Roi, puntos y buffers)
    2. Coleccion
    3. NDVI
    4. Extrae
    5. Visualiza
    6. Exporta
-*/
/////////////////////////////////////////////////////////////////
/*-- 1. Archivos externos--*/
var Perimetrocali = ee.FeatureCollection("users/mariadescance/perimetro_cali");
/*-- 2. Coleccion--*/
var roi = Perimetrocali    // region de interes (reemplazar por nuevo poly)
Map.centerObject(bu1, 15); // centra en la roi
var l8_ = ee.ImageCollection('LANDSAT/LC08/C01/T1_SR').filterBounds(roi); 
var l8_ = ee.ImageCollection('LANDSAT/LC08/C02/T1_L2').filterBounds(roi); 
//Landsat 8 para Cali
  // Applies scaling factors.
function applyScaleFactors(image) {
  var opticalBands = image.select('SR_B.').multiply(0.0000275).add(-0.2);
  var thermalBands = image.select('ST_B.*').multiply(0.00341802).add(149.0);
  return image.addBands(opticalBands, null, true)
              .addBands(thermalBands, null, true);
}
l8_ = l8_.map(applyScaleFactors);
// print (l8_) //Revisa la coleccion Landsat
/*-- 0. Funciones--*/
function renameOli(img) { // Obtiene y renombra bandas
  return img.select(
      ['SR_B2', 'SR_B3', 'SR_B4', 'SR_B5', 'SR_B6', 'SR_B7', 'QA_PIXEL'],
      ['Blue', 'Green', 'Red', 'NIR', 'SWIR1', 'SWIR2', 'pixel_qa']);
}
function fmask(img) {  // Funcion para remover nubes
  var cloudShadowBitMask = 1 << 3;
  var cloudsBitMask = 1 << 5;
  var qa = img.select('pixel_qa');
  var mask = qa.bitwiseAnd(cloudShadowBitMask)
                 .eq(0)
                 .and(qa.bitwiseAnd(cloudsBitMask).eq(0));
  return img.updateMask(mask);
} 
function prepOli(img) { //Combina funciones anteriores
  var orig = img;
  img = renameOli(img);
  img = fmask(img);
  return ee.Image(img.copyProperties(orig, orig.propertyNames()));
} 
// Filtro por calidad de imagen y nubes
var colFilter = ee.Filter.and(
  ee.Filter.bounds(roi), ee.Filter.calendarRange(1, 366, 'day_of_year'),
  ee.Filter.lt('CLOUD_COVER', 80), 
  ee.Filter.lt('GEOMETRIC_RMSE_MODEL', 10),
  ee.Filter.or( ee.Filter.eq('IMAGE_QUALITY', 9),
  ee.Filter.eq('IMAGE_QUALITY_OLI', 9)));
// Aplica filtros de calidad y de máscara de nubes
var l8 = l8_.filter(colFilter).map(prepOli);
var col = l8
// print ('Tamano de la coleccion', l8.size()) //Numero de imagenes
/*-- 3. NDVI y NDBI--*/
var addIndexL578 = function(img) { //funcion que calcula NDVI y NDBI
  var ndvi  = img.normalizedDifference(['NIR', 'Red']).rename('NDVI');
  var ndbi = img.normalizedDifference(['SWIR1', 'NIR']).rename('NDBI');
  return img.addBands(ndvi).addBands(ndbi);
};
var col = col.map(addIndexL578);  //  Aplica NDVI a c/imagen de la coleccion
print (col)
/*-- 4.1 NDVI Extrae y convierte en multicapa--*/
var ndvi = col.select('NDVI')
var multiband = ndvi.toBands();           // print(multiband)
var names     = multiband.bandNames();    // Reset the bandnames
var newNames  = names.map(function(name){ // rename the bandnames 
  var ind     = names.indexOf(name);
  return ee.String(names.get(ind)).slice(5);
});
var multiband = multiband.rename(newNames); // Multicapa de NDVI
print ( 'Colección imagenes NDVI', ndvi);    // 
//print ('Imagen Multicapa NDVI', multiband); // 
var ndbi = col.select('NDBI')
var multiband = ndbi.toBands();           // print(multiband)
var names     = multiband.bandNames();    // Reset the bandnames
var newNames  = names.map(function(name){ // rename the bandnames 
  var ind     = names.indexOf(name);
  return ee.String(names.get(ind)).slice(5);
});
var multiband = multiband.rename(newNames); // Multicapa de NDVI
print ( 'Colección imagenes NDBI', ndbi);    // 
//print ('Imagen Multicapa NDBI', multiband); // 
// Colecciones anuales
var l8_2022 = l8.filterDate('2022-01-01', '2022-12-31').median();
var ndvi_2022 = ndvi.filterDate('2022-01-01', '2022-12-31').median();
var ndbi_2022 = ndbi.filterDate('2022-01-01', '2022-12-31').median();
//var ndvi_2021 = ndvi.filterDate('2021-01-01', '2021-12-31').median();
//var ndvi_2020 = ndvi.filterDate('2020-01-01', '2020-12-31').median();
print ('Imagen NDVI 2022', ndvi_2022)
/*-- 4. Extrae en buffer 5m--*/
var merge1 = bu1.merge(ba1);
Map.addLayer(merge1, {color: 'yellow'}, 'sitio 1 - Alameda Oriente y Puerta del Sol');
var buffer = function(feature) { // Funcion que Crea buffer
  return feature.buffer(5)};     // Numero en metros, cambiar si necesrio
var buff_5m_merge1 = merge1.map(buffer) // Crea buffer en puntos totales
var buff_5m_bu1 = bu1.map(buffer) // Crea buffer en puntos de bosque urbano
var buff_5m_ba1 = ba1.map(buffer) // Crea buffer en puntos de barrio
print (' Buffers 5m', buff_5m_merge1)
//Extrae informacion espectral
var sample = ndvi_2022.sampleRegions({collection: ba1,scale: 30,geometries: true});
print ('Muestra espectral', sample) //Imprime muestra espectral
/*-- 5. Visualiza --*/
var vis_RGB   = {min: 0.0,max: 0.3,bands: ['Red', 'Green', 'Blue']}; 
//var vis_NDVI  = {min:-0.5, max:1, palette: ['white', 'yellow', 'limegreen', 'green']};
var palettes = require('users/gena/packages:palettes');
var paletteNDVI = palettes.colorbrewer.RdYlGn[5];
var paletteNDBI = palettes.kovesi.diverging_gwv_55_95_c39[5];
var vis_NDVI  = {min:-0.05, max:0.9, palette: paletteNDVI};
var vis_NDBI  = {min:-0.6, max:0.2, palette: paletteNDBI};
var vis_veg   = {min:-0.5, max:0.2, palette: ['green']};
Map.addLayer(l8_2022, vis_RGB, 'RGB');
Map.addLayer(ndvi_2022.clip(roi), vis_NDVI, 'NDVI 2022');
Map.addLayer(ndbi_2022.clip(roi), vis_NDBI, 'NDBI 2022');
//Map.addLayer(ndvi_2021.clip(roi), vis_NDVI, 'NDVI 2021');
//Map.addLayer(ndvi_2020.clip(roi), vis_NDVI, 'NDVI 2020');
//Map.setCenter(-76.5205, 3.42158, 13);
// Extrae contornos (para poder dibujar el poligono vacio)
var contorno_cali = ee.Image().byte().paint({
  featureCollection: Perimetrocali, color: 1,width: 2}); // Extrae contorno Cali
var contorno_bu1 = ee.Image().byte().paint({
  featureCollection: buff_5m_bu1, width: 2}); // Extrae contorno buffer
var contorno_ba1 = ee.Image().byte().paint({
  featureCollection: buff_5m_ba1, width: 2}); // Extrae contorno buffer 
//Dibuja Cali, puntos y buffers
//Map.addLayer(Perimetrocali,  {palette: 'white'}, 'Perimetro Cali'); //Dibuja todo
Map.addLayer(contorno_cali,  {palette: 'yellow'}, 'Cali'); //Solo contorno 
Map.addLayer(contorno_bu1, {palette: 'green'}, 'buffer  5 m', true);
Map.addLayer(contorno_ba1, {palette: 'red'}, 'buffer  5 m', true);
Map.addLayer(ba1, {color: 'black'}, 'Puntos Censo Urbano', true);
//Una grafica de varicion de NDVI 2013-2022
var chart1 = ui.Chart.image.series({ 
  imageCollection: col.select('NDVI'),
  region: roi, scale:30, xProperty: 'system:time_start'})
  .setOptions({
     title: 'Normalized Difference Vegetation Index in Cali, 2013-2022 Time Series',
     vAxis: {title: 'NDVI '}});
var chart2 = ui.Chart.image.seriesByRegion({
          imageCollection: col,
          band: 'NDVI',
          regions: buff_5m_bu1,
          reducer: ee.Reducer.mean(),
          scale: 30,
          seriesProperty: 'Sitio',
          xProperty: 'system:time_start'
        })
        .setOptions({
          title: 'Promedio NDVI por fecha - Bosque Urbano',
          hAxis: {title: 'Fecha', titleTextStyle: {italic: false, bold: true}},
          vAxis: {
            title: 'NDVI ',
            titleTextStyle: {italic: false, bold: true}
          },
          lineWidth: 5,
          colors: ['32cd32'],
        });
var chart2 = ui.Chart.image.seriesByRegion({
          imageCollection: col,
          band: 'NDVI',
          regions: buff_5m_ba1,
          reducer: ee.Reducer.mean(),
          scale: 30,
          seriesProperty: 'Sitio',
          xProperty: 'system:time_start'
        })
        .setOptions({
          title: 'Promedio NDVI por fecha - Barrio ',
          hAxis: {title: 'Fecha', titleTextStyle: {italic: false, bold: true}},
          vAxis: {
            title: 'NDVI ',
            titleTextStyle: {italic: false, bold: true}
          },
          lineWidth: 5,
          colors: ['32cd32'],
        });
print(chart1); //Grafica simple: NDVI promedio en centroide perimetroCali
print(chart2);
/*-- 6. Exporta --*/
Export.image.toDrive({ // Exporta una imagen
  image: ndvi_2022,
  region: roi,
  description: 'NDVI_2022',
  scale: 30});
//Export.image.toDrive({ //Esto exportaria toda la multicapa MUY GRANDE!
//  image: multiband, description: 'ndvi_L8_Cali',scale: 30,region: roi});